[{"id":"5672fa442b2b881d","type":"tab","label":"[statemachine] Representing gen_statem in Erlang-Red","disabled":false,"info":"## gen_statem behaviour\n\nErlang-Red won't be Erlang if it didn't know how to behave itself. This example shows how the [gen_statem](https://www.erlang.org/doc/apps/stdlib/gen_statem.html) behaviour can be visually implemented in Erlang-Red.\n\n## Setup\n\nSetting up a state machine requires defining a module for defining the behaviour of the state machine. For this test, the <a class=\"ahl-node-only\" data-ids=\"d27ff6b4cb3f4b16\">Module: pushbutton</a> is being used. It represents the [push pen button example](https://www.erlang.org/doc/apps/stdlib/gen_statem.html#module-pushbutton-code) from the documentation of the state machine.\n\nThe <a class=\"ahl-node-only\" data-ids=\"f2ebb3bf285716ac,d4fdb9f5a3792660\">state machine</a> nodes make reference to the module in their respective configurations. That defines the statemachines behaviour.\n\nWhen the statemachine receives a message from the one of the <a class=\"ahl-node-only\" data-ids=\"6d2bab8388444151,be3f533788078139,6ace31b4957dff44,d8856ed846ba27d0\">inject</a> nodes, it calls executes the follwing:\n\n```erlang\n#{payload := Action} = Msg,\nResult = gen_statem:call(Pid, binary_to_atom(Action)),\n```\n\nThe `payload` defines the action to perform and the result of the action is passed out as the payload on the outgoing message - if an outgoing message is generated.\n\n## Option: Send on state change\n\nThe difference between the two examples is that the <a class=\"ahl-group-only\" data-ids=\"5e10f2923ccf0b2a\">top one</a> only emits an outgoing message if the state has changed. This does not happen when `get_count` is triggered - it does not result in a state change so there is no outgoing message generated.\n\nThe <a class=\"ahl-group-only\" data-ids=\"3e05a4f2d46028bb\">bottom example</a> always emits outgoing messages, generating a message on every action.\n\nUsing this options allows the statemachine to act as a gateway. \n\n## Current state\n\nThe current state of the statemachine is always shown on the status of the node. \n\n## Other behaviours\n\n- [Supervisor](https://flows.red-erik.org/f/83c5e1824f32abec)\n- [Event Handler](https://flows.red-erik.org/f/b70a7ce34819e4d5)","env":[{"name":"ERED_PENDING","type":"bool","value":"false"}]},{"id":"5e10f2923ccf0b2a","type":"group","z":"5672fa442b2b881d","name":"only emit message on state change","style":{"label":true},"nodes":["f2ebb3bf285716ac","6d2bab8388444151","be3f533788078139","cb1f14a8e90433e9","aca422d93c92ee09","02bdd92d876da519"],"x":173,"y":242,"w":1042,"h":215},{"id":"f96f6bc60d58a481","type":"group","z":"5672fa442b2b881d","name":"common code used by all examples here","style":{"label":true},"nodes":["d27ff6b4cb3f4b16"],"x":173,"y":73,"w":265,"h":82},{"id":"3e05a4f2d46028bb","type":"group","z":"5672fa442b2b881d","name":"always emit messages","style":{"label":true},"nodes":["d4fdb9f5a3792660","6ace31b4957dff44","d8856ed846ba27d0","6f16fef44161a72e","f753306adf339932","3222b838d7e91c5f"],"x":178.5,"y":519,"w":1042,"h":215},{"id":"f2ebb3bf285716ac","type":"erlstatemachine","z":"5672fa442b2b881d","g":"5e10f2923ccf0b2a","name":"State machine - don't send on same state","module_name":"pushbutton","nodeid":"d27ff6b4cb3f4b16","emit_on_state_change":true,"x":578,"y":348,"wires":[["cb1f14a8e90433e9"]]},{"id":"d27ff6b4cb3f4b16","type":"erlmodule","z":"5672fa442b2b881d","g":"f96f6bc60d58a481","name":"Module: pushbutton","module_name":"pushbutton","code":"%%\n%% Inspired by\n%%  https://www.erlang.org/doc/apps/stdlib/gen_statem.html#module-pushbutton-code\n%%\n-module(pushbutton).\n-behaviour(gen_statem).\n\n-export([\n    start/0,\n    init/1,\n    callback_mode/0,\n    handle_event/4,\n    code_change/4,\n    terminate/3,\n    stop/0\n]).\n\ncallback_mode() -> handle_event_function.\n\n-define(KEEP_STATE(ReplyWith),\n    {keep_state, Data, [{reply, From, ReplyWith}]}\n).\n\nstart() ->\n    gen_statem:start({local, ?MODULE}, ?MODULE, [], []).\n\nstop() ->\n    gen_statem:stop(?MODULE).\nterminate(_Reason, _State, _Data) ->\n    void.\ncode_change(_Vsn, State, Data, _Extra) ->\n    {ok, State, Data}.\n\n%% Initial state and data\ninit([]) ->\n    State = off, \n    Data = 0,\n    {ok,State,Data}.\n\n%%% state callback(s)\n\nhandle_event(\n  {call, From},\n  <<\"push\">>,\n  off,\n  Data\n) ->\n    {next_state, on, Data + 1, [{reply, From, <<\"ok\">>}]};\n\nhandle_event(\n  {call, From},\n  <<\"push\">>,\n  on,\n  Data\n) ->\n    {next_state, off, Data, [{reply, From, <<\"ok\">>}]};\n\nhandle_event(\n  {call, From},\n  <<\"get_count\">>,\n  _CurrState,\n  Data\n) ->\n    {keep_state, Data, [{reply, From, Data}]};\n\n%%\n%% Fall through.\nhandle_event({call, From} = EventType, Stiff, State, Data) ->\n    io:format(\"TEST (call): ~p ~p ~p ~p~n\",[EventType, Stiff, State, Data]),\n    ?KEEP_STATE(<<\"not_allowed\">>);\n\nhandle_event(EventType, Stiff, State, Data) ->\n    io:format(\"TEST : ~p ~p ~p ~p~n\",[EventType, Stiff, State, Data]),\n    {keep_state, Data}.\n","x":289,"y":114,"wires":[]},{"id":"6d2bab8388444151","type":"inject","z":"5672fa442b2b881d","g":"5e10f2923ccf0b2a","name":"push","props":[{"p":"action","v":"push","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","x":290,"y":416,"wires":[["f2ebb3bf285716ac"]]},{"id":"be3f533788078139","type":"inject","z":"5672fa442b2b881d","g":"5e10f2923ccf0b2a","name":"get_count","props":[{"p":"action","v":"get_count","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","x":279,"y":283,"wires":[["f2ebb3bf285716ac"]]},{"id":"cb1f14a8e90433e9","type":"switch","z":"5672fa442b2b881d","g":"5e10f2923ccf0b2a","name":"","property":"_statem.action","propertyType":"msg","rules":[{"t":"eq","v":"push","vt":"str"},{"t":"eq","v":"get_count","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":895,"y":348,"wires":[["aca422d93c92ee09"],["02bdd92d876da519"]]},{"id":"aca422d93c92ee09","type":"ut-assert-success","z":"5672fa442b2b881d","g":"5e10f2923ccf0b2a","name":"","x":1118,"y":318.5,"wires":[]},{"id":"02bdd92d876da519","type":"ut-assert-failure","z":"5672fa442b2b881d","g":"5e10f2923ccf0b2a","name":"","x":1119,"y":399.5,"wires":[]},{"id":"d4fdb9f5a3792660","type":"erlstatemachine","z":"5672fa442b2b881d","g":"3e05a4f2d46028bb","name":"State machine - always send message","module_name":"pushbutton","nodeid":"d27ff6b4cb3f4b16","emit_on_state_change":false,"x":573.5,"y":625,"wires":[["6f16fef44161a72e"]]},{"id":"6ace31b4957dff44","type":"inject","z":"5672fa442b2b881d","g":"3e05a4f2d46028bb","name":"push","props":[{"p":"action","v":"push","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","x":295.5,"y":693,"wires":[["d4fdb9f5a3792660"]]},{"id":"d8856ed846ba27d0","type":"inject","z":"5672fa442b2b881d","g":"3e05a4f2d46028bb","name":"get_count","props":[{"p":"action","v":"get_count","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","x":284.5,"y":560,"wires":[["d4fdb9f5a3792660"]]},{"id":"6f16fef44161a72e","type":"switch","z":"5672fa442b2b881d","g":"3e05a4f2d46028bb","name":"","property":"_statem.action","propertyType":"msg","rules":[{"t":"eq","v":"push","vt":"str"},{"t":"eq","v":"get_count","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":900.5,"y":625,"wires":[["f753306adf339932"],["3222b838d7e91c5f"]]},{"id":"f753306adf339932","type":"ut-assert-success","z":"5672fa442b2b881d","g":"3e05a4f2d46028bb","name":"","x":1123.5,"y":595.5,"wires":[]},{"id":"3222b838d7e91c5f","type":"ut-assert-success","z":"5672fa442b2b881d","g":"3e05a4f2d46028bb","name":"","x":1124.5,"y":662,"wires":[]},{"id":"b5d03a7671459be0","type":"erlstatemachine","z":"5672fa442b2b881d","name":"State machine - always send message","module_name":"pushbutton","nodeid":"d27ff6b4cb3f4b16","emit_on_state_change":false,"x":650,"y":1118,"wires":[["2abe81763b91b27d"]]},{"id":"0dbc97c4c78a1087","type":"inject","z":"5672fa442b2b881d","name":"push","props":[{"p":"action","v":"push","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","x":233,"y":1122,"wires":[["b5d03a7671459be0"]]},{"id":"dfe5684d8f93585c","type":"inject","z":"5672fa442b2b881d","name":"get_count","props":[{"p":"action","v":"get_count","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","x":172,"y":977,"wires":[["76bdd73f6bc070d6"]]},{"id":"2abe81763b91b27d","type":"switch","z":"5672fa442b2b881d","name":"","property":"_statem.action","propertyType":"msg","rules":[{"t":"eq","v":"push","vt":"str"},{"t":"eq","v":"get_count","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":924,"y":1118,"wires":[["c5911e86d175f6b0"],["2d86a90e19969d31","856803224f5b275c"]]},{"id":"c5911e86d175f6b0","type":"ut-assert-success","z":"5672fa442b2b881d","name":"","x":1147,"y":1088.5,"wires":[]},{"id":"2d86a90e19969d31","type":"ut-assert-success","z":"5672fa442b2b881d","name":"","x":1148,"y":1155,"wires":[]},{"id":"703ff051a8c1339b","type":"inject","z":"5672fa442b2b881d","name":"push","props":[{"p":"action","v":"push","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","x":233,"y":1159.2,"wires":[["b5d03a7671459be0"]]},{"id":"1c1fee931f376773","type":"inject","z":"5672fa442b2b881d","name":"push","props":[{"p":"action","v":"push","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","x":233,"y":1196.4,"wires":[["b5d03a7671459be0"]]},{"id":"eedb04d43399a5ac","type":"inject","z":"5672fa442b2b881d","name":"push","props":[{"p":"action","v":"push","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","x":233,"y":1233.6000000000001,"wires":[["b5d03a7671459be0"]]},{"id":"daee3833f6a73b08","type":"inject","z":"5672fa442b2b881d","name":"push","props":[{"p":"action","v":"push","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","x":233,"y":1270.8000000000002,"wires":[["b5d03a7671459be0"]]},{"id":"76bdd73f6bc070d6","type":"delay","z":"5672fa442b2b881d","name":"","pauseType":"delay","timeout":"500","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":355,"y":1047,"wires":[["b5d03a7671459be0"]]},{"id":"856803224f5b275c","type":"ut-assert-values","z":"5672fa442b2b881d","name":"","ignore_failure_if_succeed":false,"rules":[{"t":"eql","p":"payload","pt":"msg","to":"3","tot":"num"}],"x":1143,"y":1212.5,"wires":[[]]},{"id":"c43b8aea54216f87","type":"inject","z":"5672fa442b2b881d","name":"push","props":[{"p":"action","v":"push","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","x":233,"y":1308,"wires":[["b5d03a7671459be0"]]}]