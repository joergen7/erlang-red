[{"id":"e447b0048a5983b5","type":"tab","label":"[supervisor] supervisor of supervisor of supervisor of ....","disabled":false,"info":"<small><i>[Share link](https://flows.red-erik.org/f/e447b0048a5983b5)</i></small>\n\n## Supervisors all the way down\n\nAn example of using supervisors to restart supervisors. This supercedes the [restart via message](https://flows.red-erik.org/f/6b22ce2a482c2d6d) or rather provides a simpler mechansim for restarting a supervisor. Both approaches are supported.\n\n## Setup\n\nThe core of this flow is the <a class=\"ahl-group-only\" data-ids=\"e1745dfaec070457\">root group</a> that contains the <a class=\"ahl-node-only\" data-ids=\"f9c30facfa98c063\">root supervisor</a> which is the last in a chain of supervisors. The root supervisor has an intensity of 1000 over a period of 1 second, i.e., it is designed to never fail.\n\nThe root supervisor supervises the <a class=\"ahl-node-only\" data-ids=\"b3e3826d7586da51\">one below root</a> supervisor that in turn supervises the <a class=\"ahl-node-only\" data-ids=\"c948d78b56ea338f\">two below root</a> supervisor which in turn supervises the <a class=\"ahl-node-only\" data-ids=\"49f8266870cf3ae4\">three below root</a> which finally supervises the <a class=\"ahl-node-only\" data-ids=\"0a384e288df2f95d\">supervisor controlling function node</a>.\n\nEach supervisor has an intensity and period configuration such that they eventually die and need to be restated by a supervisor. So it goes all the way up to the <a class=\"ahl-node-only\" data-ids=\"f9c30facfa98c063\">root supervisor</a> that ends up restarting the entire chain.\n\nThe node causing the failure is the <a class=\"ahl-node-only\" data-ids=\"ce7ad9dda79c3129\">function 1</a> which contains the single line of Erlang code: `exit(self(), failure)`.\n\n**Note**: each supervisor is set to restart policy of `permanent`.\n\nThe function node receives messages from the <a class=\"ahl-group-only\" data-ids=\"9f3b6edc8707cca5\">message generation</a> group that generates 2000 messages, all of which sent to the function and each time the function exits.\n\nThat exit also takes out the <a class=\"ahl-node-only\" data-ids=\"5208e18f1c766f81\">debug 11</a> node that is also supervised by the <a class=\"ahl-node-only\" data-ids=\"0a384e288df2f95d\">supervisor controlling function</a> node. That is way the debug message counter - as shown in the animation - never goes beyond 6 because the supervisor is configured with an intensity of five over a period of ten seconds. \n\n![img](https://cdn.openmindmap.org/content/1748511273753_erlang-red-super-of-super.gif)\n\nRemember the debug node is not restarted along with the function node because the <a class=\"ahl-node-only\" data-ids=\"0a384e288df2f95d\">supervisor controlling function node</a> is configured with a restart strategy `one-for-one` but because the supervisor falls down, the debug node is always restarted once the supervisor is restarted - hence the message counter reaches six. Also the sixth message kills the supervisor because the function is *allowed* to fail five times in ten seconds and the sixth failure causes the supervisor to collapse (in a smouldering heap of burning bits).\n\nIf the supervisor where to be configured with a restart strategy of `one-for-all`, then the message counter of the <a class=\"ahl-node-only\" data-ids=\"5208e18f1c766f81\">debug 11</a> would not go beyond 1 since the supervisor would also restart the debug node when it restarted the function node, i.e., on every message.\n\n## Testing \n\nThis flow also tests that features are working. For that there are two test groups: \n\n- <a class=\"ahl-group-only\" data-ids=\"dc497ddceb8383d6\">test that everything gets restarted</a> which ensures that supervisors are doing their job. What happens is that each join collects a number of messages before emitting one bundle of messages, this test then ensures that supervisors are restarting ofren enough. Each supervisor emits a message when it falls down, when it restarts and when it has started - these messages are being collected by the <a class=\"ahl-node-only\" data-ids=\"e57a8a3419e63a78\">join 82</a>, <a class=\"ahl-node-only\" data-ids=\"ecc61f0aaeff8032\">join 166</a> and <a class=\"ahl-node-only\" data-ids=\"f0249c7f877f7d7a\">join 332</a> nodes. The <a class=\"ahl-node-only\" data-ids=\"cd9ecea3aa8b07bc,28b2942d170ef74b,3e10f2f597dd4a09\">Assert True</a> nodes are reached once the joins emit their bundle message and the test succeeds.\n\n- <a class=\"ahl-group-only\" data-ids=\"59aa8abeaa454c6a\">test throughput on debug node</a> this ensures that the debug node is receiving all the messages even if it gets restarted. How it works is by counting the status changes of the <a class=\"ahl-node-only\" data-ids=\"5208e18f1c766f81\">debug 11</a> node using the <a class=\"ahl-node-only\" data-ids=\"f03f862514493696\">status: 1</a> node. **Note**, this only works because there is a <a class=\"ahl-node-only\" data-ids=\"095ceca669915bd5\">1ms delay</a> in message generation - else the debug node does actually drop messages, i.e., doesn't receive the message because the process has died and is being restarted. Erlang-Red does not buffer messages, it sends message to processes if these processes are alive else the messages get dropped.\n\n","env":[{"name":"ERED_NOT_EUNIT","value":"true","type":"bool"},{"name":"ERED_TIMEOUT","value":"9","type":"num"}]},{"id":"e1745dfaec070457","type":"group","z":"e447b0048a5983b5","style":{"color":"#a4a4a4","fill":"none","fill-opacity":"1","label":true,"label-position":"nw","stroke":"#999999","stroke-opacity":"1"},"nodes":["f9c30facfa98c063","d0f7c225c63f6d61","c381eb7bb9d689d0"],"x":752,"y":258,"w":604,"h":646},{"id":"9f3b6edc8707cca5","type":"group","z":"e447b0048a5983b5","name":"message generation","style":{"label":true},"nodes":["73f1c7593502aba5","095ceca669915bd5","ed7c19d0f90462ed"],"x":9.999969482421875,"y":676.70751953125,"w":650.3334045410156,"h":159.375},{"id":"dc497ddceb8383d6","type":"group","z":"e447b0048a5983b5","name":"test that everything gets restarted","style":{"label":true},"nodes":["e57a8a3419e63a78","3e10f2f597dd4a09","ecc61f0aaeff8032","28b2942d170ef74b","f0249c7f877f7d7a","cd9ecea3aa8b07bc","314987cdf92caa1a","4b3260fdeeac9dd1"],"x":1397,"y":88,"w":364,"h":337},{"id":"59aa8abeaa454c6a","type":"group","z":"e447b0048a5983b5","name":"test throughput on debug node","style":{"label":true},"nodes":["f03f862514493696","0827c3cdcf01b0cc","a3cb2e180d1d3398"],"x":268,"y":61,"w":565,"h":165},{"id":"d0f7c225c63f6d61","type":"group","z":"e447b0048a5983b5","g":"e1745dfaec070457","name":"","style":{"label":true},"nodes":["b3e3826d7586da51","7ff1906324f48abf","b66de255a87acc7d"],"x":795.8337938785553,"y":330,"w":534.1662061214447,"h":548},{"id":"7ff1906324f48abf","type":"group","z":"e447b0048a5983b5","g":"d0f7c225c63f6d61","style":{"color":"#a4a4a4","fill":"none","fill-opacity":"1","label":true,"label-position":"nw","stroke":"#999999","stroke-opacity":"1"},"nodes":["c948d78b56ea338f","b70b7d859dbc5968","425c6b4bbe5b3da4"],"x":821.8337938785553,"y":398.5,"w":482.1662061214447,"h":453.5},{"id":"b70b7d859dbc5968","type":"group","z":"e447b0048a5983b5","g":"7ff1906324f48abf","style":{"color":"#a4a4a4","fill":"none","fill-opacity":"1","label":true,"label-position":"nw","stroke":"#999999","stroke-opacity":"1"},"nodes":["49f8266870cf3ae4","4ce371d78f1421dc","48969dfe7abed1d3"],"x":847.8337938785553,"y":467,"w":430.1662061214447,"h":359},{"id":"4ce371d78f1421dc","type":"group","z":"e447b0048a5983b5","g":"b70b7d859dbc5968","style":{"color":"#a4a4a4","fill":"none","fill-opacity":"1","label":true,"label-position":"nw","stroke":"#999999","stroke-opacity":"1"},"nodes":["0a384e288df2f95d","ce7ad9dda79c3129","5208e18f1c766f81","9e76b4cbd5c0a78c"],"x":873.8337938785553,"y":542,"w":370.1662061214447,"h":258},{"id":"9e76b4cbd5c0a78c","type":"junction","z":"e447b0048a5983b5","g":"4ce371d78f1421dc","x":899.8337938785553,"y":719.6326316595078,"wires":[["ce7ad9dda79c3129","5208e18f1c766f81"]]},{"id":"f9c30facfa98c063","type":"erlsupervisor","z":"e447b0048a5983b5","g":"e1745dfaec070457","name":"root supervisor","scope":["b3e3826d7586da51"],"supervisor_type":"static","strategy":"one_for_one","auto_shutdown":"never","intensity":"1000","period":"1","child_type":"supervisor","child_restart":"permanent","child_shutdown":"infinite","child_shutdown_timeout":"0","x":858,"y":299,"wires":[["c381eb7bb9d689d0","314987cdf92caa1a"]]},{"id":"b3e3826d7586da51","type":"erlsupervisor","z":"e447b0048a5983b5","g":"d0f7c225c63f6d61","name":"one below root","scope":["c948d78b56ea338f"],"supervisor_type":"static","strategy":"one_for_one","auto_shutdown":"never","intensity":"1","period":"1","child_type":"supervisor","child_restart":"permanent","child_shutdown":"infinite","child_shutdown_timeout":"0","x":918,"y":371,"wires":[["b66de255a87acc7d","e57a8a3419e63a78"]]},{"id":"c948d78b56ea338f","type":"erlsupervisor","z":"e447b0048a5983b5","g":"7ff1906324f48abf","name":"two below root","scope":["49f8266870cf3ae4"],"supervisor_type":"static","strategy":"one_for_one","auto_shutdown":"never","intensity":"1","period":"6","child_type":"supervisor","child_restart":"permanent","child_shutdown":"infinite","child_shutdown_timeout":"0","x":946,"y":439.5,"wires":[["425c6b4bbe5b3da4","ecc61f0aaeff8032"]]},{"id":"49f8266870cf3ae4","type":"erlsupervisor","z":"e447b0048a5983b5","g":"b70b7d859dbc5968","name":"three below root","scope":["0a384e288df2f95d"],"supervisor_type":"static","strategy":"one_for_one","auto_shutdown":"never","intensity":"1","period":"10","child_type":"supervisor","child_restart":"permanent","child_shutdown":"infinite","child_shutdown_timeout":"0","x":978,"y":508,"wires":[["48969dfe7abed1d3","f0249c7f877f7d7a"]]},{"id":"0a384e288df2f95d","type":"erlsupervisor","z":"e447b0048a5983b5","g":"4ce371d78f1421dc","name":"supervisor controlling function node","scope":["ce7ad9dda79c3129","5208e18f1c766f81"],"supervisor_type":"static","strategy":"one_for_one","auto_shutdown":"never","intensity":"5","period":"10","child_type":"worker","child_restart":"permanent","child_shutdown":"brutal_kill","child_shutdown_timeout":"0","x":1068,"y":583,"wires":[[]]},{"id":"ce7ad9dda79c3129","type":"function","z":"e447b0048a5983b5","g":"4ce371d78f1421dc","name":"function 1","func":"%% Code here is wrapped in a fun (Msg) call\n%% fun (Msg) ->\n    exit(self(), failure)\n%% end.\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1068,"y":675,"wires":[[]]},{"id":"86123a4378f7fe05","type":"inject","z":"e447b0048a5983b5","name":"Start Button","props":[{"p":"payload"},{"p":"msgcnt","v":"0","vt":"num"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":156,"y":446,"wires":[["73f1c7593502aba5"]]},{"id":"73f1c7593502aba5","type":"change","z":"e447b0048a5983b5","g":"9f3b6edc8707cca5","name":"","rules":[{"p":"payload","pt":"msg","t":"set","to":"","tot":"date"},{"p":"msgcnt","pt":"msg","t":"set","to":"$$.msgcnt + 1","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":372.3333435058594,"y":717.70751953125,"wires":[["095ceca669915bd5","35309d41a6ba48c7","9e76b4cbd5c0a78c"]]},{"id":"095ceca669915bd5","type":"delay","z":"e447b0048a5983b5","g":"9f3b6edc8707cca5","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":564.3333740234375,"y":792.08251953125,"wires":[["ed7c19d0f90462ed"]]},{"id":"35309d41a6ba48c7","type":"debug","z":"e447b0048a5983b5","name":"debug 10","active":true,"tosidebar":false,"console":false,"tostatus":true,"complete":"payload","targetType":"msg","statusVal":"","statusType":"counter","x":552.3333740234375,"y":428,"wires":[]},{"id":"ed7c19d0f90462ed","type":"switch","z":"e447b0048a5983b5","g":"9f3b6edc8707cca5","name":"stop after 2000 messages","property":"msgcnt","propertyType":"msg","rules":[{"t":"lt","v":"2000","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":145.99996948242188,"y":795.08251953125,"wires":[["73f1c7593502aba5"]]},{"id":"5208e18f1c766f81","type":"debug","z":"e447b0048a5983b5","g":"4ce371d78f1421dc","name":"debug 11","active":true,"tosidebar":false,"console":false,"tostatus":true,"complete":"payload","targetType":"msg","statusVal":"","statusType":"counter","x":1072,"y":759,"wires":[]},{"id":"f03f862514493696","type":"status","z":"e447b0048a5983b5","g":"59aa8abeaa454c6a","name":"","scope":["5208e18f1c766f81"],"x":354,"y":185,"wires":[["1c538e85c7a78e99","0827c3cdcf01b0cc"]]},{"id":"1c538e85c7a78e99","type":"debug","z":"e447b0048a5983b5","name":"debug 1","active":true,"tosidebar":false,"console":false,"tostatus":true,"complete":"payload","targetType":"msg","statusVal":"","statusType":"counter","x":551,"y":364,"wires":[]},{"id":"c381eb7bb9d689d0","type":"debug","z":"e447b0048a5983b5","g":"e1745dfaec070457","name":"debug 2","active":true,"tosidebar":false,"console":false,"tostatus":true,"complete":"payload","targetType":"msg","statusVal":"","statusType":"counter","x":1172,"y":299,"wires":[]},{"id":"b66de255a87acc7d","type":"debug","z":"e447b0048a5983b5","g":"d0f7c225c63f6d61","name":"debug 3","active":true,"tosidebar":false,"console":false,"tostatus":true,"complete":"payload","targetType":"msg","statusVal":"","statusType":"counter","x":1172,"y":371,"wires":[]},{"id":"425c6b4bbe5b3da4","type":"debug","z":"e447b0048a5983b5","g":"7ff1906324f48abf","name":"debug 4","active":true,"tosidebar":false,"console":false,"tostatus":true,"complete":"payload","targetType":"msg","statusVal":"","statusType":"counter","x":1172,"y":439.5,"wires":[]},{"id":"48969dfe7abed1d3","type":"debug","z":"e447b0048a5983b5","g":"b70b7d859dbc5968","name":"debug 5","active":true,"tosidebar":false,"console":false,"tostatus":true,"complete":"payload","targetType":"msg","statusVal":"","statusType":"counter","x":1172,"y":508,"wires":[]},{"id":"e57a8a3419e63a78","type":"join","z":"e447b0048a5983b5","g":"dc497ddceb8383d6","name":"","mode":"custom","build":"array","property":"","propertyType":"full","key":"topic","joiner":"\\n","joinerType":"str","useparts":false,"accumulate":false,"timeout":"","count":"82","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"","reduceFixup":"","x":1473,"y":214,"wires":[["3e10f2f597dd4a09"]]},{"id":"3e10f2f597dd4a09","type":"ut-assert-success","z":"e447b0048a5983b5","g":"dc497ddceb8383d6","name":"","x":1665,"y":214,"wires":[]},{"id":"ecc61f0aaeff8032","type":"join","z":"e447b0048a5983b5","g":"dc497ddceb8383d6","name":"","mode":"custom","build":"array","property":"","propertyType":"full","key":"topic","joiner":"\\n","joinerType":"str","useparts":false,"accumulate":false,"timeout":"","count":"166","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"","reduceFixup":"","x":1483,"y":299,"wires":[["28b2942d170ef74b"]]},{"id":"28b2942d170ef74b","type":"ut-assert-success","z":"e447b0048a5983b5","g":"dc497ddceb8383d6","name":"","x":1665,"y":299,"wires":[]},{"id":"f0249c7f877f7d7a","type":"join","z":"e447b0048a5983b5","g":"dc497ddceb8383d6","name":"","mode":"custom","build":"array","property":"","propertyType":"full","key":"topic","joiner":"\\n","joinerType":"str","useparts":false,"accumulate":false,"timeout":"","count":"332","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"","reduceFixup":"","x":1483,"y":384,"wires":[["cd9ecea3aa8b07bc"]]},{"id":"cd9ecea3aa8b07bc","type":"ut-assert-success","z":"e447b0048a5983b5","g":"dc497ddceb8383d6","name":"","x":1665,"y":384,"wires":[]},{"id":"0827c3cdcf01b0cc","type":"join","z":"e447b0048a5983b5","g":"59aa8abeaa454c6a","name":"","mode":"custom","build":"array","property":"","propertyType":"full","key":"topic","joiner":"\\n","joinerType":"str","useparts":false,"accumulate":false,"timeout":"","count":"1900","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"","reduceFixup":"","x":546,"y":102,"wires":[["a3cb2e180d1d3398"]]},{"id":"a3cb2e180d1d3398","type":"ut-assert-success","z":"e447b0048a5983b5","g":"59aa8abeaa454c6a","name":"","x":737,"y":102,"wires":[]},{"id":"314987cdf92caa1a","type":"join","z":"e447b0048a5983b5","g":"dc497ddceb8383d6","name":"","mode":"custom","build":"array","property":"","propertyType":"full","key":"topic","joiner":"\\n","joinerType":"str","useparts":false,"accumulate":false,"timeout":"","count":"2","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"","reduceFixup":"","x":1473,"y":129,"wires":[["4b3260fdeeac9dd1"]]},{"id":"4b3260fdeeac9dd1","type":"ut-assert-failure","z":"e447b0048a5983b5","g":"dc497ddceb8383d6","name":"","x":1665,"y":129,"wires":[]}]