[{"id":"83c5e1824f32abec","type":"tab","label":"[supervisor] supervisor tree","disabled":false,"info":"<small><i>[Share link](https://flows.red-erik.org/f/83c5e1824f32abec)</i></small>\n\n## Supervisor Tree\n\nThis is a typical data bus flow with various components sampling from the data bus. Each component is supervised by a supervisor node ensuring that the overall architecture is self-healing.\n\n<i>Note this flow is a specialised form of the [supervisor for supervisor for supervisor for ...](https://flows.red-erik.org/f/e447b0048a5983b5) flow. More details there on how these test flows work.</i>\n\nThe <a class=\"ahl-group-only\" data-ids=\"a2a7e74a4af61408\">message generator</a> generates random message that flow along the <a class='ahl-link-node' data-ids='42854c33d24cc147,2034061e36a4f15f,2034061e36a4f15f,902a3ee2db441271,260e4be19268b1a6,902a3ee2db441271,f6220844d7d6beb1'>data bus</a> (horizontal line extending out from the <a class=\"ahl-node-only\" data-ids=\"42854c33d24cc147\">change: 2 rules</a> node).\n\n## Supervisor behaviour\n\nThe supersivor node is implemented using the Erlang [supervisor behaviour](https://www.erlang.org/doc/apps/stdlib/supervisor.html).\n\n## Setup\n\nThe <a class=\"ahl-node-only\" data-ids=\"1af8ba70d5a3524f\">root supervisor</a> supervises the <a class=\"ahl-node-only\" data-ids=\"393f1b779c6091f6\">right branch</a> supervisor and the <a class=\"ahl-node-only\" data-ids=\"fa5012a137b001d9\">left branch</a> supervisor and ensures either is restarted using the `one-for-one` restart strategy.\n\nSince the left and right branches of this tree have nothing to do with one another, using the `one-for-one` restart strategy ensures that the failure of one branch does not influence the other branch.\n\nAlternatively shutting down the <a class=\"ahl-node-only\" data-ids=\"1af8ba70d5a3524f\">root supervisor</a> will ensure that the entire flow is shutdown. So the flow has a single on/off switch.\n\nThe <a class=\"ahl-node-only\" data-ids=\"fa5012a137b001d9\">left branch</a> supervisor is in control of <a class=\"ahl-group-only\" data-ids=\"876cb4e6a0e13e60\">this group of nodes</a> including a <a class=\"ahl-node-only\" data-ids=\"96ae99eb5ff0f75e\">sub-supervisor leaf left</a>. The <a class=\"ahl-node-only\" data-ids=\"96ae99eb5ff0f75e\">leaf left</a> supervisor manages this <a class=\"ahl-group-only\" data-ids=\"7a32d11ddf48f390\">group of nodes</a>.\n\nThe <a class=\"ahl-node-only\" data-ids=\"393f1b779c6091f6\">right branch</a> supervisor supervisese these <a class=\"ahl-group-only\" data-ids=\"61bf066466ccf6c9\">nodes</a> which also includes a sub-supervisor called <a class=\"ahl-node-only\" data-ids=\"579f89501d19b608\">leaf right</a> which manages these <a class=\"ahl-group-only\" data-ids=\"198c5ec84a4303d3\">nodes</a>.\n\nAs in other supervisor test flows, the <a class=\"ahl-node-only\" data-ids=\"2be5de12297e37e8,b2079d01bc6083b3,77db69c180d41d6f\">exit</a> function nodes exit immediately upon receiving a message thus causing their respective supervisors to restart them. The <a class=\"ahl-node-only\" data-ids=\"f05dfd8751fd199d,da885704f8719ad6,0fbbd20588aed361,c9d06322583751b1,9b4dec78a245edbd,871aea169f73c835\">msg counter</a> nodes simply count the number of messages they have received. These counts are reset if the debug node is restarted.\n\nA single <a class=\"ahl-node-only\" data-ids=\"4f3ae8c1ef6c1cd7\">function node</a> does something differently and instead it just passes through the messages it receives. Difference are the spice of life.\n\n## Why is this important?\n\nOne thing to remember is that even though this flow is simply a test using placeholder <a class=\"ahl-node-only\" data-ids=\"2be5de12297e37e8,b2079d01bc6083b3,4f3ae8c1ef6c1cd7,77db69c180d41d6f\">function nodes</a>, these function nodes can easily (drag & drop & deploy) be replaced by MQTT out nodes. The <a class=\"ahl-group-only\" data-ids=\"a2a7e74a4af61408\">message generator</a> can similarly be replaced by an MQTT in node and nothing else changes. The supervisors remain the same, the debug (msg counter nodes) can stay.\n\nThe only difference would be that it would suddenly be a production ready data pipeline that any good Erlang architect would put together - in textual form.\n\nThe nodes use the same Erlang concepts and behaviours as any Erlang programmer would create using their favourite textual tool.\n\nThe only other difference is that one can *see* the data pipeline and one can even sample from the pipeline using some extra tooling (those batteries aren't included here).\n\nBut as most folks prefer to imagine a better future, visualising that future isn't half as much fun.\n\n## UML-like visual representation of the visual representation\n\nThis flow implements the following supervisor tree:\n\n```mermaid\n%% change this to LR Node-RED like UML\ngraph TB\n1af8ba70d5a3524f[\"root supervisor\"] --> fa5012a137b001d9[\"left branch\"]\n1af8ba70d5a3524f[\"root supervisor\"] --> 393f1b779c6091f6[\"right branch\"]\n393f1b779c6091f6[\"right branch\"] --> f05dfd8751fd199d([\"msg counter right branch\"])\n393f1b779c6091f6[\"right branch\"] --> 2be5de12297e37e8([\"exit\"])\n393f1b779c6091f6[\"right branch\"] --> 579f89501d19b608[\"leaf right\"]\nfa5012a137b001d9[\"left branch\"] --> 4f3ae8c1ef6c1cd7([\"pass Msg through\"])\nfa5012a137b001d9[\"left branch\"] --> 96ae99eb5ff0f75e[\"leaf left\"]\nfa5012a137b001d9[\"left branch\"] --> c9d06322583751b1([\"msg count left branch\"])\n579f89501d19b608[\"leaf right\"] --> da885704f8719ad6([\"msg counter right leaf top\"])\n579f89501d19b608[\"leaf right\"] --> b2079d01bc6083b3([\"exit\"])\n579f89501d19b608[\"leaf right\"] --> 0fbbd20588aed361([\"msg counter right leaf bottom\"])\n96ae99eb5ff0f75e[\"leaf left\"] --> 9b4dec78a245edbd([\"msg count left left top\"])\n96ae99eb5ff0f75e[\"leaf left\"] --> 77db69c180d41d6f([\"exit\"])\n96ae99eb5ff0f75e[\"leaf left\"] --> 871aea169f73c835([\"msg count left left bottom\"])\n```\n\n## Other behaviours\n\n- [Event handler](https://flows.red-erik.org/f/b70a7ce34819e4d5)\n- [State machine](https://flows.red-erik.org/f/5672fa442b2b881d)","env":[{"name":"ERED_TIMEOUT","value":"10","type":"num"},{"name":"ERED_NOT_EUNIT","value":"true","type":"bool"}]},{"id":"10ad535c44495df5","type":"group","z":"83c5e1824f32abec","style":{"color":"#a4a4a4","fill":"none","fill-opacity":"1","label":true,"label-position":"nw","stroke":"#999999","stroke-opacity":"1"},"nodes":["1af8ba70d5a3524f","393f1b779c6091f6","fa5012a137b001d9"],"x":1297,"y":469,"w":1153,"h":240},{"id":"61bf066466ccf6c9","type":"group","z":"83c5e1824f32abec","style":{"color":"#a4a4a4","fill":"none","fill-opacity":"1","label":true,"label-position":"nw","stroke":"#999999","stroke-opacity":"1"},"nodes":["2be5de12297e37e8","f05dfd8751fd199d","579f89501d19b608"],"x":2313,"y":723,"w":384,"h":186},{"id":"198c5ec84a4303d3","type":"group","z":"83c5e1824f32abec","style":{"color":"#a4a4a4","fill":"none","fill-opacity":"1","label":true,"label-position":"nw","stroke":"#999999","stroke-opacity":"1"},"nodes":["b2079d01bc6083b3","0fbbd20588aed361","da885704f8719ad6"],"x":2511,"y":967,"w":392,"h":228},{"id":"876cb4e6a0e13e60","type":"group","z":"83c5e1824f32abec","style":{"color":"#a4a4a4","fill":"none","fill-opacity":"1","label":true,"label-position":"nw","stroke":"#999999","stroke-opacity":"1"},"nodes":["4f3ae8c1ef6c1cd7","c9d06322583751b1","96ae99eb5ff0f75e","2034061e36a4f15f"],"x":1064.1674642562866,"y":815,"w":428.8325357437134,"h":381.5},{"id":"7a32d11ddf48f390","type":"group","z":"83c5e1824f32abec","style":{"color":"#a4a4a4","fill":"none","fill-opacity":"1","label":true,"label-position":"nw","stroke":"#999999","stroke-opacity":"1"},"nodes":["77db69c180d41d6f","9b4dec78a245edbd","871aea169f73c835"],"x":1596,"y":1033,"w":340,"h":241},{"id":"a2a7e74a4af61408","type":"group","z":"83c5e1824f32abec","name":"message generator","style":{"label":true},"nodes":["42854c33d24cc147","d5267b01ad627817","783c38c513ee2063","3d86e58d1499701d","33e9669d5da36116"],"x":103,"y":806,"w":745.3333740234375,"h":263.08251953125},{"id":"f6220844d7d6beb1","type":"junction","z":"83c5e1824f32abec","x":2163.1428351402283,"y":1085,"wires":[["da885704f8719ad6","b2079d01bc6083b3","0fbbd20588aed361"]]},{"id":"2034061e36a4f15f","type":"junction","z":"83c5e1824f32abec","g":"876cb4e6a0e13e60","x":1090.1674642562866,"y":950.70751953125,"wires":[["c9d06322583751b1","4f3ae8c1ef6c1cd7","902a3ee2db441271"]]},{"id":"902a3ee2db441271","type":"junction","z":"83c5e1824f32abec","x":2076.000049829483,"y":950.70751953125,"wires":[["f6220844d7d6beb1","260e4be19268b1a6"]]},{"id":"260e4be19268b1a6","type":"junction","z":"83c5e1824f32abec","x":2163.1428351402283,"y":818,"wires":[["2be5de12297e37e8","f05dfd8751fd199d"]]},{"id":"42854c33d24cc147","type":"change","z":"83c5e1824f32abec","g":"a2a7e74a4af61408","name":"","rules":[{"p":"payload","pt":"msg","t":"set","to":"","tot":"date"},{"p":"msgcnt","pt":"msg","t":"set","to":"$$.msgcnt + 1","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":465.3333740234375,"y":950.70751953125,"wires":[["d5267b01ad627817","783c38c513ee2063","2034061e36a4f15f"]]},{"id":"d5267b01ad627817","type":"delay","z":"83c5e1824f32abec","g":"a2a7e74a4af61408","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":694.3334045410156,"y":1025.08251953125,"wires":[["3d86e58d1499701d"]]},{"id":"783c38c513ee2063","type":"debug","z":"83c5e1824f32abec","g":"a2a7e74a4af61408","name":"debug 6","active":true,"tosidebar":false,"console":false,"tostatus":true,"complete":"payload","targetType":"msg","statusVal":"","statusType":"counter","x":742.3333740234375,"y":847,"wires":[]},{"id":"3d86e58d1499701d","type":"switch","z":"83c5e1824f32abec","g":"a2a7e74a4af61408","name":"stop after 2000 messages","property":"msgcnt","propertyType":"msg","rules":[{"t":"lt","v":"2023","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":239,"y":1028.08251953125,"wires":[["42854c33d24cc147"]]},{"id":"1af8ba70d5a3524f","type":"erlsupervisor","z":"83c5e1824f32abec","g":"10ad535c44495df5","name":"root supervisor","scope":["393f1b779c6091f6","fa5012a137b001d9"],"supervisor_type":"static","strategy":"one_for_one","auto_shutdown":"never","intensity":"1000","period":"1","child_type":"worker","child_restart":"permanent","child_shutdown":"infinite","child_shutdown_timeout":"0","x":1818,"y":510,"wires":[[]]},{"id":"393f1b779c6091f6","type":"erlsupervisor","z":"83c5e1824f32abec","g":"10ad535c44495df5","name":"right branch","scope":["2be5de12297e37e8","f05dfd8751fd199d","579f89501d19b608"],"supervisor_type":"static","strategy":"one_for_one","auto_shutdown":"never","intensity":"233","period":"30","child_type":"worker","child_restart":"permanent","child_shutdown":"infinite","child_shutdown_timeout":"5","x":2354,"y":668,"wires":[["2aa4cbe548169d6a"]]},{"id":"2be5de12297e37e8","type":"function","z":"83c5e1824f32abec","g":"61bf066466ccf6c9","name":"exit","func":"exit(self(), failure)","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2389,"y":764,"wires":[[]]},{"id":"b2079d01bc6083b3","type":"function","z":"83c5e1824f32abec","g":"198c5ec84a4303d3","name":"exit","func":"exit(self(), failure)","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2587,"y":1085,"wires":[[]]},{"id":"f05dfd8751fd199d","type":"debug","z":"83c5e1824f32abec","g":"61bf066466ccf6c9","name":"msg counter right branch","active":true,"tosidebar":false,"console":false,"tostatus":true,"complete":"payload","targetType":"msg","statusVal":"","statusType":"counter","x":2486,"y":818,"wires":[]},{"id":"0fbbd20588aed361","type":"debug","z":"83c5e1824f32abec","g":"198c5ec84a4303d3","name":"msg counter right leaf bottom","active":true,"tosidebar":false,"console":false,"tostatus":true,"complete":"payload","targetType":"msg","statusVal":"","statusType":"counter","x":2727,"y":1154,"wires":[]},{"id":"579f89501d19b608","type":"erlsupervisor","z":"83c5e1824f32abec","g":"61bf066466ccf6c9","name":"leaf right","scope":["da885704f8719ad6","b2079d01bc6083b3","0fbbd20588aed361"],"supervisor_type":"static","strategy":"rest_for_one","auto_shutdown":"never","intensity":"133","period":"10","child_type":"worker","child_restart":"permanent","child_shutdown":"brutal_kill","child_shutdown_timeout":"5","x":2611,"y":868,"wires":[[]]},{"id":"da885704f8719ad6","type":"debug","z":"83c5e1824f32abec","g":"198c5ec84a4303d3","name":"msg counter right leaf top","active":true,"tosidebar":false,"console":false,"tostatus":true,"complete":"payload","targetType":"msg","statusVal":"","statusType":"counter","x":2695,"y":1008,"wires":[]},{"id":"4f3ae8c1ef6c1cd7","type":"function","z":"83c5e1824f32abec","g":"876cb4e6a0e13e60","name":"pass Msg through","func":"Msg","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1289,"y":1155.5,"wires":[["9b4dec78a245edbd","77db69c180d41d6f","871aea169f73c835","aa2e265727623712"]]},{"id":"c9d06322583751b1","type":"debug","z":"83c5e1824f32abec","g":"876cb4e6a0e13e60","name":"msg count left branch","active":true,"tosidebar":false,"console":false,"tostatus":true,"complete":"payload","targetType":"msg","statusVal":"","statusType":"counter","x":1347,"y":856,"wires":[]},{"id":"96ae99eb5ff0f75e","type":"erlsupervisor","z":"83c5e1824f32abec","g":"876cb4e6a0e13e60","name":"leaf left","scope":["9b4dec78a245edbd","77db69c180d41d6f","871aea169f73c835"],"supervisor_type":"static","strategy":"one_for_all","auto_shutdown":"never","intensity":"127","period":"10","child_type":"worker","child_restart":"permanent","child_shutdown":"brutal_kill","child_shutdown_timeout":"5","x":1376,"y":1068,"wires":[[]]},{"id":"77db69c180d41d6f","type":"function","z":"83c5e1824f32abec","g":"7a32d11ddf48f390","name":"exit","func":"exit(self(), failure)","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1672,"y":1155.5,"wires":[[]]},{"id":"9b4dec78a245edbd","type":"debug","z":"83c5e1824f32abec","g":"7a32d11ddf48f390","name":"msg count left left top","active":true,"tosidebar":false,"console":false,"tostatus":true,"complete":"payload","targetType":"msg","statusVal":"","statusType":"counter","x":1769,"y":1233,"wires":[]},{"id":"871aea169f73c835","type":"debug","z":"83c5e1824f32abec","g":"7a32d11ddf48f390","name":"msg count left left bottom","active":true,"tosidebar":false,"console":false,"tostatus":true,"complete":"payload","targetType":"msg","statusVal":"","statusType":"counter","x":1780,"y":1074,"wires":[]},{"id":"fa5012a137b001d9","type":"erlsupervisor","z":"83c5e1824f32abec","g":"10ad535c44495df5","name":"left branch","scope":["4f3ae8c1ef6c1cd7","96ae99eb5ff0f75e","c9d06322583751b1"],"supervisor_type":"static","strategy":"rest_for_one","auto_shutdown":"never","intensity":"233","period":"30","child_type":"worker","child_restart":"permanent","child_shutdown":"infinite","child_shutdown_timeout":"5","x":1393,"y":659,"wires":[[]]},{"id":"33e9669d5da36116","type":"inject","z":"83c5e1824f32abec","g":"a2a7e74a4af61408","name":"Start Button","props":[{"p":"payload"},{"p":"msgcnt","v":"0","vt":"num"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":262,"y":856,"wires":[["42854c33d24cc147"]]},{"id":"aa2e265727623712","type":"join","z":"83c5e1824f32abec","name":"","mode":"custom","build":"array","property":"","propertyType":"full","key":"topic","joiner":"\\n","joinerType":"str","useparts":false,"accumulate":false,"timeout":"","count":"1995","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"","reduceFixup":"","x":1584,"y":1346,"wires":[["b5340bbb2ab54e07"]]},{"id":"b5340bbb2ab54e07","type":"ut-assert-success","z":"83c5e1824f32abec","name":"","x":1782,"y":1345.5,"wires":[]},{"id":"2aa4cbe548169d6a","type":"join","z":"83c5e1824f32abec","name":"","mode":"custom","build":"array","property":"","propertyType":"full","key":"topic","joiner":"\\n","joinerType":"str","useparts":false,"accumulate":false,"timeout":"","count":"16","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"","reduceFixup":"","x":2610,"y":613,"wires":[["39bd5634461fab43"]]},{"id":"39bd5634461fab43","type":"ut-assert-success","z":"83c5e1824f32abec","name":"","x":2845,"y":612.5,"wires":[]}]