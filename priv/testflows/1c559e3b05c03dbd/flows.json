[{"id":"1c559e3b05c03dbd","type":"tab","label":"[eventhandler] used with a supervisor node","disabled":false,"info":"## Event handlers and supervisors\n\nEvent handlers nodes also support being supervised.\n\nIt's difficult to kill an event handler process. The module that is represents one handler can be killed but the event handler process (parent process) is not affected.\n\nAn event handler has a parent process and many child processes, probably one per handler. So when a child process dies, the parent process continues.\n\nThe event handler node process monitors that parent process so that when it is supervised by a supervisor, it does not go down because the parent process of the actual event handler does not go down.\n\n## Process Tree\n\nTo make this clear:\n\n```mermaid\n%% Generated by the Flow2UML Node @ https://flowhub.org/flow2uml\n%% change direction to LR for Node-RED left-to-right UML\nflowchart TB\n089557e075e89df5@{ shape: \"rect\", label: \"Event Handler Parent Process\" } -- \"Handler PID\" --> 8d8f80fbcdad0734@{ shape: \"rect\", label: \"event handler module\" }\n089557e075e89df5@{ shape: \"rect\", label: \"Event Handler Parent Process\" } -- \"Handler PID\" --> ab05ac8e6df89e27@{ shape: \"rect\", label: \"event handler module\" }\n089557e075e89df5@{ shape: \"rect\", label: \"Event Handler Parent Process\" } -- \"Handler PID\" --> 23a078dea3c59e5b@{ shape: \"rect\", label: \"event handler module\" }\n089557e075e89df5@{ shape: \"rect\", label: \"Event Handler Parent Process\" } -- \"Handler PID\" --> 2cca665c497a8fe9@{ shape: \"rect\", label: \"event handler module\" }\n65e338689e3ae5c4@{ shape: \"rect\", label: \"Event Handler Node Process\" } -- \"Monitored PID\" --> 089557e075e89df5@{ shape: \"rect\", label: \"Event Handler Parent Process\" }\n23cc281dc7e42e86@{ shape: \"rect\", label: \"Supervisor\" } -- \"Supervised PID\" --> 65e338689e3ae5c4@{ shape: \"rect\", label: \"Event Handler Node Process\" }\n01ca56ff734b349d@{ shape: \"rect\", label: \"Supervisor node process\" } -- \"monitored PID\" --> 23cc281dc7e42e86@{ shape: \"rect\", label: \"Supervisor\" }\nsubgraph \"gen_event\"\n089557e075e89df5\n2cca665c497a8fe9\n23a078dea3c59e5b\nab05ac8e6df89e27\n8d8f80fbcdad0734\nend\nsubgraph \"ered_node_erleventhandler.erl\"\n65e338689e3ae5c4\nend\nsubgraph \"ered_node_erlsupervisor.erl\"\n23cc281dc7e42e86\n01ca56ff734b349d\nend\n```\n\nWhat this test does is actually kill the \"Event Handler Parent Process\" using the `_eventh_pid` value set on the <a class=\"ahl-node-only\" data-ids=\"0dd12e98953c345a\">Event Handler node definition</a>.\n\nThis killing is done after the fifth event. What then happens is that the supervisor restarts that event handler node, which restarts the gen_event event handler which then restarts the process for the handler that then kills the gen_event parent process after a further five events.\n\nThe supervisor node has a limit of three over ten seconds, so that this circus is repeated four times.\n","env":[{"name":"ERED_NOT_EUNIT","value":"true","type":"bool"}]},{"id":"69d8094170453de4","type":"group","z":"1c559e3b05c03dbd","name":"generate a_single_event events","style":{"label":true},"nodes":["353d5cdbfd22e958","9fb3cadc5ff7ad22","ecb0496b56927464"],"x":66.6666259765625,"y":669,"w":630.3334045410156,"h":160.70833110809326},{"id":"f95978d76d7d648c","type":"group","z":"1c559e3b05c03dbd","style":{"color":"#a4a4a4","fill":"none","fill-opacity":"1","label":true,"label-position":"nw","stroke":"#999999","stroke-opacity":"1"},"nodes":["0dd12e98953c345a","aa3067b7b43eafc8"],"x":817.4285888671875,"y":516.71435546875,"w":212,"h":202.99993896484375},{"id":"0dd12e98953c345a","type":"erleventhandler","z":"1c559e3b05c03dbd","g":"f95978d76d7d648c","name":"","handlers":[{"nodeid":"02b3e37c9b0dae94","moduleterm":""}],"x":923.4285888671875,"y":678.7142944335938,"wires":[["1d2f0c8fbd1fec60","310966faf917a076","cf5caf7d78f71fb0"]]},{"id":"aa3067b7b43eafc8","type":"erlsupervisor","z":"1c559e3b05c03dbd","g":"f95978d76d7d648c","name":"","scope":["0dd12e98953c345a"],"supervisor_type":"static","strategy":"one_for_one","auto_shutdown":"never","intensity":"3","period":"10","child_type":"worker","child_restart":"permanent","child_shutdown":"infinite","child_shutdown_timeout":"0","x":921.4285888671875,"y":557.71435546875,"wires":[[]]},{"id":"02b3e37c9b0dae94","type":"erlmodule","z":"1c559e3b05c03dbd","name":"","module_name":"kill_event_handler_parent_after_five_events","code":"-module(kill_event_handler_parent_after_five_events).\n\n-behaviour(gen_event).\n\n-export([\n    init/1,\n    handle_event/2,\n    handle_call/2,\n    handle_info/2,\n    terminate/2,\n    code_change/3\n]).\n\n-import(ered_nodes, [\n    send_msg_to_connected_nodes/2\n]).\n\ninit(Args) ->\n    {ok, #{count => 1}}.\n\nhandle_event({<<\"a_single_event\">>, Msg, #{ '_eventh_pid' := HndlrParentPid} =EventHandlerNodeDef}, #{ count := Count } = State) when Count > 5 ->\n    exit(HndlrParentPid, kill),\n    {ok, State#{ count => Count + 1 }};\n\nhandle_event({<<\"a_single_event\">>, Msg, EventHandlerNodeDef}, #{ count := Count } = State) ->\n    Msg2 = Msg#{ \n        <<\"handled\">> => <<\"a_single_event\">>, \n        <<\"count\">> => Count,\n        <<\"handler\">> => ?MODULE\n    },    \n    send_msg_to_connected_nodes(EventHandlerNodeDef, Msg2),\n    {ok, State#{ count => Count + 1 }};\n\nhandle_event(_Event, State) ->\n    {ok, State}.\n\nhandle_call(_Request, State) ->\n    {ok, ok, State}.\n\nhandle_info(_Info, State) ->\n    {ok, State}.\n\nterminate(Args, _State) ->\n    Args.\n\ncode_change(_OldVsn, State, _Extra) ->\n    {ok, State}.\n","x":931.0000610351562,"y":472.71435546875,"wires":[]},{"id":"353d5cdbfd22e958","type":"change","z":"1c559e3b05c03dbd","g":"69d8094170453de4","name":"","rules":[{"p":"event","pt":"msg","t":"set","to":"a_single_event","tot":"str"},{"p":"msgcnt","pt":"msg","t":"set","to":"$$.msgcnt + 1","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":429,"y":710,"wires":[["9fb3cadc5ff7ad22"]]},{"id":"9fb3cadc5ff7ad22","type":"delay","z":"1c559e3b05c03dbd","g":"69d8094170453de4","name":"","pauseType":"random","timeout":"1","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"milliseconds","drop":false,"allowrate":false,"outputs":1,"x":611.0000305175781,"y":785.7083311080933,"wires":[["ecb0496b56927464","0dd12e98953c345a","f519739b3ceb89a9"]]},{"id":"ecb0496b56927464","type":"switch","z":"1c559e3b05c03dbd","g":"69d8094170453de4","name":"stop after 200 messages","property":"msgcnt","propertyType":"msg","rules":[{"t":"lt","v":"200","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":202.6666259765625,"y":788.7083311080933,"wires":[["353d5cdbfd22e958"]]},{"id":"f58e1ef6b7d43951","type":"inject","z":"1c559e3b05c03dbd","name":"","props":[{"p":"msgcnt","v":"0","vt":"num"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","x":146,"y":323.71435546875,"wires":[["353d5cdbfd22e958"]]},{"id":"f519739b3ceb89a9","type":"join","z":"1c559e3b05c03dbd","name":"","mode":"custom","build":"array","property":"","propertyType":"full","key":"topic","joiner":"\\n","joinerType":"str","useparts":false,"accumulate":false,"timeout":"","count":"200","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"","reduceFixup":"","x":841,"y":878.25,"wires":[["02f8c5ee31eb1033"]]},{"id":"02f8c5ee31eb1033","type":"ut-assert-success","z":"1c559e3b05c03dbd","name":"","x":1020,"y":878.25,"wires":[]},{"id":"1d2f0c8fbd1fec60","type":"join","z":"1c559e3b05c03dbd","name":"","mode":"custom","build":"array","property":"","propertyType":"full","key":"topic","joiner":"\\n","joinerType":"str","useparts":false,"accumulate":false,"timeout":"","count":"20","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"","reduceFixup":"","x":1211.5,"y":677,"wires":[["b6e7fc02ad89f8be"]]},{"id":"b6e7fc02ad89f8be","type":"ut-assert-success","z":"1c559e3b05c03dbd","name":"","x":1397,"y":677,"wires":[]},{"id":"310966faf917a076","type":"join","z":"1c559e3b05c03dbd","name":"","mode":"custom","build":"array","property":"","propertyType":"full","key":"topic","joiner":"\\n","joinerType":"str","useparts":false,"accumulate":false,"timeout":"","count":"21","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"","reduceFixup":"","x":1210.5,"y":607.25,"wires":[["a233acbd04883b2f"]]},{"id":"a233acbd04883b2f","type":"ut-assert-failure","z":"1c559e3b05c03dbd","name":"","x":1397,"y":607.25,"wires":[]},{"id":"cf5caf7d78f71fb0","type":"switch","z":"1c559e3b05c03dbd","name":"","property":"count","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"eq","v":"2","vt":"num"},{"t":"eq","v":"3","vt":"num"},{"t":"eq","v":"4","vt":"num"},{"t":"eq","v":"5","vt":"num"}],"checkall":"true","repair":false,"outputs":5,"x":1169.5,"y":786,"wires":[["4746021db55c3912"],["a7e622aae40bddda"],["cae5d7fa89d433cb"],["3d0b40f6555433c8"],["575c8ab3c9d76f24"]]},{"id":"4746021db55c3912","type":"join","z":"1c559e3b05c03dbd","name":"","mode":"custom","build":"array","property":"","propertyType":"full","key":"topic","joiner":"\\n","joinerType":"str","useparts":false,"accumulate":false,"timeout":"","count":"4","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"","reduceFixup":"","x":1368.5,"y":759.5,"wires":[["a9662a0228b4fcb6"]]},{"id":"a9662a0228b4fcb6","type":"ut-assert-success","z":"1c559e3b05c03dbd","name":"","x":1574,"y":759.5,"wires":[]},{"id":"a7e622aae40bddda","type":"join","z":"1c559e3b05c03dbd","name":"","mode":"custom","build":"array","property":"","propertyType":"full","key":"topic","joiner":"\\n","joinerType":"str","useparts":false,"accumulate":false,"timeout":"","count":"4","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"","reduceFixup":"","x":1368.5,"y":819.125,"wires":[["3dabcf6ddfed2462"]]},{"id":"3dabcf6ddfed2462","type":"ut-assert-success","z":"1c559e3b05c03dbd","name":"","x":1574,"y":819.125,"wires":[]},{"id":"cae5d7fa89d433cb","type":"join","z":"1c559e3b05c03dbd","name":"","mode":"custom","build":"array","property":"","propertyType":"full","key":"topic","joiner":"\\n","joinerType":"str","useparts":false,"accumulate":false,"timeout":"","count":"4","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"","reduceFixup":"","x":1368.5,"y":878.75,"wires":[["3051f73039b6d7db"]]},{"id":"3051f73039b6d7db","type":"ut-assert-success","z":"1c559e3b05c03dbd","name":"","x":1574,"y":878.75,"wires":[]},{"id":"3d0b40f6555433c8","type":"join","z":"1c559e3b05c03dbd","name":"","mode":"custom","build":"array","property":"","propertyType":"full","key":"topic","joiner":"\\n","joinerType":"str","useparts":false,"accumulate":false,"timeout":"","count":"4","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"","reduceFixup":"","x":1368.5,"y":938.375,"wires":[["f30373995256e869"]]},{"id":"f30373995256e869","type":"ut-assert-success","z":"1c559e3b05c03dbd","name":"","x":1574,"y":938.375,"wires":[]},{"id":"575c8ab3c9d76f24","type":"join","z":"1c559e3b05c03dbd","name":"","mode":"custom","build":"array","property":"","propertyType":"full","key":"topic","joiner":"\\n","joinerType":"str","useparts":false,"accumulate":false,"timeout":"","count":"4","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"","reduceFixup":"","x":1368.5,"y":998,"wires":[["9365d795b8f90d4b"]]},{"id":"9365d795b8f90d4b","type":"ut-assert-success","z":"1c559e3b05c03dbd","name":"","x":1574,"y":998,"wires":[]}]