[{"id":"dc897f402c53697f","type":"tab","label":"[.breadboard] MQTT broker as flow","disabled":false,"info":"## MQTT from the ground up\n\nThis work is based on work by [@cymplecy](https://discourse.nodered.org/u/cymplecy/summary) and can be found over at the [Node-RED forum](https://discourse.nodered.org/t/fun-exercise-make-an-mqtt-broker-in-node-red/82229).\n\nThe initial commit of this flow is the original flow as found at [google cloud](https://drive.google.com/file/d/1uY-IV8KPYE5W3uL-oc9ozRvwdBHtzpcG/view?usp=sharing).\n\n## Step 1 - Convert Blockly nodes to Function nodes\n\nErlang-Red does not and probably never will support [Blockly](https://flows.nodered.org/node/node-red-contrib-blockly) since it generates Javascript code.\n\nBut since it does display the JS code, I took the code made function nodes out of the code.\n\nThis allows me to import the flow into Erlang-Red where I have to convert everything to Erlang.\n\n","env":[{"name":"ERED_PENDING","value":"true","type":"bool"}]},{"id":"ded413082f65543c","type":"group","z":"dc897f402c53697f","name":"Send to client","style":{"label":true},"nodes":["af9f5d0d7cea3ddd","7d8a1c95eebd10b5","86d40617a04bb66d","cde7df7a94f9c8a2"],"x":1645,"y":383,"w":322,"h":142},{"id":"80c12efc3d845fa3","type":"junction","z":"dc897f402c53697f","x":1187,"y":405,"wires":[["03e661a4f7ee610f"]]},{"id":"03e661a4f7ee610f","type":"junction","z":"dc897f402c53697f","x":1227,"y":365,"wires":[["d354d045491e70f7"]]},{"id":"31506b5de764bcf7","type":"junction","z":"dc897f402c53697f","x":680.1895083189011,"y":446.0233108997345,"wires":[["5f3ddf0b4c97e847"]]},{"id":"2f7ce9613861e288","type":"junction","z":"dc897f402c53697f","x":694.0611860752106,"y":417.1428532600403,"wires":[["26d3a84f0b5c547e"]]},{"id":"497bc47bdb7eaa8e","type":"junction","z":"dc897f402c53697f","x":661.7579638957977,"y":473.60934829711914,"wires":[["0c8ae20f5bca7f97"]]},{"id":"436fe3764090873b","type":"junction","z":"dc897f402c53697f","x":634.5509853363037,"y":499.1428475379944,"wires":[["46100fb0a08b0c5c"]]},{"id":"77b3e857bdd8c765","type":"junction","z":"dc897f402c53697f","x":1227,"y":685,"wires":[["e396e5ee280efc86","4012ad0d8a2cfb0c"]]},{"id":"8fd3cccdbffacd09","type":"junction","z":"dc897f402c53697f","x":367,"y":585,"wires":[["4d0ffeae2a76b8b0","b25834b00dc17621"]]},{"id":"cde7df7a94f9c8a2","type":"junction","z":"dc897f402c53697f","g":"ded413082f65543c","x":1761,"y":484,"wires":[["7d8a1c95eebd10b5","af9f5d0d7cea3ddd"]]},{"id":"27dff75b654d8823","type":"junction","z":"dc897f402c53697f","x":679.0204229354858,"y":354.4489758014679,"wires":[["1e8e2648ed67d5c6"]]},{"id":"a2a2dbd44189a0d9","type":"junction","z":"dc897f402c53697f","x":691.857127904892,"y":385.8571262359619,"wires":[["618215b887917904"]]},{"id":"98c9651dbea8582c","type":"debug","z":"dc897f402c53697f","name":"Incoming","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"true","targetType":"full","statusVal":"payload","statusType":"msg","x":267,"y":445,"wires":[]},{"id":"38440ad2e824817e","type":"tcp in","z":"dc897f402c53697f","name":"","server":"server","host":"","port":"2883","datamode":"stream","datatype":"buffer","newline":"","topic":"","trim":false,"base64":false,"tls":"","x":205,"y":359,"wires":[["98c9651dbea8582c","3addc59737a0ed8a"]]},{"id":"8b955da886c2db79","type":"inject","z":"dc897f402c53697f","name":"Publish  top=Test","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"Test","payload":"From client on broker machine","payloadType":"str","x":181,"y":983,"wires":[["8a7d115c75d00cb2"]]},{"id":"8a7d115c75d00cb2","type":"mqtt out","z":"dc897f402c53697f","name":"MQTT Out","topic":"","qos":"","retain":"","respTopic":"","contentType":"","userProps":"","correl":"","expiry":"","broker":"da2f91c287ad12f7","x":403,"y":1061,"wires":[]},{"id":"e4321e5c01b16c27","type":"change","z":"dc897f402c53697f","name":"set CONNACK","rules":[{"t":"set","p":"payload","pt":"msg","to":"[\"0b00100000\",2,0,0]","tot":"bin"}],"action":"","property":"","from":"","to":"","reg":false,"x":1047,"y":365,"wires":[["03e661a4f7ee610f","539c9d2c592d393b","a2cbd9fb813505fa"]]},{"id":"3addc59737a0ed8a","type":"switch","z":"dc897f402c53697f","name":"Test packet type","property":"payload.0","propertyType":"msg","rules":[{"t":"eq","v":"16","vt":"num"},{"t":"eq","v":"0xC0","vt":"num"},{"t":"gte","v":"0b00110000","vt":"num"},{"t":"eq","v":"0x82","vt":"num"},{"t":"eq","v":"0b10100010","vt":"num"},{"t":"eq","v":"0b11100000","vt":"num"},{"t":"else"}],"checkall":"true","repair":false,"outputs":7,"x":487,"y":425,"wires":[["27dff75b654d8823"],["a2a2dbd44189a0d9"],["2f7ce9613861e288"],["31506b5de764bcf7"],["497bc47bdb7eaa8e"],["436fe3764090873b"],["5c5cf4cf97698822"]]},{"id":"1e8e2648ed67d5c6","type":"change","z":"dc897f402c53697f","name":"CONNECT","rules":[{"t":"set","p":"mqttPacket.type","pt":"msg","to":"CONNECT","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":817,"y":351,"wires":[["e4321e5c01b16c27","03561c2e4510609a"]]},{"id":"5c5cf4cf97698822","type":"debug","z":"dc897f402c53697f","name":"Unexpected","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":497,"y":505,"wires":[]},{"id":"618215b887917904","type":"change","z":"dc897f402c53697f","name":"PINGREQ","rules":[{"t":"set","p":"mqttPacket.type","pt":"msg","to":"PINGREQ","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":817,"y":405,"wires":[["c078fde4eaa67651","59d1f5eaff7bc315"]]},{"id":"c078fde4eaa67651","type":"change","z":"dc897f402c53697f","name":"Set PINGACK","rules":[{"t":"set","p":"payload","pt":"msg","to":"[208,0]","tot":"bin"}],"action":"","property":"","from":"","to":"","reg":false,"x":1047,"y":405,"wires":[["80c12efc3d845fa3","07e8b93b1a84af24"]]},{"id":"d354d045491e70f7","type":"link out","z":"dc897f402c53697f","name":"link out 3","mode":"link","links":["86d40617a04bb66d"],"x":1292,"y":365,"wires":[]},{"id":"03561c2e4510609a","type":"debug","z":"dc897f402c53697f","name":"debug 352","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"\"CONNECT rcvd\"","targetType":"jsonata","statusVal":"","statusType":"auto","x":922,"y":345,"wires":[],"l":false},{"id":"539c9d2c592d393b","type":"debug","z":"dc897f402c53697f","name":"debug 353","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"\"CONNACK sent\"","targetType":"jsonata","statusVal":"","statusType":"auto","x":1198,"y":278,"wires":[],"l":false},{"id":"59d1f5eaff7bc315","type":"debug","z":"dc897f402c53697f","name":"debug 354","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"\"PINGREQ rcvd\"","targetType":"jsonata","statusVal":"","statusType":"auto","x":922,"y":425,"wires":[],"l":false},{"id":"07e8b93b1a84af24","type":"debug","z":"dc897f402c53697f","name":"debug 355","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"\"PINGRESP sent\"","targetType":"jsonata","statusVal":"","statusType":"auto","x":1228,"y":445,"wires":[],"l":false},{"id":"b8a6812cb8f0e9c5","type":"change","z":"dc897f402c53697f","name":"PUBLISH","rules":[{"t":"set","p":"mqttPacket.type","pt":"msg","to":"PUBLISH","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":807,"y":505,"wires":[["88419b83727f1149","8f829e2401b0dad4"]]},{"id":"88419b83727f1149","type":"debug","z":"dc897f402c53697f","name":"debug 356","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"\"PUBLISH rcvd\"","targetType":"jsonata","statusVal":"","statusType":"auto","x":882,"y":545,"wires":[],"l":false},{"id":"26d3a84f0b5c547e","type":"switch","z":"dc897f402c53697f","name":"Only QoS0","property":"payload.0","propertyType":"msg","rules":[{"t":"lte","v":"0b00111111","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":817,"y":465,"wires":[["b8a6812cb8f0e9c5"]]},{"id":"4d0ffeae2a76b8b0","type":"mqtt in","z":"dc897f402c53697f","name":"MQTT In","topic":"","qos":"2","datatype":"auto-detect","broker":"da2f91c287ad12f7","nl":false,"rap":true,"rh":0,"inputs":1,"x":467,"y":585,"wires":[["9048a940e9c269d8","eb63f1261f783d43"]]},{"id":"c4ab9a480d2b5300","type":"inject","z":"dc897f402c53697f","name":"Subscribe to Test","props":[{"p":"action","v":"subscribe","vt":"str"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"Test","x":247,"y":565,"wires":[["8fd3cccdbffacd09"]]},{"id":"eb63f1261f783d43","type":"debug","z":"dc897f402c53697f","name":"Subscribtions","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":507,"y":645,"wires":[]},{"id":"5f3ddf0b4c97e847","type":"change","z":"dc897f402c53697f","name":"SUBSCRIBE","rules":[{"t":"set","p":"mqttPacket.type","pt":"msg","to":"SUBSCRIBE","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":817,"y":605,"wires":[["2e29be5597431a04","608ceda81a1e32f5"]]},{"id":"2e29be5597431a04","type":"debug","z":"dc897f402c53697f","name":"debug 359","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"\"SUBSCRIBE rcvd\"","targetType":"jsonata","statusVal":"","statusType":"auto","x":922,"y":645,"wires":[],"l":false},{"id":"f8bb574706073725","type":"inject","z":"dc897f402c53697f","name":"Unsuscribe","props":[{"p":"action","v":"unsubscribe","vt":"str"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"Test","x":227,"y":605,"wires":[["8fd3cccdbffacd09"]]},{"id":"c548723aabcb824d","type":"inject","z":"dc897f402c53697f","name":"Connect","props":[{"p":"action","v":"connect","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","x":267,"y":525,"wires":[["8fd3cccdbffacd09"]]},{"id":"f8e2d913c7a2e082","type":"inject","z":"dc897f402c53697f","name":"Disconnect","props":[{"p":"action","v":"disconnect","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","x":247,"y":645,"wires":[["8fd3cccdbffacd09"]]},{"id":"462f8d53f850d053","type":"delay","z":"dc897f402c53697f","name":"","pauseType":"delay","timeout":"2","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":1317,"y":490,"wires":[["d06e1719fc770910","d4d4146f6450bcaa"]]},{"id":"d06e1719fc770910","type":"link out","z":"dc897f402c53697f","name":"link out 6","mode":"link","links":["86d40617a04bb66d"],"x":1462,"y":490,"wires":[]},{"id":"da3f84ead8ae89dc","type":"debug","z":"dc897f402c53697f","name":"debug 363","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"\"SUBACK sent\"","targetType":"jsonata","statusVal":"","statusType":"auto","x":1385,"y":620,"wires":[],"l":false},{"id":"2343c09d75092ba6","type":"link out","z":"dc897f402c53697f","name":"link out 7","mode":"link","links":["86d40617a04bb66d"],"x":1385,"y":580,"wires":[]},{"id":"46100fb0a08b0c5c","type":"change","z":"dc897f402c53697f","name":"DISCONNECT","rules":[{"t":"set","p":"mqttPacket.type","pt":"msg","to":"DISCONNECT","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":827,"y":765,"wires":[["73a8064f83d4db2a","6cc6c5f5acc0e55a"]]},{"id":"73a8064f83d4db2a","type":"debug","z":"dc897f402c53697f","name":"debug 364","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"\"DISCONNECT rcvd\"","targetType":"jsonata","statusVal":"","statusType":"auto","x":1023,"y":765,"wires":[],"l":false},{"id":"0c8ae20f5bca7f97","type":"change","z":"dc897f402c53697f","name":"UNSUBSCRIBE","rules":[{"t":"set","p":"mqttPacket.type","pt":"msg","to":"UNSUBSCRIBE","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":827,"y":685,"wires":[["81ad923686dfe8d9","19b6c227507e6e6b"]]},{"id":"81ad923686dfe8d9","type":"debug","z":"dc897f402c53697f","name":"debug 365","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"\"UNSUBSCRIBE rcvd\"","targetType":"jsonata","statusVal":"","statusType":"auto","x":922,"y":725,"wires":[],"l":false},{"id":"e396e5ee280efc86","type":"link out","z":"dc897f402c53697f","name":"link out 8","mode":"link","links":["86d40617a04bb66d"],"x":1282,"y":645,"wires":[]},{"id":"4012ad0d8a2cfb0c","type":"debug","z":"dc897f402c53697f","name":"debug 366","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"\"UNSUBACK sent\"","targetType":"jsonata","statusVal":"","statusType":"auto","x":1282,"y":685,"wires":[],"l":false},{"id":"2c2cfd6294b019e2","type":"debug","z":"dc897f402c53697f","name":"debug 370","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"\"SUBSCRIBER in database\"","targetType":"jsonata","statusVal":"","statusType":"auto","x":1292,"y":530,"wires":[],"l":false},{"id":"d4d4146f6450bcaa","type":"debug","z":"dc897f402c53697f","name":"debug 371","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"\"Message sent to subscriber\"","targetType":"jsonata","statusVal":"","statusType":"auto","x":1452,"y":530,"wires":[],"l":false},{"id":"9048a940e9c269d8","type":"debug","z":"dc897f402c53697f","name":"debug 372","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"\"Subscribed msg rcvd\"","targetType":"jsonata","statusVal":"","statusType":"auto","x":572,"y":585,"wires":[],"l":false},{"id":"a2cbd9fb813505fa","type":"change","z":"dc897f402c53697f","name":"create f.homemadeSub","rules":[{"t":"set","p":"homemadeSub","pt":"flow","to":"$exists($flowContext(\"homemadeSub\")) ?  $flowContext(\"homemadeSub\") : []","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":1414,"y":287,"wires":[[]]},{"id":"49784831a30cafba","type":"inject","z":"dc897f402c53697f","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":174,"y":781,"wires":[["41d34474670f52e7"]]},{"id":"e8aa1ac2a31edcd5","type":"debug","z":"dc897f402c53697f","name":"debug 374","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":604,"y":757,"wires":[]},{"id":"b25834b00dc17621","type":"delay","z":"dc897f402c53697f","name":"","pauseType":"delay","timeout":"2","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":411,"y":728,"wires":[["41d34474670f52e7"]]},{"id":"94fd08bb1f03e37f","type":"inject","z":"dc897f402c53697f","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":224,"y":912,"wires":[["0cfa542a374ed6be"]]},{"id":"0cfa542a374ed6be","type":"change","z":"dc897f402c53697f","name":"","rules":[{"t":"delete","p":"homemadeSub","pt":"flow"}],"action":"","property":"","from":"","to":"","reg":false,"x":465,"y":932,"wires":[["41d34474670f52e7"]]},{"id":"af9f5d0d7cea3ddd","type":"tcp out","z":"dc897f402c53697f","g":"ded413082f65543c","name":"","host":"","port":"","beserver":"reply","base64":false,"end":false,"tls":"","x":1871,"y":484,"wires":[]},{"id":"7d8a1c95eebd10b5","type":"debug","z":"dc897f402c53697f","g":"ded413082f65543c","name":"Sent","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"true","targetType":"full","statusVal":"payload","statusType":"msg","x":1871,"y":424,"wires":[]},{"id":"86d40617a04bb66d","type":"link in","z":"dc897f402c53697f","g":"ded413082f65543c","name":"TCP reply","links":["d354d045491e70f7","d06e1719fc770910","2343c09d75092ba6","e396e5ee280efc86"],"x":1686,"y":484,"wires":[["cde7df7a94f9c8a2"]]},{"id":"41d34474670f52e7","type":"function","z":"dc897f402c53697f","name":"function 42","func":"var homemadeSub;\n\n\nhomemadeSub = (flow.get('homemadeSub'));\nnode.status({fill:\"blue\", shape:\"ring\", text:homemadeSub});\nmsg['payload'] = homemadeSub;\n\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":432,"y":814,"wires":[["e8aa1ac2a31edcd5"]]},{"id":"6cc6c5f5acc0e55a","type":"function","z":"dc897f402c53697f","name":"function 43","func":"var _sessionId, homemadeSub, newHomemadeSub, i2, item, topicName;\n\n\n_sessionId = (msg['_session']['id']);\nhomemadeSub = (flow.get('homemadeSub'));\nif (homemadeSub.length > 0) {\n  newHomemadeSub = [];\n  var i2_end = homemadeSub.length;\n  var i2_inc = 1;\n  if (1 > i2_end) {\n    i2_inc = -i2_inc;\n  }\n  for (i2 = 1; i2_inc >= 0 ? i2 <= i2_end : i2 >= i2_end; i2 += i2_inc) {\n    item = homemadeSub[(i2 - 1)];\n    if (!(item[0] == _sessionId)) {\n      newHomemadeSub.push(item);\n    }\n  }\n  flow.set('homemadeSub', newHomemadeSub);\n}\n\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":947,"y":924,"wires":[[]]},{"id":"19b6c227507e6e6b","type":"function","z":"dc897f402c53697f","name":"function 44","func":"var rcvdPayload, _sessionId, MessageId, topicLength, topicName, homemadeSub, newHomemadeSub, i2, UNSUBACK, item;\n\nfunction convertValueToByte(value) {\n  if (isNaN(value)) {\n    return value.charCodeAt(0);\n  } else {\n    if (Buffer.isBuffer(value)) {\n      return value[0];\n    } else {\n      if (value === \" \") {\n        return value.charCodeAt(0);\n      } else {\n        return Math.min(Math.max(value, 0),255);\n      }\n    }\n  }\n}\n\n\nrcvdPayload = (msg['payload']);\n_sessionId = (msg['_session']['id']);\nMessageId = 256 * (rcvdPayload[3 - 1]) + (rcvdPayload[4 - 1]);\ntopicLength = 256 * (rcvdPayload[5 - 1]) + (rcvdPayload[6 - 1]);\ntopicName = rcvdPayload.slice(6, 6 + topicLength);\ntopicName = (topicName.toString(\"utf8\"));\nhomemadeSub = (flow.get('homemadeSub'));\nif (!('mqttPacket.unsubscribe' in msg)) {\n  msg['mqttPacket']['unsubscribe'] = ({});\n}\nmsg['mqttPacket']['unsubscribe']['topicName'] = topicName;\nmsg['mqttPacket']['unsubscribe']['MessageId'] = MessageId;\nif (homemadeSub.length > 0) {\n  newHomemadeSub = [];\n  var i2_end = homemadeSub.length;\n  var i2_inc = 1;\n  if (1 > i2_end) {\n    i2_inc = -i2_inc;\n  }\n  for (i2 = 1; i2_inc >= 0 ? i2 <= i2_end : i2 >= i2_end; i2 += i2_inc) {\n    item = homemadeSub[(i2 - 1)];\n    if (!(item[0] == _sessionId && item[1] == topicName)) {\n      newHomemadeSub.push(item);\n    }\n  }\n  flow.set('homemadeSub', newHomemadeSub);\n}\nnode.status({fill:\"blue\", shape:\"ring\", text:([MessageId,':',topicLength,':',topicName].join(''))});\nUNSUBACK = (Buffer.alloc(4));\nUNSUBACK[1 - 1] = (Buffer.alloc(1, 176))[0];\nUNSUBACK[2 - 1] = (Buffer.alloc(1, 2))[0];\nUNSUBACK[3 - 1] = convertValueToByte((rcvdPayload[3 - 1]));\nUNSUBACK[4 - 1] = convertValueToByte((rcvdPayload[4 - 1]));\nmsg['payload'] = UNSUBACK;\nnode.send([msg, null]);\nmsg['payload'] = rcvdPayload;\nnode.send([null, msg]);\n\nreturn msg;","outputs":2,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1059,"y":688,"wires":[["77b3e857bdd8c765"],[]]},{"id":"608ceda81a1e32f5","type":"function","z":"dc897f402c53697f","name":"function 45","func":"var rcvdPayload, _sessionId, topicName, homemadeSub, MessageId, topicLength, SUBACK;\n\nfunction convertValueToByte(value) {\n  if (isNaN(value)) {\n    return value.charCodeAt(0);\n  } else {\n    if (Buffer.isBuffer(value)) {\n      return value[0];\n    } else {\n      if (value === \" \") {\n        return value.charCodeAt(0);\n      } else {\n        return Math.min(Math.max(value, 0),255);\n      }\n    }\n  }\n}\n\n\nrcvdPayload = (msg['payload']);\n_sessionId = (msg['_session']['id']);\nhomemadeSub = (flow.get('homemadeSub'));\nMessageId = 256 * (rcvdPayload[3 - 1]) + (rcvdPayload[4 - 1]);\ntopicLength = 256 * (rcvdPayload[5 - 1]) + (rcvdPayload[6 - 1]);\ntopicName = rcvdPayload.slice(6, 6 + topicLength);\ntopicName = (topicName.toString(\"utf8\"));\nif (!('mqttPacket.subscribe' in msg)) {\n  msg['mqttPacket']['subscribe'] = ({});\n}\nmsg['mqttPacket']['subscribe']['topicName'] = topicName;\nmsg['mqttPacket']['subscribe']['MessageId'] = MessageId;\nhomemadeSub.push([_sessionId, topicName]);\nnode.status({fill:\"blue\", shape:\"ring\", text:([MessageId,':',topicLength,':',topicName].join(''))});\nSUBACK = (Buffer.alloc(5));\nSUBACK[1 - 1] = (Buffer.alloc(1, 144))[0];\nSUBACK[2 - 1] = (Buffer.alloc(1, 3))[0];\nSUBACK[3 - 1] = convertValueToByte((rcvdPayload[3 - 1]));\nSUBACK[4 - 1] = convertValueToByte((rcvdPayload[4 - 1]));\nSUBACK[5 - 1] = (Buffer.alloc(1, 0))[0];\nmsg['payload'] = SUBACK;\nnode.send([msg, null]);\nmsg['payload'] = rcvdPayload;\nnode.send([null, msg]);\n\n[_sessionId,'.',topicName].join('');\n\n","outputs":2,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1114,"y":605,"wires":[["da3f84ead8ae89dc","2343c09d75092ba6"],[]]},{"id":"8f829e2401b0dad4","type":"function","z":"dc897f402c53697f","name":"function 46","func":"var rcvdMessage, homemadeSub, remainingLen, topicLength, topicName, MessageId, payload, j;\n\n\nrcvdMessage = (msg['payload']);\nhomemadeSub = (flow.get('homemadeSub'));\nremainingLen = (rcvdMessage[2 - 1]);\ntopicLength = 256 * (rcvdMessage[3 - 1]) + (rcvdMessage[4 - 1]);\ntopicName = rcvdMessage.slice(4, 4 + topicLength);\ntopicName = (topicName.toString(\"utf8\"));\nmsg['mqttPacket']['topicName'] = topicName;\nMessageId = 256 * (rcvdMessage[(5 + topicLength) - 1]) + (rcvdMessage[(6 + topicLength) - 1]);\nmsg['mqttPacket']['messageId'] = MessageId;\npayload = rcvdMessage.slice(((5 + topicLength) - 1), rcvdMessage.length);\nnode.status({fill:\"blue\", shape:\"ring\", text:([MessageId,':',topicLength,':',payload].join(''))});\npayload = (payload.toString(\"latin1\"));\nmsg['mqttPacket']['payload'] = payload;\nfor (var j_index in homemadeSub) {\n  j = homemadeSub[j_index];\n  if (j[1] == topicName) {\n    node.status({fill:\"blue\", shape:\"ring\", text:'topic match'});\n    msg['_session']['id'] = (j[0]);\n    node.send([msg]);\n  }\n}\n\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1042,"y":489,"wires":[["462f8d53f850d053"]]},{"id":"da2f91c287ad12f7","type":"mqtt-broker","name":"Homemade","broker":"localhost","port":"2883","clientid":"","autoConnect":true,"usetls":false,"protocolVersion":"4","keepalive":"60","cleansession":true,"autoUnsubscribe":true,"birthTopic":"","birthQos":"0","birthRetain":"false","birthPayload":"","birthMsg":{},"closeTopic":"","closeQos":"0","closeRetain":"false","closePayload":"","closeMsg":{},"willTopic":"","willQos":"0","willRetain":"false","willPayload":"","willMsg":{},"userProps":"","sessionExpiry":""}]