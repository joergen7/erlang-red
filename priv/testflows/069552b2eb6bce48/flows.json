[{"id":"069552b2eb6bce48","type":"tab","label":"[tcp] Bad value on output port (3425)","disabled":false,"info":"## gen_tcp:send(...) and numbers\n\nThere is a spot in the [connector code](https://github.com/gorenje/erlang-red/blob/dba90f15888503b4606cb41ac675878d16684841/src/ered_tcp_connector.erl#L39-L50) that highlights a minor issue with `gen_tcp:send/2` and numbers.\n\nThis test uses the connector code but the problem applies equally to the [listener code](https://github.com/gorenje/erlang-red/blob/dba90f15888503b4606cb41ac675878d16684841/src/ered_tcp_listener.erl#L52-L63).\n\nThe problem arises - for me - when using numbers, a single number. In particular it seems to be negative integer values that cause the issue:\n\n```\n08:47:02.788 [error] Bad value on output port 'tcp_inet'\n```\n\n[Stackoverflow](https://stackoverflow.com/questions/38750444/bad-value-on-output-port-tcp-inet) has many suggestions:\n\n> In my phoenix api that I had deployed to heroku. In my case, I was setting response headers with an atom. Once I changed the atom to a binary everything started working fine again.\n\nBut for me it was single numbers that caused the issues, not http headers.\n\nThis flow test demonstrates this. The value -12 will generates the error and the value 12 will not - both are numbers NOT strings.\n\n## What does this test do?\n\nFirst a <a class=\"ahl-node-only\" data-ids=\"7bec330797c929e4\">server on port 3425</a> is started, waiting for connections. Then a <a class=\"ahl-node-only\" data-ids=\"cdf9310b209c1838\">tcp request</a> node connects to the server.\n\nWhen it does, it will send the messages that have been sent to it, in this case we have three messages consisting of the value 12 and -12.\n\nThe <a class=\"ahl-node-only\" data-ids=\"6d6da201565de404,46385dd6aa371f45,6b30b8d45824c2ea\">delay nodes</a> ensure that the messages are sent in the order 12, -12 and 12.\n\nThe test is triggered by the <a class=\"ahl-node-only\" data-ids=\"146eaf26868b802c\">inject node</a> which in turn triggers the three messages.\n\nThe <a class=\"ahl-node-only\" data-ids=\"f0e3314691d12a74,046d9545fe9ab505\">join nodes</a> show that only two messages go through, with the third (-12) being lost on the way. This demonstrates that the tcp connection isn't actually closed and continues to function.\n\n## Why is this an issue?\n\nRandom errors are annoying and tracking this one down took a while. However there is nothing that can really be done. Since the value is set by the payload and the payload on a message can be anything, this can happen at any time - day or night.\n\nThe context of the message would be important to know - what is the meaning of a negative integer value being sent over a tcp connection?\n\nSince there isn't a general answer to that question, there isn't much that can be done - generally.\n\nPerhaps raising a debug message in the panel would be the best thing to do at this stage.\n\nAnnoyingly the error generated isn't an exception and cannot be captured, it seems more to be a warning than an error. As pointed out, the tcp connection isn't closed.\n\n","env":[{"name":"ERED_NOT_EUNIT","value":"true","type":"bool"}]},{"id":"cdf9310b209c1838","type":"tcp in","z":"069552b2eb6bce48","name":"","server":"server","host":"","port":"3425","datamode":"stream","datatype":"utf8","newline":"","topic":"","trim":false,"base64":false,"tls":"","x":839,"y":565,"wires":[["df1995777960982d"]]},{"id":"7bec330797c929e4","type":"tcp request","z":"069552b2eb6bce48","name":"","server":"localhost","port":"3425","out":"time","ret":"string","splitc":"200000","newline":"","trim":false,"tls":"","x":839,"y":507,"wires":[[]]},{"id":"046d9545fe9ab505","type":"join","z":"069552b2eb6bce48","name":"","mode":"custom","build":"array","property":"","propertyType":"full","key":"topic","joiner":"\\n","joinerType":"str","useparts":false,"accumulate":false,"timeout":"","count":"2","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"","reduceFixup":"","x":1094,"y":631.75,"wires":[["dd3a799aef6166c9"]]},{"id":"6d6da201565de404","type":"delay","z":"069552b2eb6bce48","name":"","pauseType":"delay","timeout":"10","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":599,"y":433,"wires":[["7bec330797c929e4"]]},{"id":"46385dd6aa371f45","type":"delay","z":"069552b2eb6bce48","name":"","pauseType":"delay","timeout":"300","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":599,"y":507,"wires":[["7bec330797c929e4"]]},{"id":"6b30b8d45824c2ea","type":"delay","z":"069552b2eb6bce48","name":"","pauseType":"delay","timeout":"600","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":599,"y":590,"wires":[["7bec330797c929e4"]]},{"id":"f0e3314691d12a74","type":"join","z":"069552b2eb6bce48","name":"","mode":"custom","build":"array","property":"","propertyType":"full","key":"topic","joiner":"\\n","joinerType":"str","useparts":false,"accumulate":false,"timeout":"","count":"3","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"","reduceFixup":"","x":1098,"y":691.5,"wires":[["d6666cded7214c30"]]},{"id":"df1995777960982d","type":"switch","z":"069552b2eb6bce48","name":"only data packets","property":"_session.status","propertyType":"msg","rules":[{"t":"eq","v":"connected","vt":"str"}],"checkall":"false","repair":false,"outputs":1,"x":1077,"y":565,"wires":[["046d9545fe9ab505","f0e3314691d12a74"]]},{"id":"dd3a799aef6166c9","type":"ut-assert-success","z":"069552b2eb6bce48","name":"","x":1283,"y":631.75,"wires":[]},{"id":"d6666cded7214c30","type":"ut-assert-failure","z":"069552b2eb6bce48","name":"","x":1283,"y":691.5,"wires":[]},{"id":"508ebb98927e404f","type":"change","z":"069552b2eb6bce48","name":"payload = 12","rules":[{"p":"payload","pt":"msg","t":"set","to":"12","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":398,"y":433,"wires":[["6d6da201565de404"]]},{"id":"53749a8b6ce5c205","type":"change","z":"069552b2eb6bce48","name":"payload = 12","rules":[{"p":"payload","pt":"msg","t":"set","to":"12","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":398,"y":590,"wires":[["6b30b8d45824c2ea"]]},{"id":"25d8b0221cd42ca2","type":"change","z":"069552b2eb6bce48","name":"payload = -12","rules":[{"p":"payload","pt":"msg","t":"set","to":"-12","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":388,"y":507,"wires":[["46385dd6aa371f45"]]},{"id":"146eaf26868b802c","type":"inject","z":"069552b2eb6bce48","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":128,"y":507,"wires":[["508ebb98927e404f","25d8b0221cd42ca2","53749a8b6ce5c205"]]}]