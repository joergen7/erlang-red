
<!-- --- [red-module:node-red/junction] --- -->
<!--
  05-junction.html
  This file exists so that the runtime loads the Junction node into the registry,
  but it is empty so it doesn't appear in the editor palette
-->

<!-- --- [red-module:node-red/inject] --- -->
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-template-name="inject">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name">
    </div>

    <div class="form-row node-input-property-container-row">
        <ol id="node-input-property-container"></ol>
    </div>

    <div class="form-row" id="node-once">
        <label for="node-input-once">&nbsp;</label>
        <input type="checkbox" id="node-input-once" style="display:inline-block; width:15px; vertical-align:baseline;">
        <span data-i18n="inject.onstart"></span>&nbsp;
        <input type="text" id="node-input-onceDelay" placeholder="0.1" style="width:45px; height:28px;">&nbsp;
        <span data-i18n="inject.onceDelay"></span>
    </div>

    <div class="form-row">
        <label for=""><i class="fa fa-repeat"></i> <span data-i18n="inject.label.repeat"></span></label>
        <select id="inject-time-type-select">
            <option value="none" data-i18n="inject.none"></option>
            <option value="interval" data-i18n="inject.interval"></option>
            <option value="interval-time" data-i18n="inject.interval-time"></option>
            <option value="time" data-i18n="inject.time"></option>
        </select>
        <input type="hidden" id="node-input-repeat">
        <input type="hidden" id="node-input-crontab">
    </div>

    <div class="form-row inject-time-row hidden" id="inject-time-row-interval">
        <span data-i18n="inject.every"></span>
        <input id="inject-time-interval-count" class="inject-time-count" value="1"></input>
        <select style="width:100px" id="inject-time-interval-units">
            <option value="s" data-i18n="inject.seconds"></option>
            <option value="m" data-i18n="inject.minutes"></option>
            <option value="h" data-i18n="inject.hours"></option>
        </select><br/>
    </div>

    <div class="form-row inject-time-row hidden" id="inject-time-row-interval-time">
        <span data-i18n="inject.every"></span> <select style="width:90px; margin-left:20px;" id="inject-time-interval-time-units" class="inject-time-int-count" value="1">
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
            <option value="6">6</option>
            <option value="10">10</option>
            <option value="12">12</option>
            <option value="15">15</option>
            <option value="20">20</option>
            <option value="30">30</option>
            <option value="0">60</option>
        </select> <span data-i18n="inject.minutes"></span><br/>
        <span data-i18n="inject.between"></span> <select id="inject-time-interval-time-start" class="inject-time-times"></select>
        <span data-i18n="inject.and"></span> <select id="inject-time-interval-time-end" class="inject-time-times"></select><br/>
        <div id="inject-time-interval-time-days" class="inject-time-days" style="margin-top:5px">
            <div style="display:inline-block; vertical-align:top; margin-right:5px;" data-i18n="inject.on">on</div>
            <div style="display:inline-block;">
                <div>
                    <label><input type='checkbox' checked value='1'/> <span data-i18n="inject.days.0"></span></label>
                    <label><input type='checkbox' checked value='2'/> <span data-i18n="inject.days.1"></span></label>
                    <label><input type='checkbox' checked value='3'/> <span data-i18n="inject.days.2"></span></label>
                </div>
                <div>
                    <label><input type='checkbox' checked value='4'/> <span data-i18n="inject.days.3"></span></label>
                    <label><input type='checkbox' checked value='5'/> <span data-i18n="inject.days.4"></span></label>
                    <label><input type='checkbox' checked value='6'/> <span data-i18n="inject.days.5"></span></label>
                </div>
                <div>
                    <label><input type='checkbox' checked value='0'/> <span data-i18n="inject.days.6"></span></label>
                </div>
            </div>
        </div>
    </div>

    <div class="form-row inject-time-row hidden" id="inject-time-row-time">
        <span data-i18n="inject.at"></span> <input type="text" id="inject-time-time" value="12:00"></input><br/>
        <div id="inject-time-time-days" class="inject-time-days">
            <div style="display:inline-block; vertical-align:top; margin-right:5px;" data-i18n="inject.on"></div>
            <div style="display:inline-block;">
                <div>
                    <label><input type='checkbox' checked value='1'/> <span data-i18n="inject.days.0"></span></label>
                    <label><input type='checkbox' checked value='2'/> <span data-i18n="inject.days.1"></span></label>
                    <label><input type='checkbox' checked value='3'/> <span data-i18n="inject.days.2"></span></label>
                </div>
                <div>
                    <label><input type='checkbox' checked value='4'/> <span data-i18n="inject.days.3"></span></label>
                    <label><input type='checkbox' checked value='5'/> <span data-i18n="inject.days.4"></span></label>
                    <label><input type='checkbox' checked value='6'/> <span data-i18n="inject.days.5"></span></label>
                </div>
                <div>
                    <label><input type='checkbox' checked value='0'/> <span data-i18n="inject.days.6"></span></label>
                </div>
            </div>
        </div>
    </div>

</script>
<style>
    .inject-time-row {
        padding-left: 110px;
    }
    .inject-time-row:not(#inject-time-row-interval) select {
        margin: 3px 0;
    }
    .inject-time-days label {
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        vertical-align: baseline;
        width: 100px;
    }
    .inject-time-days input {
        width: auto !important;
        vertical-align: baseline !important;
    }
    .inject-time-times {
        width: 90px !important;
    }
    #inject-time-time {
        width: 75px;
        margin-left: 8px;
        margin-bottom: 8px;
    }
    .inject-time-count {
        padding-left: 3px !important;
        width: 80px !important;
    }
</style>

<script type="text/javascript">
(function() {

    function resizeDialog(size) {
        size = size || { height: $(".red-ui-tray-content form").height() }
        var rows = $("#dialog-form>div:not(.node-input-property-container-row):visible");
        var height = size.height;
        for (var i=0; i<rows.length; i++) {
            height -= $(rows[i]).outerHeight(true);
        }
        var editorRow = $("#dialog-form>div.node-input-property-container-row");
        height -= (parseInt(editorRow.css("marginTop"))+parseInt(editorRow.css("marginBottom")));
        height += 16;
        $("#node-input-property-container").editableList('height',height);
    }
    /** Retrieve editableList items (refactored for re-use in the form inject button)*/
    function getProps(el, legacy) {
        var result = {
            props: []
        }
        el.each(function(i) {
            var prop = $(this);
            var p = {
                p:prop.find(".node-input-prop-property-name").typedInput('value')
            };
            if (p.p) {
                p.v = prop.find(".node-input-prop-property-value").typedInput('value');
                p.vt = prop.find(".node-input-prop-property-value").typedInput('type');
                if(legacy) {
                    if (p.p === "payload") { // save payload to old "legacy" property
                        result.payloadType = p.vt;
                        result.payload = p.v;
                        delete p.v;
                        delete p.vt;
                    } else if (p.p === "topic" && p.vt === "str") {
                        result.topic = p.v;
                        delete p.v;
                    }
                }
                result.props.push(p);
            }
        });
        return result;
    }
    /** Perform inject, optionally sending a custom msg (refactored for re-use in the form inject button)*/
    function doInject(node, customMsg) {
        var label = node._def.label.call(node,customMsg?customMsg.__user_inject_props__:undefined);
        if (label.length > 30) {
            label = label.substring(0, 50) + "...";
        }
        label = label.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
        $.ajax({
            url: "inject/" + node.id,
            type: "POST",
            data: JSON.stringify(customMsg||{}),
            contentType: "application/json; charset=utf-8",
            success: function (resp) {
                RED.notify(node._("inject.success", { label: label }), { type: "success", id: "inject", timeout: 2000 });
            },
            error: function (jqXHR, textStatus, errorThrown) {
                if (jqXHR.status == 404) {
                    RED.notify(node._("common.notification.error", { message: node._("common.notification.errors.not-deployed") }), "error");
                } else if (jqXHR.status == 500) {
                    RED.notify(node._("common.notification.error", { message: node._("inject.errors.failed") }), "error");
                } else if (jqXHR.status == 0) {
                    RED.notify(node._("common.notification.error", { message: node._("common.notification.errors.no-response") }), "error");
                } else {
                    RED.notify(node._("common.notification.error", { message: node._("common.notification.errors.unexpected", { status: jqXHR.status, message: textStatus }) }), "error");
                }
            }
        });
    }
    RED.nodes.registerType('inject',{  
        category: 'common',
        color:"#a6bbcf",
        defaults: {
            name: {value:""},
            props:{value:[{p:"payload"},{p:"topic",vt:"str"}], validate:function(v, opt) {
                    if (!v || v.length === 0) { return true }
                    const errors = []
                    for (var i=0;i<v.length;i++) {
                        if (/^\${[^}]+}$/.test(v[i].v)) {
                            // Allow ${ENV_VAR} value
                            continue
                        }
                        if (/msg|flow|global/.test(v[i].vt)) {
                            if (!RED.utils.validatePropertyExpression(v[i].v)) {
                                errors.push(RED._("node-red:inject.errors.invalid-prop", { prop: 'msg.'+v[i].p, error: v[i].v }))
                            }
                        } else if (v[i].vt === "jsonata") {
                            try{ jsonata(v[i].v); }
                            catch(e){
                                errors.push(RED._("node-red:inject.errors.invalid-jsonata", { prop: 'msg.'+v[i].p, error: e.message }))
                            }
                        } else if (v[i].vt === "json") {
                            try{ JSON.parse(v[i].v); }
                            catch(e){
                                errors.push(RED._("node-red:inject.errors.invalid-json", { prop: 'msg.'+v[i].p, error: e.message }))
                            }
                        } else if (v[i].vt === "num"){
                            const numValidation = RED.utils.validateTypedProperty(v[i].v, 'num', { prop: 'msg.'+v[i].p });
                            if (numValidation !== true) {
                                errors.push(numValidation || RED._("node-red:inject.errors.invalid-prop", { prop: 'msg.'+v[i].p, error: v[i].v }))
                            }
                        }
                    }
                    if (errors.length > 0) {
                        return errors
                    }
                    return true;
                }
            },
            repeat: {
                value:"", validate: function(v, opt) {
                    if ((v === "") ||
                        (RED.validators.number()(v) &&
                         (v >= 0) && (v <= 2147483))) {
                        return true;
                    }
                    return RED._("node-red:inject.errors.invalid-repeat");
                }
            },
            crontab: {value:""},
            once: {value:false},
            onceDelay: {value:0.1, validate: RED.validators.number(true)},
            topic: {value:""},
            payload: {value:"", validate: RED.validators.typedInput("payloadType", false) },
            payloadType: {value:"date"},
        },
        icon: "inject.svg",
        inputs:0,
        outputs:1,
        outputLabels: function(index) {
            var lab = '';

            // if only payload and topic - display payload type
            // if only one property - show it's type
            // if more than one property (other than payload and topic) - show "x properties" where x is the number of properties.
            // this.props will not be an array for legacy inject nodes until they are re-deployed
            //
            var props = this.props;
            if (!Array.isArray(props)) {
                props = [
                    { p:"payload", v: this.payload, vt: this.payloadType },
                    { p:"topic", v: this.topic, vt: "str" }
                ]
            }
            if (props) {
                for (var i=0,l=props.length; i<l; i++) {
                    if (i > 0) lab += "\n";
                    if (i === 5) {
                        lab += "... +"+(props.length-5);
                        break;
                    }
                    lab += props[i].p+": ";

                    var propType = props[i].p === "payload"? this.payloadType : props[i].vt;
                    if (propType === "json") {
                        try {
                            var parsedProp = JSON.parse(props[i].p === "payload"? this.payload : props[i].v);
                            propType = typeof parsedProp;
                            if (propType === "object" && Array.isArray(parsedProp)) {
                                propType = "Array";
                            }
                        } catch(e) {
                            propType = "invalid";
                        }
                    }
                    lab += this._("inject.label."+propType);
                }
            }
            return lab;
        },
        label: function(customProps) {
            var suffix = "";
            // if fire once then add small indication
            if (this.once) {
                suffix = " ¹";
            }
            // but replace with repeat one if set to repeat
            if ((this.repeat && this.repeat != 0) || this.crontab) {
                suffix = "\t↻";
            }
            if (this.name) {
                return this.name+suffix;
            }
            var payload = "";
            var payloadType = "str";
            var topic = "";
            if (customProps) {
                for (var i=0;i<customProps.length;i++) {
                    if (customProps[i].p === "payload") {
                        payload = customProps[i].v;
                        payloadType = customProps[i].vt;
                    } else if (customProps[i].p === "topic") {
                        topic = customProps[i].v;
                    }
                }
            } else {
                payload = this.payload || "";
                payloadType = this.payloadType || "str";
                topic = this.topic || "";
            }
            if (payloadType === "string" ||
                    payloadType === "str" ||
                    payloadType === "num" ||
                    payloadType === "bool" ||
                    payloadType === "json") {
                if ((topic !== "") && ((topic.length + payload.length) <= 32)) {
                    return topic + ":" + payload+suffix;
                } else if (payload.length > 0 && payload.length < 24) {
                    return payload+suffix;
                } else {
                    return this._("inject.inject")+suffix;
                }
            } else if (payloadType === 'date' || payloadType === 'bin' || payloadType === 'env') {
                if ((topic !== "") && (topic.length <= 16)) {
                    return topic + ":" + this._('inject.label.'+payloadType)+suffix;
                } else {
                    return this._('inject.label.'+payloadType)+suffix;
                }
            } else if (payloadType === 'flow' || payloadType === 'global') {
                var key = RED.utils.parseContextKey(payload);
                return payloadType+"."+key.key+suffix;
            } else {
                return this._("inject.inject")+suffix;
            }
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        oneditprepare: function() {
            var node = this;
            var payloadType = node.payloadType;

            if (node.payloadType == null) {
                if (node.payload == "") {
                    payloadType = "date";
                } else {
                    payloadType = "str";
                }
            } else if (node.payloadType === 'string' || node.payloadType === 'none') {
                payloadType = "str";
            }

            $("#inject-time-type-select").on("change", function() {
                $("#node-input-crontab").val('');
                var id = $("#inject-time-type-select").val();
                $(".inject-time-row").hide();
                $("#inject-time-row-"+id).show();

                // Scroll down
                var scrollDiv = $("#dialog-form").parent();
                scrollDiv.scrollTop(scrollDiv.prop('scrollHeight'));
                resizeDialog();
            });

            $("#node-input-once").on("change", function() {
                $("#node-input-onceDelay").attr('disabled', !$("#node-input-once").prop('checked'));
            })

            $(".inject-time-times").each(function() {
                for (var i=0; i<24; i++) {
                    var l = (i<10?"0":"")+i+":00";
                    $(this).append($("<option></option>").val(i).text(l));
                }
            });
            $("<option></option>").val(24).text("00:00").appendTo("#inject-time-interval-time-end");
            $("#inject-time-interval-time-start").on("change", function() {
                var start = Number($("#inject-time-interval-time-start").val());
                var end = Number($("#inject-time-interval-time-end").val());
                $("#inject-time-interval-time-end option").remove();
                for (var i=start+1; i<25; i++) {
                    var l = (i<10?"0":"")+i+":00";
                    if (i==24) {
                        l = "00:00";
                    }
                    var opt = $("<option></option>").val(i).text(l).appendTo("#inject-time-interval-time-end");
                    if (i === end) {
                        opt.attr("selected","selected");
                    }
                }
            });

            $(".inject-time-count").spinner({
                //max:60,
                min:1
            });

            var repeattype = "none";
            if (node.repeat != "" && node.repeat != 0) {
                repeattype = "interval";
                var r = "s";
                var c = node.repeat;
                if (node.repeat % 60 === 0) { r = "m"; c = c/60; }
                if (node.repeat % 1440 === 0) { r = "h"; c = c/60; }
                $("#inject-time-interval-count").val(c);
                $("#inject-time-interval-units").val(r);
                $("#inject-time-interval-days").prop("disabled","disabled");
            } else if (node.crontab) {
                var cronparts = node.crontab.split(" ");
                var days = cronparts[4];
                if (!isNaN(cronparts[0]) && !isNaN(cronparts[1])) {
                    repeattype = "time";
                    // Fixed time
                    var time = cronparts[1]+":"+cronparts[0];
                    $("#inject-time-time").val(time);
                    $("#inject-time-type-select").val("s");
                    if (days == "*") {
                        $("#inject-time-time-days input[type=checkbox]").prop("checked",true);
                    } else {
                        $("#inject-time-time-days input[type=checkbox]").removeAttr("checked");
                        days.split(",").forEach(function(v) {
                            $("#inject-time-time-days [value=" + v + "]").prop("checked", true);
                        });
                    }
                } else {
                    repeattype = "interval-time";
                    // interval - time period
                    var minutes = cronparts[0].slice(2);
                    if (minutes === "") { minutes = "0"; }
                    $("#inject-time-interval-time-units").val(minutes);
                    if (days == "*") {
                        $("#inject-time-interval-time-days input[type=checkbox]").prop("checked",true);
                    } else {
                        $("#inject-time-interval-time-days input[type=checkbox]").removeAttr("checked");
                        days.split(",").forEach(function(v) {
                            $("#inject-time-interval-time-days [value=" + v + "]").prop("checked", true);
                        });
                    }
                    var time = cronparts[1];
                    var timeparts = time.split(",");
                    var start;
                    var end;
                    if (timeparts.length == 1) {
                        // 0 or 0-10
                        var hours = timeparts[0].split("-");
                        if (hours.length == 1) {
                            if (hours[0] === "") {
                                start = "0";
                                end = "0";
                            }
                            else {
                                start = hours[0];
                                end = Number(hours[0])+1;
                            }
                        } else {
                            start = hours[0];
                            end = Number(hours[1])+1;
                        }
                    } else {
                        // 23,0 or 17-23,0-10 or 23,0-2 or 17-23,0
                        var startparts = timeparts[0].split("-");
                        start = startparts[0];

                        var endparts = timeparts[1].split("-");
                        if (endparts.length == 1) {
                            end = Number(endparts[0])+1;
                        } else {
                            end = Number(endparts[1])+1;
                        }
                    }
                    $("#inject-time-interval-time-end").val(end);
                    $("#inject-time-interval-time-start").val(start);

                }
            } else {
                $("#inject-time-type-select").val("none");
            }

            $(".inject-time-row").hide();
            $("#inject-time-type-select").val(repeattype);
            $("#inject-time-row-"+repeattype).show();

            /* */

            var eList = $('#node-input-property-container').css('min-height','120px').css('min-width','450px');

            eList.editableList({
                buttons: [
                    {
                        id: "node-inject-test-inject-button",
                        label: node._("inject.injectNow"),
                        click: function(e) {
                            var items = eList.editableList('items');
                            var props = getProps(items);
                            var m = {__user_inject_props__: props.props};
                            doInject(node, m);
                        }
                    }
                ],
                addItem: function(container,i,opt) {
                    var prop = opt;
                    if (!prop.hasOwnProperty('p')) {
                        prop = {p:"",v:"",vt:"str"};
                    }
                    container.css({
                        overflow: 'hidden',
                        whiteSpace: 'nowrap'
                    });
                    var row = $('<div/>').appendTo(container);

                    var propertyName = $('<input/>',{class:"node-input-prop-property-name",type:"text"})
                        .css("width","30%")
                        .appendTo(row)
                        .typedInput({types:['msg']});

                    $('<div/>',{style: 'display:inline-block; padding:0px 6px;'})
                        .text('=')
                        .appendTo(row);

                    var propertyValue = $('<input/>',{class:"node-input-prop-property-value",type:"text"})
                        .css("width","calc(70% - 30px)")
                        .appendTo(row)
                        .typedInput({default:prop.vt || 'str',types:['flow','global','str','num','bool','json','bin','date','jsonata','env','msg']});

                    propertyName.typedInput('value',prop.p);
                    propertyValue.typedInput('value',prop.v);
                },
                removable: true,
                sortable: true
            });
            $('#node-inject-test-inject-button').css("float", "right").css("margin-right", "unset");

            if (RED.nodes.subflow(node.z)) {
                $('#node-inject-test-inject-button').attr("disabled",true);
            }

            if (!node.props) {
                var payload = {
                    p:'payload',
                    v: node.payload ? node.payload : '',
                    vt:payloadType ? payloadType : 'date'
                };
                var topic = {
                    p:'topic',
                    v: node.topic ? node.topic : '',
                    vt:'str'
                }
                node.props = [payload,topic];
            }

            for (var i=0; i<node.props.length; i++) {
                var prop = node.props[i];
                var newProp = { p: prop.p, v: prop.v, vt: prop.vt };
                if (newProp.v === undefined) {
                    if (prop.p === 'payload') {
                        newProp.v = node.payload ? node.payload : '';
                        newProp.vt = payloadType ? payloadType : 'date';
                    } else if (prop.p === 'topic' && prop.vt === "str") {
                        newProp.v =  node.topic ? node.topic : '';
                    }
                }
                if (newProp.vt === "string") {
                    // Fix bug in pre 2.1 where an old Inject node might have
                    // a migrated rule with type 'string' not 'str'
                    newProp.vt = "str";
                }
                eList.editableList('addItem',newProp);
            }

            $("#inject-time-type-select").trigger("change");
            $("#inject-time-interval-time-start").trigger("change");

        },
        oneditsave: function() {
            var repeat = "";
            var crontab = "";
            var type = $("#inject-time-type-select").val();
            if (type == "none") {
                // nothing
            } else if (type == "interval") {
                var count = $("#inject-time-interval-count").val();
                var units = $("#inject-time-interval-units").val();
                if (units == "s") {
                    repeat = count;
                } else {
                    if (units == "m") {
                        //crontab = "*/"+count+" * * * "+days;
                        repeat = count * 60;
                    } else if (units == "h") {
                        //crontab = "0 */"+count+" * * "+days;
                        repeat = count * 60 * 60;
                    }
                }
            } else if (type == "interval-time") {
                repeat = "";
                var count = $("#inject-time-interval-time-units").val();
                var startTime = Number($("#inject-time-interval-time-start").val());
                var endTime = Number($("#inject-time-interval-time-end").val());
                var days = $('#inject-time-interval-time-days input[type=checkbox]:checked').map(function(_, el) {
                    return $(el).val()
                }).get();
                if (days.length == 0) {
                    crontab = "";
                } else {
                    if (days.length == 7) {
                        days="*";
                    } else {
                        days = days.join(",");
                    }
                    var timerange = "";
                    if (endTime == 0) {
                        timerange = startTime+"-23";
                    } else if (startTime+1 < endTime) {
                        timerange = startTime+"-"+(endTime-1);
                    } else if (startTime+1 == endTime) {
                        timerange = startTime;
                    } else {
                        var startpart = "";
                        var endpart = "";
                        if (startTime == 23) {
                            startpart = "23";
                        } else {
                            startpart = startTime+"-23";
                        }
                        if (endTime == 1) {
                            endpart = "0";
                        } else {
                            endpart = "0-"+(endTime-1);
                        }
                        timerange = startpart+","+endpart;
                    }
                    if (count === "0") {
                        crontab = count+" "+timerange+" * * "+days;
                    } else {
                        crontab = "*/"+count+" "+timerange+" * * "+days;
                    }
                }
            } else if (type == "time") {
                var time = $("#inject-time-time").val();
                var days = $('#inject-time-time-days  input[type=checkbox]:checked').map(function(_, el) {
                    return $(el).val()
                }).get();
                if (days.length == 0) {
                    crontab = "";
                } else {
                    if (days.length == 7) {
                        days="*";
                    } else {
                        days = days.join(",");
                    }
                    var parts = time.split(":");
                    if (parts.length === 2) {
                        repeat = "";
                        parts[1] = ("00" + (parseInt(parts[1]) % 60)).substr(-2);
                        parts[0] = ("00" + (parseInt(parts[0]) % 24)).substr(-2);
                        crontab = parts[1]+" "+parts[0]+" * * "+days;
                    }
                    else { crontab = ""; }
                }
            }

            $("#node-input-repeat").val(repeat);
            $("#node-input-crontab").val(crontab);

            /* Gather the properties */
            var items = $("#node-input-property-container").editableList('items');
            delete this.payloadType;
            delete this.payload;
            this.topic = "";
            var result = getProps(items, true);
            this.props = result.props;
            if(result.hasOwnProperty('payloadType')) { this.payloadType = result.payloadType; };
            if(result.hasOwnProperty('payload')) { this.payload = result.payload; };
            if(result.hasOwnProperty('topic')) { this.topic = result.topic; };
        },
        button: {
            enabled: function() {
                return !this.changed
            },
            onclick: function () {
                if (this.changed) {
                    return RED.notify(RED._("notification.warning", { message: RED._("notification.warnings.undeployedChanges") }), "warning");
                }
                doInject(this);
            }
        },
        oneditresize: resizeDialog
    });
})();
</script>
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-help-name="inject">
<p>Injects a message into a flow either manually or at regular intervals. The message
payload can be a variety of types, including strings, JavaScript objects or the current time.</p>
<h3>Outputs</h3>
<dl class="message-properties">
    <dt>payload<span class="property-type">various</span></dt>
    <dd>The configured payload of the message.</dd>
    <dt class="optional">topic <span class="property-type">string</span></dt>
    <dd>An optional property that can be configured in the node.</dd>
</dl>
<h3>Details</h3>
<p>The Inject node can initiate a flow with a specific payload value.
The default payload is a timestamp of the current time in millisecs since January 1st, 1970.</p>
<p>The node also supports injecting strings, numbers, booleans, JavaScript objects, or flow/global context values.</p>
<p>By default, the node is triggered manually by clicking on its button within the editor. It can also be set to
inject at regular intervals or according to a schedule.</p>
<p>It can also be configured to inject once each time the flows are started.</p>
<p>The maximum <i>Interval</i> that can be specified is about 596 hours / 24 days. However if you are looking at intervals
greater than one day you should consider using a scheduler node that can cope with power outages and restarts.</p>
<p><b>Note</b>: The <i>"Interval between times"</i> and <i>"at a specific time"</i> options use the standard cron system.
This means that 20 minutes will be at the next hour, 20 minutes past and 40 minutes past - not in 20 minutes time.
If you want every 20 minutes from now - use the <i>"interval"</i> option.</p>
<p><b>Note</b>: To include a newline in a string you must use the Function or Template node to create the payload.</p>
</script>

<!-- --- [red-module:node-red/debug] --- -->

<script type="text/html" data-template-name="debug">
    <div class="form-row">
        <label for="node-input-typed-complete"><i class="fa fa-list"></i> <span data-i18n="debug.output"></span></label>
        <input id="node-input-typed-complete" type="text" style="width: 70%">
        <input id="node-input-complete" type="hidden">
        <input id="node-input-targetType" type="hidden">
    </div>
    <div class="form-row">
        <label for="node-input-tosidebar"><i class="fa fa-random"></i> <span data-i18n="debug.to"></span></label>
        <label for="node-input-tosidebar" style="width:70%">
        <input type="checkbox" id="node-input-tosidebar" style="display:inline-block; width:22px; vertical-align:top;"><span data-i18n="debug.toSidebar"></span>
        </label>
    </div>
    <div class="form-row">
        <label for="node-input-console"> </label>
        <label for="node-input-console" style="width:70%">
        <input type="checkbox" id="node-input-console" style="display:inline-block; width:22px; vertical-align:top;"><span data-i18n="debug.toConsole"></span>
        </label>
    </div>
    <div class="form-row">
    <label for="node-input-tostatus"> </label>
    <label for="node-input-tostatus" style="width:70%">
        <input type="checkbox" id="node-input-tostatus" style="display:inline-block; width:22px; vertical-align:top;"><span data-i18n="debug.toStatus"></span>
    </label>
    </div>
    <div class="form-row" id="node-tostatus-line">
        <label for="node-input-typed-status"></label>
        <input id="node-input-typed-status" type="text" style="width: 70%">
        <input id="node-input-statusVal" type="hidden">
        <input id="node-input-statusType" type="hidden">
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name">
    </div>
</script>

<script src="debug/view/debug-utils.js"></script>

<script type="text/javascript">
(function() {
    var subWindow = null;

    function activateAjaxCall(node, active, successCallback) {
        var url;
        var body;

        if (Array.isArray(node)) {
            url = "debug/"+(active?"enable":"disable");
            body = {nodes: node.map(function(n) { return n.id})}
            node = node[0];
        } else {
            url = "debug/"+node.id+"/"+(active?"enable":"disable");
        }
        $.ajax({
            url: url,
            type: "POST",
            data: body,
            success: successCallback,
            error: function(jqXHR,textStatus,errorThrown) {
                if (jqXHR.status == 404) {
                    RED.notify(node._("common.notification.error", {message: node._("common.notification.errors.not-deployed")}),"error");
                } else if (jqXHR.status === 0) {
                    RED.notify(node._("common.notification.error", {message: node._("common.notification.errors.no-response")}),"error");
                } else {
                    // TODO where is the err.status comming from?
                    RED.notify(node._("common.notification.error",{message:node._("common.notification.errors.unexpected",{status:err.status,message:err.response})}),"error");
                }
            }
        });
    }

    RED.nodes.registerType('debug',{
        category: 'common',
        defaults: {
            name: {value:"_DEFAULT_"},
            active: {value:true},
            tosidebar: {value:true},
            console: {value:false},
            tostatus: {value:false},
            complete: {value:"true", required:true},
            targetType: {value:"full"},
            statusVal: {value:""},
            statusType: {value:"auto"}
        },
        label: function() {
            var suffix = "";
            if (this.console === true || this.console === "true") { suffix = "\t⇲"; }
            if (this.targetType === "jsonata") {
                return (this.name || "JSONata") + suffix;
            }
            if (this.complete === true || this.complete === "true") {
                return (this.name||"msg") + suffix;
            } else {
                return (this.name || "msg." + ((!this.complete || this.complete === "false") ? "payload" : this.complete)) + suffix;
            }
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        color:"#87a980",
        inputs:1,
        outputs:0,
        icon: "debug.svg",
        align: "right",
        button: {
            toggle: "active",
            visible: function() { return this.tosidebar; },
            onclick: function() {
                var label = RED.utils.sanitize(this.name||"debug");
                var node = this;
                activateAjaxCall(node, node.active, function(resp, textStatus, xhr) {
                    var historyEvent = {
                        t:'edit',
                        node:node,
                        changes:{
                            active:!node.active
                        },
                        dirty:node.dirty,
                        changed:node.changed,
                        callback: function(ev) {
                            activateAjaxCall(ev.node, ev.node.active);
                        }
                    };
                    node.changed = true;
                    node.dirty = true;
                    RED.nodes.dirty(true);
                    RED.history.push(historyEvent);
                    RED.view.redraw();
                    if (xhr.status == 200) {
                        RED.notify(node._("debug.notification.activated",{label:label}),{type: "success", timeout: 2000});
                    } else if (xhr.status == 201) {
                        RED.notify(node._("debug.notification.deactivated",{label:label}),{type: "success", timeout: 2000});
                    }
                });
            }
        },
        onpaletteadd: function() {
            var options = {
                messageMouseEnter: function(sourceId) {
                    if (sourceId) {
                        var n = RED.nodes.node(sourceId);
                        if (n) {
                            n.highlighted = true;
                            n.dirty = true;
                        }
                        RED.view.redraw();
                    }
                },
                messageMouseLeave: function(sourceId) {
                    if (sourceId) {
                        var n = RED.nodes.node(sourceId);
                        if (n) {
                            n.highlighted = false;
                            n.dirty = true;
                        }
                        RED.view.redraw();
                    }
                },
                messageSourceClick: function(sourceId, aliasId, path) {
                    // Get all of the nodes that could have logged this message
                    if (RED.nodes.workspace(sourceId)) {
                        RED.view.reveal(sourceId);
                        return
                    }
                    var candidateNodes = [RED.nodes.node(sourceId)]
                    if (path) {
                        for (var i=2;i<path.length;i++) {
                            candidateNodes.push(RED.nodes.node(path[i]))
                        }
                    }
                    if (aliasId) {
                        candidateNodes.push(RED.nodes.node(aliasId));
                    }
                    if (candidateNodes.length > 1) {
                        // The node is in a subflow. Check to see if the active
                        // workspace is a subflow in the node's parentage. If
                        // so, reveal the relevant subflow instance node.
                        var ws = RED.workspaces.active();
                        for (var i=0;i<candidateNodes.length;i++) {
                            if (candidateNodes[i].z === ws) {
                                RED.view.reveal(candidateNodes[i].id);
                                return
                            }
                        }
                        // The active workspace is unrelated to the node. So
                        // fall back to revealing the top most node
                    }
                    RED.view.reveal(candidateNodes[0].id);
                },
                clear: function() {
                    RED.nodes.eachNode(function(node) {
                        node.highlighted = false;
                        node.dirty = true;
                    });
                    RED.view.redraw();
                },
                requestDebugNodeList: function(filteredNodes) {
                    var workspaceOrder = RED.nodes.getWorkspaceOrder();
                    var workspaceOrderMap = {};
                    workspaceOrder.forEach(function(ws,i) {
                        workspaceOrderMap[ws] = i;
                    });

                    var candidateNodes = [];
                    var candidateSFs = [];
                    var subflows = {};
                    RED.nodes.eachNode(function (n) {
                        var nt = n.type;
                        if (nt === "debug") {
                            if (n.z in workspaceOrderMap) {
                                candidateNodes.push(n);
                            }
                            else {
                                var sf = RED.nodes.subflow(n.z);
                                if (sf) {
                                    subflows[sf.id] = {
                                        debug: true,
                                        subflows: {}
                                    };
                                }
                            }
                        }
                        else if(nt.substring(0, 8) === "subflow:") {
                            if (n.z in workspaceOrderMap) {
                                candidateSFs.push(n);
                            }
                            else {
                                var psf = RED.nodes.subflow(n.z);
                                if (psf) {
                                    var sid = nt.substring(8);
                                    var item = subflows[psf.id];
                                    if (!item) {
                                        item = {
                                            debug: undefined,
                                            subflows: {}
                                        };
                                        subflows[psf.id] = item;
                                    }
                                    item.subflows[sid] = true;
                                }
                            }
                        }
                    });
                    candidateSFs.forEach(function (sf) {
                        var sid = sf.type.substring(8);
                        if (containsDebug(sid, subflows)) {
                            candidateNodes.push(sf);
                        }
                    });

                    candidateNodes.sort(function(A,B) {
                        var wsA = workspaceOrderMap[A.z];
                        var wsB = workspaceOrderMap[B.z];
                        if (wsA !== wsB) {
                            return wsA-wsB;
                        }
                        var labelA = RED.utils.getNodeLabel(A,A.id);
                        var labelB = RED.utils.getNodeLabel(B,B.id);
                        return labelA.localeCompare(labelB);
                    });
                    var currentWs = null;
                    var data = [];
                    var currentFlow;
                    var currentSelectedCount = 0;
                    candidateNodes.forEach(function(node) {
                        if (currentWs !== node.z) {
                            if (currentFlow && currentFlow.checkbox) {
                                currentFlow.selected = currentSelectedCount === currentFlow.children.length
                            }
                            currentSelectedCount = 0;
                            currentWs = node.z;
                            var parent = RED.nodes.workspace(currentWs) || RED.nodes.subflow(currentWs);
                            currentFlow = {
                                label: RED.utils.getNodeLabel(parent, currentWs),
                            }
                            if (!parent.disabled) {
                                currentFlow.children = [];
                                currentFlow.checkbox = true;
                            } else {
                                currentFlow.class = "disabled"
                            }
                            data.push(currentFlow);
                        }
                        if (currentFlow.children) {
                            if (!filteredNodes[node.id]) {
                                currentSelectedCount++;
                            }
                            currentFlow.children.push({
                                label: RED.utils.getNodeLabel(node,node.id),
                                node: {
                                    id: node.id
                                },
                                checkbox: true,
                                selected: !filteredNodes[node.id]
                            });
                        }
                    });
                    if (currentFlow && currentFlow.checkbox) {
                        currentFlow.selected = currentSelectedCount === currentFlow.children.length
                    }
                    if (subWindow) {
                        try {
                            subWindow.postMessage({event:"refreshDebugNodeList", nodes:data},"*");
                        } catch(err) {
                            console.log(err);
                        }
                    }
                    RED.debug.refreshDebugNodeList(data)
                }
            };

            var uiComponents = RED.debug.init(options);

            RED.sidebar.addTab({
                id: "debug",
                label: this._("debug.sidebar.label"),
                name: this._("debug.sidebar.name"),
                content: uiComponents.content,
                toolbar: uiComponents.footer,
                enableOnEdit: true,
                pinned: true,
                iconClass: "fa fa-bug",
                action: "core:show-debug-tab"
            });
            RED.actions.add("core:show-debug-tab",function() { RED.sidebar.show('debug'); });

            var that = this;
            RED._debug = function(msg) {
                that.handleDebugMessage("", {
                    name:"debug",
                    msg:msg
                });
            };

            this.refreshMessageList = function() {
                RED.debug.refreshMessageList(RED.workspaces.active());
                if (subWindow) {
                    try {
                        subWindow.postMessage({event:"workspaceChange",activeWorkspace:RED.workspaces.active()},"*");
                    } catch(err) {
                        console.log(err);
                    }
                }
            };
            RED.events.on("workspace:change", this.refreshMessageList);

            this.handleDebugMessage = function(t,o) {
                // console.log("->",o.id,o.z,o._alias);
                //
                // sourceNode should be the top-level node - one that is on a flow.
                var sourceNode;
                var pathParts;
                var pathHierarchy;
                if (o.path) {
                    // Path is a `/`-separated list of ids that identifies the
                    // complete parentage of the node that generated this message.
                    //    flow-id/subflow-A-instance/subflow-B-instance

                    // If it has one id, that is a top level flow or config node/global
                    // each subsequent id is the instance id of a subflow node
                    //
                    try { pathParts = o.path.split("/"); } catch (e) { pathParts = [o.path] }
                    if (pathParts.length === 1) {
                        // The source node is on a flow or is a global/config - so can use its id to find
                        sourceNode = RED.nodes.node(o.id);
                    } else if (pathParts.length > 1) {
                        // Highlight the subflow instance node.
                        sourceNode = RED.nodes.node(pathParts[1]);
                    }
                  const getNodeLabel = (n) => {
                    n ? (n.name || (typeof n.label === "function" && n.label())  || (typeof n.label === "string" && n.label) || (n.type + ":" + n.id)) : "undefined";
                  }
                    pathHierarchy = pathParts.map((id,index) => {
                        if (index === 0) {
                            if (id === "global") {
                                return { id: sourceNode.id, label: getNodeLabel(sourceNode) }
                            }
                          let wksp = RED.nodes.workspace(id)
                          return { id:
                                   id, label: wksp ? wksp.label : id
                          }
                        } else {
                            const instanceNode = RED.nodes.node(id)
                            const pathLabel = (instanceNode.name || RED.nodes.subflow(instanceNode.type.substring(8))?.name || instanceNode.type)
                            return { id: id, label: pathLabel }
                        }
                    })
                    if (pathParts.length === 1 && pathParts[0] !== "global") {
                        pathHierarchy.push({ id: o.id, label: getNodeLabel(sourceNode) })
                    }
                    if (o._alias) {
                        let aliasNode = RED.nodes.node(o._alias)
                        if (aliasNode) {
                            pathHierarchy.push({ id: o._alias, label: getNodeLabel(aliasNode) })
                        }
                    }
                } else {
                    // This is probably redundant...
                    sourceNode = RED.nodes.node(o.id) || RED.nodes.node(o.z);
                }
                if (sourceNode) {
                    var sourceFlow = RED.nodes.workspace(sourceNode.z)
                    o._source = {
                        id:sourceNode.id,
                        z:sourceNode.z,
                        name:sourceNode.name,
                        type:sourceNode.type,
                        // _alias identifies the actual logging node. This is
                        // not necessarily the same as sourceNode, which will be
                        // the top-level subflow instance node.
                        // This means the node's name is displayed in the sidebar.
                        _alias:o._alias,
                        flowName: sourceFlow?(sourceFlow.label||sourceNode.z):sourceNode.z,
                        path: pathParts,
                        pathHierarchy: pathHierarchy
                    };
                }
                RED.debug.handleDebugMessage(o);
                if (subWindow) {
                    try {
                        subWindow.postMessage({event:"message",msg:o},"*");
                    } catch(err) {
                        console.log(err);
                    }
                }
            };
            RED.comms.subscribe("debug",this.handleDebugMessage);

            this.clearMessageList = function() {
                RED.debug.clearMessageList(true);
                if (subWindow) {
                    try {
                        subWindow.postMessage({event:"projectChange"},"*");
                    } catch(err) {
                        console.log(err);
                    }
                }
            };
            RED.events.on("project:change", this.clearMessageList);
            RED.actions.add("core:clear-debug-messages", function() { RED.debug.clearMessageList(true) });
            RED.actions.add("core:clear-filtered-debug-messages", function() { RED.debug.clearMessageList(true, true) });

            RED.actions.add("core:activate-selected-debug-nodes", function() { setDebugNodeState(getSelectedDebugNodes(true), true); });
            RED.actions.add("core:activate-all-debug-nodes", function() { setDebugNodeState(getMatchingDebugNodes(true, true),true); });
            RED.actions.add("core:activate-all-flow-debug-nodes", function() { setDebugNodeState(getMatchingDebugNodes(true, false),true); });

            RED.actions.add("core:deactivate-selected-debug-nodes", function() { setDebugNodeState(getSelectedDebugNodes(false), false); });
            RED.actions.add("core:deactivate-all-debug-nodes", function() { setDebugNodeState(getMatchingDebugNodes(false, true),false); });
            RED.actions.add("core:deactivate-all-flow-debug-nodes", function() { setDebugNodeState(getMatchingDebugNodes(false, false),false); });

            function getSelectedDebugNodes(state) {
                var nodes = [];
                var selection = RED.view.selection();
                if (selection.nodes) {
                    selection.nodes.forEach(function(n) {
                        if (RED.nodes.subflow(n.z)) {
                            return;
                        }
                        if (n.type === 'debug' && n.active !== state) {
                            nodes.push(n);
                        } else if (n.type === 'group') {
                            nodes = nodes.concat( RED.group.getNodes(n,true).filter(function(n) {
                                return n.type === 'debug' && n.active !== state
                            }));
                        }
                    });
                }
                return nodes;

            }
            function getMatchingDebugNodes(state,globally) {
                var nodes = [];
                var filter = {type:"debug"};
                if (!globally) {
                    filter.z = RED.workspaces.active();
                }
                var candidateNodes = RED.nodes.filterNodes(filter);
                nodes = candidateNodes.filter(function(n) {
                    return n.active !== state && !RED.nodes.subflow(n.z)
                })
                return nodes;
            }

            function setDebugNodeState(nodes,state) {
                var historyEvents = [];
                if (nodes.length > 0) {
                    activateAjaxCall(nodes,false, function(resp, textStatus, xhr) {
                        nodes.forEach(function(n) {
                            historyEvents.push({
                                t: "edit",
                                node: n,
                                changed: n.changed,
                                changes: {
                                    active: n.active
                                }
                            });
                            n.active = state;
                            n.changed = true;
                            n.dirty = true;
                        })
                        RED.history.push({
                            t: "multi",
                            events: historyEvents,
                            dirty: RED.nodes.dirty(),
                            callback: function() {
                                activateAjaxCall(nodes,nodes[0].active);
                            }
                        });
                        RED.nodes.dirty(true);
                        RED.view.redraw();
                    });
                }
            }

            function containsDebug(sid, map) {
                var item = map[sid];
                if (item) {
                    if (item.debug === undefined) {
                        var sfs = Object.keys(item.subflows);
                        var contain = false;
                        for (var i = 0; i < sfs.length; i++) {
                            var sf = sfs[i];
                            if (containsDebug(sf, map)) {
                                contain = true;
                                break;
                            }
                        }
                        item.debug = contain;
                    }
                    return item.debug;
                }
                return false;
            }

            $("#red-ui-sidebar-debug-open").on("click", function(e) {
                e.preventDefault();
                subWindow = window.open(document.location.toString().replace(/[?#].*$/,"")+"debug/view/view.html"+document.location.search,"nodeREDDebugView","menubar=no,location=no,toolbar=no,chrome,height=500,width=600");
                subWindow.onload = function() {
                    subWindow.postMessage({event:"workspaceChange",activeWorkspace:RED.workspaces.active()},"*");
                };
            });
            RED.popover.tooltip($("#red-ui-sidebar-debug-open"),RED._('node-red:debug.sidebar.openWindow'));



            $(window).on('beforeunload',function() {
                if (subWindow) {
                    try {
                        subWindow.close();
                    } catch(err) {
                        console.log(err);
                    }
                }
            });

            this.handleWindowMessage = function(evt) {
                var msg = evt.data;
                if (msg.event === "mouseEnter") {
                    options.messageMouseEnter(msg.id);
                } else if (msg.event === "mouseLeave") {
                    options.messageMouseLeave(msg.id);
                } else if (msg.event === "mouseClick") {
                    options.messageSourceClick(msg.id,msg._alias,msg.path);
                } else if (msg.event === "clear") {
                    options.clear();
                } else if (msg.event === "requestDebugNodeList") {
                    options.requestDebugNodeList(msg.filteredNodes)
                }
            };
            window.addEventListener('message',this.handleWindowMessage);
        },
        onpaletteremove: function() {
            RED.comms.unsubscribe("debug",this.handleDebugMessage);
            RED.sidebar.removeTab("debug");
            RED.events.off("workspace:change", this.refreshMessageList);
            window.removeEventListener("message",this.handleWindowMessage);
            RED.actions.remove("core:show-debug-tab");
            RED.actions.remove("core:clear-debug-messages");
            delete RED._debug;
        },
        oneditprepare: function() {
            var autoType = {
                value: "auto",
                label: RED._("node-red:debug.autostatus"),
                hasValue: false
            };

            var counter = {
                value: "counter",
                label: RED._("node-red:debug.messageCount"),
                hasValue: false
            };

            $("#node-input-typed-status").typedInput({
                default: "auto",
                types:[autoType, "msg", "jsonata", counter],
                typeField: $("#node-input-statusType")
            });
            var that = this;
            var none = {
                value: "none",
                label: RED._("node-red:debug.none"),
                hasValue: false
            };
            if (this.tosidebar === undefined) {
                this.tosidebar = true;
                $("#node-input-tosidebar").prop('checked', true);
            }
            if (this.statusVal === undefined) {
                this.statusVal = (this.complete === "false") ? "payload" : ((this.complete === "true") ? "payload" : this.complete+"");
                $("#node-input-typed-status").typedInput('value',this.statusVal || "");
            }
            if (this.statusType === undefined) {
                this.statusType = "auto";
                $("#node-input-typed-status").typedInput('type',this.statusType || "auto");
            }
            if (typeof this.console === "string") {
                this.console = (this.console == 'true');
                $("#node-input-console").prop('checked', this.console);
                $("#node-input-tosidebar").prop('checked', true);
            }
            var fullType = {
                value: "full",
                label: RED._("node-red:debug.msgobj"),
                hasValue: false
            };

            $("#node-input-typed-complete").typedInput({
                default: "msg",
                types:['msg', fullType, "jsonata"],
                typeField: $("#node-input-targetType")
            });
            if (this.targetType === "jsonata") {
                var property = this.complete || "";
                $("#node-input-typed-complete").typedInput('type','jsonata');
                $("#node-input-typed-complete").typedInput('value',property);
            } else if ((this.targetType === "full") || this.complete === "true" || this.complete === true) {
                // show complete message object
                $("#node-input-typed-complete").typedInput('type','full');
            } else {
                var property = (!this.complete||(this.complete === "false")) ? "payload" : this.complete+"";
                $("#node-input-typed-complete").typedInput('type','msg');
                $("#node-input-typed-complete").typedInput('value',property);
            }
            $("#node-input-typed-complete").on('change',function() {
                if ($("#node-input-typed-complete").typedInput('type') === 'msg' &&
                    $("#node-input-typed-complete").typedInput('value') === ''
                ) {
                    $("#node-input-typed-complete").typedInput('value','payload');
                }
            });

            $("#node-input-tostatus").on('change',function() {
                if ($(this).is(":checked")) {
                    if (that.statusType === "counter") {
                        that.statusVal = "";
                    }
                    else if (!that.hasOwnProperty("statusVal") || that.statusVal === "") {
                        var type = $("#node-input-typed-complete").typedInput('type');
                        var comp = "payload";
                        if (type !== 'full') {
                            comp = $("#node-input-typed-complete").typedInput('value');
                        }
                        that.statusType = "auto";
                        that.statusVal = comp;
                    }
                    $("#node-input-typed-status").typedInput('type',that.statusType);
                    $("#node-input-typed-status").typedInput('value',that.statusVal);
                    $("#node-tostatus-line").show();
                }
                else {
                    $("#node-tostatus-line").hide();
                    that.statusType = "auto";
                    that.statusVal = "";
                    $("#node-input-typed-status").typedInput('type',that.statusType);
                    $("#node-input-typed-status").typedInput('value',that.statusVal);
                }
            });
        },
        oneditsave: function() {
            var type = $("#node-input-typed-complete").typedInput('type');
            if (type === 'full') {
                $("#node-input-complete").val("true");
            } else {
                $("#node-input-complete").val($("#node-input-typed-complete").typedInput('value'));
            }
            $("#node-input-statusVal").val($("#node-input-typed-status").typedInput('value'));
        },
        onadd: function() {
            if (this.name === '_DEFAULT_') {
                this.name = ''
                RED.actions.invoke("core:generate-node-names", this, {generateHistory: false})
            }
        }
    });
})();
</script>
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-help-name="debug">
    <p>Displays selected message properties in the debug sidebar tab and optionally the runtime log. By default it displays <code>msg.payload</code>, but can be configured to display any property, the full message or the result of a JSONata expression.</p>
    <h3>Details</h3>
    <p>The debug sidebar provides a structured view of the messages it is sent, making it easier to understand their structure.</p>
    <p>JavaScript objects and arrays can be collapsed and expanded as required. Buffer objects can be displayed as raw data or as a string if possible.</p>
    <p>Alongside each message, the debug sidebar includes information about the time the message was received, the node that sent it and the type of the message.
       Clicking on the source node id will reveal that node within the workspace.</p>
    <p>The button on the node can be used to enable or disable its output. It is recommended to disable or remove any Debug nodes that are not being used.</p>
    <p>The node can also be configured to send all messages to the runtime log, or to send short (32 characters) to the status text under the debug node.</p>
</script>

<!-- --- [red-module:node-red/complete] --- -->
<script type="text/html" data-template-name="complete">
    <div class="form-row node-input-target-row">
        <button type="button" id="node-input-complete-target-select" class="red-ui-button" data-i18n="common.label.selectNodes"></button>
    </div>
    <div class="form-row node-input-target-row node-input-target-list-row" style="position: relative; min-height: 100px">
        <div style="position: absolute; top: -30px; right: 0;"><input type="text" id="node-input-complete-target-filter"></div>
        <div id="node-input-complete-target-container-div"></div>
    </div>

    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name">
    </div>
</script>
<script type="text/javascript">
    RED.nodes.registerType('complete',{
        category: 'common',
        color:"#c0edc0",
        defaults: {
            name: {value:""},
            scope: {
                value: [],
                type: "*[]",
                validate: function (v, opt) {
                    if (v.length > 0) {
                        return true;
                    }
                    return RED._("node-red:complete.errors.scopeUndefined");
                }
            },
            uncaught: {value:false}
        },
        inputs:0,
        outputs:1,
        icon: "alert.svg",
        label: function() {
            if (this.name) {
                return this.name;
            }
            return this._("complete.completeNodes",{number:this.scope.length});
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        oneditprepare: function() {
            var node = this;
            var scope = node.scope || [];

            this._resize = function() {
                var rows = $("#dialog-form>div:not(.node-input-target-list-row)");
                var height = $("#dialog-form").height();
                for (var i=0;i<rows.length;i++) {
                    height -= $(rows[i]).outerHeight(true);
                }
                var editorRow = $("#dialog-form>div.node-input-target-list-row");
                editorRow.css("height",height+"px");
            };
            var search = $("#node-input-complete-target-filter").searchBox({
                style: "compact",
                delay: 300,
                change: function() {
                    var val = $(this).val().trim().toLowerCase();
                    if (val === "") {
                        dirList.treeList("filter", null);
                        search.searchBox("count","");
                    } else {
                        var count = dirList.treeList("filter", function(item) {
                            return item.label.toLowerCase().indexOf(val) > -1 || item.node.type.toLowerCase().indexOf(val) > -1
                        });
                        search.searchBox("count",count+" / "+candidateNodes.length);
                    }
                }
            });

            var dirList = $("#node-input-complete-target-container-div").css({width: "100%", height: "100%"})
                .treeList({multi:true}).on("treelistitemmouseover", function(e, item) {
                    item.node.highlighted = true;
                    item.node.dirty = true;
                    RED.view.redraw();
                }).on("treelistitemmouseout", function(e, item) {
                    item.node.highlighted = false;
                    item.node.dirty = true;
                    RED.view.redraw();
                })
            var candidateNodes = RED.nodes.filterNodes({z:node.z});
            var allChecked = true;
            var items = [];
            var nodeItemMap = {};

            candidateNodes.forEach(function(n) {
                if (n.id === node.id) {
                    return;
                }
                var isChecked = scope.indexOf(n.id) !== -1;

                allChecked = allChecked && isChecked;

                var nodeDef = RED.nodes.getType(n.type);
                var label;
                var sublabel;
                if (nodeDef) {
                    var l = nodeDef.label;
                    label = (typeof l === "function" ? l.call(n) : l)||"";
                    sublabel = n.type;
                    if (sublabel.indexOf("subflow:") === 0) {
                        var subflowId = sublabel.substring(8);
                        var subflow = RED.nodes.subflow(subflowId);
                        sublabel = "subflow : "+subflow.name;
                    }
                }
                if (!nodeDef || !label) {
                    label = n.type;
                }
                nodeItemMap[n.id] = {
                    node: n,
                    label: label,
                    sublabel: sublabel,
                    selected: isChecked,
                    checkbox: true
                };
                items.push(nodeItemMap[n.id]);
            });
            dirList.treeList('data',items);

            $("#node-input-complete-target-select").on("click", function(e) {
                e.preventDefault();
                var preselected = dirList.treeList('selected').map(function(n) {return n.node.id});
                RED.tray.hide();
                RED.view.selectNodes({
                    selected: preselected,
                    onselect: function(selection) {
                        RED.tray.show();
                        var newlySelected = {};
                        selection.forEach(function(n) {
                            newlySelected[n.id] = true;
                            if (nodeItemMap[n.id]) {
                                nodeItemMap[n.id].treeList.select(true);
                            }
                        })
                        preselected.forEach(function(id) {
                            if (!newlySelected[id]) {
                                nodeItemMap[id].treeList.select(false);
                            }
                        })
                    },
                    oncancel: function() {
                        RED.tray.show();
                    },
                    filter: function(n) {
                        return n.id !== node.id;
                    }
                });
            })

        },
        oneditsave: function() {
            this.scope = $("#node-input-complete-target-container-div").treeList('selected').map(function(i) { return i.node.id})
        },
        oneditresize: function(size) {
            this._resize();
        }
    });
</script>
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-help-name="complete">
    <p>Trigger a flow when another node completes its handling of a message.</p>
    <h3>Details</h3>
    <p>If a node tells the runtime when it has finished handling a message,
        this node can be used to trigger a second flow.</p>
    <p>For example, this can be used alongside a node with no output port,
        such as the Email sending node, to continue the flow.</p>
    <p>This node must be configured to handle the event for selected nodes in the
        flow. Unlike the Catch node, it does not provide a 'handle all' mode automatically
        applies to all nodes in the flow.</p>
    <p>Not all nodes will trigger this event - it will depend on whether they
        have been implemented to support this feature as introduced in Node-RED 1.0.</p>
</script>

<!-- --- [red-module:node-red/catch] --- -->

<script type="text/html" data-template-name="catch">
    <div class="form-row">
        <label style="width: auto" for="node-input-scope" data-i18n="catch.label.source"></label>
        <select id="node-input-scope-select">
            <option value="all" data-i18n="catch.scope.all"></option>
            <option value="group" data-i18n="catch.scope.group"></option>
            <option value="target" data-i18n="catch.scope.selected"></option>
        </select>
    </div>
    <div class="form-row node-input-uncaught-row">
        <input type="checkbox" id="node-input-uncaught" style="display: inline-block; width: auto; vertical-align: top; margin-left: 30px; margin-right: 5px;">
        <label for="node-input-uncaught" style="width: auto" data-i18n="catch.label.uncaught"></label>
    </div>
    <div class="form-row node-input-target-row">
        <button type="button" id="node-input-catch-target-select" class="red-ui-button" data-i18n="common.label.selectNodes"></button>
    </div>
    <div class="form-row node-input-target-row node-input-target-list-row" style="position: relative; min-height: 100px">
        <div style="position: absolute; top: -30px; right: 0;"><input type="text" id="node-input-catch-target-filter"></div>
        <div id="node-input-catch-target-container-div"></div>
    </div>

    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name">
    </div>
</script>
<script type="text/javascript">
    RED.nodes.registerType('catch',{
        category: 'common',
        color:"#e49191",
        defaults: {
            name: {value:""},
            scope: {value:null, type:"*[]"},
            uncaught: {value:false}
        },
        inputs:0,
        outputs:1,
        icon: "alert.svg",
        label: function() {
            if (this.name) {
                return this.name;
            }
            if (this.scope === "group") {
                return this._("catch.catchGroup");
            } else if (Array.isArray(this.scope)) {
                return this._("catch.catchNodes",{number:this.scope.length});
            }
            return this.uncaught?this._("catch.catchUncaught"):this._("catch.catch")
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        oneditprepare: function() {
            var node = this;
            var scope = node.scope || [];

            this._resize = function() {
                var rows = $("#dialog-form>div:not(.node-input-target-list-row)");
                var height = $("#dialog-form").height();
                for (var i=0;i<rows.length;i++) {
                    height -= $(rows[i]).outerHeight(true);
                }
                var editorRow = $("#dialog-form>div.node-input-target-list-row");
                editorRow.css("height",height+"px");
            };
            var search = $("#node-input-catch-target-filter").searchBox({
                style: "compact",
                delay: 300,
                change: function() {
                    var val = $(this).val().trim().toLowerCase();
                    if (val === "") {
                        dirList.treeList("filter", null);
                        search.searchBox("count","");
                    } else {
                        var count = dirList.treeList("filter", function(item) {
                            return item.label.toLowerCase().indexOf(val) > -1 || item.node.type.toLowerCase().indexOf(val) > -1
                        });
                        search.searchBox("count",count+" / "+candidateNodes.length);
                    }
                }
            });
            var dirList = $("#node-input-catch-target-container-div").css({width: "100%", height: "100%"})
                .treeList({multi:true}).on("treelistitemmouseover", function(e, item) {
                    item.node.highlighted = true;
                    item.node.dirty = true;
                    RED.view.redraw();
                }).on("treelistitemmouseout", function(e, item) {
                    item.node.highlighted = false;
                    item.node.dirty = true;
                    RED.view.redraw();
                })
            var candidateNodes = RED.nodes.filterNodes({z:node.z});
            var allChecked = true;
            var items = [];
            var nodeItemMap = {};

            candidateNodes.forEach(function(n) {
                if (n.id === node.id) {
                    return;
                }
                var isChecked = scope.indexOf(n.id) !== -1;

                allChecked = allChecked && isChecked;

                var nodeDef = RED.nodes.getType(n.type);
                var label;
                var sublabel;
                if (nodeDef) {
                    var l = nodeDef.label;
                    label = (typeof l === "function" ? l.call(n) : l)||"";
                    sublabel = n.type;
                    if (sublabel.indexOf("subflow:") === 0) {
                        var subflowId = sublabel.substring(8);
                        var subflow = RED.nodes.subflow(subflowId);
                        sublabel = "subflow : "+subflow.name;
                    }
                }
                if (!nodeDef || !label) {
                    label = n.type;
                }
                nodeItemMap[n.id] = {
                    node: n,
                    label: label,
                    sublabel: sublabel,
                    selected: isChecked,
                    checkbox: true
                };
                items.push(nodeItemMap[n.id]);
            });
            dirList.treeList('data',items);

            $("#node-input-catch-target-select").on("click", function(e) {
                e.preventDefault();
                var preselected = dirList.treeList('selected').map(function(n) {return n.node.id});
                RED.tray.hide();
                RED.view.selectNodes({
                    selected: preselected,
                    onselect: function(selection) {
                        RED.tray.show();
                        var newlySelected = {};
                        selection.forEach(function(n) {
                            newlySelected[n.id] = true;
                            if (nodeItemMap[n.id]) {
                                nodeItemMap[n.id].treeList.select(true);
                            }
                        })
                        preselected.forEach(function(id) {
                            if (!newlySelected[id]) {
                                nodeItemMap[id].treeList.select(false);
                            }
                        })
                    },
                    oncancel: function() {
                        RED.tray.show();
                    },
                    filter: function(n) {
                        return n.id !== node.id;
                    }
                });
            })

            $("#node-input-scope-select").on("change", function(e) {
                var scope = $(this).val();
                if (scope === "target") {
                    $(".node-input-target-row").show();
                    $(".node-input-uncaught-row").hide();
                } else {
                    $(".node-input-target-row").hide();
                    $(".node-input-uncaught-row").show();
                }
                node._resize();
            });
            if (this.scope === null) {
                $("#node-input-scope-select").val("all");
            } else if(this.scope === "group"){
                $("#node-input-scope-select").val("group");
            } else {
                $("#node-input-scope-select").val("target");
            }
            $("#node-input-scope-select").trigger("change");
        },
        oneditsave: function() {
            var scope = $("#node-input-scope-select").val();
            if (scope === 'all') {
                this.scope = null;
            } else if(scope === 'group') {
                this.scope = "group";
            } else {
                $("#node-input-uncaught").prop("checked",false);
                this.scope = $("#node-input-catch-target-container-div").treeList('selected').map(function(i) { return i.node.id})
            }
        },
        oneditresize: function(size) {
            this._resize();
        }
    });
</script>
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-help-name="catch">
    <p>Catch errors thrown by nodes on the same tab.</p>
    <h3>Outputs</h3>
    <dl class="message-properties">
        <dt>error.message <span class="property-type">string</span></dt>
        <dd>the error message.</dd>
        <dt>error.source.id <span class="property-type">string</span></dt>
        <dd>the id of the node that threw the error.</dd>
        <dt>error.source.type <span class="property-type">string</span></dt>
        <dd>the type of the node that threw the error.</dd>
        <dt>error.source.name <span class="property-type">string</span></dt>
        <dd>the name, if set, of the node that threw the error.</dd>
    </dl>
    <h3>Details</h3>
    <p>If a node throws an error whilst handling a message, the flow will typically
       halt. This node can be used to catch those errors and handle them with a
       dedicated flow.</p>
    <p>By default, the node will catch errors thrown by any node on the same tab. Alternatively
    it can be targetted at specific nodes, or configured to only catch errors that
    have not already been caught by a 'targeted' catch node.</p>
    <p>When an error is thrown, all matching catch nodes will receive the message.</p>
    <p>If an error is thrown within a subflow, the error will get handled by any
       catch nodes within the subflow. If none exists, the error will be propagated
       up to the tab the subflow instance is on.</p>
   <p>If the message already has a <code>error</code> property, it is copied to <code>_error</code>.</p>
</script>

<!-- --- [red-module:node-red/status] --- -->

<script type="text/html" data-template-name="status">
    <div class="form-row">
        <label style="width: auto" for="node-input-scope" data-i18n="status.label.source"></label>
        <select id="node-input-scope-select">
            <option value="all" data-i18n="status.scope.all"></option>
            <option value="group" data-i18n="status.scope.group"></option>
            <option value="target" data-i18n="status.scope.selected"></option>
        </select>
    </div>
    <div class="form-row node-input-target-row">
        <button type="button" id="node-input-status-target-select" class="red-ui-button" data-i18n="common.label.selectNodes"></button>
    </div>
    <div class="form-row node-input-target-row node-input-target-list-row" style="position: relative; min-height: 100px">
        <div style="position: absolute; top: -30px; right: 0;"><input type="text" id="node-input-status-target-filter"></div>
        <div id="node-input-status-target-container-div"></div>
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name">
    </div>
</script>

<script type="text/javascript">
    RED.nodes.registerType('status',{
        category: 'common',
        color:"#94c1d0",
        defaults: {
            name: {value:""},
            scope: {value:null, type:"*[]"}
        },
        inputs:0,
        outputs:1,
        icon: "status.svg",
        label: function() {
            if (this.name) {
                return this.name;
            }
            if (this.scope === "group") {
                return this._("status.statusGroup");
            } else if (Array.isArray(this.scope)) {
                return this._("status.statusNodes",{number:this.scope.length});
            }
            return this._("status.status")
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        oneditprepare: function() {
            var node = this;
            var scope = node.scope || [];
            this._resize = function() {
                var rows = $("#dialog-form>div:not(.node-input-target-list-row)");
                var height = $("#dialog-form").height();
                for (var i=0;i<rows.length;i++) {
                    height -= $(rows[i]).outerHeight(true);
                }
                var editorRow = $("#dialog-form>div.node-input-target-list-row");
                editorRow.css("height",height+"px");
            };
            var search = $("#node-input-status-target-filter").searchBox({
                style: "compact",
                delay: 300,
                change: function() {
                    var val = $(this).val().trim().toLowerCase();
                    if (val === "") {
                        dirList.treeList("filter", null);
                        search.searchBox("count","");
                    } else {
                        var count = dirList.treeList("filter", function(item) {
                            return item.label.toLowerCase().indexOf(val) > -1 || item.node.type.toLowerCase().indexOf(val) > -1
                        });
                        search.searchBox("count",count+" / "+candidateNodes.length);
                    }
                }
            });

            var dirList = $("#node-input-status-target-container-div").css({width: "100%", height: "100%"})
                .treeList({multi:true}).on("treelistitemmouseover", function(e, item) {
                    item.node.highlighted = true;
                    item.node.dirty = true;
                    RED.view.redraw();
                }).on("treelistitemmouseout", function(e, item) {
                    item.node.highlighted = false;
                    item.node.dirty = true;
                    RED.view.redraw();
                })
            var candidateNodes = RED.nodes.filterNodes({z:node.z});
            var allChecked = true;
            var items = [];
            var nodeItemMap = {};

            candidateNodes.forEach(function(n) {
                if (n.id === node.id) {
                    return;
                }
                var isChecked = scope.indexOf(n.id) !== -1;

                allChecked = allChecked && isChecked;

                var nodeDef = RED.nodes.getType(n.type);
                var label;
                var sublabel;
                if (nodeDef) {
                    var l = nodeDef.label;
                    label = (typeof l === "function" ? l.call(n) : l)||"";
                    sublabel = n.type;
                    if (sublabel.indexOf("subflow:") === 0) {
                        var subflowId = sublabel.substring(8);
                        var subflow = RED.nodes.subflow(subflowId);
                        sublabel = "subflow : "+subflow.name;
                    }
                }
                if (!nodeDef || !label) {
                    label = n.type;
                }
                nodeItemMap[n.id] = {
                    node: n,
                    label: label,
                    sublabel: sublabel,
                    selected: isChecked,
                    checkbox: true
                };
                items.push(nodeItemMap[n.id]);
            });
            dirList.treeList('data',items);

            $("#node-input-status-target-select").on("click", function(e) {
                e.preventDefault();
                var preselected = dirList.treeList('selected').map(function(n) {return n.node.id});
                RED.tray.hide();
                RED.view.selectNodes({
                    selected: preselected,
                    onselect: function(selection) {
                        RED.tray.show();
                        var newlySelected = {};
                        selection.forEach(function(n) {
                            newlySelected[n.id] = true;
                            if (nodeItemMap[n.id]) {
                                nodeItemMap[n.id].treeList.select(true);
                            }
                        })
                        preselected.forEach(function(id) {
                            if (!newlySelected[id]) {
                                nodeItemMap[id].treeList.select(false);
                            }
                        })
                    },
                    oncancel: function() {
                        RED.tray.show();
                    },
                    filter: function(n) {
                        return n.id !== node.id;
                    }
                });
            })

            $("#node-input-scope-select").on("change", function(e) {
                var scope = $(this).val();
                if (scope === "target") {
                    $(".node-input-target-row").show();
                } else {
                    $(".node-input-target-row").hide();
                }
                node._resize();
            });
            if (this.scope === null) {
                $("#node-input-scope-select").val("all");
            } else if(this.scope === "group"){
                $("#node-input-scope-select").val("group");
            } else {
                $("#node-input-scope-select").val("target");
            }
            $("#node-input-scope-select").trigger("change");
        },
        oneditsave: function() {
            var scope = $("#node-input-scope-select").val();
            if (scope === 'all') {
                this.scope = null;
            } else if(scope === 'group') {
                this.scope = "group";
            } else {
                this.scope = $("#node-input-status-target-container-div").treeList('selected').map(function(i) { return i.node.id})
            }
        },
        oneditresize: function(size) {
            this._resize();
        }
    });
</script>
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-help-name="status">
    <p>Report status messages from other nodes on the same tab.</p>
    <h3>Outputs</h3>
    <dl class="message-properties">
        <dt>status.text <span class="property-type">string</span></dt>
        <dd>the status text.</dd>
        <dt>status.source.type <span class="property-type">string</span></dt>
        <dd>the type of the node that reported status.</dd>
        <dt>status.source.id <span class="property-type">string</span></dt>
        <dd>the id of the node that reported status.</dd>
        <dt>status.source.name <span class="property-type">string</span></dt>
        <dd>the name, if set, of the node that reported status.</dd>
    </dl>
    <h3>Details</h3>
   <p>This node does not produce a <code>payload</code>.</p>
   <p>By default the node reports status for all nodes on the same workspace tab.
   It can be configured to selectively report status for individual nodes.</p>
</script>

<!-- --- [red-module:node-red/link] --- -->
<script type="text/html" data-template-name="link in">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name">
    </div>
    <div style="position:relative; height: 30px; text-align: right;"><div style="display:inline-block"><input type="text" id="node-input-link-target-filter"></div></div>
    <div class="form-row node-input-link-row"></div>
</script>
<script type="text/html" data-template-name="link out">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name">
    </div>
    <div class="form-row">
        <label for="node-input-mode"><span data-i18n="link.outMode"></span></label>
        <select id="node-input-mode" style="width: 70%">
            <option value="link" selected data-i18n="link.sendToAll"></option>
            <option value="return" data-i18n="link.returnToCaller"></option>
        </select>
    </div>
    <div class="node-input-link-rows" style="position:relative; height: 30px; text-align: right;"><div style="display:inline-block"><input type="text" id="node-input-link-target-filter"></div></div>
    <div class="form-row node-input-link-row node-input-link-rows"></div>
</script>

<script type="text/html" data-template-name="link call">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name">
    </div>
    <div class="form-row">
        <label for="node-input-timeout"><i class="fa fa-clock-o"></i> <span data-i18n="exec.label.timeout"></span></label>
        <input type="text" id="node-input-timeout" placeholder="30" style="width: 70px; margin-right: 5px;"><span data-i18n="inject.seconds"></span>
    </div>
    <div class="form-row">
        <label for="node-input-linkType" data-i18n="link.linkCallType"></label>
        <select id="node-input-linkType" style="width: 70%">
            <option value="static" data-i18n="link.staticLinkCall"></option>
            <option value="dynamic" data-i18n="link.dynamicLinkCall"></option>
        </select>
    </div>
    <div class="link-call-target-tree" style="position:relative; height: 30px; text-align: right;">
        <div style="display:inline-block"><input type="text" id="node-input-link-target-filter"></div>
    </div>
    <div class="form-row node-input-link-row link-call-target-tree"></div>
</script>

<script type="text/javascript">
(function() {

    let treeList;

    function onEditPrepare(node,targetType) {
        if (!node.links) {
            node.links = [];
        }
        node.oldLinks = [];

        const activeSubflow = RED.nodes.subflow(node.z);

        treeList = $("<div>")
            .css({width: "100%", height: "100%"})
            .appendTo(".node-input-link-row")
            .treeList({autoSelect:false})
            .on('treelistitemmouseover',function(e,item) {
                if (item.node) {
                    item.node.highlighted = true;
                    item.node.dirty = true;
                    RED.view.redraw();
                }
            })
            .on('treelistitemmouseout',function(e,item) {
                if (item.node) {
                    item.node.highlighted = false;
                    item.node.dirty = true;
                    RED.view.redraw();
                }
            });
        const candidateNodes = RED.nodes.filterNodes({type:targetType});
        let candidateNodesCount = 0;

        const search = $("#node-input-link-target-filter").searchBox({
            style: "compact",
            delay: 300,
            change: function() {
                var val = $(this).val().trim().toLowerCase();
                if (val === "") {
                    treeList.treeList("filter", null);
                    search.searchBox("count","");
                } else {
                    const count = treeList.treeList("filter", function(item) {
                        return item.label.toLowerCase().indexOf(val) > -1 || (item.node && item.node.type.toLowerCase().indexOf(val) > -1)
                    });
                    search.searchBox("count",count+" / "+candidateNodesCount);
                }
            }
        });

        const flows = [];
        const flowMap = {};

        if (activeSubflow) {
            flowMap[activeSubflow.id] = {
                id: activeSubflow.id,
                class: 'red-ui-palette-header',
                label: "Subflow : " + (activeSubflow.name || activeSubflow.id),
                expanded: true,
                children: []
            };
            flows.push(flowMap[activeSubflow.id])
        }
        if (!activeSubflow || node.type === "link call") {
            // Only "Link Call" can look outside of its own subflow
            // Link In and Link Out nodes outside of a subflow should be ignored
            RED.nodes.eachWorkspace(function (ws) {
                flowMap[ws.id] = {
                    id: ws.id,
                    class: 'red-ui-palette-header',
                    label: (ws.label || ws.id) + (node.z === ws.id ? " *" : ""),
                    expanded: true,
                    children: []
                }
                flows.push(flowMap[ws.id])
            })
        }

        candidateNodes.forEach(function (n) {
            if (flowMap[n.z]) {
                if (targetType === "link out" && n.mode === 'return') {
                    // Link In nodes looking for Link Out nodes should not
                    // include return-mode nodes.
                    return;
                }
                const isChecked = (node.links.indexOf(n.id) !== -1) || (n.links || []).indexOf(node.id) !== -1;
                if (isChecked) {
                    node.oldLinks.push(n.id);
                }
                flowMap[n.z].children.push({
                    id: n.id,
                    node: n,
                    label: n.name || n.id,
                    selected: isChecked,
                    checkbox: node.type !== "link call",
                    radio: node.type === "link call"
                })
                candidateNodesCount++;
            }
        });
        const flowsFiltered = flows.filter(function(f) { return f.children.length > 0 })
        treeList.treeList('data',flowsFiltered);
        setTimeout(function() {
            treeList.treeList('show',node.z);
        },100);
    }

    function resizeNodeList() {
        var rows = $("#dialog-form>div:not(.node-input-link-row)");
        var height = $("#dialog-form").height();
        for (var i=0;i<rows.length;i++) {
            height -= $(rows[i]).outerHeight(true);
        }
        var editorRow = $("#dialog-form>div.node-input-link-row");
        height -= (parseInt(editorRow.css("marginTop"))+parseInt(editorRow.css("marginBottom")));
        $(".node-input-link-row").css("height",height+"px");
    }

    function onEditSave(node) {
        var flows = treeList.treeList('data');
        node.links = [];
        if (node.type !== "link out" || $("#node-input-mode").val() === 'link') {
            flows.forEach(function(f) {
                f.children.forEach(function(n) {
                    if (n.selected) {
                        node.links.push(n.id);
                    }
                })
            })
        }
        node.oldLinks.sort();
        node.links.sort();

        if (node.type === "link call") {
            return
        }

        var nodeMap = {};
        var length = Math.max(node.oldLinks.length,node.links.length);
        for (var i=0;i<length;i++) {
            if (i<node.oldLinks.length) {
                nodeMap[node.oldLinks[i]] = nodeMap[node.oldLinks[i]]||{};
                nodeMap[node.oldLinks[i]].old = true;
            }
            if (i<node.links.length) {
                nodeMap[node.links[i]] = nodeMap[node.links[i]]||{};
                nodeMap[node.links[i]].new = true;
            }
        }

        let editHistories = []
        let n;
        for (let id in nodeMap) {
            if (nodeMap.hasOwnProperty(id)) {
                n = RED.nodes.node(id);
                if (n) {
                    editHistories.push({
                        t:'edit',
                        node: n,
                        changes: {
                            links: [...n.links]
                        },
                        changed: n.changed
                    })
                    if (nodeMap[id].old && !nodeMap[id].new) {
                        // Removed id
                        i = n.links.indexOf(node.id);
                        if (i > -1) {
                            n.links.splice(i,1);
                            n.changed = true
                            n.dirty = true
                        }
                    } else if (!nodeMap[id].old && nodeMap[id].new) {
                        // Added id
                        i = n.links.indexOf(id);
                        if (i === -1) {
                            n.links.push(node.id);
                            n.changed = true
                            n.dirty = true
                        }
                    }
                }
            }
        }
        if (editHistories.length > 0) {
            return {
                history: editHistories
            }
        }
    }

    function onAdd() {
        if (this.name === '_DEFAULT_') {
            this.name = ''
            RED.actions.invoke("core:generate-node-names", this, {generateHistory: false})
        }
        for (var i=0;i<this.links.length;i++) {
            var n = RED.nodes.node(this.links[i]);
            if (n && n.links.indexOf(this.id) === -1) {
                n.links.push(this.id);
            }
        }
    }

    RED.nodes.registerType('link in',{
        category: 'common',
        color:"#ddd",//"#87D8CF",
        defaults: {
            name: { value: "_DEFAULT_" },
            links: { value: [], type:"link out[]" }
        },
        inputs:0,
        outputs:1,
        icon: "link-out.svg",
        outputLabels: function(i) {
            return this.name||this._("link.linkIn");
        },
        showLabel: false,
        label: function() {
            return this.name||this._("link.linkIn");
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        oneditprepare: function() {
            onEditPrepare(this,"link out");
        },
        oneditsave: function() {
            const result = onEditSave(this);
            // In case the name has changed, ensure any link call nodes on this
            // tab are redrawn with the updated name
            var localCallNodes = RED.nodes.filterNodes({z:RED.workspaces.active(), type:"link call"});
            localCallNodes.forEach(function(node) {
                node.dirty = true;
            });
            return result
        },
        onadd: onAdd,
        oneditresize: resizeNodeList
    });

    RED.nodes.registerType('link call',{
        category: 'common',
        color:"#ddd",//"#87D8CF",
        defaults: {
            name: { value: "" },
            links: {
                value: [],
                type: "link in[]",
                validate: function (v, opt) {
                    if (((this.linkType || "static") === "static" && v.length > 0)
                      || this.linkType === "dynamic") {
                        return true;
                    }
                    return RED._("node-red:link.errors.linkUndefined");
                }
            },
            linkType: { value:"static" },
            timeout: {
                value: "30",
                label: RED._("node-red:link.timeout"),
                validate:RED.validators.number(true)
            }
        },
        inputs: 1,
        outputs: 1,
        icon: "link-call.svg",
        inputLabels: function(i) {
            return this.name||this._("link.linkCall");
        },
        label: function() {
            if (this.name) {
                return this.name;
            }
            if (this.linkType === "dynamic") {
                return this._("link.dynamicLinkLabel");
            } else if (this.links.length > 0) {
                var targetNode = RED.nodes.node(this.links[0]);
                return targetNode && (targetNode.name || this._("link.linkCall"));
            }
            return this._("inject.none");
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        oneditprepare: function() {
            const updateVisibility = function() {
                const static = $('#node-input-linkType').val() !== "dynamic";
                if(static) {
                    $("div.link-call-target-tree").show();
                } else {
                    $("div.link-call-target-tree").hide();
                }
            }
            $("#node-input-linkType").on("change",function(d){
                updateVisibility();
            });
            if (["static","dynamic"].indexOf(this.linkType) < 0) {
                $("#node-input-linkType").val('static');
            }
            updateVisibility();
            onEditPrepare(this,"link in");
        },
        oneditsave: function() {
            return onEditSave(this);
        },
        oneditresize: resizeNodeList
    });

    RED.nodes.registerType('link out',{
        category: 'common',
        color:"#ddd",//"#87D8CF",
        defaults: {
            name: { value:"_DEFAULT_" },
            mode: { value: "link" },// link || return
            links: { value: [], type:"link in[]" }
        },
        align:"right",
        inputs:1,
        outputs:0,
        icon: function() {
            if (this.mode === "return") {
                return "link-return.svg";
            } else {
                return "link-out.svg";
            }
        },
        inputLabels: function(i) {
            return this.name||(this.mode === "return" ?this._("link.linkOutReturn"):this._("link.linkOut"));
        },
        showLabel: false,
        label: function() {
            return this.name||(this.mode === "return" ?this._("link.linkOutReturn"):this._("link.linkOut"));
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        oneditprepare: function() {
            onEditPrepare(this,"link in");
            $("#node-input-mode").on("change", function() {
                $(".node-input-link-rows").toggle(this.value === "link")
            })
            if (!this.mode) {
                $("#node-input-mode").val('link').trigger("change");
            }

        },
        oneditsave: function() {
            return onEditSave(this);
        },
        onadd: onAdd,
        oneditresize: resizeNodeList
    });



})();
</script>
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-help-name="link in">
    <p>Create virtual wires between flows.</p>
    <h3>Details</h3>
    <p>The node can be connected to any <code>link out</code> node that exists on any tab.
       Once connected, they behave as if they were wired together.</p>
    <p>The wires between link nodes are only displayed when a link node is selected.
       If there are any wires to other tabs, a virtual node is shown that can be clicked
       on to jump to the appropriate tab.</p>
    <p><b>Note: </b>Links cannot be created going into, or out of, a subflow.</p>
</script>

<script type="text/html" data-help-name="link out">
    <p>Create virtual wires between flows.</p>
    <h3>Details</h3>
    <p>This node can be configured to either send messages to all <code>link in</code>
       nodes it is connected to, or to send a response back to the <code>link call</code>
       node that triggered the flow.</p>
    <p>When in 'send to all' mode, the wires between link nodes are only displayed when
       the node is selected. If there are any wires to other tabs, a virtual node
       is shown that can be clicked on to jump to the appropriate tab.</p>
    <p><b>Note: </b>Links cannot be created going into, or out of, a subflow.</p>
</script>

<script type="text/html" data-help-name="link call">
    <p>Calls a flow that starts with a <code>link in</code> node and passes on the response.</p>
    <h3>Inputs</h3>
    <dl class="message-properties">
      <dt class="optional">target<span class="property-type">string</span></dt>
      <dd>When the option <b>Link Type</b> is set to "Dynamic target", set <code>msg.target</code> to the name of the
          <code>link in</code> node you wish to call.</dd>
    </dl>
    <h3>Details</h3>
    <p>This node can be connected to a <code>link in</code> node that exists on any tab.
       The flow connected to that node must end with a <code>link out</code> node configured
       in 'return' mode.</p>
    <p>When this node receives a message, it is passed to the connected <code>link in</code> node.
       It then waits for a response which it then sends on.</p>
    <p>If no response is received within the configured timeout, default 30 seconds, the node
       will log an error that can be caught using the <code>catch</code> node.</p>
    <p>When the option <b>Link Type</b> is set to "Dynamic target" <code>msg.target</code> can be used to call a
       <code>link in</code> by name or id.
    <ul>
      <li>If there is a <code>link in</code> nodes with the same id, it will be called</li>
      <li>If there are two or more <code>link in</code> nodes with the same name, an error will be raised</li>
      <li>A <code>link call</code> cannot call a <code>link in</code> node inside a subflow</li>
    </ul>
    </p>
    The flow connected to that node must end with a <code>link out</code> node configured
    in 'return' mode.</p>
</script>

<!-- --- [red-module:node-red/comment] --- -->

<script type="text/html" data-template-name="comment">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name">
    </div>
    <div class="form-row node-text-editor-row">
        <input type="hidden" id="node-input-info" autofocus="autofocus">
        <div style="height: 250px; min-height:150px;" class="node-text-editor" id="node-input-info-editor"></div>
    </div>
</script>

<script type="text/javascript">
    RED.nodes.registerType('comment',{
        category: 'common',
        color:"#ffffff",
        defaults: {
            name: {value:""},
            info: {value:""}
        },
        inputs:0,
        outputs:0,
        icon: "comment.svg",
        label: function() {
            return this.name||this._("comment.comment");
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        info: function() {
            return this.name?"# "+this.name+"\n\n---\n\n":"";
        },
        oneditprepare: function() {
            var that = this;
            this.editor = RED.editor.createEditor({
                id: 'node-input-info-editor',
                mode: 'ace/mode/markdown',
                value: $("#node-input-info").val()
            });
            this.editor.focus();
        },
        oneditsave: function() {
            $("#node-input-info").val(this.editor.getValue());
            this.editor.destroy();
            delete this.editor;
        },
        oneditcancel: function() {
            this.editor.destroy();
            delete this.editor;
        },
        oneditresize: function(size) {
            var rows = $("#dialog-form>div:not(.node-text-editor-row)");
            var height = $("#dialog-form").height();
            for (var i=0; i<rows.length; i++) {
                height -= $(rows[i]).outerHeight(true);
            }
            var editorRow = $("#dialog-form>div.node-text-editor-row");
            height -= (parseInt(editorRow.css("marginTop"))+parseInt(editorRow.css("marginBottom")));
            $(".node-text-editor").css("height",height+"px");
            this.editor.resize();
        }
    });
</script>
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-help-name="comment">
    <p>A node you can use to add comments to your flows.</p>
    <h3>Details</h3>
    <p>The edit panel will accept Markdown syntax. The text will be rendered into
    the information side panel.</p>
</script>

<!-- --- [red-module:node-red/global-config] --- -->
<script type="text/html" data-template-name="global-config">
　　<div class="form-row">
        <label style="width: 100%"><span data-i18n="global-config.label.open-conf"></span>:</label>
    </div>
    <div class="form-row">
        <button class="red-ui-button" type="button" id="node-input-edit-env-var" data-i18n="editor:env-var.header" style="margin-left: 20px"></button>
    </div>
</script>

<script type="text/javascript">
    RED.nodes.registerType('global-config',{
        category: 'config',
        defaults: {
            name: { value: "" },
            env: { value: [] },
        },
        credentials: {
            map: { type: "map" }
        },
        oneditprepare: function() {
            $('#node-input-edit-env-var').on('click', function(evt) {
                RED.actions.invoke('core:show-user-settings', 'envvar')
            });
        },
        hasUsers: false
    });
</script>
<script type="text/html" data-help-name="global-config">
    <p>A node for holding global configuration of flows.</p>
</script>

<!-- --- [red-module:node-red/unknown] --- -->

<script type="text/html" data-template-name="unknown">
    <div class="form-tips"><span data-i18n="[html]unknown.tip"></span></div>
</script>

<script type="text/javascript">
    RED.nodes.registerType('unknown',{
        category: 'unknown',
        color:"#fff0f0",
        defaults: {
            name: {value:""}
        },
        inputs:1,
        outputs:1,
        icon: "",
        label: function() {
            return "("+this.name+")"||this._("unknown.label.unknown");
        },
        labelStyle: function() {
            return "node_label_unknown";
        }
    });
</script>
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-help-name="unknown">
    <p>This node is a type unknown to your installation of Node-RED.</p>
    <h3>Details</h3>
    <p><i>If you deploy with the node in this state, its configuration will be preserved, but
    the flow will not start until the missing type is installed.</i></p>
    <p>Use the <code>Menu - Manage Palette</code> option
    to search for and install nodes, or <b>npm install &lt;module&gt;</b> to
    install, any missing modules and restart Node-RED and reimport the nodes.</p>
    <p>It is possible this node type is already installed, but is missing a dependency. Check the Node-RED start-up
    log for any error messages associated with the missing node type.</p>
    <p>Otherwise, you should contact the author of the flow to obtain a copy of the missing node type.</p>
</script>

<!-- --- [red-module:node-red/function] --- -->
<script type="text/html" data-template-name="function">
    <style>
        .func-tabs-row {
            margin-bottom: 0;
        }
        #node-input-libs-container-row .red-ui-editableList-container {
            padding: 0px;
        }
        #node-input-libs-container-row .red-ui-editableList-container li {
            padding:0px;
        }
        #node-input-libs-container-row .red-ui-editableList-item-remove {
            right: 5px;
        }

        #node-input-libs-container-row .red-ui-editableList-header {
            display: flex;
            background: var(--red-ui-tertiary-background);
            padding-right: 75px;
            border-top-left-radius: 3px;
            border-top-right-radius: 3px;
        }
        #node-input-libs-container-row .red-ui-editableList-header > div {
            flex-grow: 1;
        }

        .node-libs-entry {
            display: flex;
        }

        .node-libs-entry .red-ui-typedInput-container {
            border-radius: 0;
            border: none;
        }
        .node-libs-entry .red-ui-typedInput-type-select {
            border-radius: 0 !important;
            height: 34px;
        }
        .node-libs-entry > span > input[type=text] {
            border-radius: 0;
            border-top-color: var(--red-ui-form-background);
            border-bottom-color: var(--red-ui-form-background);
            border-right-color: var(--red-ui-form-background);
        }
        .node-libs-entry > span > input[type=text].input-error {
        }
        .node-libs-entry > span {
            flex-grow: 1;
            width: 50%;
            position: relative;
        }
        .node-libs-entry span .node-input-libs-var, .node-libs-entry span .red-ui-typedInput-container {
            width: 100%;
        }
        .node-libs-entry > span > span > i {
            display: none;
        }
        .node-libs-entry > span > span.input-error > i {
            display: inline;
        }

    </style>
    <input type="hidden" id="node-input-func">
    <input type="hidden" id="node-input-noerr">
    <input type="hidden" id="node-input-finalize">
    <input type="hidden" id="node-input-initialize">

    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <div style="display: inline-block; width: calc(100% - 105px)"><input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name"></div>
    </div>


    <div class="form-row func-tabs-row">
        <ul style="min-width: 600px; margin-bottom: 20px;" id="func-tabs"></ul>
    </div>
    <div id="func-tabs-content" style="min-height: calc(100% - 95px);">

        <div id="func-tab-config" style="display:none">
            <div>
                <div class="form-row" style="display: inline-block; margin-right: 50px;">
                    <label for="node-input-outputs"><i class="fa fa-random"></i> <span data-i18n="function.label.outputs"></span></label>
                    <input id="node-input-outputs" style="width: 60px;" value="1">
                </div>
                <div class="form-row" style="display: inline-block;">
                    <label for="node-input-timeout"><i class="fa fa-clock-o"></i> <span data-i18n="function.label.timeout"></span></label>
                    <input id="node-input-timeout" style="width: 60px;" data-i18n="[placeholder]join.seconds">
                </div>
            </div>

            <div class="form-row node-input-libs-row hide" style="margin-bottom: 0px;">
                <label><i class="fa fa-cubes"></i> <span data-i18n="function.label.modules"></span></label>
            </div>
            <div class="form-row node-input-libs-row hide" id="node-input-libs-container-row">
                <ol id="node-input-libs-container"></ol>
            </div>
        </div>

        <div id="func-tab-init" style="display:none">
            <div class="form-row node-text-editor-row" style="position:relative">
                <div style="height: 250px; min-height:150px;" class="node-text-editor" id="node-input-init-editor" ></div>
                <div style="position: absolute; right:0; bottom: calc(100% - 20px); z-Index: 10;"><button type="button" id="node-init-expand-js" class="red-ui-button red-ui-button-small"><i class="fa fa-expand"></i></button></div>
            </div>
        </div>

        <div id="func-tab-body" style="display:none">
            <div class="form-row node-text-editor-row" style="position:relative">
                <div style="height: 220px; min-height:150px;" class="node-text-editor" id="node-input-func-editor" ></div>
                <div style="position: absolute; right:0; bottom: calc(100% - 20px); z-Index: 10;"><button type="button" id="node-function-expand-js" class="red-ui-button red-ui-button-small"><i class="fa fa-expand"></i></button></div>
            </div>
        </div>

        <div id="func-tab-finalize" style="display:none">
            <div class="form-row node-text-editor-row" style="position:relative">
                <div style="height: 250px; min-height:150px;" class="node-text-editor" id="node-input-finalize-editor" ></div>
                <div style="position: absolute; right:0; bottom: calc(100% - 20px); z-Index: 10;"><button type="button" id="node-finalize-expand-js" class="red-ui-button red-ui-button-small"><i class="fa fa-expand"></i></button></div>
            </div>
        </div>

    </div>
</script>

<script type="text/javascript">

(function() {

    var invalidModuleVNames = [
        'console',
        'util',
        'Buffer',
        'Date',
        'RED',
        'node',
        '__node__',
        'context',
        'flow',
        'global',
        'env',
        'setTimeout',
        'clearTimeout',
        'setInterval',
        'clearInterval',
        'promisify'
    ]

    var knownFunctionNodes = {};
    RED.events.on("nodes:add", function(n) {
        if (n.type === "function") {
            knownFunctionNodes[n.id] = n;
        }
    })
    RED.events.on("nodes:remove", function(n) {
        if (n.type === "function") {
            delete knownFunctionNodes[n.id];
        }
    })

    var missingModules = [];
    var missingModuleReasons = {};
    RED.events.on("runtime-state", function(event) {
        if (event.error === "missing-modules") {
            missingModules = event.modules.map(function(m) { missingModuleReasons[m.module] = m.error; return m.module });
            for (var id in knownFunctionNodes) {
                if (knownFunctionNodes.hasOwnProperty(id) && knownFunctionNodes[id].libs && knownFunctionNodes[id].libs.length > 0) {
                    RED.editor.validateNode(knownFunctionNodes[id])
                }
            }
        } else if (!event.text) {
            missingModuleReasons = {};
            missingModules = [];
            for (var id in knownFunctionNodes) {
                if (knownFunctionNodes.hasOwnProperty(id) && knownFunctionNodes[id].libs && knownFunctionNodes[id].libs.length > 0) {
                    RED.editor.validateNode(knownFunctionNodes[id])
                }
            }
        }
        RED.view.redraw();
    });

    var installAllowList = ['*'];
    var installDenyList = [];

    var modulesEnabled = true;
    if (RED.settings.get('externalModules.modules.allowInstall', true) === false) {
        modulesEnabled = false;
    }
    var settingsAllowList = RED.settings.get("externalModules.modules.allowList")
    var settingsDenyList = RED.settings.get("externalModules.modules.denyList")
    if (settingsAllowList || settingsDenyList) {
        installAllowList = settingsAllowList;
        installDenyList = settingsDenyList
    }
    installAllowList = RED.utils.parseModuleList(installAllowList);
    installDenyList = RED.utils.parseModuleList(installDenyList);


    // object that maps from library name to its descriptor
    var allLibs = [];

    function moduleName(module) {
        var match = /^([^@]+)@(.+)/.exec(module);
        if (match) {
            return [match[1], match[2]];
        }
        return [module, undefined];
    }

    function getAllUsedModules() {
        var moduleSet = new Set();
        for (var id in knownFunctionNodes) {
            if (knownFunctionNodes.hasOwnProperty(id)) {
                if (knownFunctionNodes[id].libs) {
                    for (var i=0, l=knownFunctionNodes[id].libs.length; i<l; i++) {
                        if (RED.utils.checkModuleAllowed(knownFunctionNodes[id].libs[i].module,null,installAllowList,installDenyList)) {
                            moduleSet.add(knownFunctionNodes[id].libs[i].module);
                        }
                    }
                }
            }
        }
        var modules = Array.from(moduleSet);
        modules.sort();
        return modules;
    }

    function prepareLibraryConfig(node) {
        $(".node-input-libs-row").show();
        var usedModules = getAllUsedModules();
        var typedModules = usedModules.map(function(l) {
            return {icon:"fa fa-cube", value:l,label:l,hasValue:false}
        })
        typedModules.push({
            value:"_custom_", label:RED._("editor:subflow.licenseOther"), icon:"red/images/typedInput/az.svg"
        })

        var libList = $("#node-input-libs-container").css('min-height','100px').css('min-width','450px').editableList({
            header: $('<div><div data-i18n="node-red:function.require.moduleName"></div><div data-i18n="node-red:function.require.importAs"></div></div>'),
            addItem: function(container,i,opt) {
                var parent = container.parent();
                var row0 = $("<div/>").addClass("node-libs-entry").appendTo(container);
                var fmoduleSpan = $("<span>").appendTo(row0);
                var fmodule = $("<input/>", {
                    class: "node-input-libs-val",
                    placeholder: RED._("node-red:function.require.module"),
                    type: "text"
                }).css({
                }).appendTo(fmoduleSpan).typedInput({
                    types: typedModules,
                    default: usedModules.indexOf(opt.module) > -1 ? opt.module : "_custom_"
                });
                if (usedModules.indexOf(opt.module) === -1) {
                    fmodule.typedInput('value', opt.module);
                }
                var moduleWarning = $('<span style="position: absolute;right:2px;top:7px; display:inline-block; width: 16px;"><i class="fa fa-warning"></i></span>').appendTo(fmoduleSpan);
                RED.popover.tooltip(moduleWarning.find("i"),function() {
                    var val = fmodule.typedInput("type");
                    if (val === "_custom_") {
                        val = fmodule.val();
                    }
                    var errors = [];

                    if (!RED.utils.checkModuleAllowed(val,null,installAllowList,installDenyList)) {
                        return RED._("node-red:function.error.moduleNotAllowed",{module:val});
                    } else {
                        return RED._("node-red:function.error.moduleLoadError",{module:val,error:missingModuleReasons[val]});
                    }
                })

                var fvarSpan = $("<span>").appendTo(row0);

                var fvar = $("<input/>", {
                    class: "node-input-libs-var red-ui-font-code",
                    placeholder: RED._("node-red:function.require.var"),
                    type: "text"
                }).css({
                }).appendTo(fvarSpan).val(opt.var);
                var vnameWarning = $('<span style="position: absolute; right:2px;top:7px;display:inline-block; width: 16px;"><i class="fa fa-warning"></i></span>').appendTo(fvarSpan);
                RED.popover.tooltip(vnameWarning.find("i"),function() {
                    var val = fvar.val();
                    if (invalidModuleVNames.indexOf(val) !== -1) {
                        return RED._("node-red:function.error.moduleNameReserved",{name:val})
                    } else {
                        return RED._("node-red:function.error.moduleNameError",{name:val})
                    }
                })



                fvar.on("change keyup paste", function (e) {
                    var v = $(this).val().trim();
                    if (v === "" || / /.test(v) || invalidModuleVNames.indexOf(v) !== -1) {
                        fvar.addClass("input-error");
                        vnameWarning.addClass("input-error");
                    } else {
                        fvar.removeClass("input-error");
                        vnameWarning.removeClass("input-error");
                    }
                });

                fmodule.on("change keyup paste", function (e) {
                    var val = $(this).typedInput("type");
                    if (val === "_custom_") {
                        val = $(this).val();
                    }
                    var varName = val.trim().replace(/^@/,"").replace(/@.*$/,"").replace(/[-_/\.].?/g, function(v) { return v[1]?v[1].toUpperCase():"" });
                    fvar.val(varName);
                    fvar.trigger("change");

                    if (RED.utils.checkModuleAllowed(val,null,installAllowList,installDenyList) && (missingModules.indexOf(val) === -1)) {
                        fmodule.removeClass("input-error");
                        moduleWarning.removeClass("input-error");
                    } else {
                        fmodule.addClass("input-error");
                        moduleWarning.addClass("input-error");
                    }
                });
                if (RED.utils.checkModuleAllowed(opt.module,null,installAllowList,installDenyList) && (missingModules.indexOf(opt.module) === -1)) {
                    fmodule.removeClass("input-error");
                    moduleWarning.removeClass("input-error");
                } else {
                    fmodule.addClass("input-error");
                    moduleWarning.addClass("input-error");
                }
                if (opt.var) {
                    fvar.trigger("change");
                }
            },
            removable: true
        });

        var libs = node.libs || [];
        for (var i=0,l=libs.length;i<l; i++) {
            libList.editableList('addItem',libs[i])
        }

    }

    function getLibsList() {
        var _libs = [];
        if (RED.settings.functionExternalModules !== false) {
            var libs = $("#node-input-libs-container").editableList("items");
            libs.each(function(i) {
                var item = $(this);
                var v = item.find(".node-input-libs-var").val();
                var n = item.find(".node-input-libs-val").typedInput("type");
                if (n === "_custom_") {
                    n = item.find(".node-input-libs-val").val();
                }
                if ((!v || (v === "")) ||
                    (!n || (n === ""))) {
                    return;
                }
                _libs.push({
                    var: v,
                    module: n
                });
            });
        }
        return _libs;
    }

    RED.nodes.registerType('function',{
        color:"#fdd0a2",
        category: 'function',
        defaults: {
            name: {value:"_DEFAULT_"},
            func: {value:"%% Code here is wrapped in a fun (Msg) call\n%% fun (Msg) ->\n    Msg\n%% end.\n"},
            outputs: {value:1},
            timeout:{value:RED.settings.functionTimeout || 0},
            noerr: {value:0,required:true,
                    validate: function(v, opt) {
                        if (!v) {
                            return true;
                        }
                        return RED._("node-red:function.error.invalid-js");
                    }},
            initialize: {value:""},
            finalize: {value:""},
            libs: {value: [], validate: function(v, opt) {
                if (!v) { return true; }
                for (var i=0,l=v.length;i<l;i++) {
                    var m = v[i];
                    if (!RED.utils.checkModuleAllowed(m.module,null,installAllowList,installDenyList)) {
                        return RED._("node-red:function.error.moduleNotAllowed", {
                            module: m.module
                        });
                    }
                    if (m.var === "" || / /.test(m.var)) {
                        return RED._("node-red:function.error.moduleNameError", {
                            name: m.var
                        });
                    }
                    if (missingModules.indexOf(m.module) > -1) {
                        return RED._("node-red:function.error.missing-module", {
                            module: m.module
                        });
                    }
                    if (invalidModuleVNames.indexOf(m.var) !== -1){
                        return RED._("node-red:function.error.moduleNameError", {
                            name: m.var
                        });
                    }
                }
                return true;
            }}
        },
        inputs:1,
        outputs:1,
        icon: "function.svg",
        label: function() {
            return this.name||this._("function.function");
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        oneditprepare: function() {
            var that = this;

            var tabs = RED.tabs.create({
                id: "func-tabs",
                onchange: function(tab) {
                    $("#func-tabs-content").children().hide();
                    $("#" + tab.id).show();
                    let editor = $("#" + tab.id).find('.monaco-editor').first();
                    if(editor.length) {
                        if(that.editor.nodered && that.editor.type == "monaco") {
                            that.editor.nodered.refreshModuleLibs(getLibsList());
                        }
                        RED.tray.resize();
                        //auto focus editor on tab switch
                        if (that.initEditor.getDomNode() == editor[0]) {
                            that.initEditor.focus();
                        } else if (that.editor.getDomNode() == editor[0]) {
                            that.editor.focus();
                        } else if (that.finalizeEditor.getDomNode() == editor[0]) {
                            that.finalizeEditor.focus();
                        }
                    }
                }
            });
            tabs.addTab({
                id: "func-tab-config",
                iconClass: "fa fa-cog",
                label: that._("function.label.setup")
            });

            tabs.addTab({
                id: "func-tab-init",
                label: that._("function.label.initialize")
            });
            tabs.addTab({
                id: "func-tab-body",
                label: that._("function.label.function")
            });
            tabs.addTab({
                id: "func-tab-finalize",
                label: that._("function.label.finalize")
            });

            tabs.activateTab("func-tab-body");

            $( "#node-input-outputs" ).spinner({
                min: 0,
                max: 500,
                change: function(event, ui) {
                    var value = parseInt(this.value);
                    value = isNaN(value) ? 1 : value;
                    value = Math.max(value, parseInt($(this).attr("aria-valuemin")));
                    value = Math.min(value, parseInt($(this).attr("aria-valuemax")));
                    if (value !== this.value) { $(this).spinner("value", value); }
                }
            });

            // 4294967 is max in node.js timeout.
            $( "#node-input-timeout" ).spinner({
                min: 0,
                max: 4294967,
                change: function(event, ui) {
                    var value = this.value;
                    if(value == ""){
                        value = 0;
                    }
                    else
                    {
                        value = parseInt(value);
                    }
                    value = isNaN(value) ? 1 : value;
                    value = Math.max(value, parseInt($(this).attr("aria-valuemin")));
                    value = Math.min(value, parseInt($(this).attr("aria-valuemax")));
                    if (value !== this.value) { $(this).spinner("value", value); }
                }
            });

            var buildEditor = function(id, stateId, focus, value, defaultValue, extraLibs, offset) {
                var editor = RED.editor.createEditor({
                    id: id,
                    mode: 'ace/mode/erlang',
                    value: value || defaultValue || "",
                    stateId: stateId,
                    focus: true,
                    globals: {
                        msg:true,
                        context:true,
                        RED: true,
                        util: true,
                        flow: true,
                        global: true,
                        console: true,
                        Buffer: true,
                        setTimeout: true,
                        clearTimeout: true,
                        setInterval: true,
                        clearInterval: true
                    },
                    extraLibs: extraLibs
                });
                if (defaultValue && value === "") {
                    editor.moveCursorTo(defaultValue.split("\n").length +offset, 0);
                }
                editor.__stateId = stateId;
                return editor;
            }
            this.initEditor = buildEditor('node-input-init-editor', this.id + "/" + "initEditor", false, $("#node-input-initialize").val(), RED._("node-red:function.text.initialize"), undefined, 0);
            this.editor = buildEditor('node-input-func-editor', this.id + "/" + "editor", true, $("#node-input-func").val(), undefined, that.libs || [], undefined, -1);
            this.finalizeEditor = buildEditor('node-input-finalize-editor', this.id + "/" + "finalizeEditor", false, $("#node-input-finalize").val(), RED._("node-red:function.text.finalize"), undefined, 0);

            RED.library.create({
                url:"functions", // where to get the data from
                type:"function", // the type of object the library is for
                editor:this.editor, // the field name the main text body goes to
                mode:"ace/mode/erlang",
                fields:[
                    'name', 'outputs', 'timeout',
                    {
                        name: 'initialize',
                        get: function() {
                            return that.initEditor.getValue();
                        },
                        set: function(v) {
                            that.initEditor.setValue(v||RED._("node-red:function.text.initialize"), -1);
                        }
                    },
                    {
                        name: 'finalize',
                        get: function() {
                            return that.finalizeEditor.getValue();
                        },
                        set: function(v) {
                            that.finalizeEditor.setValue(v||RED._("node-red:function.text.finalize"), -1);
                        }
                    },
                    {
                        name: 'info',
                        get: function() {
                            return that.infoEditor.getValue();
                        },
                        set: function(v) {
                            that.infoEditor.setValue(v||"", -1);
                        }
                    }
                ],
                ext:"js"
            });

            var expandButtonClickHandler = function(editor) {
                return function (e) {
                    e.preventDefault();
                    var value = editor.getValue();
                    editor.saveView(`inside function-expandButtonClickHandler ${editor.__stateId}`);
                    var extraLibs = that.libs || [];
                    RED.editor.editJavaScript({
                        value: value,
                        width: "Infinity",
                        stateId: editor.__stateId,
                        mode: "ace/mode/erlang",
                        focus: true,
                        cancel: function () {
                            setTimeout(function () {
                                editor.focus();
                            }, 250);
                        },
                        complete: function (v, cursor) {
                            editor.setValue(v, -1);
                            setTimeout(function () {
                                editor.restoreView();
                                editor.focus();
                            }, 250);
                        },
                        extraLibs: extraLibs
                    });
                }
            }
            $("#node-init-expand-js").on("click", expandButtonClickHandler(this.initEditor));
            $("#node-function-expand-js").on("click", expandButtonClickHandler(this.editor));
            $("#node-finalize-expand-js").on("click", expandButtonClickHandler(this.finalizeEditor));

            RED.popover.tooltip($("#node-init-expand-js"), RED._("node-red:common.label.expand"));
            RED.popover.tooltip($("#node-function-expand-js"), RED._("node-red:common.label.expand"));
            RED.popover.tooltip($("#node-finalize-expand-js"), RED._("node-red:common.label.expand"));

            if (RED.settings.functionExternalModules !== false) {
                prepareLibraryConfig(that);
            }
        },
        oneditsave: function() {
            var node = this;
            var noerr = 0;
            $("#node-input-noerr").val(0);

            var disposeEditor = function(editorName,targetName,defaultValue) {
                var editor = node[editorName];
                var annot = editor.getSession().getAnnotations();
                for (var k=0; k < annot.length; k++) {
                    if (annot[k].type === "error") {
                        noerr += annot.length;
                        break;
                    }
                }
                var val = editor.getValue();
                if (defaultValue) {
                    if (val.trim() == defaultValue.trim()) {
                        val = "";
                    }
                }
                editor.destroy();
                delete node[editorName];
                $("#"+targetName).val(val);
            }
            disposeEditor("editor","node-input-func");
            disposeEditor("initEditor","node-input-initialize", RED._("node-red:function.text.initialize"));
            disposeEditor("finalizeEditor","node-input-finalize", RED._("node-red:function.text.finalize"));

            $("#node-input-noerr").val(noerr);
            this.noerr = noerr;
            node.libs = getLibsList();
        },
        oneditcancel: function() {
            var node = this;

            node.editor.destroy();
            delete node.editor;

            node.initEditor.destroy();
            delete node.initEditor;

            node.finalizeEditor.destroy();
            delete node.finalizeEditor;
        },
        oneditresize: function(size) {
            var rows = $("#dialog-form>div:not(.node-text-editor-row)");
            var height = $("#dialog-form").height();
            for (var i=0; i<rows.length; i++) {
                height -= $(rows[i]).outerHeight(true);
            }
            var editorRow = $("#dialog-form>div.node-text-editor-row");
            height -= (parseInt(editorRow.css("marginTop"))+parseInt(editorRow.css("marginBottom")));
            $("#dialog-form .node-text-editor").css("height",height+"px");

            var height = size.height;
            $("#node-input-init-editor").css("height", (height - 83)+"px");
            $("#node-input-func-editor").css("height", (height - 83)+"px");
            $("#node-input-finalize-editor").css("height", (height - 83)+"px");

            this.initEditor.resize();
            this.editor.resize();
            this.finalizeEditor.resize();

            $("#node-input-libs-container").css("height", (height - 192)+"px");
        },
        onadd: function() {
            if (this.name === '_DEFAULT_') {
                this.name = ''
                RED.actions.invoke("core:generate-node-names", this, {generateHistory: false})
            }
        }
    });
})();
</script>
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-help-name="function">
    <p>A JavaScript function to run against the messages being received by the node.</p>
    <p>The messages are passed in as a JavaScript object called <code>msg</code>.</p>
    <p>By convention it will have a <code>msg.payload</code> property containing
       the body of the message.</p>
    <p>The function is expected to return a message object (or multiple message objects), but can choose
       to return nothing in order to halt a flow.</p>
    <p>The <b>On Start</b> tab contains code that will be run whenever the node is started.
        The <b>On Stop</b> tab contains code that will be run when the node is stopped.</p>
    <p>If the On Start code returns a Promise object, the node will not start handling messages
        until the promise is resolved.</p>
    <h3>Details</h3>
    <p>See the <a target="_blank" href="https://nodered.org/docs/writing-functions.html">online documentation</a>
    for more information on writing functions.</p>
    <h4>Sending messages</h4>
    <p>The function can either return the messages it wants to pass on to the next nodes
    in the flow, or can call <code>node.send(messages)</code>.</p>
    <p>It can return/send:</p>
    <ul>
      <li>a single message object - passed to nodes connected to the first output</li>
      <li>an array of message objects - passed to nodes connected to the corresponding outputs</li>
    </ul>
    <p>Note: The setup code is executed during the initialization of nodes. Therefore, if <code>node.send</code> is called in the setup tab, subsequent nodes may not be able to receive the message.</p>
    <p>If any element of the array is itself an array of messages, multiple
          messages are sent to the corresponding output.</p>
    <p>If null is returned, either by itself or as an element of the array, no
          message is passed on.</p>
    <h4>Logging and Error Handling</h4>
    <p>To log any information, or report an error, the following functions are available:</p>
      <ul>
          <li><code>node.log("Log message")</code></li>
          <li><code>node.warn("Warning")</code></li>
          <li><code>node.error("Error")</code></li>
      </ul>
    </p>
    <p>The Catch node can also be used to handle errors. To invoke a Catch node,
    pass <code>msg</code> as a second argument to <code>node.error</code>:</p>
    <pre>node.error("Error",msg);</pre>
    <h4>Accessing Node Information</h4>
    <p>The following properties are available to access information about the node:</p>
    <ul>
        <li><code>node.id</code> - id of the node</li>
        <li><code>node.name</code> - name of the node</li>
        <li><code>node.outputCount</code> - number of node outputs</li>
    </ul>
    <h4>Using environment variables</h4>
    <p>Environment variables can be accessed using <code>env.get("MY_ENV_VAR")</code>.</p>
</script>

<!-- --- [red-module:node-red/switch] --- -->
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-template-name="switch">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" style="width: calc(100% - 105px)" data-i18n="[placeholder]common.label.name">
    </div>
    <div class="form-row">
        <label for="node-input-property"><i class="fa fa-ellipsis-h"></i> <span data-i18n="switch.label.property"></span></label>
        <input type="text" id="node-input-property" style="width: calc(100% - 105px)"/>
        <input type="hidden" id="node-input-outputs"/>
    </div>
    <div class="form-row node-input-rule-container-row">
        <ol id="node-input-rule-container"></ol>
    </div>
    <div class="form-row">
        <select id="node-input-checkall" style="width:100%; margin-right:5px;">
            <option value="true" data-i18n="switch.checkall"></option>
            <option value="false" data-i18n="switch.stopfirst"></option>
        </select>
    </div>
    <div class="form-row">
        <input type="checkbox" id="node-input-repair" style="display: inline-block; width: auto; vertical-align: top;">
        <label style="width: auto;" for="node-input-repair"><span data-i18n="switch.label.repair"></span></label></input>
    </div>
</script>

<script type="text/javascript">
(function() {
    var operators = [
        {v:"eq",t:"==",kind:'V'},
        {v:"neq",t:"!=",kind:'V'},
        {v:"lt",t:"<",kind:'V'},
        {v:"lte",t:"<=",kind:'V'},
        {v:"gt",t:">",kind:'V'},
        {v:"gte",t:">=",kind:'V'},
        {v:"hask",t:"switch.rules.hask",kind:'V'},
        {v:"btwn",t:"switch.rules.btwn",kind:'V'},
        {v:"cont",t:"switch.rules.cont",kind:'V'},
        {v:"regex",t:"switch.rules.regex",kind:'V'},
        {v:"true",t:"switch.rules.true",kind:'V'},
        {v:"false",t:"switch.rules.false",kind:'V'},
        {v:"null",t:"switch.rules.null",kind:'V'},
        {v:"nnull",t:"switch.rules.nnull",kind:'V'},
        {v:"istype",t:"switch.rules.istype",kind:'V'},
        {v:"empty",t:"switch.rules.empty",kind:'V'},
        {v:"nempty",t:"switch.rules.nempty",kind:'V'},
        {v:"head",t:"switch.rules.head",kind:'S'},
        {v:"index",t:"switch.rules.index",kind:'S'},
        {v:"tail",t:"switch.rules.tail",kind:'S'},
        {v:"jsonata_exp",t:"switch.rules.exp",kind:'O'},
        {v:"else",t:"switch.rules.else",kind:'O'}
    ];

    var previousValueType = {value:"prev",label:RED._("node-red:switch.previous"),hasValue:false};
    function clipValueLength(v) {
        if (v.length > 15) {
            return v.substring(0,15)+"...";
        }
        return v;
    }
    function prop2name(key) {
        var result = RED.utils.parseContextKey(key);
        return result.key;
    }
    function getValueLabel(t,v) {
        if (t === 'str') {
            return '"'+clipValueLength(v)+'"';
        } else if (t === 'msg') {
            return t+"."+clipValueLength(v);
        } else if (t === 'flow' || t === 'global') {
            return t+"."+clipValueLength(prop2name(v));
        }
        return clipValueLength(v);
    }

    function exportRule(rule) {
        var type = rule.find("select").val();
        var r = {t:type};
        if (!(type === "true" || type === "false" || type === "null" || type === "nnull" || type === "empty" || type === "nempty" || type === "else")) {
            if ((type === "btwn") || (type === "index")) {
                r.v = rule.find(".node-input-rule-btwn-value").typedInput('value');
                r.vt = rule.find(".node-input-rule-btwn-value").typedInput('type');
                r.v2 = rule.find(".node-input-rule-btwn-value2").typedInput('value');
                r.v2t = rule.find(".node-input-rule-btwn-value2").typedInput('type');
            } else if ((type === "head") || (type === "tail")) {
                r.v = rule.find(".node-input-rule-num-value").typedInput('value');
                r.vt = rule.find(".node-input-rule-num-value").typedInput('type');
            } else if (type === "istype") {
                r.v = rule.find(".node-input-rule-type-value").typedInput('type');
                r.vt = rule.find(".node-input-rule-type-value").typedInput('type');
            } else if (type === "jsonata_exp") {
                r.v = rule.find(".node-input-rule-exp-value").typedInput('value');
                r.vt = rule.find(".node-input-rule-exp-value").typedInput('type');
            } else {
                r.v = rule.find(".node-input-rule-value").typedInput('value');
                r.vt = rule.find(".node-input-rule-value").typedInput('type');
            }
            if (type === "regex") {
                r.case = rule.find(".node-input-rule-case").prop("checked");
            }
        }
        return r;
    }

    function createValueField(row, defaultType){
        return $('<input/>',{class:"node-input-rule-value",type:"text",style:"width: 100%;"}).appendTo(row)
            .typedInput({default:defaultType||'str',types:['msg','flow','global','str','num','jsonata','env',previousValueType]});
    }

    function createNumValueField(row, defaultType){
        return $('<input/>',{class:"node-input-rule-num-value",type:"text",style:"width: 100%;"}).appendTo(row)
            .typedInput({default:defaultType||'num',types:['flow','global','num','jsonata','env']});
    }

    function createExpValueField(row){
        return $('<input/>',{class:"node-input-rule-exp-value",type:"text",style:"width: 100%;"}).appendTo(row)
            .typedInput({default:'jsonata',types:['jsonata']});
    }

    function createBtwnValueField(row, defaultType){
        return $('<input/>',{class:"node-input-rule-btwn-value",type:"text",style:"width: 100%;"}).appendTo(row)
                .typedInput({default:defaultType||'num',types:['msg','flow','global','str','num','jsonata','env',previousValueType]});
    }

    function createBtwnValue2Field(row3, andLabel, defaultType){
        $('<div/>',{class:"node-input-rule-btwn-label", style:"width: 120px; text-align: right;"}).text(" "+andLabel+" ").appendTo(row3);
        var row3InputCell = $('<div/>',{style:"flex-grow:1; margin-left: 5px;"}).appendTo(row3);
        return $('<input/>',{class:"node-input-rule-btwn-value2",type:"text",style:"width: 100%"}).appendTo(row3InputCell)
            .typedInput({default:defaultType||'num',types:['msg','flow','global','str','num','jsonata','env',previousValueType]});
    }

    function createTypeValueField(row, defaultType){
        return $('<input/>',{class:"node-input-rule-type-value",type:"text",style:"width: 100%;"}).appendTo(row).typedInput({default:defaultType || 'string',types:[
            {value:"string",label:RED._("common.type.string"),hasValue:false,icon:"red/images/typedInput/az.svg"},
            {value:"number",label:RED._("common.type.number"),hasValue:false,icon:"red/images/typedInput/09.svg"},
            {value:"boolean",label:RED._("common.type.boolean"),hasValue:false,icon:"red/images/typedInput/bool.svg"},
            {value:"array",label:RED._("common.type.array"),hasValue:false,icon:"red/images/typedInput/json.svg"},
            {value:"buffer",label:RED._("common.type.buffer"),hasValue:false,icon:"red/images/typedInput/bin.svg"},
            {value:"object",label:RED._("common.type.object"),hasValue:false,icon:"red/images/typedInput/json.svg"},
            {value:"json",label:RED._("common.type.jsonString"),hasValue:false,icon:"red/images/typedInput/json.svg"},
            {value:"undefined",label:RED._("common.type.undefined"),hasValue:false},
            {value:"null",label:RED._("common.type.null"),hasValue:false}
        ]});
    }

    RED.nodes.registerType('switch', {
        color: "#E2D96E",
        category: 'function',
        defaults: {
            name: {value:""},
            property: {value:"payload", required:true,
                       label:RED._("node-red:common.label.payload"),
                       validate: RED.validators.typedInput("propertyType", false)},
            propertyType: { value:"msg" },
            rules: {
                value:[{t:"eq", v:"", vt:"str"}],
                validate: function (rules, opt) {
                    let msg;
                    const errors = []
                    if (!rules || rules.length === 0) { return true }
                    for (var i=0;i<rules.length;i++) {
                        const opt = { label: RED._('node-red:switch.label.rule')+' '+(i+1) }
                        const r = rules[i];
                        if (r.t !== 'istype') {
                            if (r.hasOwnProperty('v')) {
                                if ((msg = RED.utils.validateTypedProperty(r.v,r.vt,opt)) !== true) {
                                    errors.push(msg)
                                }
                            }
                            if (r.hasOwnProperty('v2')) {
                                if ((msg = RED.utils.validateTypedProperty(r.v2,r.v2t,opt)) !== true) {
                                    errors.push(msg)
                                }
                            }
                        }
                    }
                    if (errors.length) {
                        console.log(errors)
                        return errors
                    }
                    return true;
                }
            },
            checkall: {value:"false", required:true},
            repair: {value:false},
            outputs: {value:1}
        },
        inputs: 1,
        outputs: 1,
        outputLabels: function(index) {
            var rule = this.rules[index];
            var label = "";
            if (rule) {
                for (var i=0;i<operators.length;i++) {
                    if (operators[i].v === rule.t) {
                        label = /^switch/.test(operators[i].t)?this._(operators[i].t):operators[i].t;
                        break;
                    }
                }
                if ((rule.t === 'btwn') || (rule.t === 'index')) {
                    label += " "+getValueLabel(rule.vt,rule.v)+" & "+getValueLabel(rule.v2t,rule.v2);
                } else if (rule.t !== 'true' && rule.t !== 'false' && rule.t !== 'null' && rule.t !== 'nnull' && rule.t !== 'empty' && rule.t !== 'nempty' && rule.t !== 'else' ) {
                    label += " "+getValueLabel(rule.vt,rule.v);
                }
                return label;
            }
        },
        icon: "switch.svg",
        label: function() {
            return this.name||this._("switch.switch");
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        oneditprepare: function() {
            var node = this;


            $("#node-input-property").typedInput({default:this.propertyType||'msg',types:['msg','flow','global','jsonata','env']});
            var outputCount = $("#node-input-outputs").val("{}");

            var andLabel = this._("switch.and");
            var caseLabel = this._("switch.ignorecase");

            $("#node-input-rule-container").css('min-height','150px').css('min-width','450px').editableList({
                addItem: function(container,i,opt) {
                    var focusValueField = false;
                    if (!opt.hasOwnProperty('r')) {
                        opt.r = {};
                        if (i > 0) {
                            var lastRule = $("#node-input-rule-container").editableList('getItemAt',i-1);
                            var exportedRule = exportRule(lastRule.element);
                            if (exportedRule.t === "istype") {
                                opt.r.vt = (exportedRule.vt === "number") ? "num" : "str";
                            } else {
                                opt.r.vt = exportedRule.vt;
                            }
                            opt.r.v = "";
                            // We could copy the value over as well and preselect it (see the 'activeElement' code below)
                            // But not sure that feels right. Is copying over the last value 'expected' behaviour?
                            // It would make sense for an explicit 'copy' action, but not sure where the copy button would
                            // go for each rule without being wasted space for most users.
                            // opt.r.v = exportedRule.v;
                            focusValueField = true;
                        }
                    }

                    opt.element = container;
                    var rule = opt.r;
                    if (!rule.hasOwnProperty('t')) {
                        rule.t = 'eq';
                    }
                    if (!opt.hasOwnProperty('i')) {
                        opt._i = Math.floor((0x99999-0x10000)*Math.random()).toString();
                    }
                    container.css({
                        overflow: 'hidden',
                        whiteSpace: 'nowrap',
                        display: "flex",
                        "align-items":"center"
                    });
                    var inputRows = $('<div></div>',{style:"flex-grow:1"}).appendTo(container);
                    var row = $('<div></div>',{style:"display: flex;"}).appendTo(inputRows);
                    var row2 = $('<div/>',{style:"display: flex; padding-top: 5px; padding-left: 175px;"}).appendTo(inputRows);
                    var row3 = $('<div/>',{style:"display: flex; padding-top: 5px; align-items: center"}).appendTo(inputRows);

                    var row4 = $('<div/>',{style:"visibility: hidden; height: 0px;"}).appendTo(inputRows);
                    var textSpan = $("<span/>").appendTo(row4);
                    var selectField = $('<select/>',{style:"width:120px; text-align: center;"}).appendTo(row);
                    var group0 = $('<optgroup/>', { label: RED._("node-red:switch.label.value-rules") }).appendTo(selectField);
                    for (var d in operators) {
                        if(operators[d].kind === 'V') {
                            group0.append($("<option></option>").val(operators[d].v).text(/^switch/.test(operators[d].t)?node._(operators[d].t):operators[d].t));
                        }
                    }
                    var group1 = $('<optgroup/>', { label: RED._("node-red:switch.label.sequence-rules") }).appendTo(selectField);
                    for (var d in operators) {
                        if(operators[d].kind === 'S') {
                            group1.append($("<option></option>").val(operators[d].v).text(/^switch/.test(operators[d].t)?node._(operators[d].t):operators[d].t));
                        }
                    }
                    for (var d in operators) {
                        if(operators[d].kind === 'O') {
                            selectField.append($("<option></option>").val(operators[d].v).text(/^switch/.test(operators[d].t)?node._(operators[d].t):operators[d].t));
                        }
                    }

                    var rowInputCell = $('<div>',{style:"flex-grow:1; margin-left: 5px;"}).appendTo(row);


                    var valueField = null;
                    var numValueField = null;
                    var expValueField = null;
                    var btwnAndLabel = null;
                    var btwnValueField = null;
                    var btwnValue2Field = null;
                    var typeValueField = null;

                    var finalspan = $('<span/>',{style:"margin-left: 5px;"}).appendTo(container);
                    finalspan.append(' &#8594; <span class="node-input-rule-index">'+(i+1)+'</span> ');

                    var caseSensitive = $('<input/>',{id:"node-input-rule-case-"+i,class:"node-input-rule-case",type:"checkbox",style:"width:auto;vertical-align:top"}).appendTo(row2);
                    $('<label/>',{for:"node-input-rule-case-"+i,style:"margin-left: 3px;"}).text(caseLabel).appendTo(row2);

                    selectField.on("change", function() {
                        var fieldToFocus;
                        var type = selectField.val();
                        if (valueField) { valueField.typedInput('hide'); }
                        if (expValueField) { expValueField.typedInput('hide'); }
                        if (numValueField) { numValueField.typedInput('hide'); }
                        if (typeValueField) { typeValueField.typedInput('hide'); }
                        if (btwnValueField) { btwnValueField.typedInput('hide'); }
                        if (btwnValue2Field) { btwnValue2Field.typedInput('hide'); }

                        if ((type === "btwn") || (type === "index")) {
                            if (!btwnValueField){
                                btwnValueField = createBtwnValueField(rowInputCell);
                            }
                            btwnValueField.typedInput('show');
                            fieldToFocus = btwnValueField;
                        } else if ((type === "head") || (type === "tail")) {
                            if (!numValueField){
                                numValueField = createNumValueField(rowInputCell);
                            }
                            numValueField.typedInput('show');
                            fieldToFocus = numValueField;
                        } else if (type === "jsonata_exp") {
                            if (!expValueField){
                                expValueField = createExpValueField(rowInputCell);
                            }
                            expValueField.typedInput('show');
                            fieldToFocus = expValueField;

                        } else if (type === "istype") {
                            if (!typeValueField){
                                typeValueField = createTypeValueField(rowInputCell);
                            }
                            typeValueField.typedInput('show');
                            fieldToFocus = typeValueField;
                        } else if (! (type === "true" || type === "false" || type === "null" || type === "nnull" || type === "empty" || type === "nempty" || type === "else" )) {
                                if (!valueField){
                                    valueField = createValueField(rowInputCell);
                                }
                                valueField.typedInput('show');
                                fieldToFocus = valueField;
                        }
                        if (type === "regex") {
                            row2.show();
                            row3.hide();
                        } else if ((type === "btwn") || (type === "index")) {
                            row2.hide();
                            row3.show();
                            if (!btwnValue2Field){
                                btwnValue2Field = createBtwnValue2Field(row3, andLabel);
                            }
                            btwnValue2Field.typedInput('show');
                        } else {
                            row2.hide();
                            row3.hide();
                        }
                        var selectedLabel = selectField.find("option:selected").text();

                        textSpan.text(selectedLabel);
                        var width = textSpan.width();
                        if (width <= 30) {
                            selectField.outerWidth(60);
                        } else if (width <= 85) {
                            selectField.outerWidth(120);
                        } else {
                            selectField.width("auto")
                        }
                        if (fieldToFocus) {
                            fieldToFocus.typedInput("focus");
                        }
                        // Preselect the contents of the element
                        // if (focusValueField && document.activeElement) {
                        //     document.activeElement.selectionStart = 0;
                        //     document.activeElement.selectionEnd = document.activeElement.value.length;
                        // }
                    });
                    selectField.val(rule.t);

                    if ((rule.t == "btwn") || (rule.t == "index")) {
                        btwnValueField = createBtwnValueField(rowInputCell,rule.vt||'num');
                        btwnValueField.typedInput('value',rule.v);
                        btwnValue2Field = createBtwnValue2Field(row3, andLabel,rule.v2t||'num');
                        btwnValue2Field.typedInput('value',rule.v2);
                    } else if ((rule.t === "head") || (rule.t === "tail")) {
                        numValueField = createNumValueField(rowInputCell,rule.vt||'num');
                        numValueField.typedInput('value',rule.v);
                    } else if (rule.t === "istype") {
                        typeValueField = createTypeValueField(rowInputCell,rule.vt);
                        typeValueField.typedInput('value',rule.vt);
                    } else if (rule.t === "jsonata_exp") {
                        expValueField = createExpValueField(rowInputCell,rule.vt||'jsonata');
                        expValueField.typedInput('value',rule.v);
                    } else if (typeof rule.v != "undefined") {
                        valueField = createValueField(rowInputCell,rule.vt||'str');
                        valueField.typedInput('value',rule.v);
                    }
                    caseSensitive.prop('checked',!!rule.case);
                    selectField.change();

                    var currentOutputs = JSON.parse(outputCount.val()||"{}");
                    currentOutputs[opt.hasOwnProperty('i')?opt.i:opt._i] = i;
                    outputCount.val(JSON.stringify(currentOutputs));
                },
                removeItem: function(opt) {
                    var currentOutputs = JSON.parse(outputCount.val()||"{}");
                    if (opt.hasOwnProperty('i')) {
                        currentOutputs[opt.i] = -1;
                    } else {
                        delete currentOutputs[opt._i];
                    }
                    var rules = $("#node-input-rule-container").editableList('items');
                    rules.each(function(i) {
                        $(this).find(".node-input-rule-index").html(i+1);
                        var data = $(this).data('data');
                        currentOutputs[data.hasOwnProperty('i')?data.i:data._i] = i;
                    });
                    outputCount.val(JSON.stringify(currentOutputs));
                },
                sortItems: function(rules) {
                    var currentOutputs = JSON.parse(outputCount.val()||"{}");
                    var rules = $("#node-input-rule-container").editableList('items');
                    rules.each(function(i) {
                        $(this).find(".node-input-rule-index").html(i+1);
                        var data = $(this).data('data');
                        currentOutputs[data.hasOwnProperty('i')?data.i:data._i] = i;
                    });
                    outputCount.val(JSON.stringify(currentOutputs));
                },
                sortable: true,
                removable: true
            });

            for (var i=0;i<this.rules.length;i++) {
                var rule = this.rules[i];
                $("#node-input-rule-container").editableList('addItem',{r:rule,i:i});
            }
        },
        oneditsave: function() {
            var rules = $("#node-input-rule-container").editableList('items');
            var node = this;
            node.rules = [];
            rules.each(function(i) {
                node.rules.push(exportRule($(this)));
            });
            this.propertyType = $("#node-input-property").typedInput('type');
        },
        oneditresize: function(size) {
            var rows = $("#dialog-form>div:not(.node-input-rule-container-row)");
            var height = size.height;
            for (var i=0;i<rows.length;i++) {
                height -= $(rows[i]).outerHeight(true);
            }
            var editorRow = $("#dialog-form>div.node-input-rule-container-row");
            height -= (parseInt(editorRow.css("marginTop"))+parseInt(editorRow.css("marginBottom")));
            height += 16;
            $("#node-input-rule-container").editableList('height',height);
        }
    });
})();
</script>
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-help-name="switch">
    <p>Route messages based on their property values or sequence position.</p>
    <h3>Details</h3>
    <p>When a message arrives, the node will evaluate each of the defined rules
    and forward the message to the corresponding outputs of any matching rules.</p>
    <p>Optionally, the node can be set to stop evaluating rules once it finds one
    that matches.</p>
    <p>The rules can be evaluated against an individual message property, a flow or global
    context property, environment variable or the result of a JSONata expression.</p>
    <h4>Rules</h4>
    <p>There are four types of rule:</p>
    <ol>
        <li><b>Value</b> rules are evaluated against the configured property</li>
        <li><b>Sequence</b> rules can be used on message sequences, such as those
            generated by the Split node</li>
        <li>A JSONata <b>Expression</b> can be provided that will be evaluated
            against the whole message and will match if the expression returns
            a true value.</li>
        <li>An <b>Otherwise</b> rule can be used to match if none of the preceeding
            rules have matched.</li>
    </ol>
    <h4>Notes</h4>
    <p>The <code>is true/false</code> and <code>is null</code> rules perform strict
       comparisons against those types. They do not convert between types.</p>
    <p>The <code>is empty</code> and <code>is not empty</code> rules can be used to test the length of Strings, Arrays and Buffers, or the number of properties an Object has. Neither rule will pass if the property being tested has a <code>boolean</code>, <code>null</code>
       or <code>undefined</code> value.</p>
    <h4>Handling message sequences</h4>
    <p>By default, the node does not modify the <code>msg.parts</code> property of messages
       that are part of a sequence.</p>
    <p>The <b>recreate message sequences</b> option can be enabled to generate new message sequences
       for each rule that matches. In this mode, the node will buffer the entire incoming
       sequence before sending the new sequences on. The runtime setting <code>nodeMessageBufferMaxLength</code>
       can be used to limit how many messages nodes will buffer.</p>
</script>

<!-- --- [red-module:node-red/change] --- -->

<script type="text/html" data-template-name="change">
    <style>
        ol#node-input-rule-container .red-ui-typedInput-container {
            flex:1;
        }
    </style>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" style="width: calc(100% - 105px)"  data-i18n="[placeholder]common.label.name">
    </div>
    <div class="form-row" style="margin-bottom:0;">
        <label><i class="fa fa-list"></i> <span data-i18n="change.label.rules"></span></label>
    </div>
    <div class="form-row node-input-rule-container-row">
        <ol id="node-input-rule-container"></ol>
    </div>
</script>

<script type="text/javascript">
(function() {
    RED.nodes.registerType('change', {
        color: "#E2D96E",
        category: 'function',
        defaults: {
            name: {value:""},
            rules:{
                value:[{t:"set",p:"payload",pt:"msg",to:"",tot:"str"}],
                validate: function(rules, opt) {
                    let msg;
                    const errors = []
                    if (!rules || rules.length === 0) { return true }
                    for (var i=0;i<rules.length;i++) {
                        const opt = { label: RED._('node-red:change.label.rule')+' '+(i+1) }
                        const r = rules[i];
                        if (r.t === 'set' || r.t === 'change' || r.t === 'delete' || r.t === 'move') {
                            if ((msg = RED.utils.validateTypedProperty(r.p,r.pt,opt)) !== true) {
                                errors.push(msg)
                            }
                        }
                        if (r.t === 'set' || r.t === 'change' || r.t === 'move') {
                            if ((msg = RED.utils.validateTypedProperty(r.to,r.tot,opt)) !== true) {
                                errors.push(msg)
                            }
                        }
                        if (r.t === 'change') {
                            if ((msg = RED.utils.validateTypedProperty(r.from,r.fromt,opt)) !== true) {
                                errors.push(msg)
                            }
                        }
                    }
                    if (errors.length) {
                        return errors
                    }
                    return true;
                }
            },
            // legacy
            action: {value:""},
            property: {value:""},
            from: {value:""},
            to: {value:""},
            reg: {value:false}
        },
        inputs: 1,
        outputs: 1,
        icon: "swap.svg",
        label: function() {
            function prop2name(type, key) {
                var result = RED.utils.parseContextKey(key);
                return type +"." +result.key;
            }
            if (this.name) {
                return this.name;
            }
            if (!this.rules) {
                if (this.action === "replace") {
                    return this._("change.label.set",{property:"msg."+this.property});
                } else if (this.action === "change") {
                    return this._("change.label.change",{property:"msg."+this.property});
                } else if (this.action === "move") {
                    return this._("change.label.move",{property:"msg."+this.property});
                } else {
                    return this._("change.label.delete",{property:"msg."+this.property});
                }
            } else {
                if (this.rules.length == 1) {
                    if (this.rules[0].t === "set") {
                        return this._("change.label.set",{property:prop2name((this.rules[0].pt||"msg"), this.rules[0].p)});
                    } else if (this.rules[0].t === "change") {
                        return this._("change.label.change",{property:prop2name((this.rules[0].pt||"msg"), this.rules[0].p)});
                    } else if (this.rules[0].t === "move") {
                        return this._("change.label.move",{property:prop2name((this.rules[0].pt||"msg"), this.rules[0].p)});
                    } else {
                        return this._("change.label.delete",{property:prop2name((this.rules[0].pt||"msg"), this.rules[0].p)});
                    }
                } else {
                    return this._("change.label.changeCount",{count:this.rules.length});
                }
            }
        },
        labelStyle: function() {
            return this.name ? "node_label_italic" : "";
        },
        oneditprepare: function() {
            var set = this._("change.action.set");
            var change = this._("change.action.change");
            var del = this._("change.action.delete");
            var move = this._("change.action.move");
            var to = this._("change.action.to");
            var toValueLabel = this._("change.action.toValue",to);
            var search = this._("change.action.search");
            var replace = this._("change.action.replace");
            var regex = this._("change.label.regex");
            var deepCopyLabel = this._("change.label.deepCopy");

            function createPropertyValue(row2_1, row2_2, defaultType) {
                var propValInput = $('<input/>',{class:"node-input-rule-property-value",type:"text"})
                    .appendTo(row2_1)
                    .typedInput({default:defaultType||'str',types:['msg','flow','global','str','num','bool','json','bin','date','jsonata','env']});

                var dcLabel = $('<label style="padding-left: 130px;"></label>').appendTo(row2_2);
                var deepCopy = $('<input type="checkbox" class="node-input-rule-property-deepCopy" style="width: auto; margin: 0 6px 0 0">').appendTo(dcLabel)
                $('<span>').text(deepCopyLabel).appendTo(dcLabel)

                propValInput.on("change", function(evt,type,val) {
                    row2_2.toggle(type === "msg" || type === "flow" || type === "global" || type === "env");
                })
                return [propValInput, deepCopy];
            }
            function createFromValue(row3_1, defaultType) {
                return $('<input/>',{class:"node-input-rule-property-search-value",type:"text"})
                .appendTo(row3_1)
                .typedInput({default:defaultType||'str',types:['msg','flow','global','str','re','num','bool','env']});
            }
            function createToValue(row3_2, defaultType) {
                return $('<input/>',{class:"node-input-rule-property-replace-value",type:"text"})
                .appendTo(row3_2)
                .typedInput({default:defaultType||'str',types:['msg','flow','global','str','num','bool','json','bin','env']});
            }
            function createMoveValue(row4, defaultType) {
                return $('<input/>',{class:"node-input-rule-property-move-value",type:"text"})
                .appendTo(row4)
                .typedInput({default:defaultType||'msg',types:['msg','flow','global']});
            }

            $('#node-input-rule-container').css('min-height','150px').css('min-width','450px').editableList({
                addItem: function(container,i,opt) {
                    var rule = opt;
                    if (!rule.hasOwnProperty('t')) {
                        rule = {t:"set",p:"payload",to:"",tot:"str"};
                    }
                    if (rule.t === "change" && rule.re) {
                        rule.fromt = 're';
                        delete rule.re;
                    }
                    if (rule.t === "set" && !rule.tot) {
                        if (rule.to.indexOf("msg.") === 0 && !rule.tot) {
                            rule.to = rule.to.substring(4);
                            rule.tot = "msg";
                        } else {
                            rule.tot = "str";
                        }
                    }
                    if (rule.t === "move" && !rule.tot) {
                        rule.tot = "msg";
                    }
                    container.css({
                        overflow: 'hidden',
                        whiteSpace: 'nowrap'
                    });
                    let fragment = document.createDocumentFragment();
                    var row1 = $('<div/>',{style:"display:flex; align-items: baseline"}).appendTo(fragment);
                    var row2 = $('<div/>',{style:"margin-top:8px;"}).appendTo(fragment);
                    var row3 = $('<div/>',{style:"margin-top:8px;"}).appendTo(fragment);
                    var row4 = $('<div/>',{style:"display:flex;margin-top:8px;align-items: baseline"}).appendTo(fragment);

                    var selectField = $('<select/>',{class:"node-input-rule-type",style:"width:110px; margin-right:10px;"}).appendTo(row1);
                    var selectOptions = [{v:"set",l:set},{v:"change",l:change},{v:"delete",l:del},{v:"move",l:move}];
                    for (var i=0; i<4; i++) {
                        selectField.append($("<option></option>").val(selectOptions[i].v).text(selectOptions[i].l));
                    }

                    var propertyName = $('<input/>',{class:"node-input-rule-property-name",type:"text"})
                        .appendTo(row1)
                        .typedInput({types:['msg','flow','global']});

                    var row2_1 = $('<div/>', {style:"display:flex;align-items: baseline"}).appendTo(row2);
                    $('<div/>',{style:"display:inline-block;text-align:right; width:120px; padding-right:10px; box-sizing:border-box;"})
                        .text(toValueLabel)
                        .appendTo(row2_1);

                    var row2_2 = $('<div/>', {style:"margin-top: 4px;"}).appendTo(row2);

                    var row3_1 = $('<div/>', {style:"display:flex;align-items: baseline"}).appendTo(row3);
                    $('<div/>',{style:"display:inline-block;text-align:right; width:120px; padding-right:10px; box-sizing:border-box;"})
                        .text(search)
                        .appendTo(row3_1);

                    var row3_2 = $('<div/>',{style:"display:flex;margin-top:8px;align-items: baseline"}).appendTo(row3);
                    $('<div/>',{style:"display:inline-block;text-align:right; width:120px; padding-right:10px; box-sizing:border-box;"})
                        .text(replace)
                        .appendTo(row3_2);

                    $('<div/>',{style:"display:inline-block;text-align:right; width:120px; padding-right:10px; box-sizing:border-box;"})
                        .text(to)
                        .appendTo(row4);

                    let propertyValue = null;
                    let fromValue = null;
                    let toValue = null;
                    let moveValue = null;

                    selectField.on("change", function() {
                        var type = $(this).val();
                        if (propertyValue) {
                            propertyValue.typedInput('hide');
                        }
                        if (fromValue) {
                            fromValue.typedInput('hide');
                        }
                        if (toValue) {
                            toValue.typedInput('hide');
                        }
                        if (moveValue) {
                            moveValue.typedInput('hide');
                        }

                        if (type == "set") {
                            if(!propertyValue) {
                                var parts = createPropertyValue(row2_1, row2_2);
                                propertyValue = parts[0];
                                deepCopy = parts[1];
                            }
                            propertyValue.typedInput('show');
                            row2.show();
                            row3.hide();
                            row4.hide();
                        } else if (type == "change") {
                            if(!fromValue) {
                                fromValue = createFromValue(row3_1);
                            }
                            fromValue.typedInput('show');
                            if(!toValue) {
                                toValue = createToValue(row3_2);
                            }
                            toValue.typedInput('show');
                            row2.hide();
                            row3.show();
                            row4.hide();
                        } else if (type == "delete") {
                            row2.hide();
                            row3.hide();
                            row4.hide();
                        } else if (type == "move") {
                            if(!moveValue) {
                                moveValue = createMoveValue(row4);
                            }
                            moveValue.typedInput('show');
                            row2.hide();
                            row3.hide();
                            row4.show();
                        }
                    });

                    selectField.val(rule.t);
                    propertyName.typedInput('value',rule.p);
                    propertyName.typedInput('type',rule.pt);
                    if (rule.t == "set") {
                        var parts = createPropertyValue(row2_1, row2_2, rule.tot);
                        propertyValue = parts[0];
                        deepCopy = parts[1];
                        propertyValue.typedInput('value',rule.to);
                        deepCopy.prop("checked", !!rule.dc);
                    }
                    if (rule.t == "move") {
                        moveValue = createMoveValue(row4,rule.tot);
                        moveValue.typedInput('value',rule.to);
                    }
                    if (rule.t == "change") {
                        fromValue = createFromValue(row3_1, rule.fromt);
                        fromValue.typedInput('value',rule.from);

                        toValue = createToValue(row3_2,rule.tot);
                        toValue.typedInput('value',rule.to);
                    }
                    selectField.change();
                    container[0].appendChild(fragment);
                },
                removable: true,
                sortable: true
            });

            if (!this.rules) {
                var rule = {
                    t:(this.action=="replace"?"set":this.action),
                    p:this.property,
                    pt:"msg"
                };

                if ((rule.t === "set")||(rule.t === "move")) {
                    rule.to = this.to;
                } else if (rule.t === "change") {
                    rule.from = this.from;
                    rule.to = this.to;
                    rule.re = this.reg;
                }

                delete this.to;
                delete this.from;
                delete this.reg;
                delete this.action;
                delete this.property;

                this.rules = [rule];
            }

            for (var i=0; i<this.rules.length; i++) {
                var rule = this.rules[i];
                $("#node-input-rule-container").editableList('addItem',rule);
            }
        },
        oneditsave: function() {
            var rules = $("#node-input-rule-container").editableList('items');
            var node = this;
            node.rules= [];
            rules.each(function(i) {
                var rule = $(this);
                var type = rule.find(".node-input-rule-type").val();
                var r = {
                    t:type,
                    p:rule.find(".node-input-rule-property-name").typedInput('value'),
                    pt:rule.find(".node-input-rule-property-name").typedInput('type')
                };
                if (type === "set") {
                    r.to = rule.find(".node-input-rule-property-value").typedInput('value');
                    r.tot = rule.find(".node-input-rule-property-value").typedInput('type');
                    if (rule.find(".node-input-rule-property-deepCopy").prop("checked")) {
                        r.dc = true;
                    }
                } else if (type === "move") {
                    r.to = rule.find(".node-input-rule-property-move-value").typedInput('value');
                    r.tot = rule.find(".node-input-rule-property-move-value").typedInput('type');
                } else if (type === "change") {
                    r.from = rule.find(".node-input-rule-property-search-value").typedInput('value');
                    r.fromt = rule.find(".node-input-rule-property-search-value").typedInput('type');
                    r.to = rule.find(".node-input-rule-property-replace-value").typedInput('value');
                    r.tot = rule.find(".node-input-rule-property-replace-value").typedInput('type');
                }
                node.rules.push(r);
            });
        },
        oneditresize: function(size) {
            var rows = $("#dialog-form>div:not(.node-input-rule-container-row)");
            var height = size.height;
            for (var i=0; i<rows.length; i++) {
                height -= $(rows[i]).outerHeight(true);
            }
            var editorRow = $("#dialog-form>div.node-input-rule-container-row");
            height -= (parseInt(editorRow.css("marginTop"))+parseInt(editorRow.css("marginBottom")));
            height += 16;
            $("#node-input-rule-container").editableList('height',height);
        }
    });
})();
</script>
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-help-name="change">
    <p>Set, change, delete or move properties of a message, flow context or global context.</p>
    <p>The node can specify multiple rules that will be applied in the order they are defined.</p>
    <h3>Details</h3>
    <p>The available operations are:</p>
    <dl class="message-properties">
    <dt>Set</dt>
    <dd>set a property. The value can be a variety of different types, or
            can be taken from an existing message or context property.</dd>
    <dt>Change</dt>
    <dd>search &amp; replace parts of the property. If regular expressions
        are enabled, the "replace with" property can include capture groups, for
        example <code>$1</code>. Replace will only change the type if there
        is a complete match.</dd>
    <dt>Delete</dt>
    <dd>delete a property.</dd>
    <dt>Move</dt>
    <dd>move or rename a property.</dd>
    </dl>
    <p>The "expression" type uses the <a href="http://jsonata.org/" target="_new">JSONata</a>
    query and expression language.
    </p>
</script>

<!-- --- [red-module:node-red/range] --- -->

<script type="text/html" data-template-name="range">
    <div class="form-row">
        <label for="node-input-property"><i class="fa fa-ellipsis-h"></i> <span data-i18n="common.label.property"></span></label>
        <input type="text" id="node-input-property" style="width:calc(70% - 1px)"/>
    </div>
    <div class="form-row">
        <label for="node-input-action"><i class="fa fa-dot-circle-o"></i> <span data-i18n="range.label.action"></span></label>
        <select id="node-input-action" style="width:70%;">
            <option value="scale" data-i18n="range.scale.payload"></option>
            <option value="clamp" data-i18n="range.scale.limit"></option>
            <option value="roll" data-i18n="range.scale.wrap"></option>
            <option value="drop" data-i18n="range.scale.drop"></option>
        </select>
    </div>
    <br/>
    <div class="form-row"><i class="fa fa-sign-in"></i> <span data-i18n="range.label.inputrange"></span>:</div>
    <div class="form-row"><label></label>
        <span data-i18n="range.label.from"></span>: <input type="text" id="node-input-minin" data-i18n="[placeholder]range.placeholder.min" style="width:100px;"/>
        &nbsp;&nbsp;<span data-i18n="range.label.to"></span>: <input type="text" id="node-input-maxin" data-i18n="[placeholder]range.placeholder.maxin" style="width:100px;"/>
    </div>
    <div class="form-row"><i class="fa fa-sign-out"></i> <span data-i18n="range.label.resultrange"></span>:</div>
    <div class="form-row"><label></label>
        <span data-i18n="range.label.from"></span>: <input type="text" id="node-input-minout" data-i18n="[placeholder]range.placeholder.min" style="width:100px;"/>
        &nbsp;&nbsp;<span data-i18n="range.label.to"></span>: <input type="text" id="node-input-maxout" data-i18n="[placeholder]range.placeholder.maxout" style="width:100px;"/>
    </div>
    <br/>
    <div class="form-row"><label></label>
        <input type="checkbox" id="node-input-round" style="display: inline-block; width: auto; vertical-align: top;">
        <label style="width: auto;" for="node-input-round"><span data-i18n="range.label.roundresult"></span></label></input>
    </div>
    <br/>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name">
    </div>
    <div class="form-tips" id="node-tip"><span data-i18n="range.tip"></span></div>
</script>

<script type="text/javascript">
    RED.nodes.registerType('range', {
        color: "#E2D96E",
        category: 'function',
        defaults: {
            minin: {value:"", required: true,
                    label:RED._("node-red:range.label.minin"),
                    validate:RED.validators.number(false)},
            maxin: {value:"", required: true,
                    label:RED._("node-red:range.label.maxin"),
                    validate:RED.validators.number(false)},
            minout: {value:"", required:true,
                     label:RED._("node-red:range.label.minout"),
                     validate:RED.validators.number(false)},
            maxout: {value:"", required:true,
                     label:RED._("node-red:range.label.maxout"),
                     validate:RED.validators.number(false)},
            action: {value:"scale"},
            round: {value:false},
            property: {value:"payload",required:true,
                       label:RED._("node-red:common.label.property"),
                       validate: RED.validators.typedInput({ type: 'msg', allowBlank: true })
                    },
            name: {value:""}
        },
        inputs: 1,
        outputs: 1,
        icon: "range.svg",
        label: function() {
            if (this.minout !== "" && this.maxout !== "") { return this.name||this.minout + " - " + this.maxout; }
            else { return this.name||this._("range.range"); }
        },
        labelStyle: function() {
            return this.name ? "node_label_italic" : "";
        },
        oneditprepare: function() {
            if (this.property === undefined) {
                $("#node-input-property").val("payload");
            }
            $("#node-input-property").typedInput({default:'msg',types:['msg']});
        }
    });
</script>
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-help-name="range">
    <p>Maps a numeric value to a different range.</p>
    <h3>Inputs</h3>
    <dl class="message-properties">
        <dt>payload <span class="property-type">number</span></dt>
        <dd>The payload <i>must</i> be a number. Anything else will try to be
        parsed into a number and rejected if that fails.</dd>
    </dl>
    <h3>Outputs</h3>
    <dl class="message-properties">
        <dt>payload <span class="property-type">number</span></dt>
        <dd>The value mapped to the new range.</dd>
    </dl>
    <h3>Details</h3>
    <p>This node will linearly scale the received value. By default, the result
    is not constrained to the range defined in the node.</p>
    <p><i>Scale and limit to target range</i> means that the result will never be outside
    the range specified within the target range.</p>
    <p><i>Scale and wrap within the target range</i> means that the result will
    be wrapped within the target range.</p>
    <p><i>Scale, but drop if outside input range</i> means that the result will
    be scaled, but any inputs outside of the inout range will be dropped.</p>
    <p>For example an input 0 - 10 mapped to 0 - 100.</p>
    <table style="outline-width:#888 solid thin">
        <tr><th width="80px">mode</th><th width="80px">input</th><th width="80px">output</th></tr>
        <tr><td><center>scale</center></td><td><center>12</center></td><td><center>120</center></td></tr>
        <tr><td><center>limit</center></td><td><center>12</center></td><td><center>100</center></td></tr>
        <tr><td><center>wrap</center></td><td><center>12</center></td><td><center>20</center></td></tr>
        <tr><td><center>drop</center></td><td><center>12</center></td><td><center><i>(no output)</i></center></td></tr>
    </table>
</script>

<!-- --- [red-module:node-red/template] --- -->

<script type="text/html" data-template-name="template">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <div style="display: inline-block; width: calc(100% - 105px)"><input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name"></div>
    </div>
    <div class="form-row">
        <label for="node-input-field"><i class="fa fa-ellipsis-h"></i> <span data-i18n="template.label.property"></span></label>
        <input type="text" id="node-input-field" placeholder="payload" style="width:250px;">
        <input type="hidden" id="node-input-fieldType">
    </div>
    <div class="form-row" style="position: relative; margin-bottom: 0px;">
        <label for="node-input-template"><i class="fa fa-file-code-o"></i> <span data-i18n="template.label.template"></span></label>
        <input type="hidden" id="node-input-template" autofocus="autofocus">
        <div style="position: absolute; right:0;display:inline-block; text-align: right; font-size: 0.8em;">
            <span data-i18n="template.label.format"></span>:
            <select id="node-input-format" style="width:110px; font-size: 10px !important;  height: 24px; padding:0;">
                <option value="handlebars">mustache</option>
                <option value="erlang">Erlang</option>
                <option value="elixir">Elixir</option>
                <option value="html">HTML</option>
                <option value="json">JSON</option>
                <option value="javascript">JavaScript</option>
                <option value="css">CSS</option>
                <option value="markdown">Markdown</option>
                <option value="php">PHP</option>
                <option value="python">Python</option>
                <option value="sql">SQL</option>
                <option value="yaml">YAML</option>
                <option value="xml">XML</option>
                <option value="text" data-i18n="template.label.none"></option>
            </select>
            <button type="button" id="node-template-expand-editor" class="red-ui-button red-ui-button-small"><i class="fa fa-expand"></i></button>
        </div>
    </div>
    <div class="form-row node-text-editor-row">
        <div style="height: 250px; min-height:150px;" class="node-text-editor" id="node-input-template-editor" ></div>
    </div>
    <div class="form-row">
        <label for="node-input-syntax"><i class="fa fa-code"></i> <span data-i18n="template.label.syntax"></span></label>
        <select id="node-input-syntax" style="width:180px;">
            <option value="mustache" data-i18n="template.label.mustache"></option>
            <option value="plain" data-i18n="template.label.plain"></option>
        </select>
    </div>
    <div class="form-row">
        <label for="node-input-output"><i class="fa fa-long-arrow-right"></i> <span data-i18n="template.label.output"></span></label>
        <select id="node-input-output" style="width:180px;">
            <option value="str" data-i18n="template.label.plain"></option>
            <option value="json" data-i18n="template.label.json"></option>
            <option value="yaml" data-i18n="template.label.yaml"></option>
        </select>
    </div>

</script>

<script type="text/javascript">
    RED.nodes.registerType('template',{
        color:"rgb(243, 181, 103)",
        category: 'function',
        defaults: {
            name: {value:""},
            field: {value:"payload",
                    label:"payload",
                    validate:RED.validators.typedInput("fieldType", false)},
            fieldType: {value:"msg"},
            format: {value:"handlebars"},
            syntax: {value:"mustache"},
            template: {value:"This is the payload: {{payload}} !"},
            output: {value:"str"}
        },
        inputs:1,
        outputs:1,
        icon: "template.svg",
        label: function() {
            return this.name||this._("template.template");;
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        oneditprepare: function() {
            const that = this;
            const stateId = RED.editor.generateViewStateId("node", this, "");
            if (!this.field) {
                this.field = 'payload';
                $("#node-input-field").val("payload");
            }
            if (!this.fieldType) {
                this.fieldType = 'msg';
            }
            if (!this.syntax) {
                this.syntax = 'mustache';
                $("#node-input-syntax").val(this.syntax);
            }
            $("#node-input-field").typedInput({
                default: 'msg',
                types: ['msg','flow','global'],
                typeField: $("#node-input-fieldType")
            });
            this.editor = RED.editor.createEditor({
                id: 'node-input-template-editor',
                mode: 'ace/mode/html',
                stateId: stateId,
                value: $("#node-input-template").val()
            });
            RED.library.create({
                url:"templates", // where to get the data from
                type:"template", // the type of object the library is for
                editor:that.editor, // the field name the main text body goes to
                fields:['name','format','output','syntax'],
                ext: "txt"
            });

            $("#node-input-format").on("change", function() {
                var mod = "ace/mode/"+$("#node-input-format").val();
                that.editor.getSession().setMode({
                    path: mod,
                    v: Date.now()
                });
            });
            RED.popover.tooltip($("#node-template-expand-editor"), RED._("node-red:common.label.expand"));
            $("#node-template-expand-editor").on("click", function (e) {
                e.preventDefault();
                const value = that.editor.getValue();
                that.editor.saveView();
                RED.editor.editText({
                    mode: $("#node-input-format").val(),
                    value: value,
                    stateId: stateId,
                    width: "Infinity",
                    focus: true,
                    complete: function (v, cursor) {
                        that.editor.setValue(v, -1);
                        setTimeout(function () {
                            that.editor.restoreView();
                            that.editor.focus();
                        }, 250);
                    }
                })
            })
        },
        oneditsave: function() {
            $("#node-input-template").val(this.editor.getValue());
            this.editor.destroy();
            delete this.editor;
        },
        oneditcancel: function() {
            this.editor.destroy();
            delete this.editor;
        },
        oneditresize: function(size) {
            var rows = $("#dialog-form>div:not(.node-text-editor-row)");
            var height = $("#dialog-form").height();
            for (var i=0; i<rows.length; i++) {
                height -= $(rows[i]).outerHeight(true);
            }
            var editorRow = $("#dialog-form>div.node-text-editor-row");
            height -= (parseInt(editorRow.css("marginTop"))+parseInt(editorRow.css("marginBottom")));
            $("#dialog-form .node-text-editor").css("height",height+"px");
            this.editor.resize();
        }
    });
</script>
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-help-name="template">
    <p>Sets a property based on the provided template.</p>
    <h3>Inputs</h3>
    <dl class="message-properties">
        <dt>msg <span class="property-type">object</span></dt>
        <dd>A msg object containing information to populate the template.</dd>
        <dt class="optional">template <span class="property-type">string</span></dt>
        <dd>A template to be populated from <code>msg.payload</code>. If not configured in the edit panel,
         this can be set as a property of msg.</dd>
    </dl>
    <h3>Outputs</h3>
    <dl class="message-properties">
        <dt>msg <span class="property-type">object</span></dt>
        <dd>a msg with a property set by populating the configured template with properties from the incoming msg.</dd>
    </dl>
    <h3>Details</h3>
    <p>By default this uses the <i><a href="http://mustache.github.io/mustache.5.html" target="_blank">mustache</a></i>
    format, but this can be switched off if required.</p>
    <p>For example, when a template of:
    <pre>Hello {{payload.name}}. Today is {{date}}</pre>
    <p>receives a message containing:
    <pre>{
  date: "Monday",
  payload: {
    name: "Fred"
  }
}</pre>
    <p>The resulting property will be:
    <pre>Hello Fred. Today is Monday</pre>
    <p>It is possible to use a property from the flow context or global context. Just use <code>{{flow.name}}</code> or
    <code>{{global.name}}</code>, or for persistable store <code>store</code> use <code>{{flow[store].name}}</code> or
    <code>{{global[store].name}}</code>.
    <p><b>Note: </b>By default, <i>mustache</i> will escape any non-alphanumeric or HTML entities in the values it substitutes.
       To prevent this, use <code>{{{triple}}}</code> braces.</p>
    <p>If you need to use <code>{{ }}</code> within your content, you can change the characters
       used to mark the templated sections. For example, to use <code>[[ ]]</code>
       instead, add the following line to the top of the template:</p>
    <pre>{{=[[ ]]=}}</pre>
    <h4>Using environment variables</h4>
    <p>The template node can access environment variables using the syntax:</p>
    <pre>My favourite colour is {{env.COLOUR}}.</pre>
</script>

<!-- --- [red-module:node-red/delay] --- -->
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-template-name="delay">
    <div class="form-row">
        <label for="node-input-delay-action"><i class="fa fa-tasks"></i> <span data-i18n="delay.action"></span></label>
        <select id="node-input-delay-action" style="width:270px !important">
            <option value="delay" data-i18n="delay.delaymsg"></option>
            <option value="rate" data-i18n="delay.limitrate"></option>
        </select>
    </div>

    <div id="delay-details">
        <div class="form-row">
            <label></label>
            <select id="node-input-delay-type" style="width:270px !important">
                <option value="delay" data-i18n="delay.delayfixed"></option>
                <option value="random" data-i18n="delay.randomdelay"></option>
                <option value="delayv" data-i18n="delay.delayvarmsg"></option>
            </select>
        </div>
        <div class="form-row" id="delay-details-for">
            <label for="node-input-timeout"><i class="fa fa-clock-o"></i> <span data-i18n="delay.for"></span></label>
            <input type="text" id="node-input-timeout" style="text-align:end; width:50px !important">
            <select id="node-input-timeoutUnits" style="width:200px !important">
              <option value="milliseconds" data-i18n="delay.milisecs"></option>
              <option value="seconds" data-i18n="delay.secs"></option>
              <option value="minutes" data-i18n="delay.mins"></option>
              <option value="hours" data-i18n="delay.hours"></option>
              <option value="days" data-i18n="delay.days"></option>
            </select>
        </div>
        <div id="random-details" class="form-row">
            <label for="node-input-randomFirst"><i class="fa fa-clock-o"></i> <span data-i18n="delay.between"></span></label>
            <input type="text" id="node-input-randomFirst" placeholder="" style="text-align:end; width:50px !important">
            &nbsp;<span data-i18n="delay.and"></span>&nbsp;
            <input type="text" id="node-input-randomLast" placeholder="" style="text-align:end; width:50px !important">
            <select id="node-input-randomUnits" style="width:140px !important">
              <option value="milliseconds" data-i18n="delay.milisecs"></option>
              <option value="seconds" data-i18n="delay.secs"></option>
              <option value="minutes" data-i18n="delay.mins"></option>
              <option value="hours" data-i18n="delay.hours"></option>
              <option value="days" data-i18n="delay.days"></option>
            </select>
        </div>
    </div>

    <div id="rate-details">
        <div class="form-row">
            <label></label>
            <select id="node-input-rate-type" style="width:270px !important">
                <option value="all" data-i18n="delay.limitall"></option>
                <option value="topic" data-i18n="delay.limittopic"></option>
            </select>
        </div>
        <div class="form-row">
            <label for="node-input-rate"><i class="fa fa-clock-o"></i> <span data-i18n="delay.rate"></span></label>
            <input type="text" id="node-input-rate" placeholder="1" style="text-align:end; width:40px !important">
            <label for="node-input-rateUnits"><span data-i18n="delay.msgper"></span></label>
            <input type="text" id="node-input-nbRateUnits" placeholder="1" style="text-align:end; width:40px !important">
            <select id="node-input-rateUnits" style="width:90px !important">
              <option value="second" data-i18n="delay.label.units.second.singular"></option>
              <option value="minute" data-i18n="delay.label.units.minute.singular"></option>
              <option value="hour" data-i18n="delay.label.units.hour.singular"></option>
              <option value="day" data-i18n="delay.label.units.day.singular"></option>
            </select>
        </div>
        <div class="form-row" id="rate-override" style="display: flex; align-items: center">
            <label></label><input style="width:30px; margin:0" type="checkbox" id="node-input-allowrate"><label style="margin:0;width: auto;" for="node-input-allowrate" data-i18n="delay.allowrate"></label>
        </div>
        <div class="form-row" id="rate-details-drop">
            <input type="hidden" id="node-input-outputs" value="1">
            <label></label>
            <select id="node-input-drop-select" style="width: 70%">
                <option id="node-input-drop-select-queue" value="queue" data-i18n="delay.queuemsg"></option>
                <option value="drop" data-i18n="delay.dropmsg"></option>
                <option value="emit" data-i18n="delay.sendmsg"></option>
            </select>
        </div>
        <div class="form-row" id="rate-details-per-topic">
            <label></label>
            <select id="node-input-rate-topic-type" style="width:270px !important">
                <option value="queue" data-i18n="delay.fairqueue"></option>
                <option value="timed" data-i18n="delay.timedqueue"></option>
            </select>
        </div>
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name">
    </div>
</script>

<script type="text/javascript">
    RED.nodes.registerType('delay',{
        category: 'function',
        color:"#E6E0F8",
        defaults: {
            name: {value:""},
            pauseType: {value:"delay", required:true},
            timeout: {
                value:"5", required:true,
                label:RED._("node-red:delay.label.delay"),
                validate:function(v,opt) {
                    if (RED.validators.number(v) && (v >= 0)) {
                        return true;
                    }
                    return RED._("node-red:delay.errors.invalid-timeout");
                }},
            timeoutUnits: {value:"seconds"},
            rate: {
                value:"1",
                required:true,
                label:RED._("node-red:delay.label.rate"),
                validate:function(v,opt) {
                    if (RED.validators.number(v) && (v >= 0)) {
                        return true;
                    }
                    return RED._("node-red:delay.errors.invalid-rate");
                }
            },
            nbRateUnits: {
                value:"1",
                required:false,
                validate:function(v,opt) {
                    if (v === undefined || (RED.validators.number(v) && (v >= 0))) {
                        return true;
                    }
                    return RED._("node-red:delay.errors.invalid-rate-unit");
                }
            },
            rateUnits: {value: "second"},
            randomFirst: {
                value:"1", required:true,
                validate:function(v,opt) {
                    if (RED.validators.number(v) && (v >= 0)) {
                        return true;
                    }
                    return RED._("node-red:delay.errors.invalid-random-first");
                }},
            randomLast: {
                value:"5", required:true,
                validate:function(v,opt) {
                    if (RED.validators.number(v) && (v >= 0)) {
                        return true;
                    }
                    return RED._("node-red:delay.errors.invalid-random-last");
                }},
            randomUnits: {value: "seconds"},
            drop: {value:false},
            allowrate: {value:false},
            outputs: { value: 1},
        },
        inputs:1,
        outputs:1,
        icon: "timer.svg",
        label: function() {
            if (this.name) {
                return this.name;
            }
            if (this.pauseType == "delayv") {
                return this._("delay.label.variable");
            } else if (this.pauseType == "delay") {
                var units = this.timeoutUnits ? this.timeoutUnits.charAt(0) : "s";
                if (this.timeoutUnits == "milliseconds") { units = "ms"; }
                return this._("delay.label.delay")+" "+this.timeout+units;
            } else if (this.pauseType == "random") {
                return this._("delay.label.random");
            } else {
                var rate = this.rate+" msg/"+(this.rateUnits ? (this.nbRateUnits > 1 ? this.nbRateUnits : '') + this.rateUnits.charAt(0) : "s");
                if (this.pauseType == "rate") {
                    return this._("delay.label.limit")+" "+rate;
                } else if (this.pauseType == "timed") {
                    return this._("delay.label.limitTopic")+" "+rate;
                } else {
                    return this._("delay.label.limitTopic")+" "+rate;
                }
            }
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        oneditprepare: function() {
            var node = this;
            $( "#node-input-timeout" ).spinner({min:1});
            $( "#node-input-rate" ).spinner({min:1});
            $( "#node-input-nbRateUnits" ).spinner({min:1});

            $( "#node-input-randomFirst" ).spinner({min:0});
            $( "#node-input-randomLast" ).spinner({min:1});

            $('.ui-spinner-button').on("click", function() {
                $(this).siblings('input').trigger("change");
            });

            $( "#node-input-nbRateUnits" ).on('change keyup', function() {
                var $this = $(this);
                var val = parseInt($this.val());
                var type = "singular";
                if (val > 1) {
                    type = "plural";
                }
                if ($this.attr("data-type") == type) {
                    return;
                }
                $this.attr("data-type", type);
                $("#node-input-rateUnits option").each(function () {
                    var $option = $(this);
                    var key = "delay.label.units." + $option.val() + "." + type;
                    $option.attr('data-i18n', 'node-red:' + key);
                    $option.html(node._(key));
                });
            });

            if (this.pauseType == "delay") {
                $("#node-input-delay-action").val('delay');
                $("#node-input-delay-type").val('delay');
            } else if (this.pauseType == "delayv") {
                $("#node-input-delay-action").val('delay');
                $("#node-input-delay-type").val('delayv');
            } else if (this.pauseType == "random") {
                $("#node-input-delay-action").val('delay');
                $("#node-input-delay-type").val('random');
            } else if (this.pauseType == "rate") {
                $("#node-input-delay-action").val('rate');
                $("#node-input-rate-type").val('all');
            } else if (this.pauseType == "queue") {
                $("#node-input-delay-action").val('rate');
                $("#node-input-rate-type").val('topic');
                $("#node-input-rate-topic-type").val('queue');
            } else if (this.pauseType == "timed") {
                $("#node-input-delay-action").val('rate');
                $("#node-input-rate-type").val('topic');
                $("#node-input-rate-topic-type").val('timed');
            }

            if (!this.timeoutUnits) {
                $("#node-input-timeoutUnits option").filter(function() {
                    return $(this).val() == 'seconds';
                }).attr('selected', true);
            }

            if (!this.randomUnits) {
                $("#node-input-randomUnits option").filter(function() {
                    return $(this).val() == 'seconds';
                }).attr('selected', true);
            }

            $("#node-input-delay-action").on("change",function() {
                if (this.value === "delay") {
                    $("#delay-details").show();
                    $("#rate-details").hide();
                } else if (this.value === "rate") {
                    $("#delay-details").hide();
                    $("#rate-details").show();
                }
            }).trigger("change");

            $("#node-input-delay-type").on("change", function() {
                if (this.value === "delay") {
                    $("#delay-details-for").show();
                    $("#random-details").hide();
                } else if (this.value === "delayv") {
                    $("#delay-details-for").show();
                    $("#random-details").hide();
                } else if (this.value === "random") {
                    $("#delay-details-for").hide();
                    $("#random-details").show();
                }
            }).trigger("change");

            if (this.outputs === 2) {
                $("#node-input-drop-select").val("emit");
            } else if (this.drop) {
                $("#node-input-drop-select").val("drop");
            } else {
                $("#node-input-drop-select").val("queue");
            }

            $("#node-input-rate-type").on("change", function() {
                if (this.value === "all") {
                    $("#rate-details-per-topic").hide();
                    $("#node-input-drop-select-queue").attr('disabled', false);
                } else if (this.value === "topic") {
                    if ($("#node-input-drop-select").val() === "queue") {
                        $("#node-input-drop-select").val("drop");
                    }
                    $("#node-input-drop-select-queue").attr('disabled', true);
                    $("#rate-details-per-topic").show();
                }
            }).trigger("change");
        },
        oneditsave: function() {
            var action = $("#node-input-delay-action").val();
            if (action === "delay") {
                this.pauseType = $("#node-input-delay-type").val();
                $("#node-input-outputs").val(1);
            } else if (action === "rate") {
                action = $("#node-input-rate-type").val();
                if (action === "all") {
                    this.pauseType = "rate";
                } else {
                    this.pauseType = $("#node-input-rate-topic-type").val();
                }
                var dropType = $("#node-input-drop-select").val();
                this.drop = dropType !== "queue";
                $("#node-input-outputs").val(dropType === "emit"?2:1);
            }
        }
    });
</script>
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-help-name="delay">
    <p>Delays each message passing through the node or limits the rate at which they can pass.</p>
    <h3>Inputs</h3>
    <dl class="message-properties">
        <dt class="optional">delay <span class="property-type">number</span></dt>
        <dd>Sets the delay, in milliseconds, to be applied to the message. This
            option only applies if the node is configured to allow the message to
            override the configured default delay interval.</dd>
        <dt class="optional">rate <span class="property-type">number</span></dt>
        <dd>Sets the rate value in milliseconds between messages.
            This node overwrites the existing rate value defined in the node configuration
            when it receives the message which contains <code>msg.rate</code> value in milliSeconds.
            This option only applies if the node is configured to allow the message to
            override the configured default rate interval.</dd>
        <dt class="optional">reset</dt>
        <dd>If the received message has this property set to any value, all
            outstanding messages held by the node are cleared without being sent.</dd>
        <dt class="optional">flush</dt>
        <dd>If the received message has this property set to a numeric value then that many messages
            will be released immediately. If set to any other type (e.g. boolean), then all
            outstanding messages held by the node are sent immediately.</dd>
        <dt class="optional">toFront</dt>
        <dd>When in rate limit mode, if the received message has this property set to boolean <code>true</code>,
            then the message is pushed to the front of the queue and will be released next.
            This can be used in combination with <code>msg.flush=1</code> to resend immediately.
        </dd>
    </dl>
    <h3>Details</h3>
    <p>When configured to delay messages, the delay interval can be a fixed value,
        a random value within a range or dynamically set for each message.
        Each message is delayed independently of any other message, based on
        the time of its arrival.
    </p>
    <p>When configured to rate limit messages, their delivery is spread across
        the configured time period. The status shows the number of messages currently in the queue.
        It can optionally discard intermediate messages as they arrive.</p>
    </p>
    <p>If set to allow override of the rate, the new rate will be applied immediately,
        and will remain in effect until changed again, the node is reset, or the flow is restarted.</p>
    <p>The rate limiting can be applied to all messages, or group them according to
        their <code>msg.topic</code> value. When grouping, intermediate messages are
        automatically dropped. At each time interval, the node can either release
        the most recent message for all topics, or release the most recent message
        for the next topic.
    </p>
    <p><b>Note</b>: In rate limit mode the maximum queue depth can be set by a property in your
        <i>settings.js</i> file. For example <code>nodeMessageBufferMaxLength: 1000,</code></p>
</script>

<!-- --- [red-module:node-red/trigger] --- -->
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-template-name="trigger">
    <div class="form-row">
        <label data-i18n="trigger.send" for="node-input-op1"></label>
        <input type="hidden" id="node-input-op1type">
        <input style="width:70%" type="text" id="node-input-op1" placeholder="1">
    </div>
    <div class="form-row">
        <label data-i18n="trigger.then"></label>
        <select id="node-then-type" style="width:70%;">
            <option value="block" data-i18n="trigger.wait-reset"></option>
            <option value="wait" data-i18n="trigger.wait-for"></option>
            <option id="node-trigger-wait-loop" value="loop" data-i18n="trigger.wait-loop"></option>
        </select>
    </div>
    <div class="form-row node-type-duration">
        <label></label>
        <input type="text" id="node-input-duration" style="text-align:end; width:70px !important">
        <select id="node-input-units" style="width:140px !important">
            <option value="ms" data-i18n="trigger.duration.ms"></option>
            <option value="s" data-i18n="trigger.duration.s"></option>
            <option value="min" data-i18n="trigger.duration.m"></option>
            <option value="hr" data-i18n="trigger.duration.h"></option>
        </select>
    </div>
    <div class="form-row node-type-wait">
    <label></label>
        <input type="checkbox" id="node-input-extend" style="margin-left:0px; vertical-align:top; width:auto !important;"> <label style="width:auto !important;" for="node-input-extend" data-i18n="trigger.extend"></label>
    </div>
    <div class="form-row node-type-override">
    <label></label>
        <input type="checkbox" id="node-input-overrideDelay" style="margin-left:0px; vertical-align:top; width:auto !important;"> <label style="width:auto !important;" for="node-input-overrideDelay" data-i18n="trigger.override"></label>
    </div>
    <div class="form-row node-type-wait">
        <label data-i18n="trigger.then-send"></label>
        <input type="hidden" id="node-input-op2type">
        <input style="width:70%" type="text" id="node-input-op2" placeholder="0">
    </div>
    <div class="form-row" id="node-second-output">
        <label></label>
            <input type="checkbox" id="node-input-second" style="margin-left: 0px; vertical-align: top; width: auto !important;"> <label style="width:auto !important;" for="node-input-second" data-i18n="trigger.second"></label>
        </div>
    <div class="form-row">
        <label data-i18n="trigger.label.reset" style="width:auto"></label>
        <div style="display:inline-block; width:70%;vertical-align:top">
        <ul>
            <li data-i18n="trigger.label.resetMessage"></li>
            <li><span data-i18n="trigger.label.resetPayload"></span> <input type="text" id="node-input-reset" style="width:150px" data-i18n="[placeholder]trigger.label.resetprompt"></li>
        </ul>
    </div>
    <br/>
    <div class="form-row">
        <label data-i18n="trigger.for" for="node-input-bytopic"></label>
        <select id="node-input-bytopic" style="width:120px;">
            <option value="all" data-i18n="trigger.alltopics"></option>
            <option value="topic" data-i18n="trigger.bytopics"></option>
        </select>
        <span class="form-row" id="node-stream-topic">
            <input type="text" id="node-input-topic" style="width:46%;"/>
        </span>
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name"></input>
        <input type="hidden" id="node-input-outputs" value="1">
    </div>
</script>

<script type="text/javascript">
    RED.nodes.registerType('trigger',{
        category: 'function',
        color:"#E6E0F8",
        defaults: {
            name: {value:""},
            op1: {value:"1",
                  label: RED._("node-red:trigger.send"),
                  validate: RED.validators.typedInput("op1type", false)},
            op2: {value:"0",
                  label: RED._("node-red:trigger.then-send"),
                  validate: RED.validators.typedInput("op2type", false)},
            op1type: {value:"val"},
            op2type: {value:"val"},
            duration: {
                value:"250", required:true,
                label:RED._("node-red:trigger.label.duration"),
                validate:RED.validators.number(false)},
            extend: {value:"false"},
            overrideDelay: {value:"false"},
            units: {value:"ms"},
            reset: {value:""},
            bytopic: {value:"all"},
            topic: {value:"topic", required:true,
                    label:RED._("node-red:trigger.label.topic")},
            outputs: {value:1}
        },
        inputs:1,
        outputs:1,
        icon: "trigger.svg",
        label: function() {
            if (this.duration > 0) {
                return this.name|| this._("trigger.label.trigger")+" "+this.duration+this.units;
            }
            if (this.duration < 0) {
                return this.name|| this._("trigger.label.trigger-loop")+" "+(this.duration * -1)+this.units;
            }
            else {
                return this.name|| this._("trigger.label.trigger-block");
            }
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        oneditprepare: function() {
            var that = this;
            if (this.topic === undefined) { $("#node-input-topic").val("topic"); }
            $("#node-input-topic").typedInput({default:'msg',types:['msg']});
            $("#node-input-bytopic").on("change", function() {
                if ($("#node-input-bytopic").val() === "all") {
                    $("#node-stream-topic").hide();
                } else {
                    $("#node-stream-topic").show();
                }
            });

            if (this.outputs == 2) { $("#node-input-second").prop('checked', true) }
            else { $("#node-input-second").prop('checked', false) }

            $("#node-input-second").change(function() {
                if ($("#node-input-second").is(":checked")) {
                    $("#node-input-outputs").val(2);
                }
                else  {
                    $("#node-input-outputs").val(1);
                }
            });
            $("#node-then-type").on("change", function() {
                if ($(this).val() == "block") {
                    $(".node-type-wait").hide();
                    $(".node-type-override").hide();
                    $(".node-type-duration").hide();
                    $("#node-second-output").hide();
                    $("#node-input-second").prop('checked', false);
                    $("#node-input-outputs").val(1);
                }
                else if ($(this).val() == "loop") {
                    if ($("#node-input-duration").val() == 0) { $("#node-input-duration").val(250); }
                    $(".node-type-wait").hide();
                    $(".node-type-override").show();
                    $(".node-type-duration").show();
                    $("#node-second-output").hide();
                    $("#node-input-second").prop('checked', false);
                    $("#node-input-outputs").val(1);
                } else {
                    if ($("#node-input-duration").val() == 0) { $("#node-input-duration").val(250); }
                    $(".node-type-wait").show();
                    $(".node-type-override").show();
                    $(".node-type-duration").show();
                    $("#node-second-output").show();
                }
            });

            if (this.op1type === 'val') {
                $("#node-input-op1type").val('str');
            }
            if (this.op2type === 'val') {
                $("#node-input-op2type").val('str');
            }

            $("#node-input-op1").on("change", function() {
                if ($("#node-input-op1type").val() === "nul") {
                    $("#node-trigger-wait-loop").hide();
                }
                else { $("#node-trigger-wait-loop").show(); }
            });

            var optionNothing = {value:"nul",label:this._("trigger.output.nothing"),hasValue:false};
            var optionPayload = {value:"pay",label:this._("trigger.output.existing"),hasValue:false};
            var optionOriginalPayload = {value:"pay",label:this._("trigger.output.original"),hasValue:false};
            var optionLatestPayload = {value:"payl",label:this._("trigger.output.latest"),hasValue:false};

            $("#node-input-op1").typedInput({
                default: 'str',
                typeField: $("#node-input-op1type"),
                types:['flow','global','str','num','bool','json','bin','date','env',
                    optionPayload,
                    optionNothing
                ]
            });
            $("#node-input-op2").typedInput({
                default: 'str',
                typeField: $("#node-input-op2type"),
                types:['flow','global','str','num','bool','json','bin','date','env',
                    optionOriginalPayload,
                    optionLatestPayload,
                    optionNothing
                ]
            });

            if (this.bytopic === undefined) {
                $("#node-input-bytopic").val("all");
            }

            if (this.duration == "0") {
                $("#node-then-type").val("block");
            }
            else if ((this.duration * 1) < 0) {
                $("#node-then-type").val("loop");
                $("#node-input-duration").val(this.duration*-1);
            } else {
                $("#node-then-type").val("wait");
            }
            $("#node-then-type").trigger("change");

            if (this.extend === "true" || this.extend === true) {
                $("#node-input-extend").prop("checked",true);
            } else {
                $("#node-input-extend").prop("checked",false);
            }
            if (this.overrideDelay === "true" || this.overrideDelay === true) {
                $("#node-input-overrideDelay").prop("checked",true);
            } else {
                $("#node-input-overrideDelay").prop("checked",false);
            }
        },
        oneditsave: function() {
            if ($("#node-then-type").val() == "block") {
                $("#node-input-duration").val("0");
            }
            if ($("#node-then-type").val() == "loop") {
                $("#node-input-duration").val($("#node-input-duration").val() * -1);
            }
        }
    });
</script>
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-help-name="trigger">
    <p>When triggered, can send a message, and then optionally a second message, unless extended or reset.</p>

    <h3>Inputs</h3>
    <dl class="message-properties">
        <dt class="optional">delay <span class="property-type">number</span></dt>
        <dd>Sets the delay, in milliseconds, to be applied to the message. This option only applies if the node is configured to allow the message to override the configured default delay interval.</dd>
        <dt class="optional">reset</dt>
        <dd>If a message is received with this property, any timeout or repeat
        currently in progress will be cleared and no message triggered.</dd>
    </dl>

    <h3>Details</h3>
    <p>This node can be used to create a timeout within a flow. By default, when
    it receives a message, it sends on a message with a <code>payload</code> of <code>1</code>.
    It then waits 250ms before sending a second message with a <code>payload</code> of <code>0</code>.
    This could be used, for example, to blink an LED attached to a Raspberry Pi GPIO pin.</p>
    <p>The payloads of each message sent can be configured to a variety of values, including
    the option to not send anything. For example, setting the initial message to <i>nothing</i> and
    selecting the option to extend the timer with each received message, the node will
    act as a watchdog timer; only sending a message if nothing is received within the
    set interval.</p>
    <p>If set to a <i>string</i> type, the node supports the mustache template syntax.</p>
    <p>The delay between sending messages can be overridden by <code>msg.delay</code> if that option is enabled in the node. The value must be provided in milliseconds.</p>
    <p>If the node receives a message with a <code>reset</code> property, or a <code>payload</code>
    that matches that configured in the node, any timeout or repeat currently in
    progress will be cleared and no message triggered.</p>
    <p>The node can be configured to resend a message at a regular interval until it
    is reset by a received message.</p>
    <p>Optionally, the node can be configured to treat messages as if they are separate streams,
    using a msg property to identify each stream. Default <code>msg.topic</code>.</p>
    <p>The status indicates the node is currently active. If multiple streams are used the status
    indicates the number of streams being held.</p>
</script>

<!-- --- [red-module:node-red/exec] --- -->
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-template-name="exec">
    <div class="form-row">
        <label for="node-input-command"><i class="fa fa-file"></i> <span data-i18n="exec.label.command"></span></label>
        <input type="text" id="node-input-command" data-i18n="[placeholder]exec.label.command">
    </div>
    <div class="form-row">
        <label><i class="fa fa-plus"></i> <span data-i18n="exec.label.append"></span></label>
        <input type="checkbox" id="node-input-addpay-cb" style="display:inline-block; width:auto;">
        <input type="text" id="node-input-addpay" style="margin-left: 5px; width:160px;">
    </div>
    <div class="form-row">
        <label for="node-input-append"> </label>
        <input type="text" id="node-input-append" data-i18n="[placeholder]exec.placeholder.extraparams">
    </div>
    <div class="form-row">
        <label><i class="fa fa-sign-out"></i> <span data-i18n="exec.label.return"></span></label>
        <select type="text" id="node-input-useSpawn" style="width:70%">
            <option value="false" data-i18n="exec.opt.exec"></option>
            <option value="true" data-i18n="exec.opt.spawn"></option>
        </select>
    </div>
    <div class="form-row">
        <label for="node-input-timer"><i class="fa fa-clock-o"></i> <span data-i18n="exec.label.timeout"></span></label>
        <input type="text" id="node-input-timer" style="width:65px;" data-i18n="[placeholder]exec.label.timeoutplace">
        <span data-i18n="exec.label.seconds"></span>
    </div>
    <div class="form-row">
        <label for="node-input-winHide" style="width: auto !important; padding-right:10px"><i class="fa fa-windows"></i> <span data-i18n="exec.label.winHide"></span></label>
        <input type="checkbox" id="node-input-winHide" style="margin-top: 0; display:inline-block; width:auto;">
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name">
    </div>
</script>

<script type="text/javascript">
    RED.nodes.registerType('exec',{
        category: 'function',
        color:"darksalmon",
        defaults: {
            command: {value:""},
            addpay: {value:"", validate: RED.validators.typedInput({ type: 'msg', allowBlank: true })},
            append: {value:""},
            useSpawn: {value:"false"},
            timer: {value:""},
            winHide: {value:false},
            oldrc: {value:false},
            name: {value:""}
        },
        inputs:1,
        outputs:3,
        outputLabels: function(i) {
            return [
                this._("exec.label.stdout"),
                this._("exec.label.stderr"),
                this._("exec.label.retcode")
            ][i];
        },
        icon: "cog.svg",
        label: function() {
            return this.name||this.command.replace(/\\n /g,"\\\\n ")||(this.useSpawn=="true"?this._("exec.spawn"):this._("exec.exec"));
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        oneditprepare: function() {
            if ($("#node-input-useSpawn").val() === null) {
                $("#node-input-useSpawn").val(this.useSpawn.toString());
            }
            $("#node-input-addpay-cb").prop("checked", this.addpay === true || (this.addpay !== false && this.addpay !== ""))
            var addpayValue = (this.addpay === true)?"payload":((this.addpay === false || this.addpay === "")?"payload":this.addpay);
            $("#node-input-addpay-cb").on("change", function(evt) {
                $("#node-input-addpay").typedInput("disable",!$("#node-input-addpay-cb").prop("checked"));
            });

            $("#node-input-addpay").val(addpayValue);
            $("#node-input-addpay").typedInput({
                default: "msg",
                types: ["msg"]
            });

            $("#node-input-addpay-cb").trigger("change")

            if (this.winHide === "true" || this.winHide === true) {
                $("#node-input-winHide").prop("checked",true);
            } else {
                $("#node-input-winHide").prop("checked",false);
            }
        },
        oneditsave: function() {
            if (!$("#node-input-addpay-cb").prop("checked")) {
                $("#node-input-addpay").val("");
            }
        }
    });
</script>
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-help-name="exec">
    <p>Runs a system command and returns its output.</p>
    <p>The node can be configured to either wait until the command completes, or to
    send its output as the command generates it.</p>
    <p>The command that is run can be configured in the node or provided by the received
    message.</p>

    <h3>Inputs</h3>
    <dl class="message-properties">
        <dt class="optional">payload <span class="property-type">string</span></dt>
        <dd>if configured to do so, will be appended to the executed command.</dd>
        <dt class="optional">kill <span class="property-type">string</span></dt>
        <dd>the type of kill signal to send an existing exec node process.</dd>
        <dt class="optional">pid <span class="property-type">number|string</span></dt>
        <dd>the process ID of an existing exec node process to kill.</dd>
    </dl>

    <h3>Outputs</h3>
    <ol class="node-ports">
        <li>Standard output
            <dl class="message-properties">
                <dt>payload <span class="property-type">string</span></dt>
                <dd>the standard output of the command.</dd>
            </dl>
            <dl class="message-properties">
                <dt>rc <span class="property-type">object</span></dt>
                <dd>exec mode only, a copy of the return code object (also available on port 3)</dd>
            </dl>
        </li>
        <li>Standard error
            <dl class="message-properties">
                <dt>payload <span class="property-type">string</span></dt>
                <dd>the standard error of the command.</dd>
            </dl>
            <dl class="message-properties">
                <dt>rc <span class="property-type">object</span></dt>
                <dd>exec mode only, a copy of the return code object (also available on port 3)</dd>
            </dl>
        </li>
        <li>Return code
            <dl class="message-properties">
                <dt>payload <span class="property-type">object</span></dt>
                <dd>an object containing the return code, and possibly <code>message</code>, <code>signal</code> properties.</dd>
            </dl>
        </li>
    </ol>
    <h3>Details</h3>
    <p>By default uses the <code>exec</code> system call which calls the command, waits for it to complete, and then
    returns the output. For example a successful command should have a return code of <code>{ code: 0 }</code>.</p>
    <p>Optionally can use <code>spawn</code> instead, which returns the output from stdout and stderr
    as the command runs, usually one line at a time. On completion it then returns an object
    on the 3rd port. For example, a successful command should return <code>{ code: 0 }</code>.</p>
    <p>Errors may return extra information on the 3rd port <code>msg.payload</code>, such as a <code>message</code> string,
    <code>signal</code> string.</p>
    <p>The command that is run is defined within the node, with an option to append <code>msg.payload</code> and a further set of parameters.</p>
    <p>Commands or parameters with spaces should be enclosed in quotes - <code>"This is a single parameter"</code></p>
    <p>The returned <code>payload</code> is usually a <i>string</i>, unless non-UTF8 characters are detected, in which
    case it is a <i>buffer</i>.</p>
    <p>The node&apos;s status icon and PID will be visible while the node is active. Changes to this can be read by the <code>Status</code> node.</p>
    <p>The <code>Hide console</code> option will hide the process console normally shown on Windows systems.</p>
    <h4>Killing processes</h4>
    <p>Sending <code>msg.kill</code> will kill a single active process. <code>msg.kill</code> should be a string containing
    the type of signal to be sent, for example, <code>SIGINT</code>, <code>SIGQUIT</code> or <code>SIGHUP</code>.
    Defaults to <code>SIGTERM</code> if set to an empty string.</p>
    <p>If the node has more than one process running then <code>msg.pid</code> must also be set with the value of the PID to be killed.</p>
    <p>If a value is provided in the <code>Timeout</code> field then, if the process has not completed when the specified number of seconds has elapsed, the process will be killed automatically</p>
    <p>Tip: if running a Python app you may need to use the <code>-u</code> parameter to stop the output being buffered.</p>
</script>

<!-- --- [red-module:node-red/rbe] --- -->

<script type="text/html" data-template-name="rbe">
    <div class="form-row">
        <label for="node-input-func"><i class="fa fa-wrench"></i> <span data-i18n="rbe.label.func"></span></label>
        <select type="text" id="node-input-func" style="width:70%;">
            <option value="rbe" data-i18n="rbe.opts.rbe"></option>
            <option value="rbei" data-i18n="rbe.opts.rbei"></option>
            <option value="deadbandEq" data-i18n="rbe.opts.deadbandEq"></option>
            <option value="deadband" data-i18n="rbe.opts.deadband"></option>
            <option value="narrowbandEq" data-i18n="rbe.opts.narrowbandEq"></option>
            <option value="narrowband" data-i18n="rbe.opts.narrowband"></option>
        </select>
    </div>
    <div class="form-row" id="node-bandgap">
        <label for="node-input-gap">&nbsp;</label>
        <input type="text" id="node-input-gap" data-i18n="[placeholder]rbe.placeholder.bandgap" style="width:95px;">
        <select type="text" id="node-input-inout" style="width:54%;">
            <option value="out" data-i18n="rbe.opts.out"></option>
            <option value="in" data-i18n="rbe.opts.in"></option>
        </select>
    </div>
    <div class="form-row" id="node-startvalue">
        <label for="node-input-start"><i class="fa fa-thumb-tack"></i> <span data-i18n="rbe.label.start"></span></label>
        <input type="text" id="node-input-start" data-i18n="[placeholder]rbe.placeholder.start" style="width:70%;">
    </div>
    <div class="form-row">
        <label for="node-input-property"><i class="fa fa-ellipsis-h"></i> <span data-i18n="node-red:common.label.property"></span></label>
        <input type="text" id="node-input-property" style="width:70%;"/>
    </div>
    <div class="form-row" style="margin-bottom: 0px;">
        <label> </label>
        <input type="checkbox" id="node-input-septopics" style="display:inline-block; width:20px; vertical-align:baseline;">
        <label style="width: auto" for="node-input-septopics" data-i18n="rbe.label.septopics"></label>
    </div>
    <div class="form-row">
        <label> </label>
        <input type="text" id="node-input-topi"  style="width:70%;"/>
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="rbe.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]rbe.label.name" style="width:70%;">
    </div>
</script>

<script type="text/javascript">
    RED.nodes.registerType("rbe", {
        color:"#E2D96E",
        category: 'function',
        defaults: {
            name: {value:""},
            func: {value:"rbe"},
            gap: {value:"",
                  label: RED._("node-red:rbe.label.gap"),
                  validate:RED.validators.regex(/^(\d*[.]*\d*|)(%|)$/)},
            start: {value:""},
            inout: {value:"out"},
            septopics: {value:true},
            property: {value:"payload", required:true,
                       label:RED._("node-red:rbe.label.property"),
                       validate: RED.validators.typedInput({ type: 'msg', allowUndefined: true })},
            topi: {value:"topic", required:true,
                   label:RED._("node-red:rbe.label.topic"),
                   validate: RED.validators.typedInput({ type: 'msg', allowUndefined: true })}
        },
        inputs:1,
        outputs:1,
        icon: "rbe.png",
        paletteLabel: "filter",
        label: function() {
            var ll = (this.func||"").replace("Eq","").replace("rbei",this._("rbe.rbe")).replace("rbe",this._("rbe.rbe"))||this._("rbe.rbe");
            return this.name||ll||this._("rbe.rbe");
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        oneditprepare: function() {
            if (this.property === undefined) {
                $("#node-input-property").val("payload");
            }
            if (this.septopics === undefined) {
                $("#node-input-septopics").prop('checked', true);
            }
            if (this.topi === undefined) {
                $("#node-input-topi").val("topic");
            }

            $("#node-input-property").typedInput({default:'msg',types:['msg']});
            $("#node-input-topi").typedInput({default:'msg',types:['msg']});
            //$( "#node-input-gap" ).spinner({min:0});
            if ($("#node-input-inout").val() === null) {
                $("#node-input-inout").val("out");
            }
            $("#node-input-func").on("change",function() {
                if (($("#node-input-func").val() === "rbe")||($("#node-input-func").val() === "rbei")) {
                    $("#node-bandgap").hide();
                } else {
                    $("#node-bandgap").show();
                }
                if (($("#node-input-func").val() === "narrowband")||($("#node-input-func").val() === "narrowbandEq")) {
                    $("#node-startvalue").show();
                } else {
                    $("#node-startvalue").hide();
                }
            });
            $("#node-input-septopics").on("change", function() {
                $("#node-input-topi").typedInput("disable",!this.checked);
            })
            $("#node-input-topi").typedInput("disable",!!!this.septopics);

        }
    });
</script>
<script type="text/html" data-help-name="rbe">
    <p>Report by Exception (RBE) node - only passes on data if the payload has changed.
       It can also block unless, or ignore if the value changes by a specified amount (Dead- and Narrowband mode).</p>
    <h3>Inputs</h3>
    <dl class="message-properties">
        <dt>payload
            <span class="property-type">number | string | (object)</span>
        </dt>
        <dd>RBE mode will accept numbers, strings, and simple objects.
            Other modes must provide a parseable number.</dd>
        <dt class="optional">topic <span class="property-type">string</span>
        </dt>
        <dd>if specified the function will work on a per topic basis. This property can be set by configuration.</dd>
        <dt class="optional">reset<span class="property-type">any</span></dt>
        <dd>if set clears the stored value for the specified msg.topic, or
            all topics if msg.topic is not specified.</dd>
    </dl>
    <h3>Outputs</h3>
    <dl class="message-properties">
        <dt>payload
            <span class="property-type">as per input</span>
        </dt>
        <dd>If triggered the output will be the same as the input.</dd>
    </dl>
    <h3>Details</h3>
    <p>In RBE mode this node will block until the <code>msg.payload</code>,
       (or selected property) value is different to the previous one.
       If required it can ignore the initial value, so as not to send anything at start.</p>
    <p>The <a href="https://en.wikipedia.org/wiki/Deadband" target="_blank">Deadband</a> modes will block the incoming value
       <i>unless</i> its change is greater or greater-equal than &plusmn; the band gap away from a previous value.</p>
    <p>The Narrowband modes will block the incoming value,
       <i>if</i> its change is greater or greater-equal than &plusmn; the band gap away from the previous value.
       It is useful for ignoring outliers from a faulty sensor for example.</p>
    <p>Both in Deadband and Narrowband modes the incoming value must contain a parseable number and
       both also supports % - only sends if/unless the input differs by more than x% of the original value.</p>
    <p>Both Deadband and Narrowband allow comparison against either the previous valid output value, thus
    ignoring any values out of range, or the previous input value, which resets the set point, thus allowing
    gradual drift (deadband), or a step change (narrowband).</p>
    <p><b>Note:</b> This works on a per <code>msg.topic</code> basis, though this can be changed to another property if desired.
       This means that a single filter node can handle multiple different topics at the same time.</p>
</script>

<!-- --- [red-module:node-red/tls] --- -->
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-template-name="tls-config">
    <div class="form-row" class="hide" id="node-config-row-uselocalfiles">
        <input type="checkbox" id="node-config-input-uselocalfiles" style="display: inline-block; width: auto; vertical-align: top;">
        <label for="node-config-input-uselocalfiles" style="width: 70%;"><span data-i18n="tls.label.use-local-files"></label>
    </div>
    <div class="form-row">
        <label style="width: 120px;"><i class="fa fa-file-text-o"></i> <span data-i18n="tls.label.cert"></span></label>
        <span class="tls-config-input-data">
            <label class="red-ui-button" for="node-config-input-certfile"><i class="fa fa-upload"></i> <span data-i18n="tls.label.upload"></span></label>
            <input class="hide" type="file" id="node-config-input-certfile">
            <span id="tls-config-certname" style="width: calc(100% - 280px); overflow: hidden; line-height:34px; height:34px; text-overflow: ellipsis; white-space: nowrap; display: inline-block; vertical-align: middle;"> </span>
            <button type="button" class="red-ui-button red-ui-button-small" id="tls-config-button-cert-clear" style="margin-left: 10px"><i class="fa fa-times"></i></button>
        </span>
        <input type="hidden" id="node-config-input-certname">
        <input type="hidden" id="node-config-input-certdata">
        <input class="hide tls-config-input-path" style="width: calc(100% - 170px);" type="text" id="node-config-input-cert" data-i18n="[placeholder]tls.placeholder.cert">
    </div>
    <div class="form-row">
        <label style="width: 120px;" for="node-config-input-key"><i class="fa fa-file-text-o"></i> <span data-i18n="tls.label.key"></span></label>
        <span class="tls-config-input-data">
            <label class="red-ui-button" for="node-config-input-keyfile"><i class="fa fa-upload"></i> <span data-i18n="tls.label.upload"></span></label>
            <input class="hide" type="file" id="node-config-input-keyfile">
            <span id="tls-config-keyname" style="width: calc(100% - 280px); overflow: hidden; line-height:34px; height:34px; text-overflow: ellipsis; white-space: nowrap; display: inline-block; vertical-align: middle;"> </span>
            <button type="button" class="red-ui-button red-ui-button-small" id="tls-config-button-key-clear" style="margin-left: 10px"><i class="fa fa-times"></i></button>
        </span>
        <input type="hidden" id="node-config-input-keyname">
        <input type="hidden" id="node-config-input-keydata">
        <input class="hide tls-config-input-path" style="width: calc(100% - 170px);" type="text" id="node-config-input-key" data-i18n="[placeholder]tls.placeholder.key">
    </div>
    <div class="form-row">
        <label style="width: 100px; margin-left: 20px;" for="node-config-input-passphrase"> <span data-i18n="tls.label.passphrase"></span></label>
        <input type="password" style="width: calc(100% - 170px);" id="node-config-input-passphrase" data-i18n="[placeholder]tls.placeholder.passphrase">
    </div>
    <div class="form-row">
        <label style="width: 120px;" for="node-config-input-ca"><i class="fa fa-file-text-o"></i> <span data-i18n="tls.label.ca"></span></label>
        <span class="tls-config-input-data">
            <label class="red-ui-button" for="node-config-input-cafile"><i class="fa fa-upload"></i> <span data-i18n="tls.label.upload"></span></label>
            <input class="hide" type="file" title=" " id="node-config-input-cafile">
            <span id="tls-config-caname" style="width: calc(100% - 280px); overflow: hidden; line-height:34px; height:34px; text-overflow: ellipsis; white-space: nowrap; display: inline-block; vertical-align: middle;"> </span>
            <button type="button" class="red-ui-button red-ui-button-small" id="tls-config-button-ca-clear" style="margin-left: 10px"><i class="fa fa-times"></i></button>
        </span>
        <input type="hidden" id="node-config-input-caname">
        <input type="hidden" id="node-config-input-cadata">
        <input class="hide tls-config-input-path" style="width: calc(100% - 170px);" type="text" id="node-config-input-ca" data-i18n="[placeholder]tls.placeholder.ca">
    </div>
    <div class="form-row">
        <input type="checkbox" id="node-config-input-verifyservercert" style="display: inline-block; width: auto; vertical-align: top;">
        <label for="node-config-input-verifyservercert" style="width: calc(100% - 170px);" data-i18n="tls.label.verify-server-cert"></label>
    </div>
    <div class="form-row">
        <label style="width: 126px;" for="node-config-input-servername"><i class="fa fa-server"></i> <span data-i18n="tls.label.servername"></span></label>
        <input style="width: calc(100% - 176px);" type="text" id="node-config-input-servername" data-i18n="[placeholder]tls.placeholder.servername">
    </div>
    <div class="form-row">
        <label style="width: 126px;" for="node-config-input-alpnprotocol"><i class="fa fa-cogs"></i> <span data-i18n="tls.label.alpnprotocol"></span></label>
        <input style="width: calc(100% - 176px);" type="text" id="node-config-input-alpnprotocol" data-i18n="[placeholder]tls.placeholder.alpnprotocol">
    </div>
    <hr>
    <div class="form-row">
        <label style="width: 120px;" for="node-config-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input style="width: calc(100% - 170px);" type="text" id="node-config-input-name" data-i18n="[placeholder]common.label.name">
    </div>
</script>

<script type="text/javascript">
    RED.nodes.registerType('tls-config',{
        category: 'config',
        defaults: {
            name: {value:""},
            cert: {value:"", validate: function(v,opt) {
                var currentKey = $("#node-config-input-key").val();
                if (currentKey === undefined) {
                    currentKey = this.key;
                }
                if (currentKey === '' || v != '') {
                    return true;
                }
                return RED._("node-red:tls.error.invalid-cert");
            }},
            key: {value:"", validate: function(v,opt) {
                var currentCert = $("#node-config-input-cert").val();
                if (currentCert === undefined) {
                    currentCert = this.cert;
                }
                if (currentCert === '' || v != '') {
                    return true;
                }
                return RED._("node-red:tls.error.invalid-key");
            }},
            ca: {value:""},
            certname: {value:""},
            keyname: {value:""},
            caname: {value:""},
            servername: {value:""},
            verifyservercert: {value: true},
            alpnprotocol: {value: ""}
        },
        credentials: {
            certdata: {type:"text"},
            keydata: {type:"text"},
            cadata: {type:"text"},
            passphrase: {type:"password"}
        },
        label: function() {
            return this.name || this._("tls.tls");
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        oneditprepare: function() {
            function updateFileUpload() {
                if ($("#node-config-input-uselocalfiles").is(':checked')) {
                    $(".tls-config-input-path").show();
                    $(".tls-config-input-data").hide();
                } else {
                    $(".tls-config-input-data").show();
                    $(".tls-config-input-path").hide();
                }
            }
            $("#node-config-input-uselocalfiles").on("click",function() {
                updateFileUpload();
            });

            function saveFile(property, file) {
                var dataInputId = "#node-config-input-"+property+"data";
                var filenameInputId = "#node-config-input-"+property+"name";
                var filename = file.name;
                var reader = new FileReader();
                reader.onload = function(event) {
                    $("#tls-config-"+property+"name").text(filename);
                    $(filenameInputId).val(filename);
                    $(dataInputId).val(event.target.result);
                }
                reader.readAsText(file,"UTF-8");
            }
            $("#node-config-input-certfile" ).on("change", function() {
                saveFile("cert", this.files[0]);
            });
            $("#node-config-input-keyfile" ).on("change", function() {
                saveFile("key", this.files[0]);
            });
            $("#node-config-input-cafile" ).on("change", function() {
                saveFile("ca", this.files[0]);
            });

            function clearNameData(prop) {
                $("#tls-config-"+prop+"name").text("");
                $("#node-config-input-"+prop+"data").val("");
                $("#node-config-input-"+prop+"name").val("");
            }
            $("#tls-config-button-cert-clear").on("click", function() {
                clearNameData("cert");
            });
            $("#tls-config-button-key-clear").on("click", function() {
                clearNameData("key");
            });
            $("#tls-config-button-ca-clear").on("click", function() {
                clearNameData("ca");
            });

            if (RED.settings.tlsConfigDisableLocalFiles) {
                $("#node-config-row-uselocalfiles").hide();
            } else {
                $("#node-config-row-uselocalfiles").show();
            }
            // in case paths were set from old TLS config
            if(this.cert || this.key || this.ca) {
                $("#node-config-input-uselocalfiles").prop('checked',true);
            }
            $("#tls-config-certname").text(this.certname);
            $("#tls-config-keyname").text(this.keyname);
            $("#tls-config-caname").text(this.caname);
            updateFileUpload();
        },
        oneditsave: function() {
            if ($("#node-config-input-uselocalfiles").is(':checked')) {
                clearNameData("ca");
                clearNameData("cert");
                clearNameData("key");
            } else {
                $("#node-config-input-ca").val("");
                $("#node-config-input-cert").val("");
                $("#node-config-input-key").val("");
            }
        }
    });
</script>
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-help-name="tls-config">
    <p>Configuration options for TLS connections.</p>
</script>

<!-- --- [red-module:node-red/httpproxy] --- -->
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-template-name="http proxy">
    <div class="form-row">
        <label for="node-config-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-config-input-name">
    </div>
    <div class="form-row">
        <label for="node-config-input-url"><i class="fa fa-globe"></i> <span data-i18n="httpin.label.url"></span></label>
        <input type="text" id="node-config-input-url" placeholder="http://hostname:port">
    </div>
    <div class="form-row">
        <input type="checkbox" id="node-config-input-useAuth" style="display: inline-block; width: auto; vertical-align: top;">
        <label for="node-config-input-useAuth" style="width: 70%;"><span data-i18n="httpin.use-proxyauth"></span></label>
        <div style="margin-left: 20px" class="node-config-input-useAuth-row hide">
            <div class="form-row">
                <label for="node-config-input-username"><i class="fa fa-user"></i> <span data-i18n="common.label.username"></span></label>
                <input type="text" id="node-config-input-username">
            </div>
            <div class="form-row">
                <label for="node-config-input-password"><i class="fa fa-lock"></i> <span data-i18n="common.label.password"></span></label>
                <input type="password" id="node-config-input-password">
            </div>
        </div>
    </div>
    <div class="form-row" style="margin-bottom:0;">
        <label><i class="fa fa-list"></i> <span data-i18n="httpin.noproxy-hosts"></span></label>
    </div>
    <div class="form-row node-config-input-noproxy-container-row">
        <ol id="node-config-input-noproxy-container"></ol>
    </div>
</script>

<script type="text/javascript">
    RED.nodes.registerType('http proxy', {
        category: 'config',
        defaults: {
            name: {value:''},
            url: {
                value:'',
                validate:function(v, opt) {
                    if ((v && (v.indexOf('://') !== -1) &&
                         (v.trim().indexOf('http') === 0))) {
                        return true;
                    }
                    return RED._("node-red:httpin.errors.invalid-url");
                }
            },
            noproxy: {value:[]}
        },
        credentials: {
            username: {type:'text'},
            password: {type:'password'}
        },
        label: function() {
            return this.name || this.url || ('http proxy:' + this.id);
        },
        oneditprepare: function() {
            $('#node-config-input-useAuth').on("change", function() {
                if ($(this).is(":checked")) {
                    $('.node-config-input-useAuth-row').show();
                } else {
                    $('.node-config-input-useAuth-row').hide();
                    $('#node-config-input-username').val('');
                    $('#node-config-input-password').val('');
                }
            });
            if (this.credentials.username || this.credentials.has_password) {
                $('#node-config-input-useAuth').prop('checked', true);
            } else {
                $('#node-config-input-useAuth').prop('checked', false);
            }
            $('#node-config-input-useAuth').change();

            var hostList = $('#node-config-input-noproxy-container')
                .css({'min-height':'150px','min-width':'450px'})
                .editableList({
                    addItem: function(container, index, data) {
                        var row = $('<div/>')
                            .css({overflow: 'hidden',whiteSpace: 'nowrap'})
                            .appendTo(container);

                        var hostField = $('<input/>',{class:'node-config-input-host',type:'text',placeholder:'hostname'})
                            .css({width:'100%'})
                            .appendTo(row);
                        if (data.host) {
                            hostField.val(data.host);
                        }
                    },
                    sortable: true,
                    removable: true
                });
            if (this.noproxy) {
                for (var i in this.noproxy) {
                    hostList.editableList('addItem', {host:this.noproxy[i]});
                }
            }
            if (hostList.editableList('items').length == 0) {
                hostList.editableList('addItem', {host:''});
            }
        },
        oneditsave: function() {
            var hosts = $('#node-config-input-noproxy-container').editableList('items');
            var node = this;
            node.noproxy = [];
            hosts.each(function(i) {
                var host = $(this).find('.node-config-input-host').val().trim();
                if (host) {
                    node.noproxy.push(host);
                }
            });
        },
        oneditresize: function(size) {
            var rows = $('#node-config-dialog-edit-form>div:not(.node-config-input-noproxy-container-row)');
            var height = size.height;
            for (var i = 0; i < rows.length; i++) {
                height -= $(rows[i]).outerHeight(true);
            }

            var editorRow = $('#node-config-dialog-edit-form>div.node-config-input-noproxy-container-row');
            height -= (parseInt(editorRow.css('margin-top')) + parseInt(editorRow.css('margin-bottom')));
            $('#node-config-input-noproxy-container').editableList('height',height);
        }
    });
</script>
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-help-name="http proxy">
    <p>Configuration options for HTTP proxy.</p>

    <h3>Details</h3>
    <p>When accessing to the host in the ignored host list, no proxy will be used.</p>
</script>

<!-- --- [red-module:node-red/mqtt] --- -->
<!--
  Copyright JS Foundation and other contributors, http://js.foundation
  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at
  http://www.apache.org/licenses/LICENSE-2.0
  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->
<style>

    .mqtt-form-row-cols2 > input.mqtt-form-row-col1 {
        width: calc(35% - 75px);
    }
    .mqtt-form-row-cols2 > select.mqtt-form-row-col1 {
        width: calc(35% - 75px);
    }

    .mqtt-form-row-cols2 > label.mqtt-form-row-col2 {
        width: 100px;
        margin-left: 42px;
        display: inline-block;
    }
    .mqtt-form-row-cols2 > input.mqtt-form-row-col2 {
        width: calc(35% - 75px);
        display: inline-block;
    }
    .mqtt-form-row-cols2 > select.mqtt-form-row-col2 {
        width: calc(35% - 75px);
        display: inline-block;
    }
    .form-row.mqtt5-out > label {
        width: 130px;
    }
    .form-row.mqtt-flags-row > label {
        vertical-align: top;
    }
    .form-row.mqtt-flags-row > .mqtt-flags {
        display: inline-block;
        width: 70%
    }

    .form-row.mqtt-flags-row > .mqtt-flags > .mqtt-flag > label {
        display: block;
        width: 100%;
    }
    .form-row.mqtt-flags-row > .mqtt-flags > .mqtt-flag > label > input {
        position: relative;
        vertical-align: bottom;
        top: -2px;
        width: 15px;
        height: 15px;
    }
    .form-row-mqtt5 {
        display: none;
    }
    .form-row-mqtt5.form-row-mqtt5-active:not(.form-row-mqtt-static-disabled) {
        display: block
    }
    .form-row-mqtt-static-disabled {
        display: none;
        /* opacity: 0.3;
        pointer-events: none; */
    }
    .form-row.form-row-mqtt-datatype-tip > .form-tips {
        width: calc(70% - 18px);
        display: inline-block;
        margin-top: -8px;
    }

</style>

<script type="text/html" data-template-name="mqtt in">
    <div class="form-row">
        <label for="node-input-broker"><i class="fa fa-globe"></i> <span data-i18n="mqtt.label.broker"></span></label>
        <input type="text" id="node-input-broker">
    </div>
    <div class="form-row">
        <label for="node-input-topicType" data-i18n="mqtt.label.action"></label>
        <select id="node-input-topicType" style="width: 70%">
            <option value="topic" data-i18n="mqtt.label.staticTopic"></option>
            <option value="dynamic" data-i18n="mqtt.label.dynamicTopic"></option>
        </select>
        <input type="hidden" id="node-input-inputs">
    </div>
    <div class="form-row form-row-mqtt-static">
        <label for="node-input-topic"><i class="fa fa-tasks"></i> <span data-i18n="common.label.topic"></span></label>
        <input type="text" id="node-input-topic" data-i18n="[placeholder]common.label.topic">
    </div>
    <div class="form-row form-row-mqtt-static">
        <label for="node-input-qos"><i class="fa fa-empire"></i> <span data-i18n="mqtt.label.qos"></span></label>
        <select id="node-input-qos" style="width:125px !important">
            <option value="0">0</option>
            <option value="1">1</option>
            <option value="2">2</option>
        </select>
    </div>
    <div class="form-row mqtt-flags-row form-row-mqtt5 form-row-mqtt-static">
        <label for="node-input-nl" ><i class="fa fa-flag"></i> <span data-i18n="mqtt.label.flags">Flags</span></label>
        <div class="mqtt-flags">
            <div class="mqtt-flag">
                <label for="node-input-nl">
                    <input type="checkbox" id="node-input-nl">
                    <span data-i18n="mqtt.label.nl"></span>
                </label>
            </div>
            <div class="mqtt-flag">
                <label for="node-input-rap">
                    <input type="checkbox" id="node-input-rap">
                    <span data-i18n="mqtt.label.rap"></span>
                </label>
            </div>
        </div>
    </div>
    <div class="form-row form-row-mqtt5 form-row-mqtt-static">
        <label for="node-input-rh" style="width:100%"><i class="fa fa-tag"></i> <span data-i18n="mqtt.label.rh"></span></label>
        <select id="node-input-rh" style="margin-left: 104px; width: 70%">
            <option value="0" data-i18n="mqtt.label.rh0"></option>
            <option value="1" data-i18n="mqtt.label.rh1"></option>
            <option value="2" data-i18n="mqtt.label.rh2"></option>
        </select>
    </div>
    <div class="form-row">
        <label for="node-input-datatype"><i class="fa fa-sign-out"></i> <span data-i18n="mqtt.label.output"></span></label>
        <select id="node-input-datatype" style="width:70%;">
            <option value="auto-detect" data-i18n="mqtt.output.auto-detect"></option>
            <option value="auto" data-i18n="mqtt.output.auto"></option>
            <option value="buffer" data-i18n="mqtt.output.buffer"></option>
            <option value="utf8" data-i18n="mqtt.output.string"></option>
            <option value="json" data-i18n="mqtt.output.json"></option>
            <option value="base64" data-i18n="mqtt.output.base64"></option>
        </select>
    </div>
    <div class="form-row form-row-mqtt-datatype-tip">
        <label> &nbsp; </label>
        <div class="form-tips" id="mqtt-in-datatype-depreciated-tip"><span data-i18n="mqtt.label.auto-mode-depreciated"></span></div>
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name">
    </div>
</script>

<script type="text/html" data-template-name="mqtt out">
    <div class="form-row">
        <label for="node-input-broker"><i class="fa fa-globe"></i> <span data-i18n="mqtt.label.broker"></span></label>
        <input type="text" id="node-input-broker">
    </div>
    <div class="form-row">
        <label for="node-input-topic"><i class="fa fa-tasks"></i> <span data-i18n="common.label.topic"></span></label>
        <input type="text" id="node-input-topic" data-i18n="[placeholder]common.label.topic">
    </div>

    <div class="form-row mqtt-form-row-cols2">
        <label for="node-input-qos" class="mqtt-form-row-col1"><i class="fa fa-empire"></i> <span data-i18n="mqtt.label.qos"></span></label>
        <select id="node-input-qos" class="mqtt-form-row-col1">
            <option value=""></option>
            <option value="0">0</option>
            <option value="1">1</option>
            <option value="2">2</option>
        </select>

        <label for="node-input-retain" class="mqtt-form-row-col2"><i class="fa fa-history"></i> <span data-i18n="mqtt.retain"></span></label>
        <select id="node-input-retain" class="mqtt-form-row-col2" >
            <option value=""></option>
            <option value="false" data-i18n="mqtt.false"></option>
            <option value="true" data-i18n="mqtt.true"></option>
        </select>
    </div>
    <div class="form-row mqtt5 mqtt5-out">
        <label for="node-input-userProps"><span data-i18n="mqtt.label.userProperties"></span></label>
        <input type="text" id="node-input-userProps" style="width: calc(100% - 166px);">
    </div>
    <div class="form-row mqtt5 mqtt5-out">
        <label for="node-input-respTopic"><span data-i18n="mqtt.label.responseTopic"></span></label>
        <input type="text" id="node-input-respTopic" style="width: calc(100% - 166px);">
    </div>
    <div class="form-row mqtt5 mqtt5-out">
        <label for="node-input-correl"><span data-i18n="mqtt.label.correlationData"></span></label>
        <input type="text" id="node-input-correl" style="width: calc(100% - 166px);">
    </div>
    <div class="form-row mqtt5 mqtt5-out">
        <label for="node-input-contentType"><span data-i18n="mqtt.label.contentType"></span></label>
        <input type="text" id="node-input-contentType" style="width: calc(100% - 166px);">
    </div>

    <div class="form-row mqtt-form-row-cols2 mqtt5 mqtt5-out">
        <label for="node-input-expiry" class="mqtt-form-row-col1"><span data-i18n="mqtt.label.expiry"></span></label>
        <input id="node-input-expiry"  style="width: calc(100% - 166px);" class="mqtt-form-row-col1" >
    </div>

    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name">
    </div>
    <div class="form-tips"><span data-i18n="mqtt.tip"></span></div>
</script>

<script type="text/html" data-template-name="mqtt-broker">
    <div class="form-row">
        <label for="node-config-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-config-input-name" data-i18n="[placeholder]common.label.name">
    </div>
    <div class="form-row">
        <ul style="min-width: 600px; margin-bottom: 20px;" id="node-config-mqtt-broker-tabs"></ul>
    </div>
    <div id="node-config-mqtt-broker-tabs-content" style="min-height:150px;">
        <div id="mqtt-broker-tab-connection" style="display:none">
            <div class="form-row node-input-broker">
                <label for="node-config-input-broker"><i class="fa fa-globe"></i> <span data-i18n="mqtt.label.broker"></span></label>
                <input type="text" id="node-config-input-broker" style="width: calc(100% - 300px);" data-i18n="[placeholder]mqtt.label.example">
                <label for="node-config-input-port" style="margin-left:20px; width:43px; "> <span data-i18n="mqtt.label.port"></span></label>
                <input type="text" id="node-config-input-port" data-i18n="[placeholder]mqtt.label.port" style="width:55px">
            </div>
            <div class="form-row" style="margin-bottom:0">
                <input type="checkbox" id="node-config-input-autoConnect" style="margin: 0 5px 0 104px; display: inline-block; width: auto;">
                <label for="node-config-input-autoConnect" style="width: auto"><span data-i18n="mqtt.label.auto-connect"></span></label>
            </div>
            <div class="form-row" style="height: 34px;">
                <input type="checkbox" id="node-config-input-usetls" style="height: 34px; margin: 0 5px 0 104px; display: inline-block; width: auto; vertical-align: top;">
                <label for="node-config-input-usetls" style="width: 100px; line-height: 34px;"><span data-i18n="mqtt.label.use-tls"></span></label>
                <span id="node-config-row-tls" class="hide"><input style="width: 320px;" type="text" id="node-config-input-tls"></span>
            </div>
            <div class="form-row">
                <label for="node-config-input-protocolVersion"><i class="fa fa-cog"></i> <span data-i18n="mqtt.label.protocolVersion"></span></label>
                <select id="node-config-input-protocolVersion" style="width:70%;">
                    <option value="3" data-i18n="mqtt.label.protocolVersion3"></option>
                    <option value="4" data-i18n="mqtt.label.protocolVersion4"></option>
                    <option value="5" data-i18n="mqtt.label.protocolVersion5"></option>
                </select>
            </div>
            <div class="form-row">
                <label for="node-config-input-clientid"><i class="fa fa-tag"></i> <span data-i18n="mqtt.label.clientid"></span></label>
                <input type="text" id="node-config-input-clientid" data-i18n="[placeholder]mqtt.placeholder.clientid">
            </div>
            <div class="form-row">
                <label for="node-config-input-keepalive"><i class="fa fa-heartbeat"></i> <span data-i18n="mqtt.label.keepalive"></span></label>
                <input type="number" min="0" id="node-config-input-keepalive" style="width: 100px">
            </div>
            <div class="form-row" style="margin-bottom:0">
                <label style="vertical-align:top;"><i class="fa fa-info"></i> <span data-i18n="mqtt.label.session"></span></label>
                <div style="display: inline-block; width:calc(100% - 110px)">
                    <div class="form-row">
                        <label for="node-config-input-cleansession" style="width: auto;">
                            <input type="checkbox" id="node-config-input-cleansession" style="position: relative;vertical-align: bottom; top: -2px; width: 15px;height: 15px;">
                            <span id="node-config-input-cleansession-label" data-i18n="mqtt.label.cleansession"></span>
                        </label>
                    </div>
                    <div class="form-row mqtt-persistence">
                        <label for="node-config-input-autoUnsubscribe" style="width: auto;">
                            <input type="checkbox" id="node-config-input-autoUnsubscribe" style="position: relative;vertical-align: bottom; top: -2px; width: 15px;height: 15px;">
                            <span id="node-config-input-autoUnsubscribe-label" data-i18n="mqtt.label.autoUnsubscribe"></span>
                        </label>
                    </div>
                    <div class="form-row mqtt5">
                        <label style="width:auto" for="node-config-input-sessionExpiry"><span data-i18n="mqtt.label.sessionExpiry"></span></label>
                        <input type="number" min="0" id="node-config-input-sessionExpiry" style="width: 100px" >
                    </div>
                </div>
            </div>
            <div class="form-row mqtt5">
                <label style="width: 125px;" for="node-config-input-userProps"><span data-i18n="mqtt.label.userProperties"></span></label>
                <input type="text" id="node-config-input-userProps" style="width: calc(100% - 166px);">
            </div>
            <br>
        </div>
        <div id="mqtt-broker-tab-security" style="display:none">
            <div class="form-row">
                <label for="node-config-input-user"><i class="fa fa-user"></i> <span data-i18n="common.label.username"></span></label>
                <input type="text" id="node-config-input-user">
            </div>
            <div class="form-row">
                <label for="node-config-input-password"><i class="fa fa-lock"></i> <span data-i18n="common.label.password"></span></label>
                <input type="password" id="node-config-input-password">
            </div>
        </div>
        <div id="mqtt-broker-tab-messages" style="display:none">
            <div id="mqtt-broker-section-birth">
                <div class="red-ui-palette-header">
                    <i class="fa fa-angle-down"></i><span data-i18n="mqtt.sections-label.birth-message"></span>
                </div>
                <div class="section-content" style="padding:10px 0 0 10px">
                    <div class="form-row">
                        <label style="width: 100px !important;" for="node-config-input-birthTopic"><i class="fa fa-tasks"></i> <span data-i18n="common.label.topic"></span></label>
                        <input style="width: calc(100% - 300px) !important" type="text" id="node-config-input-birthTopic" data-i18n="[placeholder]mqtt.placeholder.birth-topic">
                        <label style="margin-left: 10px; width: 90px !important;" for="node-config-input-birthRetain"><i class="fa fa-history"></i> <span data-i18n="mqtt.label.retain"></span></label>
                        <select id="node-config-input-birthRetain" style="width:75px !important">
                            <option value="false" data-i18n="mqtt.false"></option>
                            <option value="true" data-i18n="mqtt.true"></option>
                        </select>
                    </div>
                    <div class="form-row">
                        <label style="width: 100px !important;" for="node-config-input-birthPayload"><i class="fa fa-envelope"></i> <span data-i18n="common.label.payload"></span></label>
                        <input style="width: calc(100% - 300px) !important" type="text" id="node-config-input-birthPayload" style="width:300px" data-i18n="[placeholder]common.label.payload">
                        <label style="margin-left: 10px; width: 90px !important;" for="node-config-input-birthQos"><i class="fa fa-empire"></i> <span data-i18n="mqtt.label.qos"></span></label>
                        <select id="node-config-input-birthQos" style="width:75px !important">
                            <option value="0">0</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                        </select>
                    </div>
                    <div class="form-row mqtt5 mqtt5-out">
                        <label for="node-config-input-birth-contentType" data-i18n="mqtt.label.contentType"></label>
                        <input type="text" style="width:calc(100% - 200px);" id="node-config-input-birth-contentType">
                    </div>
                    <div class="form-row mqtt5 mqtt5-out">
                        <label for="node-config-input-birth-props" data-i18n="mqtt.label.userProperties"></label>
                        <input type="text" style="width:calc(100% - 200px);" id="node-config-input-birth-props">
                    </div>
                    <div class="form-row mqtt5 mqtt5-out">
                        <label for="node-config-input-birth-respTopic"><span data-i18n="mqtt.label.responseTopic"></span></label>
                        <input type="text" id="node-config-input-birth-respTopic" style="width: calc(100% - 200px);">
                    </div>
                    <div class="form-row mqtt5 mqtt5-out">
                        <label for="node-config-input-birth-correl"><span data-i18n="mqtt.label.correlationData"></span></label>
                        <input type="text" id="node-config-input-birth-correl" style="width: calc(100% - 200px);">
                    </div>
                    <div class="form-row mqtt5 mqtt5-out">
                        <label for="node-config-input-birth-expiry"><span data-i18n="mqtt.label.expiry"></span></label>
                        <input id="node-config-input-birth-expiry"  style="width: calc(100% - 200px);">
                    </div>
                </div>
            </div>
            <div id="mqtt-broker-section-close">
                <div class="red-ui-palette-header">
                    <i class="fa fa-angle-down"></i><span data-i18n="mqtt.sections-label.close-message"></span>
                </div>
                <div class="section-content" style="padding:10px 0 0 10px">
                    <div class="form-row">
                        <label style="width: 100px !important;" for="node-config-input-closeTopic"><i class="fa fa-tasks"></i> <span data-i18n="common.label.topic"></span></label>
                        <input style="width: calc(100% - 300px) !important" type="text" id="node-config-input-closeTopic" style="width:300px" data-i18n="[placeholder]mqtt.placeholder.close-topic">
                        <label style="margin-left: 10px; width: 90px !important;" for="node-config-input-closeRetain"><i class="fa fa-history"></i> <span data-i18n="mqtt.label.retain"></span></label>
                        <select id="node-config-input-closeRetain" style="width:75px !important">
                            <option value="false" data-i18n="mqtt.false"></option>
                            <option value="true" data-i18n="mqtt.true"></option>
                        </select>
                    </div>
                    <div class="form-row">
                        <label style="width: 100px !important;" for="node-config-input-closePayload"><i class="fa fa-envelope"></i> <span data-i18n="common.label.payload"></span></label>
                        <input style="width: calc(100% - 300px) !important" type="text" id="node-config-input-closePayload" style="width:300px" data-i18n="[placeholder]common.label.payload">
                        <label style="margin-left: 10px; width: 90px !important;" for="node-config-input-closeQos"><i class="fa fa-empire"></i> <span data-i18n="mqtt.label.qos"></span></label>
                        <select id="node-config-input-closeQos" style="width:75px !important">
                            <option value="0">0</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                        </select>
                    </div>
                    <div class="form-row mqtt5 mqtt5-out">
                        <label for="node-config-input-close-contentType" data-i18n="mqtt.label.contentType"></label>
                        <input type="text" style="width:calc(100% - 200px);" id="node-config-input-close-contentType">
                    </div>
                    <div class="form-row mqtt5 mqtt5-out">
                        <label for="node-config-input-close-props" data-i18n="mqtt.label.userProperties"></label>
                        <input type="text" style="width:calc(100% - 200px);" id="node-config-input-close-props">
                    </div>
                    <div class="form-row mqtt5 mqtt5-out">
                        <label for="node-config-input-close-respTopic"><span data-i18n="mqtt.label.responseTopic"></span></label>
                        <input type="text" id="node-config-input-close-respTopic" style="width: calc(100% - 200px);">
                    </div>
                    <div class="form-row mqtt5 mqtt5-out">
                        <label for="node-config-input-close-correl"><span data-i18n="mqtt.label.correlationData"></span></label>
                        <input type="text" id="node-config-input-close-correl" style="width: calc(100% - 200px);">
                    </div>
                    <div class="form-row mqtt5 mqtt5-out">
                        <label for="node-config-input-close-expiry"><span data-i18n="mqtt.label.expiry"></span></label>
                        <input id="node-config-input-close-expiry"  style="width: calc(100% - 200px);">
                    </div>
                </div>
            </div>
            <div id="mqtt-broker-section-will">
                <div class="red-ui-palette-header">
                    <i class="fa fa-angle-down"></i><span data-i18n="mqtt.sections-label.will-message"></span>
                </div>
                <div class="section-content" style="padding:10px 0 0 10px">
                    <div class="form-row">
                        <label style="width: 100px !important;" for="node-config-input-willTopic"><i class="fa fa-tasks"></i> <span data-i18n="common.label.topic"></span></label>
                        <input style="width: calc(100% - 300px) !important" type="text" id="node-config-input-willTopic" style="width:300px" data-i18n="[placeholder]mqtt.placeholder.will-topic">
                        <label style="margin-left: 10px; width: 90px !important;" for="node-config-input-willRetain"><i class="fa fa-history"></i> <span data-i18n="mqtt.label.retain"></span></label>
                        <select id="node-config-input-willRetain" style="width:75px !important">
                            <option value="false" data-i18n="mqtt.false"></option>
                            <option value="true" data-i18n="mqtt.true"></option>
                        </select>
                    </div>
                    <div class="form-row">
                        <label style="width: 100px !important;" for="node-config-input-willPayload"><i class="fa fa-envelope"></i> <span data-i18n="common.label.payload"></span></label>
                        <input style="width: calc(100% - 300px) !important" type="text" id="node-config-input-willPayload" style="width:300px" data-i18n="[placeholder]common.label.payload">
                        <label style="margin-left: 10px; width: 90px !important;" for="node-config-input-willQos"><i class="fa fa-empire"></i> <span data-i18n="mqtt.label.qos"></span></label>
                        <select id="node-config-input-willQos" style="width:75px !important">
                            <option value="0">0</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                        </select>
                    </div>
                    <div class="form-row mqtt5">
                        <label><span data-i18n="mqtt.label.delay"></span></label>
                        <input type="number" min="0" id="node-config-input-will-delay" style="width: 100px" >
                    </div>
                    <div class="form-row mqtt5 mqtt5-out">
                        <label for="node-config-input-will-contentType" data-i18n="mqtt.label.contentType"></label>
                        <input type="text" style="width:calc(100% - 200px);" id="node-config-input-will-contentType">
                    </div>
                    <div class="form-row mqtt5 mqtt5-out">
                        <label for="node-config-input-will-props" data-i18n="mqtt.label.userProperties"></label>
                        <input type="text" style="width:calc(100% - 200px);" id="node-config-input-will-props">
                    </div>
                    <div class="form-row mqtt5 mqtt5-out">
                        <label for="node-config-input-will-respTopic"><span data-i18n="mqtt.label.responseTopic"></span></label>
                        <input type="text" id="node-config-input-will-respTopic" style="width: calc(100% - 200px);">
                    </div>
                    <div class="form-row mqtt5 mqtt5-out">
                        <label for="node-config-input-will-correl"><span data-i18n="mqtt.label.correlationData"></span></label>
                        <input type="text" id="node-config-input-will-correl" style="width: calc(100% - 200px);">
                    </div>
                    <div class="form-row mqtt5 mqtt5-out">
                        <label for="node-config-input-will-expiry"><span data-i18n="mqtt.label.expiry"></span></label>
                        <input id="node-config-input-will-expiry"  style="width: calc(100% - 200px);">
                    </div>
                </div>
            </div>
        </div>
    </div>
</script>

<script type="text/javascript">
(function() {

    var typedInputNoneOpt = {
        value: 'none',
        label: RED._("node-red:mqtt.label.none"),
        hasValue: false
    };
    var makeTypedInputOpt = function(value){
        return {
            value: value,
            label:value,
            hasValue: false
        }
    }
    var contentTypeOpts = [
        typedInputNoneOpt,
        makeTypedInputOpt("application/json"),
        makeTypedInputOpt("application/octet-stream"),
        makeTypedInputOpt("text/csv"),
        makeTypedInputOpt("text/html"),
        makeTypedInputOpt("text/plain"),
        {
            value: "other",
            label: RED._("node-red:mqtt.label.other"),
            icon: "red/images/typedInput/az.svg"
        }
    ];

    function getDefaultContentType(value) {
        var defaultContentType;
        var matchedContentType = contentTypeOpts.filter(function(v) {
            return v.value === value;
        })
        if (matchedContentType.length > 0) {
            defaultContentType = matchedContentType[0].value;
        }
        if (value && !defaultContentType) {
            defaultContentType = 'other';
        }
        return defaultContentType || 'none'
    }
    /**
     * Test a topic string is valid for publishing
     * @param {string} topic
     * @returns `true` if it is a valid topic
     */
    function validateMQTTPublishTopic(topic, opts) {
        if(!topic || topic == "" || !/[\+#\b\f\n\r\t\v\0]/.test(topic)) {
            return true;
        }
        return RED._("node-red:mqtt.errors.invalid-topic");
    }
    RED.nodes.registerType('mqtt-broker',{
        category: 'config',
        defaults: {
            name: {value:""},
            broker: {value:"",required:true},
            port: {
                value:1883,required:false,
                label: RED._("node-red:mqtt.label.port"),
                validate:RED.validators.number(true)},
            tls: {type:"tls-config",required: false,
                  label:RED._("node-red:mqtt.label.use-tls") },
            clientid: {value:"", validate: function(v, opt) {
                let ok = true;
                if ($("#node-config-input-clientid").length) {
                    // Currently editing the node
                    let needClientId = !$("#node-config-input-cleansession").is(":checked")
                    if (needClientId) {
                        ok = (v||"").length > 0;
                    }
                } else {
                    let needClientId = !(this.cleansession===undefined || this.cleansession)
                    if (needClientId) {
                        ok = (v||"").length > 0;
                    }
                }
                if (!ok) {
                    return RED._("node-red:mqtt.errors.invalid-client-id");
                }
                return true;
            }},
            autoConnect: {value: true},
            usetls: {value: false},
            verifyservercert: { value: false},
            compatmode: { value: false},
            protocolVersion: { value: 4},
            keepalive: {
                value:60,
                label: RED._("node-red:mqtt.label.keepalive"),
                validate:RED.validators.number(false)},
            cleansession: {value: true},
            autoUnsubscribe: {value: true},
            birthTopic: {value:"", validate:validateMQTTPublishTopic},
            birthQos: {value:"0"},
            birthRetain: {value:"false"},
            birthPayload: {value:""},
            birthMsg: { value: {}},
            closeTopic: {value:"", validate:validateMQTTPublishTopic},
            closeQos: {value:"0"},
            closeRetain: {value:"false"},
            closePayload: {value:""},
            closeMsg: { value: {}},
            willTopic: {value:"", validate:validateMQTTPublishTopic},
            willQos: {value:"0"},
            willRetain: {value:"false"},
            willPayload: {value:""},
            willMsg: { value: {}},
            userProps: { value: ""},
            sessionExpiry: {value:0}
        },
        credentials: {
            user: {type:"text"},
            password: {type: "password"}
        },
        label: function() {
            if (this.name) {
                return this.name;
            }
            var b = this.broker;
            if (!b) { b = "undefined"; }
            var lab = "";
            lab = (this.clientid?this.clientid+"@":"")+b;
            if (b.indexOf("://") === -1){
                if (!this.port){ lab = lab + ":1883"; }
                else { lab = lab + ":" + this.port; }
            }
            return lab;
        },
        oneditprepare: function () {
            var tabs = RED.tabs.create({
                id: "node-config-mqtt-broker-tabs",
                onchange: function(tab) {
                    $("#node-config-mqtt-broker-tabs-content").children().hide();
                    $("#" + tab.id).show();
                }
            });
            tabs.addTab({
                id: "mqtt-broker-tab-connection",
                label: this._("mqtt.tabs-label.connection")
            });
            tabs.addTab({
                id: "mqtt-broker-tab-security",
                label: this._("mqtt.tabs-label.security")
            });

            tabs.addTab({
                id: "mqtt-broker-tab-messages",
                label: this._("mqtt.tabs-label.messages")
            });

            function setUpSection(sectionId, v5Opts, isExpanded) {
                var birthMessageSection = $("#mqtt-broker-section-"+sectionId);
                var paletteHeader = birthMessageSection.find('.red-ui-palette-header');
                var twistie = paletteHeader.find('i');
                var sectionContent = birthMessageSection.find('.section-content');

                function toggleSection(expanded) {
                    twistie.toggleClass('expanded', expanded);
                    sectionContent.toggle(expanded);
                }
                paletteHeader.on("click", function(e) {
                    e.preventDefault();
                    var isExpanded = twistie.hasClass('expanded');
                    toggleSection(!isExpanded);
                });
                toggleSection(isExpanded);
                $("#node-config-input-"+sectionId+"-contentType").val(v5Opts?v5Opts.contentType:"").typedInput({
                    default: getDefaultContentType(v5Opts?v5Opts.contentType:""),
                    types: contentTypeOpts,
                });

                $("#node-config-input-"+sectionId+"-props").val(v5Opts?v5Opts.userProps:"").typedInput({
                    default:  !(v5Opts?v5Opts.userProps:null)? 'none':'json',
                    types: [typedInputNoneOpt, 'json'],
                });
                $("#node-config-input-"+sectionId+"-respTopic").val(v5Opts?v5Opts.respTopic:"").typedInput({
                    default:  !(v5Opts?v5Opts.respTopic:null)? 'none':'str',
                    types: [typedInputNoneOpt, 'str'],
                });
                $("#node-config-input-"+sectionId+"-correl").val(v5Opts?v5Opts.correl:"").typedInput({
                    default:  !(v5Opts?v5Opts.correl:null)? 'none':'str',
                    types: [typedInputNoneOpt, 'str'],
                });
                $("#node-config-input-"+sectionId+"-expiry").val(v5Opts?v5Opts.expiry:"").typedInput({
                    default:  !(v5Opts?v5Opts.expiry:null)? 'none':'num',
                    types: [typedInputNoneOpt, 'num'],
                });
            }

            // show first section if none are set so the user gets the idea
            var showBirthSection = this.birthTopic !== ""
                || this.willTopic === ""
                && this.birthTopic === ""
                && this.closeTopic == "";
            setUpSection('birth', this.birthMsg, showBirthSection);
            setUpSection('close', this.closeMsg, this.closeTopic !== "");
            setUpSection('will', this.willMsg, this.willTopic !== "");

            if (this.willMsg) {
                $("#node-config-input-will-delay").val(this.willMsg.delay);
            }

            setTimeout(function() { tabs.resize(); },0);
            if (typeof this.cleansession === 'undefined') {
                this.cleansession = true;
                $("#node-config-input-cleansession").prop("checked",true);
            }
            if (typeof this.autoUnsubscribe === 'undefined') {
                this.autoUnsubscribe = true;
                $("#node-config-input-autoUnsubscribe").prop("checked",true);
            }
            if (typeof this.usetls === 'undefined') {
                this.usetls = false;
                $("#node-config-input-usetls").prop("checked",false);
            }
            if (typeof this.autoConnect === 'undefined') {
                this.autoConnect = true;
                $("#node-config-input-autoConnect").prop("checked",true);
            }
            if (this.compatmode === 'true' || this.compatmode === true) {
                delete this.compatmode;
                this.protocolVersion = 4;
            }
            if (typeof this.protocolVersion === 'undefined') {
                this.protocolVersion = 4;
            }
            $("#node-config-input-cleansession").on("change", function() {
                const useCleanSession = $("#node-config-input-cleansession").is(':checked');
                if(useCleanSession) {
                    $("div.form-row.mqtt-persistence").hide();
                } else {
                    $("div.form-row.mqtt-persistence").show();
                }
            });
            $("#node-config-input-protocolVersion").on("change", function() {
                var v5 = $("#node-config-input-protocolVersion").val() == "5";
                if(v5) {
                    $("#node-config-input-cleansession-label").text(RED._("node-red:mqtt.label.cleanstart"))
                    $("div.form-row.mqtt5").show();
                } else {
                    $("#node-config-input-cleansession-label").text(RED._("node-red:mqtt.label.cleansession"))
                    $("div.form-row.mqtt5").hide();
                }
            });
            $("#node-config-input-protocolVersion").val(this.protocolVersion);
            $("#node-config-input-userProps").typedInput({
                default:  !this.userProps ? 'none':'json',
                types: [typedInputNoneOpt, 'json']
            });
            $("#node-config-input-userProps").typedInput('value',this.userProps);
            if (typeof this.keepalive === 'undefined') {
                this.keepalive = 15;
                $("#node-config-input-keepalive").val(this.keepalive);
            }
            if (typeof this.birthQos === 'undefined') {
                this.birthQos = "0";
                $("#node-config-input-birthQos").val("0");
            }
            if (typeof this.closeQos === 'undefined') {
                this.willQos = "0";
                $("#node-config-input-willQos").val("0");
            }
            if (typeof this.willQos === 'undefined') {
                this.willQos = "0";
                $("#node-config-input-willQos").val("0");
            }


            function updateTLSOptions() {
                if ($("#node-config-input-usetls").is(':checked')) {
                    $("#node-config-row-tls").show();
                } else {
                    $("#node-config-row-tls").hide();
                }
            }
            updateTLSOptions();
            $("#node-config-input-usetls").on("click",function() {
                updateTLSOptions();
            });
            var node = this;
            function updateClientId() {
                if ($("#node-config-input-cleansession").is(":checked")) {
                    $("#node-config-input-clientid").attr("placeholder",node._("mqtt.placeholder.clientid"));
                } else {
                    $("#node-config-input-clientid").attr("placeholder",node._("mqtt.placeholder.clientid-nonclean"));
                }
                $("#node-config-input-clientid").trigger("change");
            }
            setTimeout(updateClientId,0);
            $("#node-config-input-cleansession").on("click",function() {
                updateClientId();
            });

            function updatePortEntry(){
                var disabled = $("#node-config-input-port").prop("disabled");
                if ($("#node-config-input-broker").val().indexOf("://") === -1){
                    if (disabled){
                        $("#node-config-input-port").prop("disabled", false);
                    }
                }
                else {
                    if (!disabled){
                        $("#node-config-input-port").prop("disabled", true);
                    }
                }
            }
            $("#node-config-input-broker").on("change", function() {
                updatePortEntry();
            });
            $("#node-config-input-broker").on( "keyup", function() {
                updatePortEntry();
            });
            setTimeout(updatePortEntry,50);
            setTimeout(function() {
                $("#node-config-input-protocolVersion").trigger("change");
            },50);

        },
        oneditsave: function() {
            if (!$("#node-config-input-usetls").is(':checked')) {
                $("#node-config-input-tls").val("");
            }

            var v5 = $("#node-config-input-protocolVersion").val() == "5";

            function saveV5Message(section) {
                var msg = {};
                if ($("#node-config-input-"+section+"Topic").val().trim().length > 0) {
                    var contentType = $("#node-config-input-"+section+"-contentType").val().trim();
                    if (contentType === '') {
                        contentType = $("#node-config-input-"+section+"-contentType").typedInput('type');
                        if (contentType === 'none' || contentType === 'other') {
                            contentType = "";
                        }
                    }
                    if (contentType) {
                        msg.contentType = contentType;
                    }
                    var props = $("#node-config-input-"+section+"-props").val().trim();
                    if (props) {
                        msg.userProps = props;
                    }
                    var resp = $("#node-config-input-"+section+"-respTopic").val().trim();
                    if (props) {
                        msg.respTopic = resp;
                    }
                    var correl = $("#node-config-input-"+section+"-correl").val().trim();
                    if (correl) {
                        msg.correl = correl;
                    }
                    var expiry = $("#node-config-input-"+section+"-expiry").val().trim();
                    if (expiry) {
                        msg.expiry = expiry;
                    }
                }
                return msg;
            }

            if (v5) {
                this.userProps = "";
                const userPropsType = $("#node-config-input-userProps").typedInput("type");
                if(userPropsType == "json") {
                    const userProps = $("#node-config-input-userProps").val();
                    if (userProps && typeof userProps === "string") {
                        this.userProps = userProps.trim();
                    }
                }
                this.birthMsg = saveV5Message("birth");
                this.closeMsg = saveV5Message("close");
                this.willMsg = saveV5Message("will");
                var willDelay = $("#node-config-input-will-delay").val();
                if (willDelay) {
                    this.willMsg.delay = willDelay;
                }
            } else {
                this.willMsg = {};
                this.birthMsg = {};
                this.closeMsg = {};
            }

        }
    });

    RED.nodes.registerType('mqtt in',{
        category: 'network',
        defaults: {
            name: {value:""},
            topic: {
                value:"",
                validate: function(v, opt) {
                    var isDynamic = this.inputs === 1;
                    var topicTypeSelect = $("#node-input-topicType");
                    if (topicTypeSelect.length) {
                        isDynamic = topicTypeSelect.val()==='dynamic'
                    }
                    if (isDynamic || ((!!v) && RED.validators.regex(/^(#$|(\+|[^+#]*)(\/(\+|[^+#]*))*(\/(\+|#|[^+#]*))?$)/)(v))) {
                        return true;
                    }
                    return RED._("node-red:mqtt.errors.invalid-topic");
                }
            },
            qos: {value: "2"},
            datatype: {value:"auto-detect",required:true},
            broker: {type:"mqtt-broker", required:true, label:RED._("node-red:mqtt.label.broker")},
            // subscriptionIdentifier: {value:0},
            nl: {value:false},
            rap: {value:true},
            rh: {value:0},
            inputs: {value:0},
        },
        color:"#d8bfd8",
        inputs:0,
        outputs:1,
        icon: "bridge.svg",
        label: function() {
            var label = "mqtt";
            if(this.topicType !== "dynamic" && this.topic) {
                label = this.topic;
            }
            return this.name || label;
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        oneditprepare: function() {
            const node = this;
            const isV5Broker = function() {
                var confNode = RED.nodes.node($("#node-input-broker").val());
                return confNode && confNode.protocolVersion === "5";
            }
            const isDynamic = function() {
                return $('#node-input-topicType').val() === "dynamic";
            }
            const updateVisibility = function() {
                var v5 = isV5Broker();
                var dynamic = isDynamic();
                $("div.form-row-mqtt5").toggleClass("form-row-mqtt5-active",!!v5);
                $("div.form-row.form-row-mqtt-static").toggleClass("form-row-mqtt-static-disabled", !!dynamic)
            }

            $("#node-input-datatype").on("change", function() {
                if($(this).val() === "auto") {
                    $(".form-row.form-row-mqtt-datatype-tip").show();
                } else {
                    $(".form-row.form-row-mqtt-datatype-tip").hide();
                }
            })
            $("#node-input-datatype").trigger("change");

            $("#node-input-broker").on("change",function(d){
                updateVisibility();
            });

            $('#node-input-topicType').on("change", function () {
                $("#node-input-inputs").val(isDynamic() ? 1 : 0);
                updateVisibility();
            });

            if (this.inputs === 1) {
                $('#node-input-topicType').val('dynamic')
            } else {
                $('#node-input-topicType').val('topic')
            }
            $('#node-input-topicType').trigger("change");

            if (this.qos === undefined) {
                $("#node-input-qos").val("2");
            }
            if (this.datatype === undefined) {
                $("#node-input-datatype").val("auto-detect");
            }
        },
        oneditsave: function() {
            if ($('#node-input-topicType').val() === "dynamic") {
                $('#node-input-topic').val("");
            }
        }
    });

    RED.nodes.registerType('mqtt out',{
        category: 'network',
        defaults: {
            name: {value:""},
            topic: {value:"", validate:validateMQTTPublishTopic},
            qos: {value:""},
            retain: {value:""},
            respTopic: {value:""},
            contentType: {value:""},
            userProps: {value:''},
            correl: {value:''},
            expiry: {value:''},
            broker: {type:"mqtt-broker", required:true,
                     label:RED._("node-red:mqtt.label.broker") }
        },
        color:"#d8bfd8",
        inputs:1,
        outputs:0,
        icon: "bridge.svg",
        align: "right",
        label: function() {
            return this.name||this.topic||"mqtt";
        },
        oneditprepare: function() {
            var that = this;

            function showHideDynamicFields() {
                var confNode = RED.nodes.node($("#node-input-broker").val());
                var v5 = confNode && confNode.protocolVersion == "5";
                if(v5) {
                    $("div.form-row.mqtt5").show();
                    var t = $("#node-input-respTopic").typedInput("type");
                    if (t == 'none') {
                        $("#node-input-correl").parent().hide();
                    } else {
                        $("#node-input-correl").parent().show();
                    }
                } else {
                    $("div.form-row.mqtt5").hide();
                }
            }

            $("#node-input-broker").on("change",function(d){
                showHideDynamicFields();
            });

            var respTopicTI = $("#node-input-respTopic").typedInput({
                default: !this.respTopic ? 'none':'str',
                types: [typedInputNoneOpt,  'str'],
            });

            var correlTI = $("#node-input-correl").typedInput({
                default: !this.correl ? 'none':'str',
                types: [typedInputNoneOpt,  'str']
            });
            //show / hide correlation data depending on respTopic
            respTopicTI.on("change", showHideDynamicFields);
            respTopicTI.triggerHandler("change");

            $("#node-input-userProps").typedInput({
                default:  !this.userProps ? 'none':'json',
                types: [typedInputNoneOpt, 'json'],
            });
            $("#node-input-expiry").typedInput({
                default: !this.expiry ? 'none':'num',
                types: [typedInputNoneOpt,  'num']
            });
            $("#node-input-contentType").typedInput({
                default: getDefaultContentType(this.contentType),
                types: contentTypeOpts
            })
        },
        oneditsave: function() {

            var contentType = $("#node-input-contentType").val().trim();
            if (contentType === '') {
                contentType = $("#node-input-contentType").typedInput('type');
                if (contentType === 'none' || contentType === 'other') {
                    contentType = "";
                }
            }
            $("#node-input-contentType").val(contentType)

        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        }
    });
})();
</script>
<!--
  Copyright JS Foundation and other contributors, http://js.foundation
  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at
  http://www.apache.org/licenses/LICENSE-2.0
  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-help-name="mqtt in">
<p>Connects to a MQTT broker and subscribes to messages from the specified topic.</p>
    <h3>Outputs</h3>
    <dl class="message-properties">
       <dt>payload <span class="property-type">string | buffer</span></dt>
       <dd>a string unless detected as a binary buffer.</dd>
       <dt>topic <span class="property-type">string</span></dt>
       <dd>the MQTT topic, uses / as a hierarchy separator.</dd>
       <dt>qos <span class="property-type">number</span> </dt>
       <dd>0, fire and forget - 1, at least once - 2, once and once only.</dd>
       <dt>retain <span class="property-type">boolean</span></dt>
       <dd>true indicates the message was retained and may be old.</dd>

       <dt class="optional">responseTopic <span class="property-type">string</span></dt>
       <dd><b>MQTTv5</b>: the MQTT response topic for the message</dd>
       <dt class="optional">correlationData <span class="property-type">Buffer</span></dt>
       <dd><b>MQTTv5</b>: the correlation data for the message</dd>
       <dt class="optional">contentType <span class="property-type">string</span></dt>
       <dd><b>MQTTv5</b>: the content-type of the payload</dd>
       <dt class="optional">userProperties <span class="property-type">object</span></dt>
       <dd><b>MQTTv5</b>: any user properties of the message</dd>
       <dt class="optional">messageExpiryInterval <span class="property-type">number</span></dt>
       <dd><b>MQTTv5</b>: the expiry time, in seconds, of the message</dd>
    </dl>
    <h3>Details</h3>
    The subscription topic can include MQTT wildcards, + for one level, # for multiple levels.</p>
    <p>This node requires a connection to a MQTT broker to be configured. This is configured by clicking
    the pencil icon.</p>
    <p>Several MQTT nodes (in or out) can share the same broker connection if required.</p>
    <h4>Dynamic Subscription</h4>
    The node can be configured to dynamically control the MQTT connection and its subscriptions. When
    enabled, the node will have an input and can be controlled by passing it messages.
    <h3>Inputs</h3>
    <p>These only apply when the node has been configured for dynamic subscriptions.</p>
    <dl class="message-properties">
       <dt>action <span class="property-type">string</span></dt>
       <dd>the name of the action the node should perform. Available actions are: <code>"connect"</code>,
       <code>"disconnect"</code>, <code>"getSubscriptions"</code>, <code>"subscribe"</code> and
       <code>"unsubscribe"</code>.</dd>
       <dt class="optional">topic <span class="property-type">string|object|array</span></dt>
       <dd>For the <code>"subscribe"</code> and <code>"unsubscribe"</code> actions, this property
           provides the topic. It can be set as either:<ul>
           <li>a String containing the topic filter</li>
           <li>an Object containing <code>topic</code> and <code>qos</code> properties</li>
           <li>an array of either strings or objects to handle multiple topics in one</li>
            </ul>
        </dd>
       <dt class="optional">broker <span class="property-type">broker</span> </dt>
       <dd>For the <code>"connect"</code> action, this property can override any
           of the individual broker configuration settings, including: <ul>
               <li><code>broker</code></li>
               <li><code>port</code></li>
               <li><code>url</code> - overrides broker/port to provide a complete connection url</li>
               <li><code>username</code></li>
               <li><code>password</code></li>
           </ul>
           <p>If this property is set and the broker is already connected an error
              will be logged unless it has the <code>force</code> property set - in which case it will
              disconnect from the broker, apply the new settings and reconnect.</p>
       </dd>
    </dl>

</script>

<script type="text/html" data-help-name="mqtt out">
    <p>Connects to a MQTT broker and publishes messages.</p>
    <h3>Inputs</h3>
    <dl class="message-properties">
       <dt>payload <span class="property-type">string | buffer</span></dt>
       <dd> the payload to publish. If this property is not set, no message will be sent. To send a blank message, set this property to an empty String.</dd>
       <dt class="optional">topic <span class="property-type">string</span></dt>
       <dd> the MQTT topic to publish to.</dd>
       <dt class="optional">qos <span class="property-type">number</span></dt>
       <dd>0, fire and forget - 1, at least once - 2, once and once only. Default 0.</dd>
       <dt class="optional">retain <span class="property-type">boolean</span></dt>
       <dd>set to true to retain the message on the broker. Default false.</dd>
       <dt class="optional">responseTopic <span class="property-type">string</span></dt>
       <dd><b>MQTTv5</b>: the MQTT response topic for the message</dd>
       <dt class="optional">correlationData <span class="property-type">Buffer</span></dt>
       <dd><b>MQTTv5</b>: the correlation data for the message</dd>
       <dt class="optional">contentType <span class="property-type">string</span></dt>
       <dd><b>MQTTv5</b>: the content-type of the payload</dd>
       <dt class="optional">userProperties <span class="property-type">object</span></dt>
       <dd><b>MQTTv5</b>: any user properties of the message</dd>
       <dt class="optional">messageExpiryInterval <span class="property-type">number</span></dt>
       <dd><b>MQTTv5</b>: the expiry time, in seconds, of the message</dd>
       <dt class="optional">topicAlias <span class="property-type">number</span></dt>
       <dd><b>MQTTv5</b>: the MQTT topic alias to use</dd>
    </dl>
    <h3>Details</h3>
    <code>msg.payload</code> is used as the payload of the published message.
    If it contains an Object it will be converted to a JSON string before being sent.
    If it contains a binary Buffer the message will be published as-is.</p>
    <p>The topic used can be configured in the node or, if left blank, can be set by <code>msg.topic</code>.</p>
    <p>Likewise the QoS and retain values can be configured in the node or, if left
    blank, set by <code>msg.qos</code> and <code>msg.retain</code> respectively. To clear a previously
    retained topic from the broker, send a blank message to that topic with the retain flag set.</p>
    <p>This node requires a connection to a MQTT broker to be configured. This is configured by clicking
    the pencil icon.</p>
    <p>Several MQTT nodes (in or out) can share the same broker connection if required.</p>

    <h4>Dynamic Control</h4>
    The connection shared by the node can be controlled dynamically. If the node receives
    one of the following control messages, it will not publish the message payload as well.
    <h3>Inputs</h3>
    <dl class="message-properties">
       <dt>action <span class="property-type">string</span></dt>
       <dd>the name of the action the node should perform. Available actions are: <code>"connect"</code>,
       and <code>"disconnect"</code>.</dd>
       <dt class="optional">broker <span class="property-type">broker</span> </dt>
       <dd>For the <code>"connect"</code> action, this property can override any
           of the individual broker configuration settings, including: <ul>
               <li><code>broker</code></li>
               <li><code>port</code></li>
               <li><code>url</code> - overrides broker/port to provide a complete connection url</li>
               <li><code>username</code></li>
               <li><code>password</code></li>
           </ul>
           <p>If this property is set and the broker is already connected an error
              will be logged unless it has the <code>force</code> property set - in which case it will
              disconnect from the broker, apply the new settings and reconnect.</p>
       </dd>
    </dl>

</script>

<script type="text/html" data-help-name="mqtt-broker">
    <p>Configuration for a connection to an MQTT broker.</p>
    <p>This configuration will create a single connection to the broker which can
       then be reused by <code>MQTT In</code> and <code>MQTT Out</code> nodes.</p>
    <p>The node will generate a random Client ID if one is not set and the
       node is configured to use a Clean Session connection. If a Client ID is set,
       it must be unique to the broker you are connecting to.</p>
    <h4>Birth Message</h4>
    <p>This is a message that will be published on the configured topic whenever the
       connection is established.</p>
    <h4>Close Message</h4>
    <p>This is a message that will be published on the configured topic before the
       connection is closed normally, either by re-deploying the node, or by shutting down.</p>
    <h4>Will Message</h4>
    <p>This is a message that will be published by the broker in the event the node
       unexpectedly loses its connection.</p>
    <h4>WebSockets</h4>
    <p>The node can be configured to use a WebSocket connection. To do so, the Server
       field should be configured with a full URI for the connection. For example:</p>
    <pre>ws://example.com:4000/mqtt</pre>

</script>

<!-- --- [red-module:node-red/httpin] --- -->
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-template-name="http in">
    <div class="form-row">
        <label for="node-input-method"><i class="fa fa-tasks"></i> <span data-i18n="httpin.label.method"></span></label>
        <select type="text" id="node-input-method" style="width:70%;">
        <option value="get">GET</option>
        <option value="post">POST</option>
        <option value="put">PUT</option>
        <option value="delete">DELETE</option>
        <option value="patch">PATCH</option>
        </select>
    </div>
    <div class="form-row form-row-http-in-upload hide">
        <label>&nbsp;</label>
        <input type="checkbox" id="node-input-upload" style="display: inline-block; width: auto; vertical-align: top;">
        <label for="node-input-upload" style="width: 70%;" data-i18n="httpin.label.upload"></label>
    </div>
    <div class="form-row">
        <label for="node-input-url"><i class="fa fa-globe"></i> <span data-i18n="httpin.label.url"></span></label>
        <input id="node-input-url" type="text" placeholder="/url">
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name">
    </div>
    <div class="form-row row-swagger-doc">
        <label for="node-input-swaggerDoc"><i class="fa fa-file-text-o"></i> <span data-i18n="httpin.label.doc"></span></label>
        <input type="text" id="node-input-swaggerDoc">
    </div>
    <div id="node-input-tip" class="form-tips"><span data-i18n="httpin.tip.in"></span><code><span id="node-input-path"></span></code>.</div>
</script>

<script type="text/html" data-template-name="http response">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name">
    </div>
    <div class="form-row">
        <label for="node-input-statusCode"><i class="fa fa-long-arrow-left"></i> <span data-i18n="httpin.label.status"></span></label>
        <input type="text" id="node-input-statusCode" placeholder="msg.statusCode">
    </div>
    <div class="form-row" style="margin-bottom:0;">
        <label><i class="fa fa-list"></i> <span data-i18n="httpin.label.headers"></span></label>
    </div>
    <div class="form-row node-input-headers-container-row">
        <ol id="node-input-headers-container"></ol>
    </div>
    <div class="form-tips"><span data-i18n="[html]httpin.tip.res"></span></div>
</script>

<script type="text/javascript">
(function() {
    RED.nodes.registerType('http in',{
        category: 'network',
        color:"rgb(231, 231, 174)",
        defaults: {
            name: {value:""},
            url: {value:"", required:true,
                  label:RED._("node-red:httpin.label.url")},
            method: {value:"get",required:true},
            upload: {value:false},
            swaggerDoc: {type:"swagger-doc", required:false}
        },
        inputs:0,
        outputs:1,
        icon: "white-globe.svg",
        label: function() {
            if (this.name) {
                return this.name;
            } else if (this.url) {
                var root = RED.settings.httpNodeRoot;
                if (root.slice(-1) != "/") {
                    root = root+"/";
                }
                if (this.url.charAt(0) == "/") {
                    root += this.url.slice(1);
                } else {
                    root += this.url;
                }
                return "["+this.method+"] "+root;
            } else {
                return "http";
            }
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        oneditprepare: function() {
            var root = RED.settings.httpNodeRoot;
            if (root.slice(-1) == "/") {
                root = root.slice(0,-1);
            }
            if (root == "") {
                $("#node-input-tip").hide();
            } else {
                $("#node-input-path").html(root);
                $("#node-input-tip").show();
            }
            if(!RED.nodes.getType("swagger-doc")){
                $('.row-swagger-doc').hide();
            }
            $("#node-input-method").on("change", function() {
                if ($(this).val() === "post") {
                    $(".form-row-http-in-upload").show();
                } else {
                    $(".form-row-http-in-upload").hide();
                }
            }).change();


        }

    });
    var headerTypes = [
        {value:"content-type",label:"Content-Type",hasValue: false},
        {value:"location",label:"Location",hasValue: false},
        {value:"other",label:RED._("node-red:httpin.label.other"),icon:"red/images/typedInput/az.svg"}
       ]
    var contentTypes = [
        {value:"application/json",label:"application/json",hasValue: false},
        {value:"application/xml",label:"application/xml",hasValue: false},
        {value:"text/css",label:"text/css",hasValue: false},
        {value:"text/html",label:"text/html",hasValue: false},
        {value:"text/plain",label:"text/plain",hasValue: false},
        {value:"image/gif",label:"image/gif",hasValue: false},
        {value:"image/png",label:"image/png",hasValue: false},
        {value:"other",label:RED._("node-red:httpin.label.other"),icon:"red/images/typedInput/az.svg"}
    ];

    RED.nodes.registerType('http response',{
        category: 'network',
        color:"rgb(231, 231, 174)",
        defaults: {
            name: {value:""},
            statusCode: {
                value:"",
                label: RED._("node-red:httpin.label.status"),
                validate: RED.validators.number(true)},
            headers: {value:{}}
        },
        inputs:1,
        outputs:0,
        align: "right",
        icon: "white-globe.svg",
        label: function() {
            return this.name||("http"+(this.statusCode?" ("+this.statusCode+")":""));
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        oneditprepare: function() {
            var headerList = $("#node-input-headers-container").css('min-height','150px').css('min-width','450px').editableList({
                addItem: function(container,i,header) {
                    var row = $('<div/>').css({
                        overflow: 'hidden',
                        whiteSpace: 'nowrap',
                        display: 'flex'
                    }).appendTo(container);
                    var propertNameCell = $('<div/>').css({'flex-grow':1}).appendTo(row);
                    var propertyName = $('<input/>',{class:"node-input-header-name",type:"text", style:"width: 100%"})
                        .appendTo(propertNameCell)
                        .typedInput({types:headerTypes});

                    var propertyValueCell = $('<div/>').css({'flex-grow':1,'margin-left':'10px'}).appendTo(row);
                    var propertyValue = $('<input/>',{class:"node-input-header-value",type:"text",style:"width: 100%"})
                        .appendTo(propertyValueCell)
                        .typedInput({types:
                            header.h === 'content-type'?contentTypes:[{value:"other",label:"other",icon:"red/images/typedInput/az.svg"}]
                        });

                    var matchedType = headerTypes.filter(function(ht) {
                        return ht.value === header.h
                    });
                    if (matchedType.length === 0) {
                        propertyName.typedInput('type','other');
                        propertyName.typedInput('value',header.h);
                        propertyValue.typedInput('value',header.v);
                    } else {
                        propertyName.typedInput('type',header.h);

                        if (header.h === "content-type") {
                            matchedType = contentTypes.filter(function(ct) {
                                return ct.value === header.v;
                            });
                            if (matchedType.length === 0) {
                                propertyValue.typedInput('type','other');
                                propertyValue.typedInput('value',header.v);
                            } else {
                                propertyValue.typedInput('type',header.v);
                            }
                        } else {
                            propertyValue.typedInput('value',header.v);
                        }
                    }

                    matchedType = headerTypes.filter(function(ht) {
                        return ht.value === header.h
                    });
                    if (matchedType.length === 0) {
                        propertyName.typedInput('type','other');
                        propertyName.typedInput('value',header.h);
                    } else {
                        propertyName.typedInput('type',header.h);
                    }

                    propertyName.on('change',function(event) {
                        var type = propertyName.typedInput('type');
                        if (type === 'content-type') {
                            propertyValue.typedInput('types',contentTypes);
                        } else {
                            propertyValue.typedInput('types',[{value:"other",label:"other",icon:"red/images/typedInput/az.svg"}]);
                        }
                    });
                },
                sortable: true,
                removable: true
            });

            if (this.headers) {
                for (var key in this.headers) {
                    if (this.headers.hasOwnProperty(key)) {
                        headerList.editableList('addItem',{h:key,v:this.headers[key]});
                    }
                }
            }
        },
        oneditsave: function() {
            var headers = $("#node-input-headers-container").editableList('items');
            var node = this;
            node.headers = {};
            headers.each(function(i) {
                var header = $(this);
                var keyType = header.find(".node-input-header-name").typedInput('type');
                var keyValue = header.find(".node-input-header-name").typedInput('value');
                var valueType = header.find(".node-input-header-value").typedInput('type');
                var valueValue = header.find(".node-input-header-value").typedInput('value');
                var key = keyType;
                var value = valueType;
                if (keyType === 'other') {
                    key = keyValue;
                }
                if (valueType === 'other') {
                    value = valueValue;
                }
                if (key !== '') {
                    node.headers[key] = value;
                }
            });
        },
        oneditresize: function(size) {
            var rows = $("#dialog-form>div:not(.node-input-headers-container-row)");
            var height = size.height;
            for (var i=0; i<rows.length; i++) {
                height -= $(rows[i]).outerHeight(true);
            }
            var editorRow = $("#dialog-form>div.node-input-headers-container-row");
            height -= (parseInt(editorRow.css("marginTop"))+parseInt(editorRow.css("marginBottom")));

            $("#node-input-headers-container").editableList('height',height);
        }
    });
})();
</script>
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-help-name="http in">
    <p>Creates an HTTP end-point for creating web services.</p>
    <h3>Outputs</h3>
    <dl class="message-properties">
        <dt>payload</dt>
        <dd>For a GET request, contains an object of any query string parameters.
            Otherwise, contains the body of the HTTP request.</dd>
        <dt>req<span class="property-type">object</span></dt>
        <dd>An HTTP request object. This object contains multiple properties that
            provide information about the request.
            <ul>
             <li><code>body</code> - the body of the incoming request. The format
                 will depend on the request.</li>
             <li><code>headers</code> - an object containing the HTTP request headers.</li>
             <li><code>query</code> - an object containing any query string parameters.</li>
             <li><code>params</code> - an object containing any route parameters.</li>
             <li><code>cookies</code> - an object containing the cookies for the request.</li>
             <li><code>files</code> - if enabled within the node, an object containing
                 any files uploaded as part of a POST request.</li>
            </ul>
        </dd>
        <dt>res<span class="property-type">object</span></dt>
        <dd>An HTTP response object. This property should not be used directly;
            the <code>HTTP Response</code> node documents how to respond to a request.
            This property must remain attached to the message passed to the response node.</dd>
    </dl>
    <h3>Details</h3>
    <p>The node will listen on the configured path for requests of a particular type.
       The path can be fully specified, such as <code>/user</code>, or include
       named parameters that accept any value, such as <code>/user/:name</code>.
       When named parameters are used, their actual value in a request can be accessed under <code>msg.req.params</code>.</p>
    <p>For requests that include a body, such as a POST or PUT, the contents of
       the request is made available as <code>msg.payload</code>.</p>
    <p>If the content type of the request can be determined, the body will be parsed to
       any appropriate type. For example, <code>application/json</code> will be parsed to
       its JavaScript object representation.</p>
    <p><b>Note:</b> this node does not send any response to the request. The flow
       must include an HTTP Response node to complete the request.</p>
</script>

<script type="text/html" data-help-name="http response">
    <p>Sends responses back to requests received from an HTTP Input node.</p>

    <h3>Inputs</h3>
    <dl class="message-properties">
        <dt>payload <span class="property-type">string</span></dt>
        <dd>The body of the response.</dd>
        <dt class="optional">statusCode <span class="property-type">number</span></dt>
        <dd>If set, this is used as the response status code. Default: 200.</dd>
        <dt class="optional">headers <span class="property-type">object</span></dt>
        <dd>If set, provides HTTP headers to include in the response.</dd>
        <dt class="optional">cookies <span class="property-type">object</span></dt>
        <dd>If set, can be used to set or delete cookies.</dd>
    </dl>
    <h3>Details</h3>
    <p>The <code>statusCode</code> and <code>headers</code> can also be set within
    the node itself. If a property is set within the node, it cannot be overridden
    by the corresponding message property.</p>
    <h4>Cookie handling</h4>
    <p>The <code>cookies</code> property must be an object of name/value pairs.
    The value can be either a string to set the value of the cookie with default
    options, or it can be an object of options.</p>
    <p>The following example sets two cookies - one called <code>name</code> with
    a value of <code>nick</code>, the other called <code>session</code> with a
    value of <code>1234</code> and an expiry set to 15 minutes.</p>
    <pre>
msg.cookies = {
    name: 'nick',
    session: {
        value: '1234',
        maxAge: 900000
    }
}</pre>
    <p>The valid options include:</p>
    <ul>
    <li><code>domain</code> - (String) domain name for the cookie</li>
    <li><code>expires</code> - (Date) expiry date in GMT. If not specified or set to 0, creates a session cookie</li>
    <li><code>maxAge</code> - (String) expiry date as relative to the current time in milliseconds</li>
    <li><code>path</code> - (String) path for the cookie. Defaults to /</li>
    <li><code>value</code> - (String) the value to use for the cookie</li>
    </ul>
    <p>To delete a cookie, set its <code>value</code> to <code>null</code>.</p>

</script>

<!-- --- [red-module:node-red/httprequest] --- -->
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-template-name="http request">
    <div class="form-row">
        <label for="node-input-method"><i class="fa fa-tasks"></i> <span data-i18n="httpin.label.method"></span></label>
        <select type="text" id="node-input-method" style="width:70%;">
        <option value="GET">GET</option>
        <option value="POST">POST</option>
        <option value="PUT">PUT</option>
        <option value="DELETE">DELETE</option>
        <option value="HEAD">HEAD</option>
        <option value="use" data-i18n="httpin.setby"></option>
        </select>
    </div>

    <div class="form-row">
        <label for="node-input-url"><i class="fa fa-globe"></i> <span data-i18n="httpin.label.url"></span></label>
        <input id="node-input-url" type="text" placeholder="http://">
    </div>

    <div class="form-row node-input-paytoqs-row">
        <label for="node-input-paytoqs"><span data-i18n="common.label.payload"></span></label>
        <select id="node-input-paytoqs" style="width: 70%;">
            <option value="ignore" data-i18n="httpin.label.paytoqs.ignore"></option>
            <option value="query" data-i18n="httpin.label.paytoqs.query"></option>
            <option value="body" data-i18n="httpin.label.paytoqs.body"></option>
        </select>
    </div>

    <div class="form-row">
        <input type="checkbox" id="node-input-usetls" style="display: inline-block; width: auto; vertical-align: top;">
        <label for="node-input-usetls" style="width: auto" data-i18n="httpin.use-tls"></label>
        <div id="node-row-tls" class="hide">
            <label style="width: auto; margin-left: 20px; margin-right: 10px;" for="node-input-tls"><span data-i18n="httpin.tls-config"></span></label><input type="text" style="width: 300px" id="node-input-tls">
        </div>
    </div>

    <div class="form-row">
        <input type="checkbox" id="node-input-useAuth" style="display: inline-block; width: auto; vertical-align: top;">
        <label for="node-input-useAuth" style="width: 70%;"><span data-i18n="httpin.basicauth"></span></label>
        <div style="margin-left: 20px" class="node-input-useAuth-row hide">
            <div class="form-row">
                <label for="node-input-authType-select"><i class="fa fa-user-secret "></i> <span data-i18n="httpin.label.authType"></span></label>
                <select type="text" id="node-input-authType-select" style="width:70%;">
                    <option value="basic"  data-i18n="httpin.basic"></option>
                    <option value="digest" data-i18n="httpin.digest"></option>
                    <option value="bearer" data-i18n="httpin.bearer"></option>
                </select>
                <input type="hidden" id="node-input-authType">
            </div>
            <div class="form-row node-input-basic-row">
                <label for="node-input-user"><i class="fa fa-user"></i> <span data-i18n="common.label.username"></span></label>
                <input type="text" id="node-input-user">
            </div>
            <div class="form-row">
                <label for="node-input-password"> <i class="fa fa-lock"></i> <span data-i18n="common.label.password" id="node-span-password"></span><span data-i18n="httpin.label.bearerToken" id="node-span-token" style="display:none"></span></label>
                <input type="password" id="node-input-password">
            </div>
        </div>
    </div>

    <div class="form-row">
        <input type="checkbox" id="node-input-persist" style="display: inline-block; width: auto; vertical-align: top;">
        <label for="node-input-persist" style="width: auto" data-i18n="httpin.persist"></label>
    </div>

    <div class="form-row">
        <input type="checkbox" id="node-input-useProxy" style="display: inline-block; width: auto; vertical-align: top;">
        <label for="node-input-useProxy" style="width: auto;"><span data-i18n="httpin.use-proxy"></span></label>
        <div id="node-input-useProxy-row" class="hide">
            <label style="width: auto; margin-left: 20px; margin-right: 10px;" for="node-input-proxy"><i class="fa fa-globe"></i> <span data-i18n="httpin.proxy-config"></span></label><input type="text" style="width: 270px" id="node-input-proxy">
        </div>
    </div>

    <div class="form-row">
        <input type="checkbox" id="node-input-senderr" style="display: inline-block; width: auto; vertical-align: top;">
        <label for="node-input-senderr" style="width: auto" data-i18n="httpin.senderr"></label>
    </div>

    <div class="form-row">
        <input type="checkbox" id="node-input-insecureHTTPParser" style="display: inline-block; width: auto; vertical-align: top;">
        <label for="node-input-insecureHTTPParser" style="width: auto;" data-i18n="httpin.insecureHTTPParser"></label>
    </div>


    <div class="form-row">
        <label for="node-input-ret"><i class="fa fa-arrow-left"></i> <span data-i18n="httpin.label.return"></span></label>
        <select type="text" id="node-input-ret" style="width:70%;">
        <option value="txt" data-i18n="httpin.utf8"></option>
        <option value="bin" data-i18n="httpin.binary"></option>
        <option value="obj" data-i18n="httpin.json"></option>
        </select>
    </div>

    <div class="form-row form-tips" id="tip-json" hidden><span data-i18n="httpin.tip.req"></span></div>

    <div class="form-row" style="margin-bottom:0;">
        <label><i class="fa fa-list"></i> <span data-i18n="httpin.label.headers"></span></label>
    </div>
    <div class="form-row node-input-headers-container-row">
        <ol id="node-input-headers-container"></ol>
    </div>

    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name">
    </div>
</script>

<script type="text/javascript">
(function() {
    const headerTypes = [
        { value: "Accept", label: "Accept", hasValue: false },
        { value: "Accept-Encoding", label: "Accept-Encoding", hasValue: false },
        { value: "Accept-Language", label: "Accept-Language", hasValue: false },
        { value: "Authorization", label: "Authorization", hasValue: false },
        { value: "Content-Type", label: "Content-Type", hasValue: false },
        { value: "Cache-Control", label: "Cache-Control", hasValue: false },
        { value: "User-Agent", label: "User-Agent", hasValue: false },
        { value: "Location", label: "Location", hasValue: false },
        { value: "other", label: RED._("node-red:httpin.label.other"),
          hasValue: true, icon: "red/images/typedInput/az.svg" },
        { value: "msg", label: "msg.", hasValue: true },
    ]
    const headerOptions = {};
    const defaultOptions = [
        { value: "other", label: RED._("node-red:httpin.label.other"),
          hasValue: true, icon: "red/images/typedInput/az.svg" },
        { value: "msg", label: "msg.", hasValue: true },
    ];
    headerOptions["accept"] = [
        { value: "text/plain", label: "text/plain", hasValue: false },
        { value: "text/html", label: "text/html", hasValue: false },
        { value: "application/json", label: "application/json", hasValue: false },
        { value: "application/xml", label: "application/xml", hasValue: false },
        ...defaultOptions,
    ];
    headerOptions["accept-encoding"] = [
        { value: "gzip", label: "gzip", hasValue: false },
        { value: "deflate", label: "deflate", hasValue: false },
        { value: "compress", label: "compress", hasValue: false },
        { value: "br", label: "br", hasValue: false },
        { value: "gzip, deflate", label: "gzip, deflate", hasValue: false },
        { value: "gzip, deflate, br", label: "gzip, deflate, br", hasValue: false },
        ...defaultOptions,
    ];
    headerOptions["accept-language"] = [
        { value: "*", label: "*", hasValue: false },
        { value: "en-GB, en-US, en;q=0.9", label: "en-GB, en-US, en;q=0.9", hasValue: false },
        { value: "de-AT, de-DE;q=0.9, en;q=0.5", label: "de-AT, de-DE;q=0.9, en;q=0.5", hasValue: false },
        { value: "es-mx,es,en;q=0.5", label: "es-mx,es,en;q=0.5", hasValue: false },
        { value: "fr-CH, fr;q=0.9, en;q=0.8", label: "fr-CH, fr;q=0.9, en;q=0.8", hasValue: false },
        { value: "zh-CN, zh-TW; q = 0.9, zh-HK; q = 0.8, zh; q = 0.7, en; q = 0.6", label: "zh-CN, zh-TW; q = 0.9, zh-HK; q = 0.8, zh; q = 0.7, en; q = 0.6", hasValue: false },
        { value: "ja-JP, jp", label: "ja-JP, jp", hasValue: false },
        ...defaultOptions,
    ];
    headerOptions["content-type"] = [
        { value: "text/css", label: "text/css", hasValue: false },
        { value: "text/plain", label: "text/plain", hasValue: false },
        { value: "text/html", label: "text/html", hasValue: false },
        { value: "application/json", label: "application/json", hasValue: false },
        { value: "application/octet-stream", label: "application/octet-stream", hasValue: false },
        { value: "application/pdf", label: "application/pdf", hasValue: false },
        { value: "application/xml", label: "application/xml", hasValue: false },
        { value: "application/zip", label: "application/zip", hasValue: false },
        { value: "multipart/form-data", label: "multipart/form-data", hasValue: false },
        { value: "audio/aac", label: "audio/aac", hasValue: false },
        { value: "audio/ac3", label: "audio/ac3", hasValue: false },
        { value: "audio/basic", label: "audio/basic", hasValue: false },
        { value: "audio/mp4", label: "audio/mp4", hasValue: false },
        { value: "audio/ogg", label: "audio/ogg", hasValue: false },
        { value: "image/bmp", label: "image/bmp", hasValue: false },
        { value: "image/gif", label: "image/gif", hasValue: false },
        { value: "image/jpeg", label: "image/jpeg", hasValue: false },
        { value: "image/png", label: "image/png", hasValue: false },
        { value: "image/tiff", label: "image/tiff", hasValue: false },
        ...defaultOptions,
    ];
    headerOptions["cache-control"] = [
        { value: "max-age=0", label: "max-age=0", hasValue: false },
        { value: "max-age=86400", label: "max-age=86400", hasValue: false },
        { value: "no-cache", label: "no-cache", hasValue: false },
        ...defaultOptions,
    ];

    headerOptions["user-agent"] = [
        { value: "Mozilla/5.0", label: "Mozilla/5.0", hasValue: false },
        ...defaultOptions,
    ];

    function getHeaderOptions(headerName) {
        const lc = (headerName || "").toLowerCase();
        let opts = headerOptions[lc];
        return opts || defaultOptions;
    }

    RED.nodes.registerType('http request',{
        category: 'network',
        color:"rgb(231, 231, 174)",
        defaults: {
            name: {value:""},
            method:{value:"GET"},
            ret: {value:"txt"},
            paytoqs: {value: false},
            url:{
                value:"",
                validate: function(v, opt) {
                    if ((v.trim().length === 0) ||
                        (v.indexOf("://") === -1) ||
                        (v.trim().indexOf("http") === 0)) {
                        return true;
                    }
                    return RED._("node-red:httpin.errors.invalid-url");
                }
            },
            tls: {type:"tls-config",required: false,
                  label:RED._("node-red:httpin.tls-config") },
            persist: {value:false},
            proxy: {type:"http proxy",required: false,
                    label:RED._("node-red:httpin.proxy-config") },
            insecureHTTPParser: {value: false},
            authType: {value: ""},
            senderr: {value: false},
            headers: { value: [] }
        },
        credentials: {
            user: {type:"text"},
            password: {type: "password"}
        },
        inputs:1,
        outputs:1,
        outputLabels: function(i) {
            return ({
                txt: this._("httpin.label.utf8String"),
                bin: this._("httpin.label.binaryBuffer"),
                obj: this._("httpin.label.jsonObject")
            }[this.ret]);
        },
        icon: "white-globe.svg",
        label: function() {
            return this.name||this._("httpin.httpreq");
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        oneditprepare: function() {
            const node = this;
            $("#node-input-useAuth").on("change", function() {
                if ($(this).is(":checked")) {
                    $(".node-input-useAuth-row").show();
                    // Nodes (< version 0.20.x) with credentials but without authentication type, need type 'basic'
                    if (!$('#node-input-authType').val()) {
                        $("#node-input-authType-select").val('basic').trigger("change");
                    }
                } else {
                    $(".node-input-useAuth-row").hide();
                    $('#node-input-authType').val('');
                    $('#node-input-user').val('');
                    $('#node-input-password').val('');
                }
                RED.tray.resize();
            });
            $("#node-input-authType-select").on("change", function() {
                const val = $(this).val();
                $("#node-input-authType").val(val);
                if (val === "basic" || val === "digest") {
                    $(".node-input-basic-row").show();
                    $('#node-span-password').show();
                    $('#node-span-token').hide();
                } else if (val === "bearer") {
                    $(".node-input-basic-row").hide();
                    $('#node-span-password').hide();
                    $('#node-span-token').show();
                    $('#node-input-user').val('');
                }
                RED.tray.resize();
            });
            $("#node-input-method").on("change", function() {
                if ($(this).val() == "GET") {
                    $(".node-input-paytoqs-row").show();
                } else {
                    $(".node-input-paytoqs-row").hide();
                }
                RED.tray.resize();
            });
            if (node.paytoqs === true || node.paytoqs == "query") {
                $("#node-input-paytoqs").val("query");
            } else if (node.paytoqs === "body") {
                $("#node-input-paytoqs").val("body");
            } else {
                $("#node-input-paytoqs").val("ignore");
            }
            if (node.authType) {
                $('#node-input-useAuth').prop('checked', true);
                $("#node-input-authType-select").val(node.authType);
                $("#node-input-authType-select").change();
            } else {
                $('#node-input-useAuth').prop('checked', false);
            }
            $("#node-input-useAuth").change();

            function updateTLSOptions() {
                if ($("#node-input-usetls").is(':checked')) {
                    $("#node-row-tls").show();
                } else {
                    $("#node-row-tls").hide();
                }
                RED.tray.resize();
            }
            if (node.tls) {
                $('#node-input-usetls').prop('checked', true);
            } else {
                $('#node-input-usetls').prop('checked', false);
            }
            updateTLSOptions();
            $("#node-input-usetls").on("click",function() {
                updateTLSOptions();
            });

            function updateProxyOptions() {
                if ($("#node-input-useProxy").is(":checked")) {
                    $("#node-input-useProxy-row").show();
                } else {
                    $("#node-input-useProxy-row").hide();
                }
                RED.tray.resize();
            }
            if (node.proxy) {
                $("#node-input-useProxy").prop("checked", true);
            } else {
                $("#node-input-useProxy").prop("checked", false);
            }

            if (node.insecureHTTPParser) {
                $("node-intput-insecureHTTPParser").prop("checked", true)
            } else {
                $("node-intput-insecureHTTPParser").prop("checked", false)
            }
            updateProxyOptions();
            $("#node-input-useProxy").on("click", function() {
                updateProxyOptions();
            });

            $("#node-input-ret").on("change", function() {
                if ($("#node-input-ret").val() === "obj") {
                    $("#tip-json").show();
                } else {
                    $("#tip-json").hide();
                }
                RED.tray.resize();
            });
            const hasMatch = function (arr, value) {
                return arr.some(function (ht) {
                    return ht.value === value
                });
            }
            const headerList = $("#node-input-headers-container").css('min-height', '150px').css('min-width', '450px').editableList({
                addItem: function (container, i, header) {
                    const row = $('<div/>').css({
                        overflow: 'hidden',
                        whiteSpace: 'nowrap',
                        display: 'flex'
                    }).appendTo(container);
                    const propertNameCell = $('<div/>').css({ 'flex-grow': 1 }).appendTo(row);
                    const propertyName = $('<input/>', { class: "node-input-header-name", type: "text", style: "width: 100%" })
                        .appendTo(propertNameCell)
                        .typedInput({ types: headerTypes });

                    const propertyValueCell = $('<div/>').css({ 'flex-grow': 1, 'margin-left': '10px' }).appendTo(row);
                    const propertyValue = $('<input/>', { class: "node-input-header-value", type: "text", style: "width: 100%" })
                        .appendTo(propertyValueCell)
                        .typedInput({
                            types: getHeaderOptions(header.keyType)
                        });

                    const setup = function(_header) {
                        const headerTypeIsAPreset = function(h) {return hasMatch(headerTypes, h) };
                        const headerValueIsAPreset = function(h, v) {return hasMatch(getHeaderOptions(h), v) };
                        const {keyType, keyValue, valueType, valueValue} = header;
                        if(keyType == "msg" || keyType == "other") {
                            propertyName.typedInput('type', keyType);
                            propertyName.typedInput('value', keyValue);
                        } else if (headerTypeIsAPreset(keyType)) {
                            propertyName.typedInput('type', keyType);
                        } else {
                            propertyName.typedInput('type', "other");
                            propertyName.typedInput('value', keyValue);
                        }
                        if(valueType == "msg" || valueType == "other") {
                            propertyValue.typedInput('type', valueType);
                            propertyValue.typedInput('value', valueValue);
                        } else if (headerValueIsAPreset(propertyName.typedInput('type'), valueType)) {
                            propertyValue.typedInput('type', valueType);
                        } else {
                            propertyValue.typedInput('type', "other");
                            propertyValue.typedInput('value', valueValue);
                        }
                    }
                    setup(header);

                    propertyName.on('change', function (event) {
                        propertyValue.typedInput('types', getHeaderOptions(propertyName.typedInput('type')));
                    });

                },
                sortable: true,
                removable: true
            });
            if (node.headers) {
                for (let index = 0; index < node.headers.length; index++) {
                    const element = node.headers[index];
                    headerList.editableList('addItem', node.headers[index]);
                }
            }
        },
        oneditsave: function() {
            if (!$("#node-input-usetls").is(':checked')) {
                $("#node-input-tls").val("_ADD_");
            }
            if (!$("#node-input-useProxy").is(":checked")) {
                $("#node-input-proxy").val("_ADD_");
            }
            const headers = $("#node-input-headers-container").editableList('items');
            const node = this;
            node.headers = [];
            headers.each(function(i) {
                const header = $(this);
                const keyType = header.find(".node-input-header-name").typedInput('type');
                const keyValue = header.find(".node-input-header-name").typedInput('value');
                const valueType = header.find(".node-input-header-value").typedInput('type');
                const valueValue = header.find(".node-input-header-value").typedInput('value');
                if (keyType !== '' || keyType === 'other' || keyType === 'msg') {
                    node.headers.push({
                        keyType, keyValue, valueType, valueValue
                    })
                }
            });
        },
        oneditresize: function(size) {
            const dlg = $("#dialog-form");
            const expandRow = dlg.find('.node-input-headers-container-row');
            let height = dlg.height() - 5;
            if(expandRow && expandRow.length){
                const siblingRows = dlg.find('> .form-row:not(.node-input-headers-container-row)');
                for (let i = 0; i < siblingRows.size(); i++) {
                    const cr = $(siblingRows[i]);
                    if(cr.is(":visible"))
                        height -= cr.outerHeight(true);
                }
                $("#node-input-headers-container").editableList('height',height);
            }
        }
    });
})();
</script>
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-help-name="http request">
    <p>Sends HTTP requests and returns the response.</p>

    <h3>Inputs</h3>
    <dl class="message-properties">
        <dt class="optional">url <span class="property-type">string</span></dt>
        <dd>If not configured in the node, this optional property sets the url of the request.</dd>
        <dt class="optional">method <span class="property-type">string</span></dt>
        <dd>If not configured in the node, this optional property sets the HTTP method of the request.
            Must be one of <code>GET</code>, <code>PUT</code>, <code>POST</code>, <code>PATCH</code> or <code>DELETE</code>.</dd>
        <dt class="optional">headers <span class="property-type">object</span></dt>
        <dd>Sets the HTTP headers of the request. NOTE: Any headers set in the node configuration will overwrite any matching headers in <code>msg.headers</code> </dd>
        <dt class="optional">cookies <span class="property-type">object</span></dt>
        <dd>If set, can be used to send cookies with the request.</dd>
        <dt class="optional">payload</dt>
        <dd>Sent as the body of the request.</dd>
        <dt class="optional">rejectUnauthorized</dt>
        <dd>If set to <code>false</code>, allows requests to be made to https sites that use
            self signed certificates.</dd>
        <dt class="optional">followRedirects</dt>
        <dd>If set to <code>false</code> prevent following Redirect (HTTP 301).<code>true</code> by default</dd>
        <dt class="optional">requestTimeout</dt>
        <dd>If set to a positive number of milliseconds, will override the globally set <code>httpRequestTimeout</code> parameter.</dd>
    </dl>
    <h3>Outputs</h3>
    <dl class="message-properties">
        <dt>payload <span class="property-type">string | object | buffer</span></dt>
        <dd>The body of the response. The node can be configured to return the body
             as a string, attempt to parse it as a JSON string or leave it as a
             binary buffer.</dd>
        <dt>statusCode <span class="property-type">number</span></dt>
        <dd>The status code of the response, or the error code if the request could not be completed.</dd>
        <dt>headers <span class="property-type">object</span></dt>
        <dd>An object containing the response headers.</dd>
        <dt>responseUrl <span class="property-type">string</span></dt>
        <dd>In case any redirects occurred while processing the request, this property is the final redirected url.
            Otherwise, the url of the original request.</dd>
        <dt>responseCookies <span class="property-type">object</span></dt>
        <dd>If the response includes cookies, this property is an object of name/value pairs for each cookie.</dd>
        <dt>redirectList <span class="property-type">array</span></dt>
        <dd>If the request was redirected one or more times, the accumulated information will be added to this property. `location` is the next redirect destination. `cookies` is the cookies returned from the redirect source.</dd>
    </dl>
    <h3>Details</h3>
    <p>When configured within the node, the URL property can contain <a href="http://mustache.github.io/mustache.5.html" target="_blank">mustache-style</a> tags. These allow the
    url to be constructed using values of the incoming message. For example, if the url is set to
    <code>example.com/{{{topic}}}</code>, it will have the value of <code>msg.topic</code> automatically inserted.
    Using {{{...}}} prevents mustache from escaping characters like / & etc.</p>
    <p>The node can optionally automatically encode <code>msg.payload</code> as query string parameters for a GET request, in which case <code>msg.payload</code> has to be an object.</p>
    <p><b>Note</b>: If running behind a proxy, the standard <code>http_proxy=...</code> environment variable should be set and Node-RED restarted, or use Proxy Configuration. If Proxy Configuration was set, the configuration take precedence over environment variable.</p>
    <h4>Using multiple HTTP Request nodes</h4>
    <p>In order to use more than one of these nodes in the same flow, care must be taken with
    the <code>msg.headers</code> property. The first node will set this property with
    the response headers. The next node will then use those headers for its request - this
    is not usually the right thing to do. If <code>msg.headers</code> property is left unchanged
    between nodes, it will be ignored by the second node. To set custom headers, <code>msg.headers</code>
    should first be deleted or reset to an empty object: <code>{}</code>.
    <h4>Cookie handling</h4>
    <p>The <code>cookies</code> property passed to the node must be an object of name/value pairs.
    The value can be either a string to set the value of the cookie or it can be an
    object with a single <code>value</code> property.</p>
    <p>Any cookies returned by the request are passed back under the <code>responseCookies</code> property.</p>
    <h4>Content type handling</h4>
    <p>If <code>msg.payload</code> is an Object, the node will automatically set the content type
    of the request to <code>application/json</code> and encode the body as such.</p>
    <p>To encode the request as form data, <code>msg.headers["content-type"]</code> should be set to <code>application/x-www-form-urlencoded</code>.</p>
    <h4>File Upload</h4>
    <p>To perform a file upload, <code>msg.headers["content-type"]</code> should be set to <code>multipart/form-data</code>
        and the <code>msg.payload</code> passed to the node must be an object with the following structure:</p>
    <pre><code>{
    "KEY": {
        "value": FILE_CONTENTS,
        "options": {
            "filename": "FILENAME"
        }
    }
}</code></pre>
    <p>The values of <code>KEY</code>, <code>FILE_CONTENTS</code> and <code>FILENAME</code>
    should be set to the appropriate values.</p>

</script>

<!-- --- [red-module:node-red/websocket] --- -->
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->
<!-- WebSocket Input Node -->
<script type="text/html" data-template-name="websocket in">
    <div class="form-row">
        <label for="node-input-mode"><i class="fa fa-dot-circle-o"></i> <span data-i18n="websocket.label.type"></span></label>
        <select id="node-input-mode">
            <option value="server" data-i18n="websocket.listenon"></option>
            <option value="client" data-i18n="websocket.connectto"></option>
        </select>
    </div>
    <div class="form-row" id="websocket-server-row">
        <label for="node-input-server"><i class="fa fa-bookmark"></i> <span data-i18n="websocket.label.path"></span></label>
        <input type="text" id="node-input-server">
    </div>
    <div class="form-row" id="websocket-client-row">
        <label for="node-input-client"><i class="fa fa-bookmark"></i> <span data-i18n="websocket.label.url"></span></label>
        <input type="text" id="node-input-client">
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name">
    </div>
</script>

<script type="text/javascript">

(function() {

    const headerTypes = [
        /*
        { value: "Accept", label: "Accept", hasValue: false },
        { value: "Accept-Encoding", label: "Accept-Encoding", hasValue: false },
        { value: "Accept-Language", label: "Accept-Language", hasValue: false },
        */
        { value: "Authorization", label: "Authorization", hasValue: false },
        /*
        { value: "Content-Type", label: "Content-Type", hasValue: false },
        { value: "Cache-Control", label: "Cache-Control", hasValue: false },
        */
        { value: "User-Agent", label: "User-Agent", hasValue: false },
        /*
        { value: "Location", label: "Location", hasValue: false },
        */
        { value: "other", label: RED._("node-red:httpin.label.other"),
          hasValue: true, icon: "red/images/typedInput/az.svg" },
    ]

    const headerOptions = {};
    const defaultOptions = [
        { value: "other", label: RED._("node-red:httpin.label.other"),
          hasValue: true, icon: "red/images/typedInput/az.svg" },
        "env",
    ];
    /*
    headerOptions["accept"] = [
        { value: "text/plain", label: "text/plain", hasValue: false },
        { value: "text/html", label: "text/html", hasValue: false },
        { value: "application/json", label: "application/json", hasValue: false },
        { value: "application/xml", label: "application/xml", hasValue: false },
        ...defaultOptions,
    ];

    headerOptions["accept-encoding"] = [
        { value: "gzip", label: "gzip", hasValue: false },
        { value: "deflate", label: "deflate", hasValue: false },
        { value: "compress", label: "compress", hasValue: false },
        { value: "br", label: "br", hasValue: false },
        { value: "gzip, deflate", label: "gzip, deflate", hasValue: false },
        { value: "gzip, deflate, br", label: "gzip, deflate, br", hasValue: false },
        ...defaultOptions,
    ];
    headerOptions["accept-language"] = [
        { value: "*", label: "*", hasValue: false },
        { value: "en-GB, en-US, en;q=0.9", label: "en-GB, en-US, en;q=0.9", hasValue: false },
        { value: "de-AT, de-DE;q=0.9, en;q=0.5", label: "de-AT, de-DE;q=0.9, en;q=0.5", hasValue: false },
        { value: "es-mx,es,en;q=0.5", label: "es-mx,es,en;q=0.5", hasValue: false },
        { value: "fr-CH, fr;q=0.9, en;q=0.8", label: "fr-CH, fr;q=0.9, en;q=0.8", hasValue: false },
        { value: "zh-CN, zh-TW; q = 0.9, zh-HK; q = 0.8, zh; q = 0.7, en; q = 0.6", label: "zh-CN, zh-TW; q = 0.9, zh-HK; q = 0.8, zh; q = 0.7, en; q = 0.6", hasValue: false },
        { value: "ja-JP, jp", label: "ja-JP, jp", hasValue: false },
        ...defaultOptions,
    ];
    headerOptions["content-type"] = [
        { value: "text/css", label: "text/css", hasValue: false },
        { value: "text/plain", label: "text/plain", hasValue: false },
        { value: "text/html", label: "text/html", hasValue: false },
        { value: "application/json", label: "application/json", hasValue: false },
        { value: "application/octet-stream", label: "application/octet-stream", hasValue: false },
        { value: "application/pdf", label: "application/pdf", hasValue: false },
        { value: "application/xml", label: "application/xml", hasValue: false },
        { value: "application/zip", label: "application/zip", hasValue: false },
        { value: "multipart/form-data", label: "multipart/form-data", hasValue: false },
        { value: "audio/aac", label: "audio/aac", hasValue: false },
        { value: "audio/ac3", label: "audio/ac3", hasValue: false },
        { value: "audio/basic", label: "audio/basic", hasValue: false },
        { value: "audio/mp4", label: "audio/mp4", hasValue: false },
        { value: "audio/ogg", label: "audio/ogg", hasValue: false },
        { value: "image/bmp", label: "image/bmp", hasValue: false },
        { value: "image/gif", label: "image/gif", hasValue: false },
        { value: "image/jpeg", label: "image/jpeg", hasValue: false },
        { value: "image/png", label: "image/png", hasValue: false },
        { value: "image/tiff", label: "image/tiff", hasValue: false },
        ...defaultOptions,
    ];
    headerOptions["cache-control"] = [
        { value: "max-age=0", label: "max-age=0", hasValue: false },
        { value: "max-age=86400", label: "max-age=86400", hasValue: false },
        { value: "no-cache", label: "no-cache", hasValue: false },
        ...defaultOptions,
    ];
    */
    headerOptions["user-agent"] = [
        { value: "Mozilla/5.0", label: "Mozilla/5.0", hasValue: false },
        ...defaultOptions,
    ];

    function getHeaderOptions(headerName) {
        const lc = (headerName || "").toLowerCase();
        let opts = headerOptions[lc];
        return opts || defaultOptions;
    }

    function ws_oneditprepare() {
        $("#websocket-client-row").hide();
        $("#node-input-mode").on("change", function() {
            if ( $("#node-input-mode").val() === 'client') {
                $("#websocket-server-row").hide();
                $("#websocket-client-row").show();
            }
            else {
                $("#websocket-server-row").show();
                $("#websocket-client-row").hide();
            }
        });

        if (this.client) {
            $("#node-input-mode").val('client').change();
        }
        else {
            $("#node-input-mode").val('server').change();
        }
    }

    function ws_oneditsave() {
        if ($("#node-input-mode").val() === 'client') {
            $("#node-input-server").append('<option value="">Dummy</option>');
            $("#node-input-server").val('');
        }
        else {
            $("#node-input-client").append('<option value="">Dummy</option>');
            $("#node-input-client").val('');
        }
    }

    function ws_label() {
        var nodeid = (this.client)?this.client:this.server;
        var wsNode = RED.nodes.node(nodeid);
        return this.name||(wsNode?"[ws] "+wsNode.label():"websocket");
    }

    function ws_validateserver() {
        if ($("#node-input-mode").val() === 'client' || (this.client && !this.server)) {
            return true;
        }
        else {
            if (RED.nodes.node(this.server) != null) {
                return true;
            }
            return RED._("node-red:websocket.errors.missing-server");
        }
    }

    function ws_validateclient() {
        if ($("#node-input-mode").val() === 'client' || (this.client && !this.server)) {
            if (RED.nodes.node(this.client) != null) {
                return true;
            }
            return RED._("node-red:websocket.errors.missing-client");
        }
        else {
            return true;
        }
    }

    RED.nodes.registerType('websocket in',{
        category: 'network',
        defaults: {
            name: {value:""},
            server: {type:"websocket-listener", validate: ws_validateserver},
            client: {type:"websocket-client", validate: ws_validateclient}
        },
        color:"rgb(215, 215, 160)",
        inputs:0,
        outputs:1,
        icon: "white-globe.svg",
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        label: ws_label,
        oneditsave: ws_oneditsave,
        oneditprepare: ws_oneditprepare
    });

    RED.nodes.registerType('websocket out',{
        category: 'network',
        defaults: {
            name: {value:""},
            server: {type:"websocket-listener", validate: ws_validateserver},
            client: {type:"websocket-client", validate: ws_validateclient}
        },
        color:"rgb(215, 215, 160)",
        inputs:1,
        outputs:0,
        icon: "white-globe.svg",
        align: "right",
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        label: ws_label,
        oneditsave: ws_oneditsave,
        oneditprepare: ws_oneditprepare
    });

    RED.nodes.registerType('websocket-listener',{
        category: 'config',
        defaults: {
            path: {value:"",required:true,
                   label:RED._("node-red:websocket.label.path"),
                   validate:RED.validators.regex(/^((?!\/debug\/ws).)*$/)},
            wholemsg: {value:"false"}
        },
        inputs:0,
        outputs:0,
        label: function() {
            var root = RED.settings.httpNodeRoot;
            if (root.slice(-1) != "/") {
                root = root+"/";
            }
            if (this.path) {
                if (this.path.charAt(0) == "/") {
                    root += this.path.slice(1);
                } else {
                    root += this.path;
                }
            }
            return root;
        },
        oneditprepare: function() {
            var root = RED.settings.httpNodeRoot;
            if (root.slice(-1) == "/") {
                root = root.slice(0,-1);
            }
            if (root === "") {
                $("#node-config-ws-tip").hide();
            } else {
                $("#node-config-ws-path").html(RED._("node-red:websocket.tip.path2", { path: root }));
                $("#node-config-ws-tip").show();
            }
        }
    });

    RED.nodes.registerType('websocket-client',{
        category: 'config',
        defaults: {
            path: {
                value:"",required:true,
                label:RED._("node-red:websocket.label.path"),
                validate:RED.validators.regex(/^((?!\/debug\/ws).)*$/)},
            tls: {type:"tls-config",required: false},
            wholemsg: {value:"false"},
            hb: {
                value: "",
                label:RED._("node-red:websocket.sendheartbeat"),
                validate: RED.validators.number(/*blank allowed*/true) },
            subprotocol: {value:"",required: false},
            headers: { value: [] }
        },
        inputs:0,
        outputs:0,
        label: function() {
            return this.path;
        },
        oneditprepare: function() {

            const node = this;

            $("#node-config-input-path").on("change keyup paste",function() {
                $(".node-config-row-tls").toggle(/^wss:/i.test($(this).val()))
            });
            $("#node-config-input-path").change();

            var heartbeatActive = (this.hb && this.hb != "0");
            $("#node-config-input-hb-cb").prop("checked",heartbeatActive);
            $("#node-config-input-hb-cb").on("change", function(evt) {
                $("#node-config-input-hb-row").toggle(this.checked);
            })
            $("#node-config-input-hb-cb").trigger("change");
            if (!heartbeatActive) {
                $("#node-config-input-hb").val("");
            }

            const hasMatch = function (arr, value) {
                return arr.some(function (ht) {
                    return ht.value === value
                });
            }

            const headerList = $("#node-input-headers-container").css('min-height', '150px').css('min-width', '450px').editableList({
                addItem: function (container, i, header) {
                    const row = $('<div/>').css({
                        overflow: 'hidden',
                        whiteSpace: 'nowrap',
                        display: 'flex'
                    }).appendTo(container);
                    const propertNameCell = $('<div/>').css({ 'flex-grow': 1 }).appendTo(row);
                    const propertyName = $('<input/>', { class: "node-input-header-name", type: "text", style: "width: 100%" })
                        .appendTo(propertNameCell)
                        .typedInput({ types: headerTypes });

                    const propertyValueCell = $('<div/>').css({ 'flex-grow': 1, 'margin-left': '10px' }).appendTo(row);
                    const propertyValue = $('<input/>', { class: "node-input-header-value", type: "text", style: "width: 100%" })
                        .appendTo(propertyValueCell)
                        .typedInput({
                            types: getHeaderOptions(header.keyType)
                        });

                    const setup = function(_header) {
                        const headerTypeIsAPreset = function(h) {return hasMatch(headerTypes, h) };
                        const headerValueIsAPreset = function(h, v) {return hasMatch(getHeaderOptions(h), v) };

                        const {keyType, keyValue, valueType, valueValue} = header;

                        if(keyType == "other") {
                            propertyName.typedInput('type', keyType);
                            propertyName.typedInput('value', keyValue);
                        } else if (headerTypeIsAPreset(keyType)) {
                            propertyName.typedInput('type', keyType);
                        } else {
                            propertyName.typedInput('type', "other");
                            propertyName.typedInput('value', keyValue);
                        }

                        if(valueType == "other" || valueType == "env" ) {
                            propertyValue.typedInput('type', valueType);
                            propertyValue.typedInput('value', valueValue);
                        } else if (headerValueIsAPreset(propertyName.typedInput('type'), valueType)) {
                            propertyValue.typedInput('type', valueType);
                        } else {
                            propertyValue.typedInput('type', "other");
                            propertyValue.typedInput('value', valueValue);
                        }
                    }
                    setup(header);

                    propertyName.on('change', function (event) {
                        propertyValue.typedInput('types', getHeaderOptions(propertyName.typedInput('type')));
                    });

                },
                sortable: true,
                removable: true
            });
            if (node.headers) {
                for (let index = 0; index < node.headers.length; index++) {
                    const element = node.headers[index];
                    headerList.editableList('addItem', node.headers[index]);
                }
            }
        },
        oneditsave: function() {

            const node = this;

            if (!/^wss:/i.test($("#node-config-input-path").val())) {
                $("#node-config-input-tls").val("_ADD_");
            }
            if (!$("#node-config-input-hb-cb").prop("checked")) {
                $("#node-config-input-hb").val("0");
            }

            const headers = $("#node-input-headers-container").editableList('items');

            node.headers = [];
            headers.each(function(i) {
                const header = $(this);
                const keyType = header.find(".node-input-header-name").typedInput('type');
                const keyValue = header.find(".node-input-header-name").typedInput('value');
                const valueType = header.find(".node-input-header-value").typedInput('type');
                const valueValue = header.find(".node-input-header-value").typedInput('value');
                node.headers.push({
                    keyType, keyValue, valueType, valueValue
                })

            });
        },
        oneditresize: function(size) {
            const dlg = $("#dialog-form");
            const expandRow = dlg.find('.node-input-headers-container-row');
            let height = dlg.height() - 5;
            if(expandRow && expandRow.length){
                const siblingRows = dlg.find('> .form-row:not(.node-input-headers-container-row)');
                for (let i = 0; i < siblingRows.size(); i++) {
                    const cr = $(siblingRows[i]);
                    if(cr.is(":visible"))
                        height -= cr.outerHeight(true);
                }
                $("#node-input-headers-container").editableList('height',height);
            }
        }
    });

})();
</script>

<!-- WebSocket out Node -->
<script type="text/html" data-template-name="websocket out">
    <div class="form-row">
        <label for="node-input-mode"><i class="fa fa-dot-circle-o"></i> <span data-i18n="websocket.label.type"></span></label>
        <select id="node-input-mode">
            <option value="server" data-i18n="websocket.listenon"></option>
            <option value="client" data-i18n="websocket.connectto"></option>
        </select>
    </div>
    <div class="form-row" id="websocket-server-row">
        <label for="node-input-server"><i class="fa fa-bookmark"></i> <span data-i18n="websocket.label.path"></span></label>
        <input type="text" id="node-input-server">
    </div>
    <div class="form-row" id="websocket-client-row">
        <label for="node-input-client"><i class="fa fa-bookmark"></i> <span data-i18n="websocket.label.url"></span></label>
        <input type="text" id="node-input-client">
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name">
    </div>
</script>

<!-- WebSocket Server configuration node -->
<script type="text/html" data-template-name="websocket-listener">
    <div class="form-row">
        <label for="node-config-input-path"><i class="fa fa-bookmark"></i> <span data-i18n="websocket.label.path"></span></label>
        <input id="node-config-input-path" type="text" placeholder="/ws/example">
    </div>
    <div class="form-row">
        <label for="node-config-input-wholemsg" data-i18n="websocket.sendrec"></label>
        <select type="text" id="node-config-input-wholemsg" style="width: 70%;">
            <option value="false" data-i18n="websocket.payload"></option>
            <option value="true" data-i18n="websocket.message"></option>
        </select>
    </div>
    <div class="form-tips">
        <span data-i18n="[html]websocket.tip.path1"></span>
        <p id="node-config-ws-tip"><span id="node-config-ws-path"></span></p>
    </div>
</script>

<!-- WebSocket Client configuration node -->
<script type="text/html" data-template-name="websocket-client">
    <div class="form-row">
        <label for="node-config-input-path"><i class="fa fa-bookmark"></i> <span data-i18n="websocket.label.url"></span></label>
        <input id="node-config-input-path" type="text" placeholder="ws://example.com/ws">
    </div>
    <div class="form-row node-config-row-tls hide">
        <label for="node-config-input-tls" data-i18n="httpin.tls-config"></label>
        <input type="text" id="node-config-input-tls">
    </div>
    <div class="form-row">
        <label for="node-config-input-subprotocol"><i class="fa fa-tag"></i> <span data-i18n="websocket.label.subprotocol"></span></label>
        <input type="text" id="node-config-input-subprotocol">
    </div>
    <div class="form-row">
        <label for="node-config-input-wholemsg" data-i18n="websocket.sendrec"></label>
        <select type="text" id="node-config-input-wholemsg" style="width: 70%;">
            <option value="false" data-i18n="websocket.payload"></option>
            <option value="true" data-i18n="websocket.message"></option>
        </select>
    </div>
    <div class="form-row" style="display: flex; align-items: center; min-height: 34px">
        <label for="node-config-input-hb-cb" data-i18n="websocket.sendheartbeat"></label>
        <input type="checkbox" style="margin: 0 8px; width:auto" id="node-config-input-hb-cb">
        <span id="node-config-input-hb-row" class="hide" >
            <input type="text" style="width: 70px; margin-right: 3px" id="node-config-input-hb">
            <span  data-i18n="inject.seconds"></span>
        </span>
    </div>
    <div class="form-row" style="margin-bottom:0;">
        <label><i class="fa fa-list"></i> <span data-i18n="httpin.label.headers"></span></label>
    </div>
    <div class="form-row node-input-headers-container-row">
        <ol id="node-input-headers-container"></ol>
    </div>
    <div class="form-tips">
        <p><span data-i18n="[html]websocket.tip.url1"></span></p>
        <p><span data-i18n="[html]websocket.tip.url2"></span></p>
        <span data-i18n="[html]websocket.tip.headers"></span>
    </div>
</script>
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-help-name="websocket in">
    <p>WebSocket input node.</p>
    <p>By default, the data received from the WebSocket will be in <code>msg.payload</code>.
    The socket can be configured to expect a properly formed JSON string, in which
    case it will parse the JSON and send on the resulting object as the entire message.</p>
</script>

<script type="text/html" data-help-name="websocket out">
    <p>WebSocket out node.</p>
    <p>By default, <code>msg.payload</code> will be sent over the WebSocket. The socket
    can be configured to encode the entire <code>msg</code> object as a JSON string and send that
    over the WebSocket.</p>

    <p>If the message arriving at this node started at a WebSocket In node, the message
    will be sent back to the client that triggered the flow. Otherwise, the message
    will be broadcast to all connected clients.</p>
    <p>If you want to broadcast a message that started at a WebSocket In node, you
    should delete the <code>msg._session</code> property within the flow.</p>
</script>

<script type="text/html" data-help-name="websocket-listener">
   <p>This configuration node creates a WebSocket Server endpoint using the specified path.</p>
</script>

<script type="text/html" data-help-name="websocket-client">
   <p>This configuration node connects a WebSocket client to the specified URL.</p>
</script>

<!-- --- [red-module:node-red/tcpin] --- -->
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-template-name="tcp in">
    <div class="form-row">
        <label for="node-input-server"><i class="fa fa-dot-circle-o"></i> <span data-i18n="tcpin.label.type"></span></label>
        <select id="node-input-server" style="width:120px; margin-right:5px;">
            <option value="server" data-i18n="tcpin.type.listen"></option>
            <option value="client" data-i18n="tcpin.type.connect"></option>
        </select>
        <span data-i18n="tcpin.label.port"></span> <input type="text" id="node-input-port" style="width:65px">
    </div>
    <div class="form-row hidden" id="node-input-host-row" style="padding-left:110px;">
        <span data-i18n="tcpin.label.host"></span> <input type="text" id="node-input-host" placeholder="localhost" style="width: 60%;">
    </div>
    <div class="form-row" id="node-input-tls-enable">
        <label> </label>
        <input type="checkbox" id="node-input-usetls" style="display: inline-block; width:auto; vertical-align:top;">
        <label for="node-input-usetls" style="width:auto" data-i18n="httpin.use-tls"></label>
        <div id="node-row-tls" class="hide">
            <label style="width:auto; margin-left:20px; margin-right:10px;" for="node-input-tls"><span data-i18n="httpin.tls-config"></span></label><input type="text" style="width: 300px" id="node-input-tls">
        </div>
    </div>

    <div class="form-row">
        <label><i class="fa fa-sign-out"></i> <span data-i18n="tcpin.label.output"></span></label>
        <select id="node-input-datamode" style="width:110px;">
            <option value="stream" data-i18n="tcpin.output.stream"></option>
            <option value="single" data-i18n="tcpin.output.single"></option>
        </select>
        <select id="node-input-datatype" style="width:140px;">
            <option value="buffer" data-i18n="tcpin.output.buffer"></option>
            <option value="utf8" data-i18n="tcpin.output.string"></option>
            <option value="base64" data-i18n="tcpin.output.base64"></option>
        </select>
        <span data-i18n="tcpin.label.payload"></span>
    </div>

    <div id="node-row-newline" class="form-row hidden" style="padding-left:110px;">
        <span data-i18n="tcpin.label.delimited"></span> <input type="text" id="node-input-newline" style="width:110px;" data-i18n="[placeholder]tcpin.label.optional"><br/>
        <input type="checkbox" id="node-input-trim" style="display:inline-block; width:auto; vertical-align:top;"> <span data-i18n="tcpin.label.reattach"></span>
    </div>

    <div class="form-row">
        <label for="node-input-topic"><i class="fa fa-tasks"></i> <span data-i18n="common.label.topic"></span></label>
        <input type="text" id="node-input-topic" data-i18n="[placeholder]common.label.topic">
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name">
    </div>
</script>

<script type="text/javascript">
    RED.nodes.registerType('tcp in',{
        category: 'network',
        color: "Silver",
        defaults: {
            name: {value:""},
            server: {value:"server", required:true},
            host: {
                value:"",
                validate:function(v, opt) {
                    if ((this.server == "server")||v.length > 0) {
                        return true;
                    }
                    return RED._("node-red:tcpin.errors.invalid-host");
                }
            },
            port: {
                value:"", required:true,
                label:RED._("node-red:tcpin.label.port"),
                validate:RED.validators.number(false)},
            datamode:{value:"stream"},
            datatype:{value:"buffer"},
            newline:{value:""},
            topic: {value:""},
            trim: {value:false},
            base64: {/*deprecated*/ value:false, required:true},
            tls: {type:"tls-config", value:'', required:false,
                  label:RED._("node-red:httpin.tls-config") }
        },
        inputs:0,
        outputs:1,
        icon: "bridge-dash.svg",
        label: function() {
            return this.name || "tcp:"+(this.host?this.host+":":"")+this.port;
        },
        labelStyle: function() {
            return this.name ? "node_label_italic" : "";
        },
        oneditprepare: function() {
            var updateOptions = function() {
                var sockettype = $("#node-input-server").val();
                if (sockettype == "client") {
                    $("#node-input-host-row").show();
                } else {
                    $("#node-input-host-row").hide();
                }
                var datamode = $("#node-input-datamode").val();
                var datatype = $("#node-input-datatype").val();
                if (datamode == "stream") {
                    if (datatype == "utf8") {
                        $("#node-row-newline").show();
                    } else {
                        $("#node-row-newline").hide();
                    }
                } else {
                    $("#node-row-newline").hide();
                }
            };
            updateOptions();
            $("#node-input-server").change(updateOptions);
            $("#node-input-datatype").change(updateOptions);
            $("#node-input-datamode").change(updateOptions);
            function updateTLSOptions() {
                if ($("#node-input-usetls").is(':checked')) {
                    $("#node-row-tls").show();
                } else {
                    $("#node-row-tls").hide();
                }
            }
            if (this.tls) {
                $('#node-input-usetls').prop('checked', true);
            } else {
                $('#node-input-usetls').prop('checked', false);
            }
            updateTLSOptions();
            $("#node-input-usetls").on("click",function() {
                updateTLSOptions();
            });
        },
        oneditsave: function() {
            if (!$("#node-input-usetls").is(':checked')) {
                $("#node-input-tls").val("_ADD_");
            }
        }
    });
</script>


<script type="text/html" data-template-name="tcp out">
    <div class="form-row">
        <label for="node-input-beserver"><i class="fa fa-dot-circle-o"></i> <span data-i18n="tcpin.label.type"></span></label>
        <select id="node-input-beserver" style="width:150px; margin-right:5px;">
            <option value="server" data-i18n="tcpin.type.listen"></option>
            <option value="client" data-i18n="tcpin.type.connect"></option>
            <option value="reply" data-i18n="tcpin.type.reply"></option>
        </select>
        <span id="node-input-port-row"><span data-i18n="tcpin.label.port"></span> <input type="text" id="node-input-port" style="width: 65px"></span>
    </div>

    <div class="form-row hidden" id="node-input-host-row" style="padding-left: 110px;">
        <span data-i18n="tcpin.label.host"></span> <input type="text" id="node-input-host" style="width: 60%;">
    </div>

    <div class="form-row" id="node-input-tls-enable">
        <label> </label>
        <input type="checkbox" id="node-input-usetls" style="display: inline-block; width: auto; vertical-align: top;">
        <label for="node-input-usetls" style="width: auto" data-i18n="httpin.use-tls"></label>
        <div id="node-row-tls" class="hide">
            <label style="width: auto; margin-left: 20px; margin-right: 10px;" for="node-input-tls"><span data-i18n="httpin.tls-config"></span></label><input type="text" style="width: 300px" id="node-input-tls">
        </div>
    </div>

    <div class="form-row hidden" id="node-input-end-row">
        <label>&nbsp;</label>
        <input type="checkbox" id="node-input-end" style="display: inline-block; width: auto; vertical-align: top;">
        <label for="node-input-end" style="width: 70%;"><span data-i18n="tcpin.label.close-connection"></span></label>
    </div>

    <div class="form-row">
        <label>&nbsp;</label>
        <input type="checkbox" id="node-input-base64" placeholder="base64" style="display: inline-block; width: auto; vertical-align: top;">
        <label for="node-input-base64" style="width: 70%;"><span data-i18n="tcpin.label.decode-base64"></span></label>
    </div>

    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name">
    </div>
</script>

<script type="text/javascript">
    RED.nodes.registerType('tcp out',{
        category: 'network',
        color: "Silver",
        defaults: {
            name: {value:""},
            host: {
                value:"",
                validate:function(v, opt) {
                    if ((this.beserver != "client")||v.length > 0) {
                        return true;
                    }
                    return RED._("node-red:tcpin.errors.invalid-host");
                }
            },
            port: {
                value:"",
                validate:function(v) {
                    if ((this.beserver == "reply")||RED.validators.number()(v)) {
                        return true;
                    }
                    return RED._("node-red:tcpin.errors.invalid-port");
                }
            },
            beserver: {value:"client", required:true},
            base64: {value:false, required:true},
            end: {value:false, required:true},
            tls: {type:"tls-config", value:'', required:false,
                  label:RED._("node-red:httpin.tls-config") }
        },
        inputs:1,
        outputs:0,
        icon: "bridge-dash.svg",
        align: "right",
        label: function() {
            return this.name || "tcp:"+(this.host?this.host+":":"")+this.port;
        },
        labelStyle: function() {
            return (this.name)?"node_label_italic":"";
        },
        oneditprepare: function() {
            var updateOptions = function() {
                var sockettype = $("#node-input-beserver").val();
                if (sockettype == "reply") {
                    $("#node-input-port-row").hide();
                    $("#node-input-host-row").hide();
                    $("#node-input-end-row").hide();
                    $("#node-input-tls-enable").hide();
                } else if (sockettype == "client"){
                    $("#node-input-port-row").show();
                    $("#node-input-host-row").show();
                    $("#node-input-end-row").show();
                    $("#node-input-tls-enable").show();
                } else {
                    $("#node-input-port-row").show();
                    $("#node-input-host-row").hide();
                    $("#node-input-end-row").show();
                    $("#node-input-tls-enable").show();
                }
            };
            updateOptions();
            $("#node-input-beserver").change(updateOptions);
            function updateTLSOptions() {
                if ($("#node-input-usetls").is(':checked')) {
                    $("#node-row-tls").show();
                } else {
                    $("#node-row-tls").hide();
                }
            }
            if (this.tls) {
                $('#node-input-usetls').prop('checked', true);
            } else {
                $('#node-input-usetls').prop('checked', false);
            }
            updateTLSOptions();
            $("#node-input-usetls").on("click",function() {
                updateTLSOptions();
            });
        },
        oneditsave: function() {
            if (!$("#node-input-usetls").is(':checked')) {
                $("#node-input-tls").val("_ADD_");
            }
        }
    });
</script>


<script type="text/html" data-template-name="tcp request">
    <div class="form-row">
        <label for="node-input-server"><i class="fa fa-globe"></i> <span data-i18n="tcpin.label.server"></span></label>
        <input type="text" id="node-input-server" placeholder="ip.address" style="width:45%">
        <span data-i18n="tcpin.label.port"></span>
        <input type="text" id="node-input-port" style="width:60px">
    </div>
    <div class="form-row" id="node-input-tls-enable">
        <label> </label>
        <input type="checkbox" id="node-input-usetls" style="display: inline-block; width: auto; vertical-align: top;">
        <label for="node-input-usetls" style="width: auto" data-i18n="httpin.use-tls"></label>
        <div id="node-row-tls" class="hide">
            <label style="width: auto; margin-left: 20px; margin-right: 10px;" for="node-input-tls"><span data-i18n="httpin.tls-config"></span></label><input type="text" style="width: 300px" id="node-input-tls">
        </div>
    </div>
    <div class="form-row">
        <label for="node-input-ret"><i class="fa fa-sign-out"></i> <span data-i18n="tcpin.label.return"></span></label>
        <select type="text" id="node-input-ret" style="width:54%;">
            <option value="buffer" data-i18n="tcpin.output.buffer"></option>
            <option value="string" data-i18n="tcpin.output.string"></option>
        </select>
    </div>
    <div class="form-row">
        <label for="node-input-out"><i class="fa fa-sign-out fa-rotate-90"></i> <span data-i18n="tcpin.label.close"></span></label>
        <select type="text" id="node-input-out" style="width:54%;">
            <option value="time" data-i18n="tcpin.return.timeout"></option>
            <option value="char" data-i18n="tcpin.return.character"></option>
            <option value="count" data-i18n="tcpin.return.number"></option>
            <option value="sit" data-i18n="tcpin.return.never"></option>
            <option value="immed" data-i18n="tcpin.return.immed"></option>
        </select>
        <input type="text" id="node-input-splitc" style="width:50px;">
        <span id="node-units"></span>
    </div>
    <div id="node-row-newline" class="form-row hidden" style="padding-left:162px;">
        <span data-i18n="tcpin.label.delimited"></span> <input type="text" id="node-input-newline" style="width:110px;" data-i18n="[placeholder]tcpin.label.optional"><br/>
        <input type="checkbox" id="node-input-trim" style="display:inline-block; width:auto; vertical-align:top;"> <span data-i18n="tcpin.label.reattach"></span>
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name">
    </div>
</script>

<script type="text/javascript">
    RED.nodes.registerType('tcp request',{
        category: 'network',
        color: "Silver",
        defaults: {
            name: {value:""},
            server: {value:""},
            port: {
                value:"",
                label: RED._("node-red:tcpin.label.port"),
                validate:RED.validators.regex(/^(\d*|)$/)
            },
            out: {value:"time", required:true},
            ret: {value:"buffer"},
            splitc: {value:"0", required:true},
            newline: {value:""},
            trim: {value:false},
            tls: {type:"tls-config", value:'', required:false, label:RED._("node-red:httpin.tls-config")}
        },
        inputs:1,
        outputs:1,
        icon: "bridge-dash.svg",
        label: function() {
            return this.name || "tcp:"+(this.server?this.server+":":"")+this.port;
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        oneditprepare: function() {
            var previous = null;
            if ($("#node-input-ret").val() == undefined) {
                $("#node-input-ret").val("buffer");
                this.ret = "buffer";
            }
            $("#node-input-ret").on("change", function() {
                if ($("#node-input-ret").val() === "string" && $("#node-input-out").val() === "sit") { $("#node-row-newline").show(); }
                else { $("#node-row-newline").hide(); }
            });
            $("#node-input-out").on("change", function() {
                if ($("#node-input-ret").val() === "string" && $("#node-input-out").val() === "sit") { $("#node-row-newline").show(); }
                else { $("#node-row-newline").hide(); }
            });
            $("#node-input-out").on('focus', function () { previous = this.value; }).on("change", function() {
                $("#node-input-splitc").show();
                if (previous === null) { previous = $("#node-input-out").val(); }
                if ($("#node-input-out").val() == "char") {
                    if (previous != "char") { $("#node-input-splitc").val("\\n"); }
                    $("#node-units").text("");
                }
                else if ($("#node-input-out").val() == "time") {
                    if (previous != "time") { $("#node-input-splitc").val("0"); }
                    $("#node-units").text(RED._("node-red:tcpin.label.ms"));
                }
                else if ($("#node-input-out").val() == "immed") {
                    if (previous != "immed") { $("#node-input-splitc").val(" "); }
                    $("#node-units").text("");
                    $("#node-input-splitc").hide();
                }
                else if ($("#node-input-out").val() == "count") {
                    if (previous != "count") { $("#node-input-splitc").val("12"); }
                    $("#node-units").text(RED._("node-red:tcpin.label.chars"));
                }
                else {
                    if (previous != "sit") { $("#node-input-splitc").val(" "); }
                    $("#node-units").text("");
                    $("#node-input-splitc").hide();
                }
            });
            function updateTLSOptions() {
                if ($("#node-input-usetls").is(':checked')) {
                    $("#node-row-tls").show();
                } else {
                    $("#node-row-tls").hide();
                }
            }
            if (this.tls) {
                $('#node-input-usetls').prop('checked', true);
            } else {
                $('#node-input-usetls').prop('checked', false);
            }
            updateTLSOptions();
            $("#node-input-usetls").on("click",function() {
                updateTLSOptions();
            });
        },
        oneditsave: function() {
            if (!$("#node-input-usetls").is(':checked')) {
                $("#node-input-tls").val("_ADD_");
            }
        }
    });
</script>
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-help-name="tcp in">
    <p>Provides a choice of TCP inputs. Can either connect to a remote TCP port,
       or accept incoming connections.</p>
    <p><b>Note: </b>On some systems you may need root or administrator access
    to access ports below 1024.</p>
</script>

<script type="text/html" data-help-name="tcp out">
    <p>Provides a choice of TCP outputs. Can either connect to a remote TCP port,
    accept incoming connections, or reply to messages received from a TCP In node.</p>
    <p>Only the <code>msg.payload</code> is sent.</p>
    <p>If <code>msg.payload</code> is a string containing a Base64 encoding of binary
    data, the Base64 decoding option will cause it to be converted back to binary
    before being sent.</p>
    <p>If <code>msg._session</code> is not present the payload is
    sent to <b>all</b> connected clients.</p>
    <p>In Reply-to mode, setting <code>msg.reset = true</code> will reset the connection
        specified by _session.id, or all connections if no _session.id is specified.</p>
    <p><b>Note: </b>On some systems you may need root or administrator access
    to access ports below 1024.</p>
</script>

<script type="text/html" data-help-name="tcp request">
    <p>A simple TCP request node - sends the <code>msg.payload</code> to a server tcp port and expects a response.</p>
    <p>Connects, sends the "request", and reads the "response". It can either count a number of
    returned characters into a fixed buffer, match a specified character before returning,
    wait a fixed timeout from first reply and then return, sit and wait for data, or send then close the connection
    immediately, without waiting for a reply.</p>
    <p>If in sit and wait mode (remain connected) you can send <code>msg.reset = true</code> or <code>msg.reset = "host:port"</code> to force a break in
    the connection and an automatic reconnection.</p>
    <p>The response will be output in <code>msg.payload</code> as a buffer, so you may want to .toString() it.</p>
    <p>If you leave tcp host or port blank they must be set by using the <code>msg.host</code> and <code>msg.port</code> properties in every message sent to the node.</p>
</script>

<!-- --- [red-module:node-red/udp] --- -->
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<!--  The Input Node  -->
<script type="text/html" data-template-name="udp in">
    <div class="form-row">
        <label for="node-input-port"><i class="fa fa-sign-in"></i> <span data-i18n="udp.label.listen"></span></label>
        <select id="node-input-multicast" style='width:70%'>
          <option value="false" data-i18n="udp.udpmsgs"></option>
          <option value="true" data-i18n="udp.mcmsgs"></option>
        </select>
    </div>
    <div class="form-row node-input-group">
        <label for="node-input-group"><i class="fa fa-list"></i> <span data-i18n="udp.label.group"></span></label>
        <input type="text" id="node-input-group" placeholder="225.0.18.83">
    </div>
    <div class="form-row node-input-iface">
        <label for="node-input-iface"><i class="fa fa-random"></i> <span data-i18n="udp.label.interface"></span></label>
        <input type="text" id="node-input-iface" data-i18n="[placeholder]udp.placeholder.interfaceprompt">
    </div>
    <div class="form-row">
        <label for="node-input-port"><i class="fa fa-sign-in"></i> <span data-i18n="udp.label.onport"></span></label>
        <input type="text" id="node-input-port" style="width:80px">
        &nbsp;&nbsp;<span data-i18n="udp.label.using"></span> <select id="node-input-ipv" style="width:80px">
          <option value="udp4">ipv4</option>
          <option value="udp6">ipv6</option>
        </select>
    </div>
    <div class="form-row">
        <label for="node-input-datatype"><i class="fa fa-sign-out"></i> <span data-i18n="udp.label.output"></span></label>
        <select id="node-input-datatype" style="width:70%;">
            <option value="buffer" data-i18n="udp.output.buffer"></option>
            <option value="utf8" data-i18n="udp.output.string"></option>
            <option value="base64" data-i18n="udp.output.base64"></option>
        </select>
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name">
    </div>
    <div class="form-tips"><span data-i18n="udp.tip.in"></span></div>
    <div class="form-tips" id="udpporttip"><span data-i18n="[html]udp.tip.port"></span></div>
</script>

<script type="text/javascript">
    RED.nodes.registerType('udp in',{
        category: 'network',
        color:"Silver",
        defaults: {
            name: {value:""},
            iface: {value:""},
            port: {
                value:"", required:true,
                label:RED._("node-red:udp.label.port"),
                validate:RED.validators.number(false)
            },
            ipv: {value:"udp4"},
            multicast: {value:"false"},
            group: {
                value:"",
                validate:function(v,opt) {
                    if ((this.multicast !== "true")||v.length > 0) {
                        return true;
                    }
                    return RED._("node-red:udp.errors.invalid-group");
                }
            },
            datatype: {value:"buffer",required:true}
        },
        inputs:0,
        outputs:1,
        icon: "bridge-dash.svg",
        label: function() {
            if (this.multicast=="false") {
                return this.name||"udp "+this.port;
            }
            else {
                return this.name||"udp "+(this.group+":"+this.port);
            }
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        oneditprepare: function() {
            $("#node-input-multicast").on("change", function() {
                var id = $("#node-input-multicast").val();
                if (id == "false") {
                    $(".node-input-group").hide();
                    $(".node-input-iface").hide();
                }
                else {
                    $(".node-input-group").show();
                    $(".node-input-iface").show();
                }
            });
            $("#node-input-multicast").change();

            var porttip = this._("udp.tip.port");
            var alreadyused = this._("udp.errors.alreadyused");
            var portsInUse = {};
            $.getJSON('udp-ports/'+this.id,function(data) {
                portsInUse = data || {};
                $('#udpporttip').html(porttip + data);
            });
            $("#node-input-port").on("change", function() {
                var portnew = $("#node-input-port").val();
                if (portsInUse.hasOwnProperty($("#node-input-port").val())) {
                    RED.notify(alreadyused+" "+$("#node-input-port").val(),"warn");
                }
            });
        }
    });
</script>


<!--  The Output Node  -->
<script type="text/html" data-template-name="udp out">
    <div class="form-row">
        <label for="node-input-port"><i class="fa fa-envelope"></i> <span data-i18n="udp.label.send"></span></label>
        <select id="node-input-multicast" style="width:40%">
          <option value="false" data-i18n="udp.udpmsg"></option>
          <option value="broad" data-i18n="udp.bcmsg"></option>
          <option value="multi" data-i18n="udp.mcmsg"></option>
        </select>
        <span data-i18n="udp.label.toport"></span> <input type="text" id="node-input-port" style="width:70px">
    </div>
    <div class="form-row node-input-addr">
        <label for="node-input-addr" id="node-input-addr-label"><i class="fa fa-list"></i> <span data-i18n="udp.label.address"></span></label>
        <input type="text" id="node-input-addr" data-i18n="[placeholder]udp.placeholder.address" style="width:50%;">
        <select id="node-input-ipv" style="width:70px">
          <option value="udp4">ipv4</option>
          <option value="udp6">ipv6</option>
        </select>
    </div>
    <div class="form-row node-input-iface">
        <label for="node-input-iface"><i class="fa fa-random"></i> <span data-i18n="udp.label.interface"></span></label>
        <input type="text" id="node-input-iface" data-i18n="[placeholder]udp.placeholder.interface">
    </div>
    <div class="form-row">
        <label for="node-input-outport-type">&nbsp;</label>
        <select id="node-input-outport-type">
          <option id="node-input-outport-type-random" value="random" data-i18n="udp.bind.random"></option>
          <option value="fixed" data-i18n="udp.bind.local"></option>
        </select>
        <input type="text" id="node-input-outport" style="width:70px;">
    </div>
    <div class="form-row">
        <label>&nbsp;</label>
        <input type="checkbox" id="node-input-base64" style="display:inline-block; width:auto; vertical-align:top;">
        <label for="node-input-base64" style="width:70%;"><span data-i18n="udp.label.decode-base64"></span></label>
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name">
    </div>
    <div class="form-tips"><span data-i18n="[html]udp.tip.out"></span></div>
</script>

<script type="text/javascript">
    RED.nodes.registerType('udp out',{
        category: 'network',
        color:"Silver",
        defaults: {
            name: {value:""},
            addr: {value:""},
            iface: {value:""},
            port: {value:""},
            ipv: {value:"udp4"},
            outport: {value:""},
            base64: {value:false,required:true},
            multicast: {value:"false"}
        },
        inputs:1,
        outputs:0,
        icon: "bridge-dash.svg",
        align: "right",
        label: function() {
            return this.name||"udp "+(this.addr+":"+this.port);
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        oneditprepare: function() {
            var addresslabel = this._("udp.label.address");
            var addressph = this._("udp.placeholder.address");
            var grouplabel = this._("udp.label.group");
            var bindrandom = this._("udp.bind.random");
            var bindtarget = this._("udp.bind.target");

            var type = this.outport===""?"random":"fixed";
            $("#node-input-outport-type").val(type);

            $("#node-input-outport-type").on("change", function() {
                var type = $(this).val();
                if (type == "random") {
                    $("#node-input-outport").val("").hide();
                } else {
                    $("#node-input-outport").show();
                }
            });
            $("#node-input-outport-type").change();

            $("#node-input-multicast").on("change", function() {
                var id = $("#node-input-multicast").val();
                if (id === "multi") {
                    $(".node-input-iface").show();
                    $("#node-input-addr-label").html('<i class="fa fa-list"></i> ' + grouplabel);
                    $("#node-input-addr")[0].placeholder = '225.0.18.83';
                }
                else if (id === "broad") {
                    $(".node-input-iface").hide();
                    $("#node-input-addr-label").html('<i class="fa fa-list"></i> ' + addresslabel);
                    $("#node-input-addr")[0].placeholder = '255.255.255.255';
                }
                else {
                    $(".node-input-iface").hide();
                    $("#node-input-addr-label").html('<i class="fa fa-list"></i> ' + addresslabel);
                    $("#node-input-addr")[0].placeholder = addressph;
                }
                var type = $(this).val();
                if (type == "false") {
                    $("#node-input-outport-type-random").html(bindrandom);
                } else {
                    $("#node-input-outport-type-random").html(bindtarget);
                }
            });
            $("#node-input-multicast").change();
        }
    });
</script>
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-help-name="udp in">
    <p>A UDP input node, that produces a <code>msg.payload</code> containing a
    Buffer, string, or base64 encoded string. Supports multicast.</p>
    <p>It also provides <code>msg.ip</code> and <code>msg.port</code> set to the
    ip address and port from which the message was received.</p>
    <p><b>Note</b>: On some systems you may need root or administrator access to use
    ports below 1024 and/or broadcast.</p>
</script>

<script type="text/html" data-help-name="udp out">
    <p>This node sends <code>msg.payload</code> to the designated UDP host and port. Supports multicast.</p>
    <p>You may also use <code>msg.ip</code> and <code>msg.port</code> to set the destination values, but the statically configured values have precedence.</p>
    <p>If you select broadcast either set the address to the local broadcast ip address, or maybe try 255.255.255.255, which is the global broadcast address.</p>
    <p><b>Note</b>: On some systems you may need to be root to use ports below 1024 and/or broadcast.</p>
</script>

<!-- --- [red-module:node-red/CSV] --- -->

<script type="text/html" data-template-name="csv">
    <div class="form-row">
        <label for="node-input-temp"><i class="fa fa-list"></i> <span data-i18n="csv.label.columns"></span></label>
        <input type="text" id="node-input-temp" data-i18n="[placeholder]csv.placeholder.columns">
    </div>
    <div class="form-row">
        <label for="node-input-select-sep"><i class="fa fa-text-width"></i> <span data-i18n="csv.label.separator"></span></label>
            <select style="width:150px" id="node-input-select-sep">
                <option value="," data-i18n="csv.separator.comma"></option>
                <option value="\t" data-i18n="csv.separator.tab"></option>
                <option value=" " data-i18n="csv.separator.space"></option>
                <option value=";" data-i18n="csv.separator.semicolon"></option>
                <option value=":" data-i18n="csv.separator.colon"></option>
                <option value="#" data-i18n="csv.separator.hashtag"></option>
                <option value="" data-i18n="csv.separator.other"></option>
           </select>
           <input style="width:40px;" type="text" id="node-input-sep" pattern=".">
    </div>
    <div class="form-row">
        <label><i class="fa fa-code"></i> <span data-i18n="csv.label.spec"></span></label>
        <div style="display: inline-grid;width: 70%;">
            <select style="width:100%" id="csv-option-spec">
                <option value="rfc" data-i18n="csv.spec.rfc"></option>
                <option value="" data-i18n="csv.spec.legacy"></option>
            </select>
            <div>
                <div class="form-tips csv-lecacy-warning" data-i18n="node-red:csv.spec.legacy_warning"
                    style="width: calc(100% - 18px); margin-top: 4px; max-width: unset;">
                </div>
            </div>
        </div>
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name">
    </div>
    <hr align="middle"/>
    <div class="form-row">
        <label style="width:100%;"><span data-i18n="csv.label.c2o"></span></label>
    </div>
    <div class="form-row" style="padding-left:20px;">
        <label><i class="fa fa-sign-in"></i> <span data-i18n="csv.label.input"></span></label>
        <span data-i18n="csv.label.skip-s"></span>&nbsp;<input type="text" id="node-input-skip" style="width:40px; height:25px;"/>&nbsp;<span data-i18n="csv.label.skip-e"></span><br/>
        <label>&nbsp;</label>
        <input style="width:20px; vertical-align:baseline; margin-right:5px;" type="checkbox" id="node-input-hdrin"><label style="width:auto; margin-top:7px;" for="node-input-hdrin"><span data-i18n="csv.label.firstrow"></span></label><br/>
        <label>&nbsp;</label>
        <input style="width:20px; vertical-align:baseline; margin-right:5px;" type="checkbox" id="node-input-strings"><label style="width:auto; margin-top:7px;" for="node-input-strings"><span data-i18n="csv.label.usestrings"></span></label><br/>
        <label>&nbsp;</label>
        <input style="width:20px; vertical-align:baseline; margin-right:5px;" type="checkbox" id="node-input-include_empty_strings"><label style="width:auto; margin-top:7px;" for="node-input-include_empty_strings"><span data-i18n="csv.label.include_empty_strings"></span></label><br/>
        <label>&nbsp;</label>
        <input style="width:20px; vertical-align:baseline; margin-right:5px;" type="checkbox" id="node-input-include_null_values"><label style="width:auto; margin-top:7px;" for="node-input-include_null_values"><span data-i18n="csv.label.include_null_values"></span></label><br/>
    </div>
    <div class="form-row" style="padding-left:20px;">
        <label><i class="fa fa-sign-out"></i> <span data-i18n="csv.label.output"></span></label>
        <select type="text" id="node-input-multi" style="width:250px;">
            <option value="one" data-i18n="csv.output.row"></option>
            <option value="mult" data-i18n="csv.output.array"></option>
        </select>
    </div>
    <div class="form-row" style="margin-top:20px">
        <label style="width:100%;"><span data-i18n="csv.label.o2c"></span></label>
    </div>
    <div class="form-row" style="padding-left:20px;">
        <label><i class="fa fa-sign-out"></i> <span data-i18n="csv.label.output"></span></label>
        <!-- <input style="width:20px; vertical-align:top; margin-right:5px;" type="checkbox" id="node-input-hdrout"><label style="width:auto;" for="node-input-hdrout"><span data-i18n="csv.label.includerow"></span></span> -->
        <select style="width:60%" id="node-input-hdrout">
            <option value="none" data-i18n="csv.hdrout.none"></option>
            <option value="all" data-i18n="csv.hdrout.all"></option>
            <option value="once" data-i18n="csv.hdrout.once"></option>
        </select>
    </div>
    <div class="form-row" style="padding-left:20px;">
        <label></label>
        <label style="width:auto; margin-right:10px;" for="node-input-ret"><span data-i18n="csv.label.newline"></span></label>
        <select style="width:calc(70% - 108px);" id="node-input-ret">
            <option value='\r\n' data-i18n="csv.newline.windows"></option>
            <option value='\n' data-i18n="csv.newline.linux"></option>
            <option value='\r' data-i18n="csv.newline.mac"></option>
       </select>
    </div>
</script>


<script type="text/javascript">
    RED.nodes.registerType('csv',{
        category: 'parser',
        color:"#DEBD5C",
        defaults: {
            name: {value:""},
            spec: {value:"rfc"},
            sep: {
                value:',', required:true,
                label:RED._("node-red:csv.label.separator"),
                validate:RED.validators.regex(/^.{1,2}$/)},
            //quo: {value:'"',required:true},
            hdrin: {value:""},
            hdrout: {value:"none"},
            multi: {value:"one",required:true},
            ret: {value:'\\r\\n'}, // default to CRLF (RFC4180 Sec 2.1: "Each record is located on a separate line, delimited by a line break (CRLF)")
            temp: {value:""},
            skip: {value:"0"},
            strings: {value:true},
            include_empty_strings: {value:""},
            include_null_values: {value:""}
        },
        inputs:1,
        outputs:1,
        icon: "parser-csv.svg",
        label: function() {
            return this.name||"csv";
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        oneditprepare: function() {
            if (this.hdrout === false) { this.hdrout = "none"; $("#node-input-hdrout").val("none"); }
            if (this.hdrout === true) { this.hdrout = "all"; $("#node-input-hdrout").val("all");}
            if (this.strings === undefined) { this.strings = true; $("#node-input-strings").prop('checked', true); }
            if (this.skip === undefined) { this.skip = 0; $("#node-input-skip").val("0");}
            $("#node-input-skip").spinner({ min:0 });
            if (this.sep == "," || this.sep == "\\t" || this.sep == ";" || this.sep == ":" || this.sep == " " || this.sep == "#") {
                $("#node-input-select-sep").val(this.sep);
                $("#node-input-sep").hide();
            } else {
                $("#node-input-select-sep").val("");
                $("#node-input-sep").val(this.sep);
                $("#node-input-sep").show();
            }
            $("#node-input-select-sep").on("change", function() {
                var v = $("#node-input-select-sep").val();
                $("#node-input-sep").val(v);
                if (v == "") {
                    $("#node-input-sep").val("");
                    $("#node-input-sep").show().focus();
                } else {
                    $("#node-input-sep").hide();
                }
            });

            $("#csv-option-spec").on("change", function() {
                if ($("#csv-option-spec").val() == "rfc") {
                    $(".form-tips.csv-lecacy-warning").hide();
                } else {
                    $(".form-tips.csv-lecacy-warning").show();
                }
            });
            // new nodes will have `spec` set to "rfc" (default), but existing nodes will either not have
            // a spec value or it will be empty - we need to maintain the legacy behaviour for existing
            // flows but default to rfc for new nodes
            let spec = !this.spec ? "" : "rfc"
            $("#csv-option-spec").val(spec).trigger("change")
        },
        oneditsave: function() {
            const specFormVal = $("#csv-option-spec").val() || '' // empty === legacy
            const spectNodeVal = this.spec || ''  // empty === legacy, null/undefined means in-place node upgrade (keep as is)
            if (specFormVal !== spectNodeVal) {
                // only update the flow value if changed (avoid marking the node dirty unnecessarily)
                this.spec = specFormVal
            }
        }
    });
</script>
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-help-name="csv">
    <p>Converts between a CSV formatted string and its JavaScript object representation, in either direction.</p>
    <h3>Inputs</h3>
    <dl class="message-properties">
        <dt>payload<span class="property-type">object | array | string</span></dt>
        <dd>A JavaScript object, array or CSV string.</dd>
    </dl>
    <h3>Outputs</h3>
    <dl class="message-properties">
        <dt>payload<span class="property-type">object | array | string</span></dt>
        <dd>
        <ul>
            <li>If the input is a string it tries to parse it as CSV and creates a JavaScript object of key/value pairs for each line.
                The node will then either send a message for each line, or a single message containing an array of objects.</li>
            <li>If the input is a JavaScript object it tries to build a CSV string.</li>
            <li>If the input is an array of simple values, it builds a single line CSV string.</li>
            <li>If the input is an array of arrays, or an array of objects, a multiple-line CSV string is created.</li>
        </ul>
        </dd>
    </dl>
    <h3>Details</h3>
    <p>The column template can contain an ordered list of column names. When converting CSV to an object, the column names
    will be used as the property names. Alternatively, the column names can be taken from the first row of the CSV.
        <p>When the RFC parser is selected, the column template must be compliant with RFC4180.</p>
    </p>
    <p>When converting to CSV, the columns template is used to identify which properties to extract from the object and in what order.</p>
    <p>If the columns template is blank then you can use a simple comma separated list of properties supplied in <code>msg.columns</code> to
    determine what to extract and in what order. If neither are present then all the object properties are output in the order
    in which the properties are found in the first row.</p>
    <p>If the input is an array then the columns template is only used to optionally generate a row of column titles.</p>
    <p>If 'parse numerical values' option is checked, string numerical values will be returned as numbers, ie. middle value '1,"1.5",2'.</p>
    <p>If 'include empty strings' option is checked, empty strings will be returned in result, ie. middle value '"1","",3'.</p>
    <p>If 'include null values' option is checked, null values will be returned in result, ie. middle value '"1",,3'.</p>
    <p>The node can accept a multi-part input as long as the <code>parts</code> property is set correctly, for example from a file-in node or split node.</p>
    <p>If outputting multiple messages they will have their <code>parts</code> property set and form a complete message sequence.</p>
    <p>If the node is set to only send column headers once, then setting <code>msg.reset</code> to any value will cause the node to resend the headers.</p>
    <p><b>Note:</b> the column template must be comma separated - even if a different separator is chosen for the data.</p>
    <p><b>Note:</b> in RFC mode, catchable errors will be thrown for malformed CSV headers and invalid input payload data</p>
</script>

<!-- --- [red-module:node-red/HTML] --- -->

<script type="text/html" data-template-name="html">
    <div class="form-row">
        <label for="node-input-property"><i class="fa fa-ellipsis-h"></i> <span data-i18n="common.label.property"></span></label>
        <input type="text" id="node-input-property" style="width:70%">
    </div>
    <div class="form-row">
        <label for="node-input-tag"><i class="fa fa-filter"></i> <span data-i18n="html.label.select"></span></label>
        <input type="text" id="node-input-tag" placeholder="h1">
    </div>
    <div class="form-row">
        <label for="node-input-ret"><i class="fa fa-sign-out"></i> <span data-i18n="html.label.output"></span></label>
        <select id="node-input-ret" style="width:70%">
            <option value="html" data-i18n="html.output.html"></option>
            <option value="text" data-i18n="html.output.text"></option>
            <option value="attr" data-i18n="html.output.attr"></option>
            <option value="compl" data-i18n="html.output.compl"></option>
            <!-- <option value="val">return the value from a form element</option> -->
        </select>
    </div>
    <div class="form-row">
        <label for="node-input-as">&nbsp;</label>
        <select id="node-input-as" style="width:70%">
            <option value="single" data-i18n="html.format.single"></option>
            <option value="multi" data-i18n="html.format.multi"></option>
        </select>
    </div>
    <div class="form-row">
        <label for="node-input-outproperty">&nbsp;</label>
        <span data-i18n="html.label.in" style="padding-left:8px; padding-right:2px; vertical-align:-1px;"></span> <input type="text" id="node-input-outproperty" style="width:64%">
    </div>
    <div id='html-prefix-row' class="form-row" style="display: none;">
        <label for="node-input-chr" style="width: 230px;"><i class="fa fa-tag"></i> <span data-i18n="html.label.prefix"></span></label>
        <input type="text" id="node-input-chr" style="text-align:center; width: 40px;" placeholder="_">
    </div>
    <br/>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" style="width:70%" data-i18n="[placeholder]common.label.name">
    </div>
</script>

<script type="text/javascript">
    RED.nodes.registerType('html',{
        category: 'parser',
        color:"#DEBD5C",
        defaults: {
            name: {value:""},
            property: {value:"payload", validate: RED.validators.typedInput({ type: 'msg', allowUndefined: true }) },
            outproperty: {value:"payload", validate: RED.validators.typedInput({ type: 'msg', allowUndefined: true }) },
            tag: {value:""},
            ret: {value:"html"},
            as: {value:"single"},
            chr: { value: "_" }
        },
        inputs:1,
        outputs:1,
        icon: "parser-html.svg",
        label: function() {
            return this.name||this.tag||"html";
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        oneditprepare: function() {
            $("#node-input-property").typedInput({default:'msg',types:['msg']});
            $("#node-input-outproperty").typedInput({default:'msg',types:['msg']});
            $('#node-input-ret').on( 'change', () => {
                if ( $('#node-input-ret').val() == "compl" ) {
                    $('#html-prefix-row').show()
                } else {
                    $('#html-prefix-row').hide()
                }
            });
        }
    });
</script>
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-help-name="html">
    <p>Extracts elements from an html document held in <code>msg.payload</code> using a CSS selector.</p>
    <h3>Inputs</h3>
    <dl class="message-properties">
    <dt>payload <span class="property-type">string</span></dt>
    <dd>the html string from which to extract elements.</dd>
    <dt class="optional">select <span class="property-type">string</span></dt>
    <dd>if not configured in the edit panel the selector can be set as a property of msg.</dd>
</dl>
    <h3>Output</h3>
    <dl class="message-properties">
        <dt>payload <span class="property-type">array | string</span></dt>
        <dd>the result can be either a single message with a payload containing an array of the matched elements, or multiple
           messages that each contain a matched element. If multiple messages are sent they will also have <code>parts</code> set.</dd>
    </dl>
    <h3>Details</h3>
    <p>This node supports a combination of CSS and jQuery selectors. See the
    <a href="https://github.com/fb55/CSSselect#user-content-supported-selectors" target="_blank">css-select documentation</a> for more information
    on the supported syntax.</p>
</script>

<!-- --- [red-module:node-red/JSON] --- -->

<script type="text/html" data-template-name="json">
    <div class="form-row">
        <label for="node-input-action"><i class="fa fa-dot-circle-o"></i> <span data-i18n="json.label.action"></span></label>
        <select style="width:70%" id="node-input-action">
            <option value=""    data-i18n="json.label.actions.toggle"></option>
            <option value="str" data-i18n="json.label.actions.str"></option>
            <option value="obj" data-i18n="json.label.actions.obj"></option>
        </select>
    </div>
    <div class="form-row">
        <label for="node-input-property"><i class="fa fa-ellipsis-h"></i> <span data-i18n="json.label.property"></span></label>
        <input type="text" id="node-input-property" style="width:70%;"/>
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name">
    </div>
    <hr align="middle"/>
    <div class="form-row node-json-to-json-options">
        <label style="width:100%;"><span data-i18n="json.label.o2j"></span></label>
    </div>
    <div class="form-row node-json-to-json-options" style="padding-left: 20px;">
        <input style="width:20px; vertical-align:top; margin-right: 5px;" type="checkbox" id="node-input-pretty"><label style="width: auto;" for="node-input-pretty" data-i18n="json.label.pretty"></label>
    </div>
</script>

<script type="text/javascript">
    RED.nodes.registerType('json',{
        category: 'parser',
        color:"#DEBD5C",
        defaults: {
            name: {value:""},
            property: {value:"payload",required:true,
                       validate: RED.validators.typedInput({ type: 'msg', allowUndefined: true}),
                       label:RED._("node-red:json.label.property")},
            action: {value:""},
            pretty: {value:false}
        },
        inputs:1,
        outputs:1,
        icon: "parser-json.svg",
        label: function() {
            return this.name||"json";
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        oneditprepare: function() {
            if (this.property === undefined) {
                $("#node-input-property").val("payload");
            }
            $("#node-input-property").typedInput({default:'msg',types:['msg']});
            $("#node-input-action").on("change", function() {
                if (this.value === "" || this.value === "str") {
                    $(".node-json-to-json-options").show();
                } else {
                    $(".node-json-to-json-options").hide();
                }
            });
            $("#node-input-action").change();
        }
    });
</script>
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-help-name="json">
    <p>Converts between a JSON string and its JavaScript object representation, in either direction.</p>
    <h3>Inputs</h3>
    <dl class="message-properties">
        <dt>payload<span class="property-type">object | string</span></dt>
        <dd>A JavaScript object or JSON string.</dd>
        <dt>schema<span class="property-type">object</span></dt>
        <dd>An optional JSON Schema object to validate the payload against.
        The property will be deleted before the <code>msg</code> is sent to the next node.</dd>
    </dl>
    <h3>Outputs</h3>
    <dl class="message-properties">
        <dt>payload<span class="property-type">object | string</span></dt>
        <dd>
            <ul>
                <li>If the input is a JSON string it tries to parse it to a JavaScript object.</li>
                <li>If the input is a JavaScript object it creates a JSON string. The string can optionally be well-formatted.</li>
            </ul>
        </dd>
        <dt>schemaError<span class="property-type">array</span></dt>
        <dd>If JSON schema validation fails, the catch node will have a <code>schemaError</code> property
            containing an array of errors.</dd>
    </dl>
    <h3>Details</h3>
    <p>By default, the node operates on <code>msg.payload</code>, but can be configured
       to convert any message property.</p>
    <p>The node can also be configured to ensure a particular encoding instead of toggling
       between the two. This can be used, for example, with the <code>HTTP In</code>
       node to ensure the payload is a parsed object even if an incoming request
       did not set its content-type correctly for the HTTP In node to do the conversion.</p>
    <p>If the node is configured to ensure the property is encoded as a String and it
       receives a String, no further checks will be made of the property. It will
       not check the String is valid JSON nor will it reformat it if the format option
       is selected.</p>
    <p>For more details about JSON Schema you can consult the specification
    <a href="http://json-schema.org/latest/json-schema-validation.html">here</a>.</p>
</script>

<!-- --- [red-module:node-red/XML] --- -->

<script type="text/html" data-template-name="xml">
    <div class="form-row">
        <label for="node-input-property"><i class="fa fa-ellipsis-h"></i> <span data-i18n="common.label.property"></span></label>
        <input type="text" id="node-input-property" style="width:70%;"/>
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name">
    </div>
    <hr align="middle"/>
    <div class="form-row">
        <label style="width:100%;"><span data-i18n="xml.label.x2o"></span></label>
    </div>
    <div class="form-row" style="padding-left: 20px;">
        <label style="width:250px;" for="node-input-attr" data-i18n="xml.label.represent"></label> <input type="text" id="node-input-attr" style="text-align:center; width:40px" placeholder="$">
    </div>
    <div class="form-row" style="padding-left: 20px;">
        <label style="width:250px;" for="node-input-chr" data-i18n="xml.label.prefix"></label> <input type="text" id="node-input-chr" style="text-align:center; width:40px" placeholder="_">
    </div>
</script>

<script type="text/javascript">
    RED.nodes.registerType('xml',{
        category: 'parser',
        color:"#DEBD5C",
        defaults: {
            name: {value:""},
            property: {value:"payload",required:true,
                       label:RED._("node-red:common.label.property"),
                       validate: RED.validators.typedInput({ type: 'msg', allowUndefined: true })},
            attr: {value:""},
            chr: {value:""}
        },
        inputs:1,
        outputs:1,
        icon: "parser-xml.svg",
        label: function() {
            return this.name||"xml";
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        oneditprepare: function() {
            if (this.property === undefined) {
                $("#node-input-property").val("payload");
            }
            $("#node-input-property").typedInput({default:'msg',types:['msg']});
        }
    });
</script>
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-help-name="xml">
    <p>Converts between an XML string and its JavaScript object representation, in either direction.</p>
    <h3>Inputs</h3>
    <dl class="message-properties">
        <dt>payload<span class="property-type">object | string</span></dt>
        <dd>A JavaScript object or XML string.</dd>
        <dt class="optional">options <span class="property-type">object</span></dt>
        <dd>This optional property can be used to pass in any of the options supported by the underlying
            library used to convert to and from XML. See <a href="https://github.com/Leonidas-from-XIV/node-xml2js/blob/master/README.md#options" target="_blank">the xml2js docs</a>
            for more information.</dd>
    </dl>
    <h3>Outputs</h3>
    <dl class="message-properties">
        <dt>payload<span class="property-type">object | string</span></dt>
        <dd>
            <ul>
                <li>If the input is a string it tries to parse it as XML and creates a JavaScript object.</li>
                <li>If the input is a JavaScript object it tries to build an XML string.</li>
            </ul>
        </dd>
    </dl>
    <h3>Details</h3>
    <p>When converting between XML and an object, any XML attributes are added as a property named <code>$</code> by default.
    Any text content is added as a property named <code>_</code>. These property names can be specified in the node configuration.</p>
    <p>For example, the following XML will be converted as shown:</p>
    <pre>&lt;p class="tag"&gt;Hello World&lt;/p&gt;</pre>
    <pre>{
  "p": {
    "$": {
      "class": "tag"
    },
    "_": "Hello World"
  }
}</pre>
</script>

<!-- --- [red-module:node-red/YAML] --- -->

<script type="text/html" data-template-name="yaml">
    <div class="form-row">
        <label for="node-input-property"><i class="fa fa-ellipsis-h"></i> <span data-i18n="common.label.property"></span></label>
        <input type="text" id="node-input-property" style="width:70%;"/>
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name">
    </div>
</script>

<script type="text/javascript">
    RED.nodes.registerType('yaml',{
        category: 'parser',
        color:"#DEBD5C",
        defaults: {
            property: {value:"payload",required:true,
                       validate: RED.validators.typedInput({ type: 'msg', allowUndefined: true }),
                       label:RED._("node-red:common.label.property")},
            name: {value:""}
        },
        inputs:1,
        outputs:1,
        icon: "parser-yaml.svg",
        label: function() {
            return this.name||"yaml";
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        oneditprepare: function() {
            if (this.property === undefined) {
                $("#node-input-property").val("payload");
            }
            $("#node-input-property").typedInput({default:'msg',types:['msg']});
        }
    });
</script>
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-help-name="yaml">
    <p>Converts between a YAML formatted string and its JavaScript object representation, in either direction.</p>
    <h3>Inputs</h3>
    <dl class="message-properties">
        <dt>payload<span class="property-type">object | string</span></dt>
        <dd>A JavaScript object or YAML string.</dd>
    </dl>
    <h3>Outputs</h3>
    <dl class="message-properties">
        <dt>payload<span class="property-type">object | string</span></dt>
        <dd>
            <ul>
                <li>If the input is a YAML string it tries to parse it to a JavaScript object.</li>
                <li>If the input is a JavaScript object it creates a YAML string.</li>
            </ul>
        </dd>
    </dl>
</script>

<!-- --- [red-module:node-red/split] --- -->
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-template-name="split">
    <!-- <div class="form-row"><span data-i18n="[html]split.intro"></span></div> -->
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="node-red:common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]node-red:common.label.name">
    </div>
    <div class="form-row">
        <label for="node-input-property"><i class="fa fa-forward"></i> <span data-i18n="split.splitThe"></span></label>
        <input type="text" id="node-input-property" style="width:70%;"/>
    </div>
    <div class="form-row"><span data-i18n="[html]split.strBuff"></span></div>
    <div class="form-row">
        <label for="node-input-splt" style="padding-left:10px; margin-right:-10px;" data-i18n="split.splitUsing"></label>
        <input type="text" id="node-input-splt" style="width:70%">
        <input type="hidden" id="node-input-spltType">
    </div>
    <div class="form-row">
        <input type="checkbox" id="node-input-stream" style="margin-left:10px; vertical-align:top; width:auto;">
        <label for="node-input-stream" style="width:auto;" data-i18n="split.stream"></label>
    </div>
    <div class="form-row"><span data-i18n="[html]split.array"></span></div>
    <div class="form-row">
        <label for="node-input-arraySplt" style="padding-left:10px; margin-right:-10px;" data-i18n="split.splitUsing"></label>
        <input type="text" id="node-input-arraySplt" style="width:70%">
        <input type="hidden" id="node-input-arraySpltType">
    </div>
    <div class="form-row"><span data-i18n="[html]split.object"></span></div>
    <div class="form-row" style="padding-left: 10px"><span data-i18n="[html]split.objectSend"></span></div>
    <div class="form-row">
        <input type="checkbox" id="node-input-addname-cb" style="margin-left:10px; vertical-align:baseline; width:auto;">
        <label for="node-input-addname-cb" style="width:auto;" data-i18n="split.addname"></label>
        <input type="text" id="node-input-addname" style="width:70%">
    </div>
</script>

<script type="text/javascript">
    RED.nodes.registerType('split',{
        category: 'sequence',
        color:"#E2D96E",
        defaults: {
            name: {value:""},
            splt: {value:"\\n"},
            spltType: {value:"str"},
            arraySplt: {value:1},
            arraySpltType: {value:"len"},
            stream: {value:false},
            addname: {value:"", validate: RED.validators.typedInput({ type: 'msg', allowBlank: true })},
            property: {value:"payload",required:true}
        },
        inputs:1,
        outputs:1,
        icon: "split.svg",
        label: function() {
            return this.name||this._("split.split");
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        oneditprepare: function() {
            if (this.property === undefined) {
                $("#node-input-property").val("payload");
            }
            $("#node-input-property").typedInput({default:'msg',types:['msg']});
            $("#node-input-splt").typedInput({
                default: 'str',
                typeField: $("#node-input-spltType"),
                types:[
                    'str',
                    'bin',
                    {value:"len", label:RED._("node-red:split.splitLength"),validate:/^\d+$/}
                ]
            });
            if (this.arraySplt === undefined) {
                $("#node-input-arraySplt").val(1);
            }
            $("#node-input-arraySplt").typedInput({
                default: 'len',
                typeField: $("#node-input-arraySpltType"),
                types:[
                    {value:"len", label:RED._("node-red:split.splitLength"),validate:/^\d+$/}
                ]
            });
            $("#node-input-addname").typedInput({
                typeField: $("#node-input-fnameType"),
                types:['msg']
            });

            $("#node-input-addname-cb").on("change", function() {
                $("#node-input-addname").prop('disabled',!this.checked);
            })
            if (this.addname === "") {
                $("#node-input-addname-cb").prop('checked',false);
                $("#node-input-addname").val('topic');
            } else {
                $("#node-input-addname-cb").prop('checked',true);
            }
            $("#node-input-addname-cb").change();
        },
        oneditsave: function() {
            if (!$("#node-input-addname-cb").prop('checked')) {
                $("#node-input-addname").val('');
            }
        }
    });
</script>


<script type="text/html" data-template-name="join">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name">
    </div>
    <div class="form-row">
        <label data-i18n="join.mode.mode"></label>
        <select id="node-input-mode" style="width:200px;">
            <option value="auto" data-i18n="join.mode.auto"></option>
            <option value="custom" data-i18n="join.mode.custom"></option>
            <option value="reduce" data-i18n="join.mode.reduce"></option>
        </select>
    </div>
    <div class="node-row-custom">
        <div class="form-row node-row-property">
            <label data-i18n="join.combine"> </label>
            <input type="text" id="node-input-property" style="width:70%;">
            <input type="hidden" id="node-input-propertyType">
        </div>
        <div class="form-row">
            <label data-i18n="join.create"></label>
            <select id="node-input-build" style="width:70%;">
                <option value="string" data-i18n="join.type.string"></option>
                <option value="buffer" data-i18n="join.type.buffer"></option>
                <option value="array" data-i18n="join.type.array"></option>
                <option value="object" data-i18n="join.type.object"></option>
                <option value="merged" data-i18n="join.type.merged"></option>
            </select>
        </div>
        <div class="form-row node-row-key">
            <label style="vertical-align:top; margin-top:7px; width:auto; margin-right: 5px;" data-i18n="join.using"></label>
            <div style="display:inline-block">
                <input type="text" id="node-input-key" style="width:220px;"> <span data-i18n="join.key"></span>
            </div>
        </div>
        <div class="form-row node-row-joiner">
            <label for="node-input-joiner" data-i18n="join.joinedUsing"></label>
            <input type="text" id="node-input-joiner" style="width:70%">
            <input type="hidden" id="node-input-joinerType">
        </div>

        <div class="form-row">
            <input type="checkbox" id="node-input-useparts" style="margin-left:8px; margin-right:8px; vertical-align:baseline; width:auto;">
            <label for="node-input-useparts" style="width:auto;" data-i18n="join.useparts"></label>
        </div>

        <div class="form-row node-row-trigger" id="trigger-row">
            <label style="width:auto;" data-i18n="join.send"></label>
            <ul>
                <li>
                    <label style="width:280px;" for="node-input-count" data-i18n="join.afterCount"></label> <input id="node-input-count" data-i18n="[placeholder]join.count" type="text" style="width:75px;">
                </li>
                <li class="node-row-accumulate" style="list-style-type:none;">
                    <input type="checkbox" id="node-input-accumulate" style="display:inline-block; width:20px; margin-left:20px; vertical-align:top;">  <label style="width: auto" for="node-input-accumulate" data-i18n="join.subsequent"></label>
                </li>
                <li>
                    <label style="width:280px;" for="node-input-timeout" data-i18n="join.afterTimeout"></label> <input id="node-input-timeout" data-i18n="[placeholder]join.seconds" type="text" style="width:75px;">
                </li>
                <li>
                    <label style="width:auto; padding-top:6px;" data-i18n="[html]join.complete"></label>
                </li>
            </ul>
        </div>
    </div>
    <div class="node-row-reduce">
        <div class="form-row">
            <label for="node-input-reduceExp" data-i18n="join.reduce.exp" style="margin-left:10px;"></label>
            <input type="text" id="node-input-reduceExp" data-i18n="[placeholder]join.reduce.exp-value" style="width:65%">
        </div>
        <div class="form-row">
            <label for="node-input-reduceInit" data-i18n="join.reduce.init" style="margin-left:10px;"></label>
            <input type="text" id="node-input-reduceInit" data-i18n="[placeholder]join.reduce.init" style="width:65%">
            <input type="hidden" id="node-input-reduceInitType">
        </div>
        <div class="form-row">
            <label for="node-input-reduceFixup" data-i18n="join.reduce.fixup" style="margin-left:10px;"></label>
            <input type="text" id="node-input-reduceFixup" data-i18n="[placeholder]join.reduce.exp-value" style="width:65%">
        </div>
        <div class="form-row">
            <label>&nbsp;</label>
            <input type="checkbox" id="node-input-reduceRight" style="display:inline-block; width:auto; vertical-align:top; margin-left:10px;">
            <label for="node-input-reduceRight" style="width:70%;" data-i18n="join.reduce.right" style="margin-left:10px;"/>
        </div>
    </div>
    <div class="form-tips form-tips-auto hide" data-i18n="[html]join.tip"></div>
</script>

<script type="text/javascript">
    RED.nodes.registerType('join',{
        category: 'sequence',
        color:"#E2D96E",
        defaults: {
            name: {value:""},
            mode: {value:"auto"},
            build: { value:"object"},
            property: {
                value:"payload",
                label: RED._("node-red:join.message-prop"),
                validate:RED.validators.typedInput("propertyType", false)
            },
            propertyType: { value:"msg"},
            key: {value:"topic", validate: (function () {
                const typeValidator = RED.validators.typedInput({ type: 'msg' })
                return function(v, opt) {
                    const joinMode = $("#node-input-mode").val() || this.mode
                    if (joinMode !== 'custom') {
                        return true
                    }
                    const buildType = $("#node-input-build").val() || this.build
                    if (buildType !== 'object') {
                        return true
                    } else {
                        return typeValidator(v, opt)
                    }
                }
                })()
            },
            joiner: { value:"\\n"},
            joinerType: { value:"str"},
            useparts: { value:false },
            accumulate: { value:"false" },
            timeout: {value:""},
            count: {value:""},
            reduceRight: {value:false},
            reduceExp: {value:undefined},
            reduceInit: {value:undefined},
            reduceInitType: {value:undefined},
            reduceFixup: {value:undefined}
        },
        inputs:1,
        outputs:1,
        icon: "join.svg",
        label: function() {
            var nam = this.name||this._("join.join");
            if (this.mode === "custom" && !isNaN(Number(this.count))) {
                nam += " "+this.count;
                if (this.accumulate === true) { nam+= "+"; }
            }
            return nam;
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        oneditprepare: function() {
            var node = this;
            $("#node-input-useparts").on("change", function(e) {
                if (node.useparts === undefined) {
                    node.useparts = true;
                    $("#node-input-useparts").attr('checked', true);
                }
            });

            $("#node-input-mode").on("change", function(e) {
                var val = $(this).val();
                $(".node-row-custom").toggle(val==='custom');
                $(".node-row-reduce").toggle(val==='reduce');
                $(".form-tips-auto").toggle((val==='auto') || (val==='reduce'));
                if (val === "auto") {
                    $("#node-input-accumulate").attr('checked', false);
                }
                else if (val === "custom") {
                    $("#node-input-build").change();
                }
                else if (val === "reduce") {
                    var jsonata_or_empty = {
                        value: "jsonata",
                        label: "expression",
                        icon: "red/images/typedInput/expr.svg",
                        validate: function(v) {
                            try{
                                if(v !== "") {
                                    jsonata(v);
                                }
                                return true;
                            }
                            catch(e){
                                return false;
                            }
                        },
                        expand:function() {
                            var that = this;
                            RED.editor.editExpression({
                                value: this.value().replace(/\t/g,"\n"),
                                complete: function(v) {
                                    that.value(v.replace(/\n/g,"\t"));
                                }
                            })
                        }
                    };
                    $("#node-input-reduceExp").typedInput({types:[jsonata_or_empty]});
                    $("#node-input-reduceInit").typedInput({
                        default: 'num',
                        types:['flow','global','str','num','bool','json','bin','date','jsonata','env'],
                        typeField: $("#node-input-reduceInitType")
                    });
                    $("#node-input-reduceFixup").typedInput({types:[jsonata_or_empty]});
                }
            });

            $("#node-input-build").on("change", function(e) {
                var val = $(this).val();
                $(".node-row-key").toggle(val==='object');
                $(".node-row-accumulate").toggle(val==='object' || val==='merged');
                $(".node-row-joiner").toggle(val==='string' || val==='buffer');
                $(".node-row-trigger").toggle(val!=='auto');
                if (val === 'string' || val==='buffer') {
                    $("#node-input-property").typedInput('types',['msg']);
                    $("#node-input-joiner").typedInput("show");
                } else {
                    $("#node-input-property").typedInput('types', ['msg', {
                        value: "full",
                        label: RED._("node-red:join.completeMessage"),
                        hasValue: false
                    }]);
                }
            });

            $("#node-input-joiner").typedInput({
                default: 'str',
                typeField: $("#node-input-joinerType"),
                types:['str', 'bin']
            });

            $("#node-input-property").typedInput({
                typeField: $("#node-input-propertyType"),
                types: ['msg', {
                    value: "full",
                    label: RED._("node-red:join.completeMessage"),
                    hasValue: false
                }]
            });

            $("#node-input-key").typedInput({
                types:['msg']
            });

            $("#node-input-build").change();
            $("#node-input-mode").change();
        },
        oneditsave: function() {
            var build = $("#node-input-build").val();
            if (build !== 'object' && build !== 'merged') {
                $("#node-input-accumulate").prop("checked",false);
            }
        }
    });
</script>
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-help-name="split">
    <p>Splits a message into a sequence of messages.</p>

    <h3>Inputs</h3>
    <dl class="message-properties">
        <dt>payload<span class="property-type">object | string | array | buffer</span></dt>
        <dd>The behaviour of the node is determined by the type of <code>msg.payload</code>:
            <ul>
                <li><b>string</b>/<b>buffer</b> - the message is split using the specified character (default: <code>\n</code>), buffer sequence or into fixed lengths.</li>
                <li><b>array</b> - the message is split into either individual array elements, or arrays of a fixed-length.</li>
                <li><b>object</b> - a message is sent for each key/value pair of the object.</li>
            </ul>
        </dd>
    </dl>
    <h3>Outputs</h3>
    <dl class="message-properties">
        <dt>parts<span class="property-type">object</span></dt>
        <dd>This property contains information about how the message was split from
        the original message. If passed to the <b>join</b> node, the sequence can be
        reassembled into a single message. The property has the following properties:
        <ul>
            <li><code>id</code> - an identifier for the group of messages</li>
            <li><code>index</code> - the position within the group</li>
            <li><code>count</code> - if known, the total number of messages in the group. See 'streaming mode' below.</li>
            <li><code>type</code> - the type of message - string/array/object/buffer</li>
            <li><code>ch</code> - for a string or buffer, the data used to the split the message as either the string or an array of bytes</li>
            <li><code>key</code> - for an object, the key of the property this message was created from. The node can be configured to also copy this value to another message properties, such as <code>msg.topic</code>.</li>
            <li><code>len</code> - the length of each message when split using a fixed length value</li>
        </ul>
        </dd>
    </dl>
    <h3>Details</h3>
    <p>This node makes it easy to create a flow that performs common actions across
    a sequence of messages before, using the <b>join</b> node, recombining the
    sequence into a single message.</p>
    <p>It uses the <code>msg.parts</code> property to track the individual parts
    of a sequence.</p>
    <h4>Streaming mode</h4>
    <p>The node can also be used to reflow a stream of messages. For example, a
    serial device that sends newline-terminated commands may deliver a single message
    with a partial command at its end. In 'streaming mode', this node will split
    a message and send each complete segment. If there is a partial segment at the end,
    the node will hold on to it and prepend it to the next message that is received.
    </p>
    <p>When operating in this mode, the node will not set the <code>msg.parts.count</code>
    property as it does not know how many messages to expect in the stream. This
    means it cannot be used with the <b>join</b> node in its automatic mode.</p>
</script>

<script type="text/html" data-help-name="join">
    <p>Joins sequences of messages into a single message.</p>
    <p>There are three modes available:</p>
    <dl>
        <dt>automatic</dt>
        <dd>When paired with the <b>split</b> node, it will automatically join the messages to reverse the split that was performed.</dd>
        <dt>manual</dt>
        <dd>Join sequences of messages in a variety of ways.</dd>
        <dt>reduce sequence</dt>
        <dd>Apply an expression against all messages in a sequence to reduce it to a single message.</dd>
    </dl>
    <h3>Inputs</h3>
    <dl class="message-properties">
        <dt class="optional">parts<span class="property-type">object</span></dt>
        <dd>To automatically join a sequence of messages, they should all have
        this property set. The <b>split</b> node generates this property but it
        can be manually created. It has the following properties:
        <ul>
            <li><code>id</code> - an identifier for the group of messages</li>
            <li><code>index</code> - the position within the group</li>
            <li><code>count</code> - the total number of messages in the group</li>
            <li><code>type</code> - the type of message - string/array/object/buffer</li>
            <li><code>ch</code> - for a string or buffer, the data used to the split the message as either the string or an array of bytes</li>
            <li><code>key</code> - for an object, the key of the property this message was created from</li>
            <li><code>len</code> - the length of each message when split using a fixed length value</li>
        </ul>
        </dd>
        <dt class="optional">complete</dt>
        <dd>If set, the node will append the payload, and then send the output message in its current state.
            If you don't wish to append the payload, delete it from the msg.</dd>
        <dt class="optional">reset</dt>
        <dd>If set, the node will clear any partially complete message and not send it.</dd>
        <dt class="optional">restartTimeout</dt>
        <dd>If set, and the node has a timeout configured, that timeout will be restarted.</dd>
    </dl>
    <h3>Details</h3>

    <h4>Automatic mode</h4>
    <p>Automatic mode uses the <code>parts</code> property of incoming messages to
       determine how the sequence should be joined. This allows it to automatically
       reverse the action of a <b>split</b> node.</p>

    <h4>Manual mode</h4>
    <p>When configured to join in manual mode, the node is able to join sequences
     of messages into a number of different results:</p>
    <ul>
        <li>a <b>string</b> or <b>buffer</b> - created by joining the selected property of each message with the specified join characters or buffer.</li>
        <li>an <b>array</b> - created by adding each selected property, or entire message, to the output array.</li>
        <li>a <b>key/value object</b> - created by using a property of each message to determine the key under which
        the required value is stored.</li>
        <li>a <b>merged object</b> - created by merging the property of each message under a single object.</li>
    </ul>
    <p>The other properties of the output message are taken from the last message received before the result is sent.</p>
    <p>A <i>count</i> can be set for how many messages should be received before generating the output message.
    For object outputs, once this count has been reached, the node can be configured to send a message for each subsequent message
    received.</p>
    <p>A <i>timeout</i> can be set to trigger sending the new message using whatever has been received so far.
     This timeout can be restarted by sending a message with the <code>msg.restartTimeout</code> property set.</p>
    <p>If a message is received with the <code>msg.complete</code> property set, the output message is finalised and sent.
    This resets any part counts.</p>
    <p>If a message is received with the <code>msg.reset</code> property set, the partly complete message is deleted and not sent.
    This resets any part counts.</p>

    <h4>Reduce Sequence mode</h4>
    <p>When configured to join in reduce mode, an expression is applied to each
       message in a sequence and the result accumulated to produce a single message.</p>

    <dl class="message-properties">
        <dt>Initial value</dt>
        <dd>The initial value of the accumulated value (<code>$A</code>).</dd>
        <dt>Reduce expression</dt>
        <dd>A JSONata expression that is called for each message in the sequence.
            The result is passed to the next call of the expression as the accumulated value.
            In the expression, the following special variables can be used:
            <ul>
                <li><code>$A</code>: the accumulated value, </li>
                <li><code>$I</code>: index of the message in the sequence, </li>
                <li><code>$N</code>: number of messages in the sequence.</li>
            </ul>
        </dd>
        <dt>Fix-up expression</dt>
        <dd>An optional JSONata expression that is applied after the reduce expression
            has been applied to all messages in the sequence.
            In the expression, following special variables can be used:
            <ul>
                <li><code>$A</code>: the accumulated value, </li>
                <li><code>$N</code>: number of messages in the sequence.</li>
            </ul>
        </dd>
        <p>By default, the reduce expression is applied in order, from the first
           to the last message of the sequence. It can optionally be applied in
           reverse order.</p>
        <p>$N is the number of messages that arrive - even if they are identical.</p>
    </dl>
    <p><b>Example:</b> the following settings, given a sequence of numeric values,
       calculates the average value:
        <ul>
            <li><b>Reduce expression</b>: <code>$A+payload</code></li>
            <li><b>Initial value</b>: <code>0</code></li>
            <li><b>Fix-up expression</b>: <code>$A/$N</code></li>
        </ul>
    </p>
    <h4>Storing messages</h4>
    <p>This node will buffer messages internally in order to work across sequences. The
       runtime setting <code>nodeMessageBufferMaxLength</code> can be used to limit how many messages nodes
       will buffer.</p>
</script>

<!-- --- [red-module:node-red/sort] --- -->
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-template-name="sort">

    <div class="form-row">
        <label for="node-input-target"><i class="fa fa-dot-circle-o"></i> <span data-i18n="sort.target"></span></label>
        <input type="text" id="node-input-target" style="width:70%;">
        <input type="hidden" id="node-input-targetType">
    </div>

    <div class="node-row-sort-msg-key">
        <div class="form-row">
            <label for="node-input-msgKey"><i class="fa fa-filter"></i> <span data-i18n="sort.key"></span></label>
            <input type="text" id="node-input-msgKey" style="width:70%;">
            <input type="hidden" id="node-input-msgKeyType">
        </div>
    </div>

    <div class="node-row-sort-seq-key">
        <div class="form-row">
            <label for="node-input-seqKey"><i class="fa fa-filter"></i> <span data-i18n="sort.key"></span></label>
            <input type="text" id="node-input-seqKey" style="width:70%;">
            <input type="hidden" id="node-input-seqKeyType">
        </div>
    </div>

    <div class="form-row">
        <label><i class="fa fa-random"></i>  <span data-i18n="sort.order"></span></label>
        <select id="node-input-order" style="width:200px;">
            <option value="ascending" data-i18n="sort.ascending"></option>
            <option value="descending" data-i18n="sort.descending"></option>
        </select>
    </div>

    <div class="form-row" id="node-as_num">
        <label>&nbsp;</label>
        <input type="checkbox" id="node-input-as_num" style="display: inline-block; width: auto; vertical-align: top;">
        <label for="node-input-as_num" style="width: 70%;" data-i18n="sort.as-number"></label>
    </div>

    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name">
    </div>
</script>

<script type="text/javascript">
    RED.nodes.registerType('sort',{
        category: 'sequence',
        color:"#E2D96E",
        defaults: {
            name: { value:"" },
            order: { value:"ascending" },
            as_num: { value:false },
            target: { value:"payload" },
            targetType: { value:"msg" },
            msgKey: { value:"payload" },
            msgKeyType: { value:"elem" },
            seqKey: { value:"payload" },
            seqKeyType: { value:"msg" }
        },
        inputs:1,
        outputs:1,
        icon: "sort.svg",
        label: function() {
            return this.name||this._("sort.sort");
        },
        labelStyle: function() {
            return this.name ? "node_label_italic" : "";
        },
        oneditprepare: function() {
            var seq = {
                value: "seq",
                label: RED._("node-red:sort.seq"),
                hasValue: false
            };
            var elem = {
                value: "elem",
                label: RED._("node-red:sort.elem"),
                hasValue: false
            };
            $("#node-input-target").typedInput({
                default:'msg',
                typeField: $("#node-input-targetType"),
                types:['msg', seq]
            });
            $("#node-input-msgKey").typedInput({
                default:'elem',
                typeField: $("#node-input-msgKeyType"),
                types:[elem, 'jsonata']
            });
            $("#node-input-seqKey").typedInput({
                default:'msg',
                typeField: $("#node-input-seqKeyType"),
                types:['msg', 'jsonata']
            });
            $("#node-input-target").on("change", function(e) {
                var val = $("#node-input-target").typedInput('type');
                $(".node-row-sort-msg-key").toggle(val === "msg");
                $(".node-row-sort-seq-key").toggle(val === "seq");
            });
            $("#node-input-target").change();
        }
    });
</script>
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-help-name="sort">
    <p>A function that sorts message property or a sequence of messages.</p>
    <p>When configured to sort message property, the node sorts array data pointed to by specified message property.</p>
    <p>When configured to sort a sequence of messages, it will reorder the messages.</p>
    <p>The sorting order can be:</p>
    <ul>
        <li><b>ascending</b>,</li>
        <li><b>descending</b>.</li>
    </ul>
    <p>For numbers, numerical ordering can be specified by a checkbox.</p>
    <p>Sort key can be element value or JSONata expression for sorting property value, or message property or JSONata expression for sorting a message sequence.<p>
    <p>When sorting a message sequence, the sort node relies on the received messages to have <code>msg.parts</code> set.  The split node generates this property, but can be manually created.  It has the following properties:</p>
    <p>
        <ul>
            <li><code>id</code> - an identifier for the group of messages</li>
            <li><code>index</code> - the position within the group</li>
            <li><code>count</code> - the total number of messages in the group</li>
        </ul>
    </p>
    <p><b>Note:</b> This node internally keeps messages for its operation.  In order to prevent unexpected memory usage, maximum number of messages kept can be specified.  Default is no limit on number of messages.
        <ul>
            <li><code>nodeMessageBufferMaxLength</code> property set in <b>settings.js</b>.</li>
        </ul>
    </p>
</script>

<!-- --- [red-module:node-red/batch] --- -->
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-template-name="batch">
    <div class="form-row">
        <label for="node-input-mode"><span data-i18n="batch.mode.label"></span></label>
        <select type="text" id="node-input-mode" style="width: 300px;">
            <option value="count" data-i18n="batch.mode.num-msgs"></option>
            <option value="interval" data-i18n="batch.mode.interval"></option>
            <option value="concat" data-i18n="batch.mode.concat"></option>
        </select>
    </div>

    <div class="node-row-msg-count">
        <div class="form-row node-row-count">
            <label style="margin-left: 10px; width: 175px;" for="node-input-count" data-i18n="batch.count.label"></label>
            <input type="text" id="node-input-count" style="width: 50px;">
        </div>
    </div>

    <div class="node-row-msg-overlap">
        <div class="form-row node-row-overlap">
            <label style="margin-left: 10px; width: 175px;" for="node-input-overlap" data-i18n="batch.count.overlap"></label>
            <input type="text" id="node-input-overlap" style="width: 50px;">
        </div>
        <div class="form-row">
            <input type="checkbox" id="node-input-honourParts" style="margin-left: 10px; margin-right:10px; vertical-align:top; width:auto;">
            <label for="node-input-honourParts" style="width:auto;" data-i18n="batch.honourParts"></label>
        </div>
    </div>

    <div class="node-row-msg-interval">
        <div class="form-row node-row-interval">
            <label style="margin-left: 10px; width: 175px;" for="node-input-interval"> <span data-i18n="batch.interval.label"></span></label>
            <input type="text" id="node-input-interval" style="width: 50px;">
            <span data-i18n="batch.interval.seconds"></span>
        </div>
        <div class="form-row">
            <input type="checkbox" id="node-input-allowEmptySequence" style="margin-left:20px; margin-right:10px; vertical-align:top; width:auto;">
            <label for="node-input-allowEmptySequence" style="width:auto;" data-i18n="batch.interval.empty"></label>
        </div>
    </div>

    <div class="node-row-msg-concat">
        <div class="form-row">
            <label data-i18n="batch.concat.topics-label"></label>
            <div class="form-row node-input-topics-container-row">
                <ol id="node-input-topics-container"></ol>
            </div>
        </div>
    </div>

    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name">
    </div>

</script>

<script type="text/javascript">
    RED.nodes.registerType("batch",{
        category: "sequence",
        color:"#E2D96E",
        defaults: {
            name: {value:""},
            mode: {value:"count"},
            count: {
                value:10,
                validate:function(v, opt) {
                    if (RED.validators.number(v) && (v >= 1)) {
                        return true;
                    }
                    return RED._("node-red:batch.error.invalid-count");
                }
            },
            overlap: {
                value:0,
                validate:function(v, opt) {
                    if (RED.validators.number(v) && (v >= 0)) {
                        return true;
                    }
                    return RED._("node-red:batch.error.invalid-overlap");
                }
            },
            interval: {
                value:10,
                validate:function(v, opt) {
                    if (RED.validators.number(v) && (v >= 1)) {
                        return true;
                    }
                    return RED._("node-red:batch.error.invalid-interval");
                }
            },
            allowEmptySequence: {value:false},
            honourParts: {value:false},
            topics: {value:[{topic:""}]}
        },
        inputs:1,
        outputs:1,
        icon: "batch.svg",
        label: function() {
            var nam = this.name||this._("batch.batch");
            if (this.mode === "count" && !isNaN(Number(this.count))) {
                nam += " "+this.count;
            }
            if (this.mode === "interval" && !isNaN(Number(this.interval))) {
                nam += " "+this.interval+"s";
            }
            return nam;
        },
        labelStyle: function() {
            return this.name ? "node_label_italic" : "";
        },
        oneditprepare: function() {
            var node = this;
            var topic_str = node._("batch.concat.topic");

            function resizeTopics(topic) {
                var newWidth = topic.width();
                topic.find('.red-ui-typedInput')
                     .typedInput("width",newWidth-15);
            }

            $("#node-input-topics-container")
                .css('min-height','150px').css('min-width','430px')
                .editableList({
                    addItem: function(container, i, opt) {
                        if (!opt.hasOwnProperty('topic')) {
                            opt.topic = "";
                        }
                        var row = $('<div/>').appendTo(container);
                        var valueField = $('<input/>',{
                            class:"node-input-topic-value",
                            type:"text",
                            style:"margin-left: 5px;"
                        }).appendTo(row)
                        .typedInput({default:'str', types:['str']});
                        valueField.typedInput('value', opt.topic);
                        valueField.typedInput('type', 'str');
                        valueField.attr('placeholder', topic_str);
                        resizeTopics(container);
                    },
                    resizeItem: resizeTopics,
                    sortable: true,
                    removable: true
                });

            $("#node-input-count").spinner({min:1});
            $("#node-input-overlap").spinner({min:0});
            $("#node-input-interval").spinner({min:1});
            $("#node-input-mode").on("change", function(e) {
                var val = $(this).val();
                $(".node-row-msg-count").toggle(val==="count");
                $(".node-row-msg-overlap").toggle(val==="count");
                $(".node-row-msg-interval").toggle(val==="interval");
                $(".node-row-msg-concat").toggle(val==="concat");
                if (val==="concat") {
                    var topics = node.topics;
                    var container = $("#node-input-topics-container");
                    container.editableList('empty');
                    for (var i = 0; i < topics.length; i++) {
                        var topic = topics[i];
                        container.editableList('addItem', topic);
                    }
                }
            });
        },
        oneditsave: function() {
            var topics = $("#node-input-topics-container").editableList('items');
            var node = this;
            node.topics = [];
            topics.each(function(i) {
                var topicData = $(this).data('data');
                var topic = $(this);
                var vf = topic.find(".node-input-topic-value");
                var value = vf.typedInput('value');
                var type = vf.typedInput('type');
                var r = {topic:value};
                node.topics.push(r);
            });
        },
        oneditresize: function(size) {
            var rows = $("#dialog-form>div:not(.node-input-topics-container-row)");
            var height = size.height;
            for (var i = 0; i < rows.length; i++) {
                height -= $(rows[i]).outerHeight(true);
            }
            var editorRow = $("#dialog-form>div.node-input-topics-container-row");
            height -= (parseInt(editorRow.css("marginTop"))+parseInt(editorRow.css("marginBottom")));
            $("#node-input-topics-container").editableList('height',height);
        }
    });
</script>
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-help-name="batch">
    <p>Creates sequences of messages based on various rules.</p>
    <h3>Details</h3>
    <p>There are three modes for creating message sequences:</p>
    <dl>
        <dt>Number of messages</dt>
        <dd>groups messages into sequences of a given length. The <b>overlap</b>
        option specifies how many messages at the end of one sequence should be
        repeated at the start of the next sequence.</dd>

        <dt>Time interval</dt>
        <dd>groups messages that arrive within the specified interval. If no messages
            arrive within the interval, the node can optionally send on an empty message.</dd>

        <dt>Concatenate Sequences</dt>
        <dd>creates a message sequence by concatenating incoming sequences. Each message
            must have a <code>msg.topic</code> property and a <code>msg.parts</code> property
            identifying its sequence. The node is configured with a list of <code>topic</code>
            values to identify the order sequences are concatenated.
        </dd>
    </dl>
    <h4>Storing messages</h4>
    <p>This node will buffer messages internally in order to work across sequences. The
       runtime setting <code>nodeMessageBufferMaxLength</code> can be used to limit how many messages nodes
       will buffer.</p>
    <p>If a message is received with the <code>msg.reset</code> property set, the buffered messages are deleted and not sent.</p>
</script>

<!-- --- [red-module:node-red/file] --- -->

<script type="text/html" data-template-name="file">
    <div class="form-row node-input-filename">
         <label for="node-input-filename"><i class="fa fa-file"></i> <span data-i18n="file.label.filename"></span></label>
         <input id="node-input-filename" type="text">
         <input type="hidden" id="node-input-filenameType">
    </div>
    <div class="form-row">
        <label for="node-input-overwriteFile"><i class="fa fa-random"></i> <span data-i18n="file.label.action"></span></label>
        <select type="text" id="node-input-overwriteFile" style="width: 250px;">
            <option value="false" data-i18n="file.action.append"></option>
            <option value="true" data-i18n="file.action.overwrite"></option>
            <option value="delete" data-i18n="file.action.delete"></option>
        </select>
    </div>
    <div class="form-row form-row-file-write-options">
        <label>&nbsp;</label>
        <input type="checkbox" id="node-input-appendNewline" style="display: inline-block; width: auto; vertical-align: top;">
        <label for="node-input-appendNewline" style="width: 70%;"><span data-i18n="file.label.addnewline"></span></label>
    </div>
    <div class="form-row form-row-file-write-options">
        <label>&nbsp;</label>
        <input type="checkbox" id="node-input-createDir" style="display: inline-block; width: auto; vertical-align: top;">
        <label for="node-input-createDir" style="width: 70%;"><span data-i18n="file.label.createdir"></span></label>
    </div>
    <div class="form-row form-row-file-encoding">
        <label for="node-input-encoding"><i class="fa fa-flag"></i> <span data-i18n="file.label.encoding"></span></label>
        <select type="text" id="node-input-encoding" style="width: 250px;">
        </select>
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name">
    </div>
    <div class="form-tips"><span data-i18n="file.tip"></span></div>
</script>

<script type="text/html" data-template-name="file in">
    <div class="form-row">
         <label for="node-input-filename"><i class="fa fa-file"></i> <span data-i18n="file.label.filename"></span></label>
         <input id="node-input-filename" type="text">
         <input type="hidden" id="node-input-filenameType">
    </div>
    <div class="form-row">
        <label for="node-input-format"><i class="fa fa-sign-out"></i> <span data-i18n="file.label.outputas"></span></label>
        <select id="node-input-format" style="width: 250px;">
            <option value="utf8" data-i18n="file.output.utf8"></option>
            <option value="lines" data-i18n="file.output.lines"></option>
            <option value="" data-i18n="file.output.buffer"></option>
            <option value="stream" data-i18n="file.output.stream"></option>
        </select>
    </div>
    <div class="form-row" id="file-allprops">
        <label>&nbsp;</label>
        <input type="checkbox" id="node-input-allProps" style="display:inline-block; width:auto; vertical-align:top;">
        <label for="node-input-allProps" style="width: 70%;"><span data-i18n="file.label.allProps"></span></label>
    </div>
    <div class="form-row" id="encoding-spec">
        <label for="node-input-encoding"><i class="fa fa-flag"></i> <span data-i18n="file.label.encoding"></span></label>
        <select type="text" id="node-input-encoding" style="width:250px;">
        </select>
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name">
    </div>
    <div class="form-tips"><span data-i18n="file.tip"></span></div>
</script>

<script type="text/javascript">
(function(){
    var encodings = [
        [ "file.encoding.native",
          "utf8",
          "ucs2",
          "utf-16le",
          "ascii",
          "binary",
          "base64",
          "hex"
        ],
        [ "file.encoding.unicode",
          "utf-16be",
        ],
        [ "file.encoding.japanese",
          "Shift_JIS",
          "Windows-31j",
          "Windows932",
          "EUC-JP"
        ],
        [ "file.encoding.chinese",
          "GB2312",
          "GBK",
          "GB18030",
          "Windows936",
          "EUC-CN"
        ],
        [ "file.encoding.korean",
          "KS_C_5601",
          "Windows949",
          "EUC-KR"
        ],
        [ "file.encoding.taiwan",
          "Big5",
          "Big5-HKSCS",
          "Windows950"
        ],
        [ "file.encoding.windows",
          "cp874",
          "cp1250",
          "cp1251",
          "cp1252",
          "cp1253",
          "cp1254",
          "cp1255",
          "cp1256",
          "cp1257",
          "cp1258"
        ],
        [ "file.encoding.iso",
          "ISO-8859-1",
          "ISO-8859-2",
          "ISO-8859-3",
          "ISO-8859-4",
          "ISO-8859-5",
          "ISO-8859-6",
          "ISO-8859-7",
          "ISO-8859-8",
          "ISO-8859-9",
          "ISO-8859-10",
          "ISO-8859-11",
          "ISO-8859-12",
          "ISO-8859-13",
          "ISO-8859-14",
          "ISO-8859-15",
          "ISO-8859-16"
        ],
        [ "file.encoding.ibm",
          "cp437",
          "cp737",
          "cp775",
          "cp808",
          "cp850",
          "cp852",
          "cp855",
          "cp856",
          "cp857",
          "cp858",
          "cp860",
          "cp861",
          "cp866",
          "cp869",
          "cp922",
          "cp1046",
          "cp1124",
          "cp1125",
          "cp1129",
          "cp1133",
          "cp1161",
          "cp1162",
          "cp1163"
        ],
        [ "file.encoding.mac",
          "maccroatian",
          "maccyrillic",
          "macgreek",
          "maciceland",
          "macroman",
          "macromania",
          "macthai",
          "macturkish",
          "macukraine",
          "maccenteuro",
          "macintosh"
        ],
        [ "file.encoding.koi8",
          "koi8-r",
          "koi8-u",
          "koi8-ru",
          "koi8-t"
        ],
        [ "file.encoding.misc",
          "armscii8",
          "rk1048",
          "tcvn",
          "georgianacademy",
          "georgianps",
          "pt154",
          "viscii",
          "iso646cn",
          "iso646jp",
          "hproman8",
          "tis620"
        ]
    ];

    RED.nodes.registerType('file',{
        category: 'storage',
        defaults: {
            name: {value:""},
            filename: {value:"", validate: RED.validators.typedInput({ typeField: 'filenameType' })},
            filenameType: {value:"str"},
            appendNewline: {value:true},
            createDir: {value:false},
            overwriteFile: {value:"false"},
            encoding: {value:"none"}
        },
        color:"BurlyWood",
        inputs:1,
        outputs:1,
        icon: "file-out.svg",
        label: function() {
            var fn = this.filename;
            if(this.filenameType != "str" && this.filenameType != "env" ) { fn = ""; }
            if(this.filenameType === "env") { fn = "env."+fn; }
            if (this.overwriteFile === "delete") {
                return this.name||this._("file.label.deletelabel",{file:fn});
            } else {
                return this.name||fn||this._("file.label.write");
            }
        },
        paletteLabel: RED._("node-red:file.label.write"),
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        oneditprepare: function() {
            var node = this;
            var encSel = $("#node-input-encoding");
            var label = node._("file.encoding.none");
            $("<option/>", {
                value: "none",
                label: label
            }).text(label).appendTo(encSel);
            $("<option/>", {
                value: "setbymsg",
                label: node._("file.encoding.setbymsg")
            }).text(label).appendTo(encSel);
            $("#node-input-filename").typedInput({
                default: "str",
                types: [{label:RED._("node-red:file.label.path"), value:"str", icon:""}, "msg", "jsonata", "env"],
                typeField: $("#node-input-filenameType")
            });
            if(typeof node.filenameType == 'undefined') {
                //existing node AND filenameType is not set - inplace (compatible) upgrade to new typedInput
                if(node.filename == "") { //was using empty value to denote msg.filename - set typedInput to match
                    node.filename = "filename";
                    node.filenameType = "msg";
                    $("#node-input-filename").typedInput("type", node.filenameType);
                    $("#node-input-filename").typedInput("value", node.filename);
                } else if(/^\${[^}]+}$/.test(node.filename)) { //was using an ${ENV_VAR}
                    node.filenameType = "env";
                    node.filename = node.filename.replace(/\${([^}]+)}/g, function(match, name) {
                        return (name === undefined)?"":name;
                    });
                    $("#node-input-filename").typedInput("type", node.filenameType);
                    $("#node-input-filename").typedInput("value", node.filename);
                } else { //was using a static filename - set typedInput type to str
                    node.filenameType = "str";
                    $("#node-input-filename").typedInput("type", node.filenameType);
                    $("#node-input-filename").typedInput("value", node.filename);
                }
            }
            encodings.forEach(function(item) {
                if(Array.isArray(item)) {
                    var group = $("<optgroup/>", {
                        label: node._(item[0])
                    }).appendTo(encSel);
                    for (var i = 1; i < item.length; i++) {
                        var enc = item[i];
                        $("<option/>", {
                            value: enc,
                            label: enc
                        }).text(enc).appendTo(group);
                    }
                }
                else {
                    $("<option/>", {
                        value: item,
                        label: item
                    }).text(item).appendTo(encSel);
                }
            });
            encSel.val(node.encoding);
            $("#node-input-overwriteFile").on("change",function() {
                if (this.value === "delete") {
                    $(".form-row-file-write-options").hide();
                    $(".form-row-file-encoding").hide();
                } else {
                    $(".form-row-file-write-options").show();
                    $(".form-row-file-encoding").show();
                }
            });
        }
    });

    RED.nodes.registerType('file in',{
        category: 'storage',
        defaults: {
            name: {value:""},
            filename: {value:"", validate: RED.validators.typedInput({ typeField: 'filenameType' }) },
            filenameType: {value:"str"},
            format: {value:"utf8"},
            chunk: {value:false},
            sendError: {value: false},
            encoding: {value: "none"},
            allProps: {value: false}
        },
        color:"BurlyWood",
        inputs:1,
        outputs:1,
        outputLabels: function(i) {
            var l;
            if (this.format === "utf8") {
                l = "file.label.utf8String";
            } else if (this.format === "lines") {
                l = "file.label.utf8String_plural";
            } else if (this.format === "stream") {
                l = "file.label.binaryBuffer_plural";
            } else {
                l = "file.label.binaryBuffer";
            }
            return this._(l);
        },
        icon: "file-in.svg",
        label: function() {
            var fn = this.filename;
            if(this.filenameType != "str" && this.filenameType != "env" ) { fn = ""; }
            if(this.filenameType === "env") { fn = "env."+fn; }
            return this.name||fn||this._("file.label.read");
        },
        paletteLabel: RED._("node-red:file.label.read"),
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        oneditprepare: function() {
            var node = this;
            var encSel = $("#node-input-encoding");
            var label = node._("file.encoding.none");
            $("<option/>", {
                value: "none",
                label: label
            }).text(label).appendTo(encSel);
            $("#node-input-filename").typedInput({
                default: "str",
                types: [{label:RED._("node-red:file.label.path"), value:"str", icon:""}, "msg", "jsonata", "env"],
                typeField: $("#node-input-filenameType")
            });
            if(typeof node.filenameType == 'undefined') {
                //existing node AND filenameType is not set - inplace (compatible) upgrade to new typedInput
                if(node.filename == "") { //was using empty value to denote msg.filename - set typedInput to match
                    node.filename = "filename";
                    node.filenameType = "msg";
                    $("#node-input-filename").typedInput("type", node.filenameType);
                    $("#node-input-filename").typedInput("value", node.filename);
                } else if(/^\${[^}]+}$/.test(node.filename)) { //was using an ${ENV_VAR}
                    node.filenameType = "env";
                    node.filename = node.filename.replace(/\${([^}]+)}/g, function(match, name) {
                        return (name === undefined)?"":name;
                    });
                    $("#node-input-filename").typedInput("type", node.filenameType);
                    $("#node-input-filename").typedInput("value", node.filename);
                } else { //was using a static filename - set typedInput type to str
                    node.filenameType = "str";
                    $("#node-input-filename").typedInput("type", node.filenameType);
                    $("#node-input-filename").typedInput("value", node.filename);
                }
            }
            encodings.forEach(function(item) {
                if(Array.isArray(item)) {
                    var group = $("<optgroup/>", {
                        label: node._(item[0])
                    }).appendTo(encSel);
                    for (var i = 1; i < item.length; i++) {
                        var enc = item[i];
                        $("<option/>", {
                            value: enc,
                            label: enc
                        }).text(enc).appendTo(group);
                    }
                }
                else {
                    $("<option/>", {
                        value: item,
                        label: item
                    }).text(item).appendTo(encSel);
                }
            });
            encSel.val(node.encoding);
            $("#node-input-format").on("change",function() {
                var format = $("#node-input-format").val();
                if ((format === "utf8") || (format === "lines")) {
                    $("#encoding-spec").show();
                }
                else {
                    $("#encoding-spec").hide();
                }
                if ((format === "lines") || (format === "stream")) {
                    $("#file-allprops").show();
                }
                else {
                    $("#file-allprops").hide();
                }
            });
        }
    });
})();
</script>
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-help-name="file">
    <p>Writes <code>msg.payload</code> to a file, either adding to the end or replacing the existing content.
       Alternatively, it can delete the file.</p>
    <h3>Inputs</h3>
    <dl class="message-properties">
        <dt class="optional">filename <span class="property-type">string</span></dt>
        <dd>The name of the file to be updated can be provided in the node configuration, or as a message property.
            By default it will use <code>msg.filename</code> but this can be customised in the node.
        </dd>
        <dt class="optional">encoding <span class="property-type">string</span></dt>
        <dd>If encoding is configured to be set by msg, then this optional property can set the encoding.</dt>
    </dl>
    <h3>Output</h3>
    <p>On completion of write, input message is sent to output port.</p>
    <h3>Details</h3>
    <p>Each message payload will be added to the end of the file, optionally appending
    a newline (\n) character between each one.</p>
    <p>If <code>msg.filename</code> is used the file will be closed after every write.
    For best performance use a fixed filename.</p>
    <p>It can be configured to overwrite the entire file rather than append. For example,
    when writing binary data to a file, such as an image, this option should be used
    and the option to append a newline should be disabled.</p>
    <p>Encoding of data written to a file can be specified from list of encodings.</p>
    <p>Alternatively, this node can be configured to delete the file.</p>
</script>

<script type="text/html" data-help-name="file in">
    <p>Reads the contents of a file as either a string or binary buffer.</p>
    <h3>Inputs</h3>
    <dl class="message-properties">
        <dt class="optional">filename <span class="property-type">string</span></dt>
        <dd>The name of the file to be read can be provided in the node configuration, or as a message property.
            By default it will use <code>msg.filename</code> but this can be customised in the node.
        </dd>
    </dl>
    <h3>Outputs</h3>
    <dl class="message-properties">
        <dt>payload <span class="property-type">string | buffer</span></dt>
        <dd>The contents of the file as either a string or binary buffer.</dd>
        <dt class="optional">filename <span class="property-type">string</span></dt>
        <dd>If not configured in the node, this optional property sets the name of the file to be read.</dd>
    </dl>
    <h3>Details</h3>
    <p>The filename should be an absolute path, otherwise it will be relative to
    the working directory of the Node-RED process.</p>
    <p>On Windows, path separators may need to be escaped, for example: <code>\\Users\\myUser</code>.</p>
    <p>Optionally, a text file can be split into lines, outputting one message per line, or a binary file
    split into smaller buffer chunks - the chunk size being operating system dependant, but typically 64k (Linux/Mac) or 41k (Windows).</p>
    <p>When split into multiple messages, each message will have a <code>parts</code>
    property set, forming a complete message sequence.</p>
    <p>Encoding of input data can be specified from list of encodings if output format is string.</p>
    <p>Errors should be caught and handled using a Catch node.</p>
</script>

<!-- --- [red-module:node-red/watch] --- -->
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-template-name="watch">
    <div class="form-row node-input-filename">
         <label for="node-input-files"><i class="fa fa-file"></i> <span data-i18n="watch.label.files"></span></label>
         <input id="node-input-files" type="text" tabindex="1" data-i18n="[placeholder]watch.placeholder.files">
    </div>
    <div class="form-row">
        <label>&nbsp;</label>
        <input type="checkbox" id="node-input-recursive" style="display:inline-block; width:auto; vertical-align:top;">
        <label for="node-input-recursive" style="width:70%;"> <span data-i18n="watch.label.recursive"></span></label>
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name">
    </div>
     <div id="node-input-tip" class="form-tips"><span data-i18n="watch.tip"></span></div>
</script>

<script type="text/javascript">
    RED.nodes.registerType('watch',{
        category: 'storage',
        defaults: {
            name: {value:""},
            files: {value:"",required:true,
                    label:RED._("node-red:watch.label.files")},
            recursive: {value:""}
        },
        color:"BurlyWood",
        inputs:0,
        outputs:1,
        icon: "watch.svg",
        label: function() {
            return this.name||this.files||this._("watch.watch");
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        }
    });
</script>
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-help-name="watch">
    <p>Watches a directory or file for changes.</p>
    <p>You can enter a list of comma separated directories and/or files. You will
    need to put quotes "..." around any that have spaces in.</p>
    <p>On Windows you must use double back-slashes \\ in any directory names.</p>
    <p>The full filename of the file that actually changed is put into <code>msg.payload</code> and <code>msg.filename</code>,
    while a stringified version of the watch list is returned in <code>msg.topic</code>.</p>
    <p><code>msg.file</code> contains just the short filename of the file that changed.
    <code>msg.type</code> has the type of thing changed, usually <i>file</i> or <i>directory</i>,
    while <code>msg.size</code> holds the file size in bytes.</p>
    <p>Of course in Linux, <i>everything</i> is a file and thus can be watched...</p>
    <p><b>Note: </b>The directory or file must exist in order to be watched. If the file
    or directory gets deleted it may no longer be monitored even if it gets re-created.</p>
</script>

<!-- --- [red-module:@gorenje/node-red-contrib-flowcompare/flowcompare] --- -->
<script type="text/javascript">
(function ($) {
   RED.nodes.registerType('FlowCompareCfg', {
      category: 'config',
      hasUsers: false,
      defaults: {
         name: { value: "" },
         data: { value: "" }
      },
      paletteLabel: 'FlowCompareCfg',
      label: function () {
         return this.name;
      }
  });
})(jQuery);
</script>

<!-- The html for the config node info panel (in right sidebar) -->
<script type="text/x-red" data-template-name="FlowCompareCfg">
   <p>Visually compare local flow with flow deployed on the server.</p>
   Visual comparison of flows being edited and flow that has been deployed.
</script>

<!-- --- [red-module:@gregoriusrippenstein/erlang-red-supervisor-node/erlsupervisor] --- -->
<script type="text/javascript">
  (function(){

  RED.nodes.registerType('erlsupervisor',{
    color: '#E9967A',
    icon: "font-awesome/fa-ambulance",
    category: 'behaviour',
    paletteLabel: 'Supervisor',

    defaults: {
      name: {
        value:"",
      },

      scope: { value: "flow", type: "*[]" },

      supervisor_type: { value: "static" },
      strategy: { value: "one_for_one" },
      auto_shutdown: { value: "never" },
      intensity: { value: "1" },
      period: { value: "5" },

      child_type: { value: "worker" },
      child_restart: { value: "permanent" },
      child_shutdown: { value: "infinite" },
      child_shutdown_timeout: { value: "0" }
    },

    inputs: 1,

    outputs: 1,

    label: function() {
        if (this.name) {
            return this.name;
        }
        if (this.scope === "group") {
            return this._("erlsupervisor.superviseGroup");
        } else if (Array.isArray(this.scope)) {
            return this._("erlsupervisor.nodeCount",{number:this.scope.length});
        }
        return this._("erlsupervisor.superviseFlow")
    },

    labelStyle: function() {
      return this.name?"node_label_italic":"";
    },

    onpaletteadd: function() {
    },

    onpaletteremove: function() {
    },

    oneditprepare: function() {
      var node = this;

      var tabs = RED.tabs.create({
        id: "erlsupervisor-tabs",
        onchange: function (tab) {
          $("#erlsupervisor-tabs-content").children().hide();
          $("#" + tab.id).show();
        }
      });

      tabs.addTab({
        id: "erlsupervisor-tab-supervisor-config",
        iconClass: "fa fa-cog",
        label: node._("erlsupervisor.label.tab.supervisor_config")
      });

      tabs.addTab({
        id: "erlsupervisor-tab-child-config",
        iconClass: "fa fa-child",
        label: node._("erlsupervisor.label.tab.child_config")
      });

      tabs.activateTab("erlsupervisor-tab-supervisor-config");

      var scope = node.scope || [];

      this._resize = function () {
        var rows = $("#dialog-form>div:not(.node-input-target-list-row)");
        var height = $("#dialog-form").height();
        for (var i = 0; i < rows.length; i++) {
          height -= $(rows[i]).outerHeight(true);
        }
        var editorRow = $("#dialog-form>div.node-input-target-list-row");
        editorRow.css("height", height + "px");
      };
      var search = $("#node-input-erlsupervisor-target-filter").searchBox({
        style: "compact",
        delay: 300,
        change: function () {
          var val = $(this).val().trim().toLowerCase();
          if (val === "") {
            dirList.treeList("filter", null);
            search.searchBox("count", "");
          } else {
            var count = dirList.treeList("filter", function (item) {
              return item.label.toLowerCase().indexOf(val) > -1 || item.node.type.toLowerCase().indexOf(val) > -1
            });
            search.searchBox("count", count + " / " + candidateNodes.length);
          }
        }
      });

      /*
        sortable is a hidden feature of treeList --> https://github.com/node-red/node-red/blob/master/packages/node_modules/%40node-red/editor-client/src/js/ui/common/treeList.js --> which is a feature of editableList ==> https://github.com/node-red/node-red/blob/master/packages/node_modules/%40node-red/editor-client/src/js/ui/common/editableList.js
       */
      var dirList = $("#node-input-erlsupervisor-target-container-div").css({
          width: "100%",
          height: "100%"
        }).treeList({
          multi: true,
          sortable: true
        }).on("treelistitemmouseover", function (e, item) {
          item.node.highlighted = true;
          item.node.dirty = true;
          RED.view.redraw();
        }).on("treelistitemmouseout", function (e, item) {
          item.node.highlighted = false;
          item.node.dirty = true;
          RED.view.redraw();
        })

      var candidateNodes = RED.nodes.filterNodes({ z: node.z });
      var items = [];
      var scopedItems = [];
      var nodeItemMap = {};

      candidateNodes.forEach(function (n) {
        if (n.id === node.id || n.type === "erlmodule") {
          return;
        }
        var isChecked = scope.indexOf(n.id) !== -1;

        var nodeDef = RED.nodes.getType(n.type);
        var label;
        var sublabel;
        if (nodeDef) {
          var l = nodeDef.label;
          label = (typeof l === "function" ? l.call(n) : l) || "";
          sublabel = n.type;
          if (sublabel.indexOf("subflow:") === 0) {
            var subflowId = sublabel.substring(8);
            var subflow = RED.nodes.subflow(subflowId);
            sublabel = "subflow : " + subflow.name;
          }
        }
        if (!nodeDef || !label) {
          label = n.type;
        }

        nodeItemMap[n.id] = {
          node: n,
          id: n.id,
          label: label,
          sublabel: sublabel,
          selected: isChecked,
          checkbox: true
        };

        if ( isChecked ) {
          scopedItems.push(nodeItemMap[n.id]);
        } else {
          items.push(nodeItemMap[n.id]);
        }
      });

      scopedItems.sort( (a,b) => { return scope.indexOf(a.id) < scope.indexOf(b.id) ? -1 : 1})

      dirList.treeList('data', [...scopedItems, ...items]);

      $("#node-input-erlsupervisor-target-select").on("click", function (e) {
        e.preventDefault();
        var preselected = dirList.treeList('selected').map(function (n) { return n.node.id });
        RED.tray.hide();
        RED.view.selectNodes({
          selected: preselected,
          onselect: function (selection) {
            RED.tray.show();
            var newlySelected = {};
            selection.forEach(function (n) {
              newlySelected[n.id] = true;
              if (nodeItemMap[n.id]) {
                nodeItemMap[n.id].treeList.select(true);
              }
            })
            preselected.forEach(function (id) {
              if (!newlySelected[id]) {
                nodeItemMap[id].treeList.select(false);
              }
            })
          },
          oncancel: function () {
            RED.tray.show();
          },
          filter: function (n) {
            return n.id !== node.id && n.type != "erlmodule";
          }
        });
      })

      $("#node-input-scope-select").on("change", function (e) {
        var scope = $(this).val();
        if (scope === "target") {
          $(".node-input-target-row").show();
        } else {
          $(".node-input-target-row").hide();
        }
        node._resize();
      });

      $("#node-input-child_shutdown").on("change", function (e) {
        var sdown = $(this).val();
        if (sdown === "timeout") {
          $("#node-input-child_shutdown_timeout").show();
        } else {
          $("#node-input-child_shutdown_timeout").hide();
        }
      });
      $("#node-input-child_shutdown").trigger('change')

      if (this.scope === null || this.scope === "flow") {
        $("#node-input-scope-select").val("flow");
      } else if (this.scope === "group") {
        $("#node-input-scope-select").val("group");
      } else {
        $("#node-input-scope-select").val("target");
      }
      $("#node-input-scope-select").trigger("change");

      $('#node-input-erlsupervisor-target-container-div > .red-ui-treeList-container').css({ "height": "40vh" })
    },

    oneditcancel: function() {
    },

    oneditsave: function() {
      var scope = $("#node-input-scope-select").val();
      if (scope === null || scope === 'flow') {
        this.scope = 'flow';
      } else if (scope === 'group') {
        this.scope = "group";
      } else {
        // this seems to be the only way to get the list of ids in sorted ordered ...
        this.scope = Array.from($("#node-input-erlsupervisor-target-container-div").find('li').find('.selected').map( (d,o) => $($(o).parent()).data().data.id ))
      }
    },

    oneditresize: function(size) {
      this._resize();
    },


  });
})();

</script>

<script type="text/html" data-template-name="erlsupervisor">

      <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="node-red:common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]node-red:common.label.name">
      </div>

      <div class="form-row func-tabs-row">
        <ul style="min-width: 400px; margin-bottom: 20px;" id="erlsupervisor-tabs"></ul>
      </div>

      <div id="erlsupervisor-tabs-content" style="min-height: calc(100% - 95px);">

        <div id="erlsupervisor-tab-supervisor-config" style="display:none">
          <div class="form-row">
            <label style="width: 150px;" for="node-input-supervisor_type" data-i18n="erlsupervisor.label.supervisor_type"></label>
            <select id="node-input-supervisor_type" disabled>
                <option value="dynamic" data-i18n="erlsupervisor.supervisor_type.dynamic"></option>
                <option value="static" data-i18n="erlsupervisor.supervisor_type.static"></option>
            </select>
          </div>

          <div class="form-row">
            <label style="width: 150px;" for="node-input-strategy" data-i18n="erlsupervisor.label.restart_strategy"></label>
            <select id="node-input-strategy">
                <option value="one_for_one" data-i18n="erlsupervisor.restart_strategy.one_for_one"></option>
                <option value="one_for_all" data-i18n="erlsupervisor.restart_strategy.one_for_all"></option>
                <option value="rest_for_one" data-i18n="erlsupervisor.restart_strategy.rest_for_one"></option>
                <option value="simple_one_for_one" data-i18n="erlsupervisor.restart_strategy.simple_one_for_one"></option>
            </select>
          </div>

          <div class="form-row">
            <label style="width: 150px;" for="node-input-auto_shutdown" data-i18n="erlsupervisor.label.auto_shutdown"></label>
            <select id="node-input-auto_shutdown">
                <option value="never" data-i18n="erlsupervisor.auto_shutdown.never"></option>
                <option value="any_significant" data-i18n="erlsupervisor.auto_shutdown.any_significant"></option>
                <option value="all_significant" data-i18n="erlsupervisor.auto_shutdown.all_significant"></option>
            </select>
          </div>

          <div class="form-row">
            <label style="width: 150px;" for="node-input-intensity" data-i18n="erlsupervisor.label.intensity"></label>
            <input type="number" id="node-input-intensity" data-i18n="[placeholder]erlsupervisor.placeholder.intensity" style="width: 100px;"></input>
          </div>

          <div class="form-row">
            <label style="width: 150px;" for="node-input-period" data-i18n="erlsupervisor.label.period"></label>
            <input type="number" id="node-input-period" data-i18n="[placeholder]erlsupervisor.placeholder.period"  style="width: 100px;"></input>
          </div>

          <div class="form-row">
            <label style="width: 150px;" for="node-input-scope" data-i18n="erlsupervisor.label.source"></label>
            <select id="node-input-scope-select">
                <option value="flow" data-i18n="erlsupervisor.scope.all"></option>
                <option value="group" data-i18n="erlsupervisor.scope.group"></option>
                <option value="target" data-i18n="erlsupervisor.scope.selected"></option>
            </select>
          </div>

          <div class="form-row node-input-target-row">
            <button type="button" id="node-input-erlsupervisor-target-select" class="red-ui-button" data-i18n="node-red:common.label.selectNodes"></button>
          </div>

          <div class="form-row node-input-target-row node-input-target-list-row" style="position: relative; min-height: 100px">
            <div style="position: absolute; top: -30px; right: 0;"><input type="text" id="node-input-erlsupervisor-target-filter"></div>
            <div id="node-input-erlsupervisor-target-container-div"></div>
          </div>
        </div>

        <div id="erlsupervisor-tab-child-config" style="display:none">

          <div class="form-row">
            <label style="width: 150px;" for="node-input-supervisor_type" data-i18n="erlsupervisor.label.child_type"></label>
            <select id="node-input-child_type">
                <option value="worker" data-i18n="erlsupervisor.child_type.worker"></option>
                <option value="supervisor" data-i18n="erlsupervisor.child_type.supervisor"></option>
            </select>
          </div>

          <div class="form-row">
            <label style="width: 150px;" for="node-input-child_restart" data-i18n="erlsupervisor.label.child_restart"></label>
            <select id="node-input-child_restart">
                <option value="permanent" data-i18n="erlsupervisor.child_restart.permanent"></option>
                <option value="temporary" data-i18n="erlsupervisor.child_restart.temporary"></option>
                <option value="transient" data-i18n="erlsupervisor.child_restart.transient"></option>
            </select>
          </div>

          <div class="form-row">
            <label style="width: 150px;" for="node-input-child_shutdown" data-i18n="erlsupervisor.label.child_shutdown"></label>
            <select id="node-input-child_shutdown">
                <option value="brutal_kill" data-i18n="erlsupervisor.child_shutdown.brutal_kill"></option>
                <option value="timeout" data-i18n="erlsupervisor.child_shutdown.timeout"></option>
                <option value="infinite" data-i18n="erlsupervisor.child_shutdown.infinite"></option>
            </select>
            <input type="number" id="node-input-child_shutdown_timeout" data-i18n="[placeholder]erlsupervisor.placeholder.timeout"  style="width: 100px; display: none;"></input>
          </div>
        </div>

    </div>
</script>
<script type="text/html" data-help-name="erlsupervisor">
  <p>Supervisor for restarting selected nodes if they die.</p>
  Supervisor for restarting selected nodes if they die.

<p>This will restart nodes or a group of nodes, depening on the strategy if they die.

<p>Failure is throwing an exception, die is if the process dies, disappears, vanishes.

<p>For more detauls, <a href="https://www.erlang.org/doc/apps/stdlib/supervisor.html">Erlang documentation</a>.

</script>

<!-- --- [red-module:@gregoriusrippenstein/erlang-red-supervisor-node/erlmodule] --- -->
<script type="text/javascript">
  (function(){

  RED.nodes.registerType('erlmodule',{
    color: '#fdd0a2',
    icon: "font-awesome/fa-keyboard-o",
    category: 'function',
    paletteLabel: 'Module Code',
    defaults: {
      name: {
        value: "",
      },
      module_name: {
        value:"",
        required: true,
        validate: RED.validators.regex(/^[a-z0-9_]+$/)
      },
      code: {
        value: "-module().\n\n-import(module, [\n   funct/1\n]).\n\n\n-export([\n   something/1\n]).\n\nsomething(V) ->\n  io:format(\"hello world~n\",[]).\n\n",
        required: true
      }
    },

    inputs: 0,

    outputs: 0,

    label: function() {
      return (this.name || this.module_name || this._def.paletteLabel);
    },

    labelStyle: function() {
      return this.name?"node_label_italic":"";
    },

    onpaletteadd: function() {
    },

    onpaletteremove: function() {
    },

    oneditprepare: function() {
      var node = this;

      this.editor = RED.editor.createEditor({
        id: 'node-input-erlmodule-editor',
        mode: 'ace/mode/erlang',
        value: this.code,
        width: "Infinity",
        height: "calc(90vh)",
        focus: true
      });
    },

    oneditcancel: function() {
      this.editor.destroy();
      delete this.editor;
    },

    oneditsave: function() {
      this.code = this.editor.getValue();
      this.editor.destroy();
      delete this.editor;
    },

    oneditresize: function(size) {
    },


  });
})();

</script>

<script type="text/html" data-template-name="erlmodule">
  <div class="form-row">
    <label for="node-input-module_name"><i class="fa fa-tag"></i> <span data-i18n="erlmodule.label.module_name"></span></label>
    <input type="text" id="node-input-module_name" data-i18n="[placeholder]erlmodule.label.module_name">
  </div>

  <div class="form-row">
      <div style="height: 73vh; min-height:150px;" class="node-text-editor" id="node-input-erlmodule-editor"></div>
  </div>

  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="erlmodule.label.name"></span></label>
    <input type="text" id="node-input-name" data-i18n="[placeholder]erlmodule.label.name">
  </div>
</script>
<script type="text/html" data-help-name="erlmodule">
  <p>Node for encapsulating erlang module code.</p>
  Node for encapsulating erlang module code.

Defines a module that can be used with a state machine and other elements of Erlang-Red.
</script>

<!-- --- [red-module:@gregoriusrippenstein/erlang-red-supervisor-node/erlstatemachine] --- -->
<script type="text/javascript">
  (function(){

  RED.nodes.registerType('erlstatemachine',{
    color: '#FFCC66',
    icon: "font-awesome/fa-gears",
    category: 'behaviour',
    paletteLabel: 'State Machine',
    defaults: {
      name: {
        value:"",
      },

      scope: { value: null, type: "*[]" },

      emit_on_state_change: {
        value: false
      }
    },

    inputs: 1,

    outputs: 1,

    label: function() {
      let label = this._def.paletteLabel
      if (this.scope && this.scope.length > 0) {
        let nodeLabels = this.scope.map( d => RED.nodes.node(d) ).map( nde => RED.utils.getNodeLabel(nde))
        label = `[${nodeLabels.join(", ")}]\t${this.emit_on_state_change ? "⋮" : "➝"}`
      }
      return (this.name || label);
    },

    labelStyle: function() {
      return this.name?"node_label_italic":"";
    },

    onpaletteadd: function() {
    },

    onpaletteremove: function() {
    },

    oneditprepare: function() {
      var node = this;
      // nodeid was the old value, scope is the new. Why? Because Node-RED editor
      // updates "scope" variable name with new node ids automagically when doing
      // copy and paste operations.
      if ( (!node.scope || node.scope.length == 0) && node.nodeid != "" ) {
        node.scope = [node.nodeid]
      }

      var tabs = RED.tabs.create({
        id: "erlstatemachine-tabs",
        onchange: function (tab) {
          $("#erlstatemachine-tabs-content").children().hide();
          $("#" + tab.id).show();
        }
      });

      tabs.addTab({
        id: "erlstatemachine-tab-statem-config",
        iconClass: "fa fa-cog",
        label: node._("erlstatemachine.label.tab.statem_config")
      });

      tabs.addTab({
        id: "erlstatemachine-tab-handler-config",
        iconClass: "fa fa-keyboard-o",
        label: node._("erlstatemachine.label.tab.handler_config")
      });

      tabs.activateTab("erlstatemachine-tab-handler-config");

      var dirList = $("#node-input-handler-target-container-div").css({
        width: "100%",
        height: "calc(100%)"
      }).treeList(
        {
          multi: false
        }
      ).on('treelistselect', function (event, item) {
        if (item && item.nodeid) {
          RED.view.reveal(item.nodeid);
          RED.view.select(item.nodeid);
        }
      }).on('treelistconfirm', function (event, item) {
      }).on("treelistitemmouseover", function (e, item) {
        item.node.highlighted = true;
        item.node.dirty = true;
        RED.view.redraw();
      }).on("treelistitemmouseout", function (e, item) {
        item.node.highlighted = false;
        item.node.dirty = true;
        RED.view.redraw();
      })

      var search = $("#node-input-handler-target-filter").searchBox({
        style: "compact",
        delay: 300,
        change: function () {
          var val = $(this).val().trim().toLowerCase();
          if (val === "") {
            dirList.treeList("filter", null);
            search.searchBox("count", "");
          } else {
            var count = dirList.treeList("filter", function (item) {
              return item.label.toLowerCase().indexOf(val) > -1 || item.sublabel.toLowerCase().indexOf(val) > -1
            });
            search.searchBox("count", count + " / " + dirList.treeList("data").length);
          }
        }
      });

      let data = RED.nodes.filterNodes({ z: RED.workspaces.active() }).filter(n => n.id != this.id).filter(n => n.type == "erlmodule").map(nde => {
        return {
          label: RED.utils.getNodeLabel(nde),
          icon: "",
          nodeid: nde.id,
          node: nde,
          sublabel: nde.type,
          selected: this.scope && (this.scope.indexOf(nde.id) > -1),
          checkbox: false,
          radio: true,
          children: undefined
        }
      })

      dirList.treeList('data', data)
    },

    oneditcancel: function() {
    },

    oneditsave: function() {
      if ( $("#node-input-handler-target-container-div").treeList('selected').nodeid ) {
        this.scope = [$("#node-input-handler-target-container-div").treeList('selected').nodeid]
      } else {
        this.scope = []
      }
    },

    oneditresize: function(size) {
    },
  });
})();

</script>

<script type="text/html" data-template-name="erlstatemachine">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="node-red:common.label.name"></span></label>
    <input type="text" id="node-input-name" data-i18n="[placeholder]node-red:common.label.name">
  </div>

  <div class="form-row func-tabs-row">
    <ul style="min-width: 400px; margin-bottom: 20px;" id="erlstatemachine-tabs"></ul>
  </div>

  <div id="erlstatemachine-tabs-content" style="min-height: calc(100% - 95px);">

    <div id="erlstatemachine-tab-statem-config" style="display:none">
      <div class="form-row">
        <input type="checkbox" id="node-input-emit_on_state_change"
                style="display:inline-block; width:15px; vertical-align:baseline;">
        <label for="node-input-emit_on_state_change"><span data-i18n="erlstatemachine.label.emit-on-state-change"></span></label>
      </div>
    </div>

    <div id="erlstatemachine-tab-handler-config" style="display:none">
      <div class="form-row" style="margin-left: 10px; position: relative; height: 40vh; margin-right: 15px; min-height: 5vh;">
        <div style=" margin-bottom: 5px; width: 35%; padding-left: 60%;">
          <input type="text" id="node-input-handler-target-filter">
        </div>

        <div id="node-input-handler-target-container-div"></div>
      </div>
    </div>
  </div>
</script>
<script type="text/html" data-help-name="erlstatemachine">
  <p>Implements that State Machine behaviour.</p>
  Implements the Erlang state machine behaviour.

<p>
See <a href="https://www.erlang.org/doc/apps/stdlib/gen_statem">OTP Docu</a> for more details.
</p>

<p>
A handler can only be of type <code>erlmodule</code>.
</p>

<p>
  <a href='https://flows.red-erik.org/f/5672fa442b2b881d' target='_blank'>Example</a>
</p>
</script>

<!-- --- [red-module:@gregoriusrippenstein/erlang-red-supervisor-node/erleventhandler] --- -->
<script type="text/javascript">
  (function(){

  RED.nodes.registerType('erleventhandler',{
    color: '#FFCC66',
    icon: "font-awesome/fa-snowflake-o",
    category: 'behaviour',
    paletteLabel: 'Event Handler',
    defaults: {
      name: {
        value:"",
      },
      handlers: {
        value: [{ nodeid: "", moduleterm: ""}]
      }
    },

    inputs: 1,

    outputs: 1,

    label: function() {
      return (this.name || this._def.paletteLabel);
    },

    labelStyle: function() {
      return this.name?"node_label_italic":"";
    },

    onpaletteadd: function() {
    },

    onpaletteremove: function() {
    },

    oneditprepare: function() {
      let allModules = [ ["", "-- select module --"], ...RED.nodes.filterNodes({ type: "erlmodule" }).map( d => [d.id, d.module_name] )]

      this.handlers.sort((a, b) => a.nodeid < b.nodeid).forEach(currVal => {
        var sltObj = $('<select>', { class: 'erleventhandler-erlmodule' })

        for (var idx = 0; idx < allModules.length; idx++) {
          let val = allModules[idx]
          let selected = val[0] == currVal.nodeid ? { selected: "selected" } : {}

          sltObj.append($("<option>", { value: val[0], ...selected }).append(val[1]))
        }

        var txtObj = $('<input>', { type: "text", value: currVal.moduleterm, style: "width: 200px;", class: "erleventhandler-erlterm" })

        var container = $("<div>", { class: "form-row" });

        container.append('<a href="#" style="float: right; color: red;" onclick="$(this).parent().remove(); return false;"><i class="fa fa-close"></i></a>')
        container.append('<a href="#" style="float: right; margin-right: 10px; color: green;" onclick="$(\'#erleventhandler-handler-config-container\').append($(this).parent().clone()); return false;"><i class="fa fa-plus"></i></a>')

        container.append(sltObj).append(txtObj)

        container.appendTo($('#erleventhandler-handler-config-container'))
      })
    },

    oneditcancel: function() {
    },

    oneditsave: function() {
      let result = []
      $($('#erleventhandler-handler-config-container').find('.erleventhandler-erlmodule')).each((idx, elem) => {
        result.push({ nodeid: $(elem).val(), moduleterm: $(elem).siblings().filter(".erleventhandler-erlterm").val() })
      })
      this.handlers = result
    },

    oneditresize: function(size) {
    },


  });
})();

</script>

<script type="text/html" data-template-name="erleventhandler">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="node-red:common.label.name"></span></label>
    <input type="text" id="node-input-name" data-i18n="[placeholder]node-red:common.label.name">
  </div>

  <div class="form-row">
    <span>Select a static selection of event handlers. <br>
       Need to define Erlang Module node first else <br>
      this selection will be empty.</span>

    <p><p>
    <span>This can be dynamically extended at runtime <br>
    using the <b>add_handler</b> message.</span>
  </div>

  <div class="form-row">
    <div id="erleventhandler-handler-config-container"></div>
  </div>
</script>
<script type="text/html" data-help-name="erleventhandler">
  <p>Implements that event handler behaviour.</p>
  Implements the Erlang event behaviour.

See <a href="https://www.erlang.org/doc/apps/stdlib/gen_event.html">OTP Docu</a> for more details.

<p>
<a href='https://flows.red-erik.org/f/b70a7ce34819e4d5' target="_blank">Example</a>.
</p>

</script>

<!-- --- [red-module:@gregoriusrippenstein/erlang-red-supervisor-node/erlgenserver] --- -->
<script type="text/javascript">
  (function(){
    RED.nodes.registerType('erlgenserver',{
    color: '#FFCC66',
    icon: "font-awesome/fa-server",
    category: 'behaviour',
    paletteLabel: 'Generic Server',
    defaults: {
      name: {
        value:"",
      },

      scope: { value: null, type: "*[]" },
    },

    inputs: 1,

    outputs: 1,

    label: function () {
      let label = this._def.paletteLabel
      if (this.scope && this.scope.length > 0) {
        let nodes = this.scope.map( id => RED.nodes.node(id) ).map( nde => nde && RED.utils.getNodeLabel(nde) )
        label = `[${nodes.join(", ")}]`
      }
      return (this.name || label);
    },

    labelStyle: function() {
      return this.name?"node_label_italic":"";
    },

    onpaletteadd: function() {
    },

    onpaletteremove: function() {
    },

    oneditprepare: function() {
      var node = this;

      var tabs = RED.tabs.create({
        id: "erlgenserver-tabs",
        onchange: function (tab) {
          $("#erlgenserver-tabs-content").children().hide();
          $("#" + tab.id).show();
        }
      });

      tabs.addTab({
        id: "erlgenserver-tab-statem-config",
        iconClass: "fa fa-cog",
        label: node._("erlgenserver.label.tab.statem_config")
      });

      tabs.addTab({
        id: "erlgenserver-tab-handler-config",
        iconClass: "fa fa-keyboard-o",
        label: node._("erlgenserver.label.tab.handler_config")
      });

      tabs.activateTab("erlgenserver-tab-handler-config");

      var dirList = $("#node-input-handler-target-container-div").css({
        width: "100%",
        height: "calc(100%)"
      }).treeList(
        {
          multi: true
        }
      ).on('treelistselect', function (event, item) {
        if (item && item.nodeid) {
          RED.view.reveal(item.nodeid);
          RED.view.select(item.nodeid);
        }
      }).on('treelistconfirm', function (event, item) {
      }).on("treelistitemmouseover", function (e, item) {
        item.node.highlighted = true;
        item.node.dirty = true;
        RED.view.redraw();
      }).on("treelistitemmouseout", function (e, item) {
        item.node.highlighted = false;
        item.node.dirty = true;
        RED.view.redraw();
      })

      var search = $("#node-input-handler-target-filter").searchBox({
        style: "compact",
        delay: 300,
        change: function () {
          var val = $(this).val().trim().toLowerCase();
          if (val === "") {
            dirList.treeList("filter", null);
            search.searchBox("count", "");
          } else {
            var count = dirList.treeList("filter", function (item) {
              return item.label.toLowerCase().indexOf(val) > -1 || item.sublabel.toLowerCase().indexOf(val) > -1
            });
            search.searchBox("count", count + " / " + dirList.treeList("data").length);
          }
        }
      });

      let data = RED.nodes.filterNodes({ z: RED.workspaces.active() }).filter(n => n.id != this.id).filter(n => n.type == "erlmodule").map(nde => {
        return {
          label: RED.utils.getNodeLabel(nde),
          icon: "",
          nodeid: nde.id,
          node: nde,
          sublabel: nde.type,
          selected: this.scope && this.scope.indexOf(nde.id) > -1,
          checkbox: true,
          radio: false,
          children: undefined
        }
      })

      dirList.treeList('data', data)
    },

    oneditcancel: function() {
    },

    oneditsave: function() {
      this.scope = $("#node-input-handler-target-container-div").treeList('selected').map( d => d.nodeid )
    },

    oneditresize: function(size) {
    },


  });
})();

</script>

<script type="text/html" data-template-name="erlgenserver">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="node-red:common.label.name"></span></label>
    <input type="text" id="node-input-name" data-i18n="[placeholder]node-red:common.label.name">
  </div>

    <div class="form-row func-tabs-row">
      <ul style="min-width: 400px; margin-bottom: 20px;" id="erlgenserver-tabs"></ul>
    </div>

    <div id="erlgenserver-tabs-content" style="min-height: calc(100% - 95px);">

      <div id="erlgenserver-tab-statem-config" style="display:none">
        <div class="form-row">
          No options at the moment.
        </div>
      </div>

      <div id="erlgenserver-tab-handler-config" style="display:none">
        <div class="form-row"
          style="margin-left: 10px; position: relative; height: 40vh; margin-right: 15px; min-height: 5vh;">
          <div style=" margin-bottom: 5px; width: 35%; padding-left: 60%;">
            <input type="text" id="node-input-handler-target-filter">
          </div>

          <div id="node-input-handler-target-container-div"></div>
        </div>
      </div>
    </div>
</script>
<script type="text/html" data-help-name="erlgenserver">
  <p>Implements that gen_server behaviour.</p>
  Implements the Erlang generic server behaviour.

See <a href="https://www.erlang.org/doc/apps/stdlib/gen_server.html">OTP Docu</a> for more details.

</script>

<!-- --- [red-module:@gregoriusrippenstein/erlang-red-unittest/ut-assert-failure] --- -->
<script type="text/javascript">
  (function(){


  function frontendSupportFunction() {
  }

  var functTwo = (arg) => {

  };

  RED.nodes.registerType('ut-assert-failure',{
    color: '#FFAAAA',
    icon: "font-awesome/fa-frown-o",
    category: 'testing',
    defaults: {
      name: {
        value:"",
      },
    },

    paletteLabel: 'Assert False',
    inputs: 1,

    outputs: 0,

    label: function() {
      return (this.name || this._def.paletteLabel);
    },

    labelStyle: function() {
      return this.name?"node_label_italic":"";
    },

    onpaletteadd: function() {
    },

    onpaletteremove: function() {
    },

    oneditprepare: function() {
    },

    oneditcancel: function() {
    },

    oneditsave: function() {
    },

    oneditresize: function(size) {
    },


  });
})();

</script>

<script type="text/html" data-template-name="ut-assert-failure">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="node-red:common.label.name"></span></label>
    <input type="text" id="node-input-name" data-i18n="[placeholder]node-red:common.label.name">
  </div>
</script>
<script type="text/html" data-help-name="ut-assert-failure">
  <p>If this node is reached in a test flow, it will cause a failure of the test.</p>
  If this node is reached in a test flow, it will cause a failure of the test.

Attach this to any branch of a flow that is intended to fail.
</script>

<!-- --- [red-module:@gregoriusrippenstein/erlang-red-unittest/ut-assert-values] --- -->
<script type="text/javascript">
  (function(){

  RED.nodes.registerType('ut-assert-values',{
    color: '#FDF0C2',
    icon: "font-awesome/fa-exclamation",
    category: 'testing',
    defaults: {
      name: {
        value:"",
      },
      ignore_failure_if_succeed: {
        value: false
      },
      rules: {
        value: [{ t: "eql", p: "payload", pt: "msg", to: "", tot: "str" }],
        validate: function (rules, opt) {
          let msg;
          const errors = []
          if (!rules || rules.length === 0) { return true }
          for (var i = 0; i < rules.length; i++) {
            const opt = { label: RED._('ut-assert-values.label.rule') + ' ' + (i + 1) }
            const r = rules[i];
            if (r.t === 'eql' || r.t === 'noteql' || r.t === 'mth' || r.t === 'notmth' || r.t === 'debug' || r.t === 'notset' ||  r.t === 'set') {
              if ((msg = RED.utils.validateTypedProperty(r.p, r.pt, opt)) !== true) {
                errors.push(msg)
              }
            }
            if (r.t === 'eql' || r.t === 'noteql' || r.t === 'mth' || r.t === 'notmth') {
              if ((msg = RED.utils.validateTypedProperty(r.to, r.tot, opt)) !== true) {
                errors.push(msg)
              }
            }
          }
          if (errors.length) {
            return errors
          }
          return true;
        }
      },

    },

    paletteLabel: 'Assert Values',
    inputs: 1,

    outputs: 1,
    outputLabels: ["result"],

    label: function () {
      function prop2name(type, key) {
        var result = RED.utils.parseContextKey(key);
        return type + "." + result.key;
      }
      if (this.name) {
        return this.name;
      }
      if ( this.rules) {
        if (this.rules.length == 1) {
          return this._("ut-assert-values.label." + this.rules[0].t, { property: prop2name((this.rules[0].pt || "msg"), this.rules[0].p) });
        } else {
          return this._("ut-assert-values.label.changeCount", { count: this.rules.length });
        }
      }
    },

    labelStyle: function() {
      return this.name?"node_label_italic":"";
    },

    onpaletteadd: function() {
    },

    onpaletteremove: function() {
    },

    oneditprepare: function() {
      var to = this._("ut-assert-values.action.to");
      var toValueLabel = this._("ut-assert-values.action.toValue", to);
      var search = this._("ut-assert-values.action.search");
      var replace = this._("ut-assert-values.action.replace");
      var regex = this._("ut-assert-values.label.regex");

      var node = this;

      function createPropertyValue(row2_1, row2_2, defaultType) {
        var propValInput = $('<input/>', { class: "node-input-rule-property-value", type: "text" })
          .appendTo(row2_1)
          .typedInput({ default: defaultType || 'str', types: ['msg', 'flow', 'global', 'str', 'num', 'bool', 'json', 'bin', 'date', 'jsonata', 'env'] });

        propValInput.on("change", function (evt, type, val) {
          row2_2.toggle(type === "msg" || type === "flow" || type === "global" || type === "env");
        })
        return [propValInput, undefined];
      }


      function createFromValue(row3_1, defaultType) {
        return $('<input/>', { class: "node-input-rule-property-search-value", type: "text" })
          .appendTo(row3_1)
          .typedInput({ default: defaultType || 'str', types: ['msg', 'flow', 'global', 'str', 're', 'num', 'bool', 'env'] });
      }


      function createToValue(row3_2, defaultType) {
        return $('<input/>', { class: "node-input-rule-property-replace-value", type: "text" })
          .appendTo(row3_2)
          .typedInput({ default: defaultType || 'str', types: ['msg', 'flow', 'global', 'str', 'num', 'bool', 'json', 'bin', 'env'] });
      }


      function createMoveValue(row4, defaultType) {
        return $('<input/>', { class: "node-input-rule-property-move-value", type: "text" })
          .appendTo(row4)
          .typedInput({ default: defaultType || 'msg', types: ['msg', 'flow', 'global'] });
      }

      $('#node-input-assert-values-rule-container').css('min-height', '150px').css('min-width', '450px').editableList({
        addItem: function (container, i, opt) {
          var rule = opt;
          if (!rule.hasOwnProperty('t')) {
            rule = { t: "eql", p: "payload", to: "", tot: "str" };
          }
          container.css({
            overflow: 'hidden',
            whiteSpace: 'nowrap'
          });
          let fragment = document.createDocumentFragment();
          var row1 = $('<div/>', { style: "display:flex; align-items: baseline" }).appendTo(fragment);
          var row2 = $('<div/>', { style: "margin-top:8px;" }).appendTo(fragment);
          var row3 = $('<div/>', { style: "margin-top:8px;" }).appendTo(fragment);
          var row4 = $('<div/>', { style: "display:flex;margin-top:8px;align-items: baseline" }).appendTo(fragment);

          var selectField = $('<select/>', { class: "node-input-rule-type", style: "width:110px; margin-right:10px;" }).appendTo(row1);
          var selectOptions = [
            { v: "eql" },
            { v: "noteql" },
            { v: "mth" },
            { v: "notmth" },
            { v: "set" },
            { v: "notset" },
            { v: "debug" },
          ];
          for (var i = 0; i < selectOptions.length; i++) {
            let label = node._("ut-assert-values.action." + (selectOptions[i].l || selectOptions[i].v))
            selectField.append($("<option></option>").val(selectOptions[i].v).text(label));
          }

          var propertyName = $('<input/>', { class: "node-input-rule-property-name", type: "text" })
            .appendTo(row1)
            .typedInput({ types: ['msg', 'flow', 'global'] });

          var row2_1 = $('<div/>', { style: "display:flex;align-items: baseline" }).appendTo(row2);
          $('<div/>', { style: "display:inline-block;text-align:right; width:120px; padding-right:10px; box-sizing:border-box;" })
            .text(toValueLabel)
            .appendTo(row2_1);

          var row2_2 = $('<div/>', { style: "margin-top: 4px;" }).appendTo(row2);

          var row3_1 = $('<div/>', { style: "display:flex;align-items: baseline" }).appendTo(row3);
          $('<div/>', { style: "display:inline-block;text-align:right; width:120px; padding-right:10px; box-sizing:border-box;" })
            .text(search)
            .appendTo(row3_1);

          var row3_2 = $('<div/>', { style: "display:flex;margin-top:8px;align-items: baseline" }).appendTo(row3);
          $('<div/>', { style: "display:inline-block;text-align:right; width:120px; padding-right:10px; box-sizing:border-box;" })
            .text(replace)
            .appendTo(row3_2);

          $('<div/>', { style: "display:inline-block;text-align:right; width:120px; padding-right:10px; box-sizing:border-box;" })
            .text(to)
            .appendTo(row4);

          let propertyValue = null;
          let fromValue = null;
          let toValue = null;
          let moveValue = null;

          selectField.on("change", function () {
            var type = $(this).val();
            if (propertyValue) {
              propertyValue.typedInput('hide');
            }
            if (fromValue) {
              fromValue.typedInput('hide');
            }
            if (toValue) {
              toValue.typedInput('hide');
            }
            if (moveValue) {
              moveValue.typedInput('hide');
            }

            if (type != "notset" && type != "debug" && type != "set") {
              if (!propertyValue) {
                var parts = createPropertyValue(row2_1, row2_2);
                propertyValue = parts[0];
              }

              propertyValue.typedInput('show');
              propertyValue.typedInput('value', rule.to);
              propertyValue.typedInput('type', rule.tot);

              row2.show();
              row3.hide();
              row4.hide();
            } else {
              row2.hide();
              row3.hide();
              row4.hide();
            }
          });

          selectField.val(rule.t);
          propertyName.typedInput('value', rule.p);
          propertyName.typedInput('type', rule.pt);
          selectField.change();
          container[0].appendChild(fragment);
        },
        removable: true,
        sortable: true
      });

      for (var i = 0; i < this.rules.length; i++) {
        var rule = this.rules[i];
        $("#node-input-assert-values-rule-container").editableList('addItem', rule);
      }
    },

    oneditcancel: function() {
    },

    oneditsave: function() {
      var rules = $("#node-input-assert-values-rule-container").editableList('items');

      var node = this;
      node.rules = [];

      rules.each(function (i) {
        var rule = $(this);
        var type = rule.find(".node-input-rule-type").val();

        var r = {
          t: type,
          p: rule.find(".node-input-rule-property-name").typedInput('value'),
          pt: rule.find(".node-input-rule-property-name").typedInput('type')
        };

        if (type !== "notset" && type !== "debug" && type !== "set") {
          r.to = rule.find(".node-input-rule-property-value").typedInput('value');
          r.tot = rule.find(".node-input-rule-property-value").typedInput('type');
        }
        node.rules.push(r);
      });

    },

    oneditresize: function(size) {
      var rows = $("#dialog-form>div:not(.node-input-assert-values-rule-container-row)");
      var height = size.height;
      for (var i = 0; i < rows.length; i++) {
        height -= $(rows[i]).outerHeight(true);
      }
      var editorRow = $("#dialog-form>div.node-input-assert-values-rule-container-row");
      height -= (parseInt(editorRow.css("marginTop")) + parseInt(editorRow.css("marginBottom")));
      height += 16;
      $("#node-input-assert-values-rule-container").editableList('height', height);
    },


  });
})();

</script>

<script type="text/html" data-template-name="ut-assert-values">
  <style>
    ol#node-input-assert-values-rule-container .red-ui-typedInput-container {
      flex: 1;
    }
  </style>

  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="node-red:common.label.name"></span></label>
    <input type="text" id="node-input-name" style="width: calc(100% - 105px)"  data-i18n="[placeholder]node-red:common.label.name">
  </div>

  <div class="form-row">
    <input type="checkbox" id="node-input-ignore_failure_if_succeed"
             style="display:inline-block; width:15px; vertical-align:baseline;">
    <label for="node-input-ignore_failure_if_succeed"><span data-i18n="ut-assert-values.label.ignore_failure_if_succeed"></span></label>
  </div>

  <div class="form-row" style="margin-bottom:0;">
    <label><i class="fa fa-list"></i> <span data-i18n="ut-assert-values.label.rules"></span></label>
  </div>
  <div class="form-row node-input-rule-container-row node-input-assert-values-rule-container-row">
    <ol id="node-input-assert-values-rule-container"></ol>
  </div>
</script>
<script type="text/html" data-help-name="ut-assert-values">
  <p>Ensure specific values are set on the message passing through this node.</p>
  Ensure specific values are set on the message passing through this node.

<p>
If the values do not match, this node will cause and error.

<p>
Upon completion, the node sets the "assert_succeed" flag on the message to either true or false depending on whether
all tests succeed or some failed. This is an all or one flag.

<p>
The "assert_failures" array value is set on the message to contain all failures and unsupported features.

<p>
<b>Ignore if Succeed</b>

<p>
The <i>ignore failure if succeed</i> flag can be used if the assert value node receives multiple messages however as long as one message succeeded, then the assert values node will succeed and messages that failure will be ignored.

<p>
Normally each message is independent of one another but in the case of an assert values node with the flag "ignore failure" set, the node will remain in success mode until Node-RED, the flow or the node is reset/restarted.

<p>
Failures will still be sent to the debug panel however the node status will remain succeeded.

</script>

<!-- --- [red-module:@gregoriusrippenstein/erlang-red-unittest/ut-assert-success] --- -->
<script type="text/javascript">
  (function(){


  function frontendSupportFunction() {
  }

  var functTwo = (arg) => {

  };

  RED.nodes.registerType('ut-assert-success',{
    color: '#addb7b',
    icon: "font-awesome/fa-smile-o",
    category: 'testing',
    defaults: {
      name: {
        value:"",
      },
    },

    paletteLabel: "Assert True",
    inputs: 1,

    outputs: 0,

    label: function() {
      return (this.name || this._def.paletteLabel);
    },

    labelStyle: function() {
      return this.name?"node_label_italic":"";
    },

    onpaletteadd: function() {
    },

    onpaletteremove: function() {
    },

    oneditprepare: function() {
    },

    oneditcancel: function() {
    },

    oneditsave: function() {
    },

    oneditresize: function(size) {
    },


  });
})();

</script>

<script type="text/html" data-template-name="ut-assert-success">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="node-red:common.label.name"></span></label>
    <input type="text" id="node-input-name" data-i18n="[placeholder]node-red:common.label.name">
  </div>
</script>
<script type="text/html" data-help-name="ut-assert-success">
  <p>This node failes if, during flow execution, it is not reached.</p>
  A success assertion meaning that this node **must** be reached when a flow is executed as part of a test.

If this node isn't reached, then the test will fail.
</script>

<!-- --- [red-module:@gregoriusrippenstein/erlang-red-unittest/ut-assert-status] --- -->
<script type="text/javascript">
  (function(){


  function frontendSupportFunction() {
  }

  var functTwo = (arg) => {

  };

  RED.nodes.registerType('ut-assert-status',{
    color: '#C0DEED',
    icon: "font-awesome/fa-window-minimize",
    category: 'testing',
    paletteLabel: 'Assert Status',
    defaults: {
      name: {
        value:"",
      },
      nodeid: {
        value: "",
        required: true
      },
      content: {
        value: "",
      },
      colour: {
        value: "grey",
        required: true
      },
      shape: {
        value: "dot",
        required: true
      },
      inverse: {
        value: false,
        required: true
      }
    },

    inputs: 0,

    outputs: 0,

    label: function() {
      if ( this.nodeid && !this.name) {
        let nodeLabel = `[${this.nodeid}]`;
        let node = RED.nodes.node(this.nodeid)
        if (node) {
          nodeLabel = RED.utils.getNodeLabel(node)
        }

        if ( this.inverse )  {
          return `Assert No Status for ${nodeLabel}`
        } else {
          return `Assert Status for ${nodeLabel}: ${this.colour} ${this.shape}`
        }
      } else { return (this.name || this._def.paletteLabel) }
    },

    labelStyle: function() {
      return (this.name || this.nodeid) ? "node_label_italic" : "";
    },

    onpaletteadd: function() {
    },

    onpaletteremove: function() {
    },

    oneditprepare: function() {
      $('#node-input-inverse').on('change', () => {
        if ($('#node-input-inverse').is(":checked")) {
          $('#ut-assert-status-opts-to-hide-on-inverse').fadeOut(300);
        } else {
          $('#ut-assert-status-opts-to-hide-on-inverse').fadeIn(300);
        }
      });

      var dirList = $("#node-input-assert-status-target-container-div").css({
        width: "100%",
        height: "calc(100%)"
      }).treeList(
        {
          multi: false
        }
      ).on('treelistselect', function (event, item) {
        if (item && item.nodeid) {
          RED.view.reveal(item.nodeid);
          RED.view.select(item.nodeid);
        }
      }).on('treelistconfirm', function (event, item) {
      }).on("treelistitemmouseover", function (e, item) {
        item.node.highlighted = true;
        item.node.dirty = true;
        RED.view.redraw();
      }).on("treelistitemmouseout", function (e, item) {
        item.node.highlighted = false;
        item.node.dirty = true;
        RED.view.redraw();
      });

      var search = $("#node-input-assert-status-target-filter").searchBox({
        style: "compact",
        delay: 300,
        change: function () {
          var val = $(this).val().trim().toLowerCase();
          if (val === "") {
            dirList.treeList("filter", null);
            search.searchBox("count", "");
          } else {
            var count = dirList.treeList("filter", function (item) {
              return item.label.toLowerCase().indexOf(val) > -1 || item.sublabel.toLowerCase().indexOf(val) > -1
            });
            search.searchBox("count", count + " / " + dirList.treeList("data").length);
          }
        }
      });

      let data = RED.nodes.filterNodes({ z: RED.workspaces.active() }).filter(n => n.id != this.id).map(nde => {
        return {
          label: RED.utils.getNodeLabel(nde),
          icon: "",
          nodeid: nde.id,
          node: nde,
          sublabel: nde.type,
          selected: nde.id == this.nodeid,
          checkbox: false,
          radio: true,
          children: undefined
        }
      })

      dirList.treeList('data', data)
    },

    oneditcancel: function() {
    },

    oneditsave: function() {
      this.nodeid = $("#node-input-assert-status-target-container-div").treeList('selected').nodeid;
    },

    oneditresize: function(size) {
    },


  });
})();

</script>

<script type="text/html" data-template-name="ut-assert-status">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="node-red:common.label.name"></span></label>
    <input type="text" id="node-input-name" data-i18n="[placeholder]node-red:common.label.name">
  </div>

  <div class="form-row">
    <input type="checkbox" id="node-input-inverse"
             style="display:inline-block; width:15px; vertical-align:baseline;">
    <label for="node-input-inverse"><span data-i18n="ut-assert-status.label.inverse"></span></label>
  </div>

  <div id="ut-assert-status-opts-to-hide-on-inverse">
    <div class="form-row">
      <label for="node-input-content"><i class="fa fa-tag"></i> <span data-i18n="ut-assert-status.label.content"></span></label>
      <input type="text" id="node-input-content" data-i18n="[placeholder]ut-assert-status.label.content">
    </div>

    <div class="form-row">
      <label for="node-input-colour">
            <i class="fa fa-tag"></i>
            <span>Colour</span>
          </label>

      <select id="node-input-colour">
        <option value="red" selected=selected>Red</option>
        <option value="grey">Grey</option>
        <option value="blue">Blue</option>
        <option value="yellow">Yellow</option>
        <option value="green">Green</option>
      </select>
    </div>

    <div class="form-row">
      <label for="node-input-shape">
            <i class="fa fa-tag"></i>
            <span>Shape</span>
          </label>

      <select id="node-input-shape">
        <option value="dot" selected=selected>Dot</option>
        <option value="ring">Ring</option>
      </select>
    </div>
  </div>


    <div class="form-row" style="margin-left: 10px; position: relative; height: 40vh; margin-right: 15px; min-height: 5vh;"">
          <div style=" margin-bottom: 5px; width: 35%; padding-left: 60%;">
      <input type="text" id="node-input-assert-status-target-filter">
    </div>

    <div id="node-input-assert-status-target-container-div"></div>
    </div>
</script>
<script type="text/html" data-help-name="ut-assert-status">
  <p>Assert that a status message was generated by a specific node.</p>
  Assert that a status message was generated by a specific node.
</script>

<!-- --- [red-module:@gregoriusrippenstein/erlang-red-unittest/ut-assert-debug] --- -->
<script type="text/javascript">
  (function(){

  RED.nodes.registerType('ut-assert-debug',{
    color: '#D8BFD8',
    icon: "font-awesome/fa-bug",
    category: 'testing',
    paletteLabel: 'Assert Debug',
    defaults: {
      name: {
        value:"",
      },
      nodeid: {
        value: "",
        required: true
      },
      msgtype: {
        value: "normal",
        required: true
      },
      inverse: {
        value: false,
        required: true
      },
    },

    inputs: 0,

    outputs: 0,

    label: function() {
      if (this.nodeid && !this.name ) {
        let nodeLabel = `[${this.nodeid}]`;
        let node = RED.nodes.node(this.nodeid)
        if (node) {
          nodeLabel = RED.utils.getNodeLabel(node)
        }

        if ( this.inverse ) {
          return `Assert No Debug from ${nodeLabel}`
        } else {
          return `Assert Debug of ${this.msgtype} for ${nodeLabel}`
        }
      } else { return (this.name || this._def.paletteLabel) }
    },

    labelStyle: function() {
      return (this.name || this.nodeid) ? "node_label_italic" : "";
    },

    onpaletteadd: function() {
    },

    onpaletteremove: function() {
    },

    oneditprepare: function() {
      $('#node-input-inverse').on('change', () => {
        if ($('#node-input-inverse').is(":checked")) {
          $('#ut-assert-debug-opts-to-hide-on-inverse').fadeOut(300);
        } else {
          $('#ut-assert-debug-opts-to-hide-on-inverse').fadeIn(300);
        }
      });

      var dirList = $("#node-input-assert-debug-target-container-div").css({
        width: "100%",
        height: "calc(100%)"
      }).treeList(
        {
          multi: false
        }
      ).on('treelistselect', function (event, item) {
        if (item && item.nodeid) {
          RED.view.reveal(item.nodeid);
          RED.view.select(item.nodeid);
        }
      }).on('treelistconfirm', function (event, item) {
      }).on("treelistitemmouseover", function (e, item) {
        item.node.highlighted = true;
        item.node.dirty = true;
        RED.view.redraw();
      }).on("treelistitemmouseout", function (e, item) {
        item.node.highlighted = false;
        item.node.dirty = true;
        RED.view.redraw();
      });

      var search = $("#node-input-assert-debug-target-filter").searchBox({
        style: "compact",
        delay: 300,
        change: function () {
          var val = $(this).val().trim().toLowerCase();
          if (val === "") {
            dirList.treeList("filter", null);
            search.searchBox("count", "");
          } else {
            var count = dirList.treeList("filter", function (item) {
              return item.label.toLowerCase().indexOf(val) > -1 || item.sublabel.toLowerCase().indexOf(val) > -1
            });
            search.searchBox("count", count + " / " + dirList.treeList("data").length);
          }
        }
      });

      let data = RED.nodes.filterNodes({z:RED.workspaces.active()}).filter( n => n.id != this.id ).map( nde =>{
          return {
            label: RED.utils.getNodeLabel(nde),
            icon: "",
            nodeid: nde.id,
            node: nde,
            sublabel: nde.type,
            selected: nde.id == this.nodeid,
            checkbox: false,
            radio: true,
            children: undefined
         }
      })

      dirList.treeList('data',data)
    },

    oneditcancel: function() {
    },

    oneditsave: function() {
      this.nodeid = $("#node-input-assert-debug-target-container-div").treeList('selected').nodeid
    },

    oneditresize: function(size) {
    },


  });
})();

</script>

<script type="text/html" data-template-name="ut-assert-debug">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="node-red:common.label.name"></span></label>
    <input type="text" id="node-input-name" data-i18n="[placeholder]node-red:common.label.name">
  </div>

  <div class="form-row">
     <input type="checkbox" id="node-input-inverse"
           style="display:inline-block; width:15px; vertical-align:baseline;">
    <label for="node-input-inverse"><span data-i18n="ut-assert-debug.label.inverse"></span></label>
  </div>

  <div id="ut-assert-debug-opts-to-hide-on-inverse">
    <div class="form-row">
      <label for="node-input-msgtype">
              <i class="fa fa-tag"></i>
              <span>Msg Type</span>
            </label>

      <select id="node-input-msgtype">
          <option value="normal">Normal</option>
          <option value="warning">Warning</option>
          <option value="error">Error</option>
        </select>
    </div>
  </div>

    <div class="form-row" style="margin-left: 10px; position: relative; height: 40vh; margin-right: 15px; min-height: 5vh;">
      <div style="margin-bottom: 5px; width: 35%; padding-left: 60%;">
        <input type="text" id="node-input-assert-debug-target-filter">
      </div>

      <div id="node-input-assert-debug-target-container-div"></div>
    </div>
</script>
<script type="text/html" data-help-name="ut-assert-debug">
  <p>Assert that a debug message was generated by a specific node.</p>
  Assert that a debug message was generated by a specific node.
</script>

<!-- --- [red-module:@gregoriusrippenstein/node-red-contrib-flow2uml/flowtomermaid] --- -->
<script type="text/javascript">
(function ($) {
   RED.nodes.registerType('Flow2MermaidCfg', {
      category: 'config',
      hasUsers: false,
      defaults: {
         name: { value: "" },
         direction: { value: "" },
         genmereditor: {value:""},
      },
      paletteLabel: 'Flow2MermaidCfg',
      label: function () {
         return this.name;
      }
  });
})(jQuery);
</script>

<!-- The html for the config node info panel (in right sidebar) -->
<script type="text/x-red" data-template-name="Flow2MermaidCfg">
   <p>Generate a Mermaid flowchart diagram from the active flow tab.</p>

   <h3>Description</h3>
   Convert the current flow tabl a work-flow UML diagram in Mermaid syntax. The result is stored in the pasteboard - Ctrl/Cmd-V can be used to paste the Mermaid diagram into the <a style="color: blue;" target=_blank href="https://mermaid.live/edit">live editor <i class="fa fa-external-link"></i></a>.
</script>

<!-- --- [red-module:@gregoriusrippenstein/node-red-contrib-flow2uml/mermaid-flowchart] --- -->
<script type="text/javascript">
  (function(){

  RED.nodes.registerType('mermaid-flowchart',{
    color: '#C7E9C0',
    icon: "font-awesome/fa-code-fork",
    category: 'mermaid',
    paletteLabel: 'Flowchart',
    defaults: {
      name: {
        value:"",
      },
      shape: {
        value:"rect"
      },
      wirecfgs: {
        value: [{ name: "", id: "", arrow: "" }],
      }
    },

    inputs: 1,

    outputs: 1,

    label: function() {
      return (this.name || this._def.paletteLabel);
    },

    labelStyle: function() {
      return this.name?"node_label_italic":"";
    },

    onpaletteadd: function() {
    },

    onpaletteremove: function() {
    },

    oneditprepare: function() {
      var possibleArrows = [
        "--", "-.-", "==",
        "-->", "-.->", "==>",
        "<-->", "<-.->", "<==>",
        "--x", "-.-x", "==x",
        "x--x", "x-.-x", "x==x",
        "--o", "-.-o", "==o",
        "o--o", "o-.-o", "o==o",
      ]
      var allOurWires = [];

      RED.nodes.getDownstreamNodes(RED.nodes.node(this.id)).forEach(nde => {
        if ( !this.wirecfgs.some( (d) => d.id == nde.id ) ) {
          this.wirecfgs.push({id: nde.id, name: "", arrow: "-->"})
        }
        allOurWires.push( nde.id)
      })

      this.wirecfgs.sort( (a,b) => a.id < b.id ).forEach( currVal => {
         let nde = RED.nodes.node(currVal.id)

        // support older versions
        currVal.arrow = { "arrow": "-->", "thickarrow": "==>", "line": "--", "dotarrow": "-.->" }[currVal.arrow] || currVal.arrow;

          if ( !nde ) { return }
          if ( allOurWires.indexOf(currVal.id) < 0 ) { return }

          var sltObj = $('<select>', {class: 'wirecfg-arrow', style: "max-width: 100px"} )
          for (var idx = 0; idx < possibleArrows.length; idx++ ) {
            let val = possibleArrows[idx]
            let selected = val == currVal.arrow ? { selected: "selected" } : {}

            sltObj.append( $( "<option>", { value: val, ...selected }).append(val) )
          }
          var container = $("<div>", { class: "wirecfg form-row", "data-id": nde.id });
          container.append('<a href="#" style="float: right; color: red;" onclick="$(this).parent().remove(); return false;"><i class="fa fa-close"></i></a>')
          container.append('<a href="#" style="float: right; margin-right: 10px; color: green;" onclick="$(\'#node-input-wirecfgs-container\').append($(this).parent().clone()); return false;"><i class="fa fa-plus"></i></a>')

        var label = $('<label>', { for: "node-input-name", "data-id": nde.id, onmouseover: "nde=RED.nodes.node($(this).data('id'));nde.highlighted = true;nde.dirty=true;RED.view.redraw();", onmouseout: "nde=RED.nodes.node($(this).data('id'));nde.highlighted = false;nde.dirty=true;RED.view.redraw();" })
          label.append('<i class="fa fa-tag"></i>&nbsp;')
          label.append($("<span>").text(RED.utils.getNodeLabel(nde)))

          container.append(label)
          container.append($('<br/>'))
          container.append( $('<input>', { style: 'min-width: 150px', class:'wirecfg-name', type: "text", placeholder: "Name", value: currVal.name }))

          container.append( sltObj )

          container.appendTo($('#node-input-wirecfgs-container'))
      })
    },

    oneditcancel: function() {
    },

    oneditsave: function() {
      let result = []
      $($('#node-input-wirecfgs-container').find('.wirecfg')).each( (idx,elem) => {
        result.push( { name: $(elem).find('.wirecfg-name').val(), id: $(elem).data("id"), arrow: $(elem).find('.wirecfg-arrow').val()})
      })
      this.wirecfgs = result
    },

    oneditresize: function(size) {
    },


  });
})();

</script>

<script type="text/html" data-template-name="mermaid-flowchart">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="node-red:common.label.name"></span></label>
    <input type="text" id="node-input-name" data-i18n="[placeholder]node-red:common.label.name">
  </div>

  <div class="form-row">
    <label for="node-input-shape"><i class="fa fa-tag"></i> <span data-i18n="mermaid-flowchart.label.shape"></span></label>
    <select id="node-input-shape">
          <option value="stadium" data-i18n="mermaid-flowchart.label.shapes.stadium"></option>
          <option value="rounded" data-i18n="mermaid-flowchart.label.shapes.rounded"></option>
          <option value="rect" data-i18n="mermaid-flowchart.label.shapes.rect"></option>
          <option value="circle" data-i18n="mermaid-flowchart.label.shapes.circle"></option>
          <option value="sm-circ" data-i18n="mermaid-flowchart.label.shapes.sm-circ"></option>
          <option value="dbl-circ" data-i18n="mermaid-flowchart.label.shapes.dbl-circ"></option>
          <option value="fr-circ" data-i18n="mermaid-flowchart.label.shapes.fr-circ"></option>
          <option value="bow-rect" data-i18n="mermaid-flowchart.label.shapes.bow-rect"></option>
          <option value="fr-rect" data-i18n="mermaid-flowchart.label.shapes.fr-rect"></option>
          <option value="cross-circ" data-i18n="mermaid-flowchart.label.shapes.cross-circ"></option>
          <option value="tag-doc" data-i18n="mermaid-flowchart.label.shapes.tag-doc"></option>
          <option value="tag-rect" data-i18n="mermaid-flowchart.label.shapes.tag-rect"></option>
          <option value="text" data-i18n="mermaid-flowchart.label.shapes.text"></option>
          <option value="notch-rect" data-i18n="mermaid-flowchart.label.shapes.notch-rect"></option>
          <option value="hourglass" data-i18n="mermaid-flowchart.label.shapes.hourglass"></option>
          <option value="bolt" data-i18n="mermaid-flowchart.label.shapes.bolt"></option>
          <option value="brace" data-i18n="mermaid-flowchart.label.shapes.brace"></option>
          <option value="brace-r" data-i18n="mermaid-flowchart.label.shapes.brace-r"></option>
          <option value="braces" data-i18n="mermaid-flowchart.label.shapes.braces"></option>
          <option value="lean-r" data-i18n="mermaid-flowchart.label.shapes.lean-r"></option>
          <option value="lean-l" data-i18n="mermaid-flowchart.label.shapes.lean-l"></option>
          <option value="cyl" data-i18n="mermaid-flowchart.label.shapes.cyl"></option>
          <option value="diam" data-i18n="mermaid-flowchart.label.shapes.diam"></option>
          <option value="delay" data-i18n="mermaid-flowchart.label.shapes.delay"></option>
          <option value="h-cyl" data-i18n="mermaid-flowchart.label.shapes.h-cyl"></option>
          <option value="lin-cyl" data-i18n="mermaid-flowchart.label.shapes.lin-cyl"></option>
          <option value="curv-trap" data-i18n="mermaid-flowchart.label.shapes.curv-trap"></option>
          <option value="div-rect" data-i18n="mermaid-flowchart.label.shapes.div-rect"></option>
          <option value="doc" data-i18n="mermaid-flowchart.label.shapes.doc"></option>
          <option value="tri" data-i18n="mermaid-flowchart.label.shapes.tri"></option>
          <option value="fork" data-i18n="mermaid-flowchart.label.shapes.fork"></option>
          <option value="win-pane" data-i18n="mermaid-flowchart.label.shapes.win-pane"></option>
          <option value="f-circ" data-i18n="mermaid-flowchart.label.shapes.f-circ"></option>
          <option value="lin-doc" data-i18n="mermaid-flowchart.label.shapes.lin-doc"></option>
          <option value="lin-rect" data-i18n="mermaid-flowchart.label.shapes.lin-rect"></option>
          <option value="notch-pent" data-i18n="mermaid-flowchart.label.shapes.notch-pent"></option>
          <option value="flip-tri" data-i18n="mermaid-flowchart.label.shapes.flip-tri"></option>
          <option value="sl-rect" data-i18n="mermaid-flowchart.label.shapes.sl-rect"></option>
          <option value="trap-t" data-i18n="mermaid-flowchart.label.shapes.trap-t"></option>
          <option value="docs" data-i18n="mermaid-flowchart.label.shapes.docs"></option>
          <option value="st-rect" data-i18n="mermaid-flowchart.label.shapes.st-rect"></option>
          <option value="odd" data-i18n="mermaid-flowchart.label.shapes.odd"></option>
          <option value="flag" data-i18n="mermaid-flowchart.label.shapes.flag"></option>
          <option value="hex" data-i18n="mermaid-flowchart.label.shapes.hex"></option>
          <option value="trap-b" data-i18n="mermaid-flowchart.label.shapes.trap-b"></option>
      </select>
  </div>

  <div class="form-row">
    <span>Labels</span>
  </div>

  <div class="form-row">
    <div id="node-input-wirecfgs-container"></div>
  </div>
</script>
<script type="text/html" data-help-name="mermaid-flowchart">
  <p>Used to create mermaid flowchart</p>
  Used to create mermaid flowchart
</script>

<!-- --- [red-module:@gregoriusrippenstein/node-red-contrib-flowhub/flowhubpull] --- -->
<script type="text/javascript">
 (function(){

   function flowHubPullUpdateFlows(e=null,o=null){let t=t=>{if("failed"==t.status)return RED.notify(t.msg,{type:"error",id:"FlowHubPull",timeout:4e3});let i=[],r={},l=[];Object.keys(t.data).forEach(function(e){var o=t.data[e].name.match(/^(\[.+\])/);o?r[o[0]]?r[o[0]].push(t.data[e]):r[o[0]]=[t.data[e]]:l.push(t.data[e])}),Object.keys(r).sort((e,o)=>e<o?-1:1).forEach(e=>{var o=r[e].map(e=>({label:e.name,icon:"fa "+(RED.nodes.workspace(e.id)?"fa-check-circle-o":""),flowid:e.id,sublabel:e.id,selected:$("#node-input-flowhubpull-flowid").val()==e.id,checkbox:!1,children:void 0}));i.push({label:e,icon:"",flowid:"",sublabel:"",selected:!1,checkbox:!1,children:o.sort((e,o)=>e.label<o.label?-1:1)})}),l.sort((e,o)=>e.name<o.name?-1:1).forEach(e=>{i.push({label:e.name,icon:"fa "+(RED.nodes.workspace(e.id)?"fa-check-circle-o":""),flowid:e.id,sublabel:e.id,selected:$("#node-input-flowhubpull-flowid").val()==e.id,checkbox:!1,children:void 0})}),e&&e(i)};$.get({url:"https://api.flowhub.org/v1/flows?cb="+(new Date).getTime(),headers:{"X-FHB-TOKEN":o}}).done(e=>{t(e)}).fail(e=>{var i="";"rejected"==e.state()?$.ajax({url:"FlowHubCatalogue",type:"POST",contentType:"application/json; charset=utf-8",data:JSON.stringify({token:o}),success:function(e){t(e)},error:function(e,o,t){i="<p>Failed to retrieve FlowHub catalogue, request blocked.</p><p>Request: <b>https://api.flowhub.org/v1/flows</b></p><p>AdBlocker or uBlock might have prevented request.</p><p>Please check browser console for more details.</p>",console.log("Error",o),RED.notify(i,{type:"error",id:"FlowHubPull",timeout:4e3})}}):(i="<p>Failed to retrieve FlowHub catalogue.</p><p>Check browser console for more details.</p>",console.warn("Error loading https://api.flowhub.org/v1/flows:",e),RED.notify(i,{type:"error",id:"FlowHubPull",timeout:4e3}))})}function obtainConfigNode(){let o=[];return RED.nodes.eachConfig(function(e){"FlowHubCfg"===e.type&&o.push(e)}),o[0]}function tokenToUrl(e){e=e.substring(4);var o="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789-_".split("");let t=Object.fromEntries(o.map((e,o)=>[e,o])),i=Object.fromEntries(o.map((e,o)=>[o,e]));return e.replaceAll(/./gi,(e,o)=>i[(t[e]+o+1)%64])}function obtainFhbToken(e,i){$.ajax({url:"FlowHubToken",type:"POST",contentType:"application/json; charset=utf-8",data:JSON.stringify({cfgnode:e}),success:function(e){i(e.token)},error:function(e,o,t){i("")}})}function doFlowImportForSidebar(i,e){RED.notify("Pull triggered",{type:"warning",timeout:3e3}),$.get({url:"https://api.flowhub.org/v3/flows/"+$("#node-input-flowhubpull-flowid").val().trim()+"?cb="+(new Date).getTime()+"&v="+$("#node-input-flowhubpull-flowrevision").val().trim(),headers:{"X-FHB-TOKEN":e,"User-Agent":"FlowHub.org Sidebar"}}).done((o,e)=>{try{if(!o||!o.flowdata||!Array.isArray(JSON.parse(o.flowdata)))return RED.notify("Access denied or revision not found.",{type:"error",timeout:3e3})}catch(e){return RED.notify("Access Denied, parse error.",{type:"error",timeout:3e3})}var t;RED.nodes.workspace(o.flowid)||((t=ensureYourConfigNodeExists()).flowrevisions||={},t.flowrevisions[o.flowid]!=o.revision&&(t.flowrevisions[o.flowid]=o.revision)),RED.clipboard.import(),setTimeout(()=>{var e=JSON.parse(o.flowdata);i&&(e=e.filter(function(e){return"tab"!=e.type})),$("#red-ui-clipboard-dialog-import-text").val(JSON.stringify(e)).trigger("paste")},300)}).fail(e=>{var o="<p>Failed to retrieve flow data from FlowHub, request blocked.</p><p>Request: https://api.flowhub.org/v3/flows/"+$("#node-input-flowhubpull-flowid").val().trim()+"</p><p>AdBlocker or uBlock might have prevented request.</p><p>Please check browser console for more details.</p>";RED.notify(o,{type:"error",id:"FlowHubPull",timeout:4e3})})}function doFlowImportForPullNode(e,o){RED.notify("Pull triggered",{type:"warning",timeout:3e3});$.get({url:"https://api.flowhub.org/v3/flows/"+$("#node-input-flowid").val().trim()+"?cb="+(new Date).getTime()+"&v="+$("#node-input-flowrevision").val().trim(),headers:{"X-FHB-TOKEN":o,"User-Agent":"FlowHub.org Pull Node"}}).done((o,e)=>{try{if(!o||!o.flowdata||!Array.isArray(JSON.parse(o.flowdata)))return RED.notify("Access denied or revision not found.",{type:"error",timeout:3e3})}catch(e){return RED.notify("Access Denied, parse error.",{type:"error",timeout:3e3})}var t;RED.nodes.workspace(o.flowid)||(t=(()=>{let o=void 0;return RED.nodes.eachConfig(function(e){"FlowHubCfg"===e.type&&(o=e)}),o})())&&(t.flowrevisions||={},t.flowrevisions[o.flowid]!=o.revision)&&(t.flowrevisions[o.flowid]=o.revision),RED.clipboard.import(),setTimeout(()=>{var e=JSON.parse(o.flowdata);$("#red-ui-clipboard-dialog-import-text").val(JSON.stringify(e)).trigger("paste")},300)}).fail(e=>{var o="<p>Failed to retrieve flow data from FlowHub, request blocked.</p><p>Request: https://api.flowhub.org/v3/flows/"+$("#node-input-flowhubpull-flowid").val().trim()+"</p><p>AdBlocker or uBlock might have prevented request.</p><p>Please check browser console for more details.</p>";RED.notify(o,{type:"error",id:"FlowHubPull",timeout:4e3})})}function checkForDuplication(e){$.get({url:"https://api.flowhub.org/v1/flows/"+$("#node-input-flowhubpull-flowid").val()+"?cb="+(new Date).getTime()+"&v="+$("#node-input-flowhubpull-flowrevision").val(),headers:{"X-FHB-TOKEN":e}},function(e,o){let t=[];if(!Array.isArray(e))return RED.notify("Access denied or revision not found.","error");if(e.forEach((e,o)=>{"tab"==e.type?RED.nodes.workspace(e.id)&&t.push(e):"junction"==e.type?RED.nodes.junction(e.id)&&t.push(e):"group"==e.type?RED.nodes.group(e.id)&&t.push(e):"subflow"==e.type?RED.nodes.subflow(e.id)&&t.push(e):RED.nodes.node(e.id)&&t.push(e)}),0==t.length){RED.notify("Found no duplication.","success");try{$("#node-input-flowhubpull-sb-duplication-container-div").treeList("empty")}catch(e){}}else{RED.notify("Found "+t.length+" items of duplication","warning");try{$("#node-input-flowhubpull-sb-duplication-container-div").treeList("empty")}catch(e){$("#node-input-flowhubpull-sb-duplication-container-div").css({width:"100%",height:"calc(100%)"}).treeList({multi:!1}).on("treelistitemmouseover",function(e,o){}).on("treelistitemmouseout",function(e,o){}).on("treelistselect",function(e,o){o.node&&(RED.workspaces.show(o.node.z,!1,!1,!0),RED.view.reveal(o.node.id,!0),RED.view.redraw())}).on("treelistconfirm",function(e,o){var t;o.node&&(t=o.node.id,setTimeout(()=>{var e=RED.nodes.node(t);e&&(RED.view.reveal(e.id),RED.view.select(e.id),RED.editor.edit(e)),t==RED.workspaces.active()&&RED.workspaces.edit()},50))})}t=t.map(e=>({node:e,label:e.id,sublabel:e.type,selected:!1,checkbox:!1})),$("#node-input-flowhubpull-sb-duplication-container-div").treeList("data",t)}})}

   RED.nodes.registerType('FlowHubPull',{
     color: '#44eeff',
     icon: "flowhubpull.svg",
     category: 'flowhub',
     defaults: {
       name: { value: ""},
       notab: { value: false },
       flowid: { value: "" },
       flowname: { value: "" },
       flowrevision: { value: "" }
     },
     inputs: 1,
     outputs: 2,

     label: function() {
       return (this.name || this.flowname || this.flowid || this._def.paletteLabel);
     },

     onpaletteadd: () => {
     },

     oneditresize: function(size) {
       if ( this._resize ) { this._resize(); };
     },

     oneditprepare: function() {
       var dirList = $("#node-input-flowhubpull-target-container-div").css({
        width: "100%",
        height: "100%"
       }).treeList(
         {
           multi:false
         }
       ).on('treelistselect', function(event, item) {
         if ( item.flowid ) {
          $('#node-input-flowid').val(item.flowid);
          $('#node-input-flowname').val(item.label);

          obtainFhbToken(obtainConfigNode(), (token) => {
            if ( token !== "" && token ) {
              token = "?t=" + tokenToUrl(token)
            }
            $('#flowhubpull-view-flow-link').attr(
            'href', 'https://flowhub.org/f/' + item.flowid + token
            ).show();
          })

          $('#node-input-import-flow-but').prop('disabled',false)
         }
       }).on('treelistconfirm', function(event, item) {
         if ( item.flowid ) {
          $('#node-input-flowid').val(item.flowid);
          $('#node-input-flowname').val(item.label);

          obtainFhbToken(obtainConfigNode(), (token) => {
            if ( token !== "" && token ) {
              token = "?t=" + tokenToUrl(token)
            }
            $('#flowhubpull-view-flow-link').attr(
              'href', 'https://flowhub.org/f/' + item.flowid + token
            ).show();
          });

          $('#node-input-import-flow-but').prop('disabled',false)
          $("#node-input-import-flow-but").trigger('click');
         }
       });

       if ( this.flowid ) {
         setTimeout( () => {
          obtainFhbToken(obtainConfigNode(), (token) => {
            if ( token !== "" && token ) {
              token = "?t=" + tokenToUrl(token)
            }

            $('#flowhubpull-view-flow-link').attr(
              'href', 'https://flowhub.org/f/' + $('#node-input-flowid').val() + token
            ).show();
          })
         }, 200);
       } else {
        $('#node-input-import-flow-but').prop('disabled',true)
       }

       this._resize = function() {
         var rows = $("#dialog-form>div:not(.node-input-target-list-row)");
         var height = $("#dialog-form").height();
         for (var i=0;i<rows.length;i++) {
           height -= $(rows[i]).outerHeight(true);
         }
         var editorRow = $("#dialog-form>div.node-input-target-list-row");
         editorRow.css("height",height+"px");
       };

       var search = $("#node-input-flowhubpull-target-filter").searchBox({
         style: "compact",
         delay: 300,
         change: function() {
           var val = $(this).val().trim().toLowerCase();
           if (val === "") {
             dirList.treeList("filter", null);
             search.searchBox("count","");
           } else {
             var count = dirList.treeList("filter", function(item) {
               return item.label.toLowerCase().indexOf(val) > -1 || item.sublabel.toLowerCase().indexOf(val) > -1
             });
             search.searchBox("count",count + " / " + dirList.treeList("data").length);
           }
         }
       });

       obtainFhbToken(obtainConfigNode(), (token) => {
        flowHubPullUpdateFlows( (lst) => { dirList.treeList('data', lst) }, token);
       })

       $('#node-input-refresh-list-but').on('click', function(e) {
         e.preventDefault();

         setTimeout( () => {
           obtainFhbToken(obtainConfigNode(), (token) => {
            flowHubPullUpdateFlows( (lst) => {
              dirList.treeList('empty')
              $('#flowhubpull-view-flow-link').hide()
              setTimeout( () => {
                dirList.treeList('data', lst)
              },300)
            }, token);
           })
         }, 300);
       });

       $("#node-input-import-flow-but").on("click", function(e) {
         if ( e ) { e.preventDefault(); }

         if ( $('#node-input-flowid').val().trim() == "" ||
              !$('#node-input-flowid').val() ) {
           return RED.notify(RED._("notification.warning", {
             message: "FlowID not provided, doing nothing."
           }), "warning");
         }

         $('#node-dialog-ok').trigger('click')

         let notab = $('#node-input-notab').prop('checked');
         obtainFhbToken(obtainConfigNode(), (token) => {
           doFlowImportForPullNode(notab, token)
         })
       });

       if ( this.notab ) {
         $('#flowhubpull-dialog-import-opt-current').addClass('selected')
         $('#flowhubpull-dialog-import-opt-new').removeClass('selected')
        } else {
         $('#flowhubpull-dialog-import-opt-new').addClass('selected')
         $('#flowhubpull-dialog-import-opt-current').removeClass('selected')
       }

       $('#flowhubpull-dialog-import-opt-current').on('click', (e) => {
         e.preventDefault();
         $('#node-input-notab').prop('checked', true)
         $('#flowhubpull-dialog-import-opt-new').removeClass('selected')
         $('#flowhubpull-dialog-import-opt-current').addClass('selected')
       })

       $('#flowhubpull-dialog-import-opt-new').on('click', (e) => {
         e.preventDefault();
         $('#node-input-notab').prop('checked', false)
         $('#flowhubpull-dialog-import-opt-current').removeClass('selected')
         $('#flowhubpull-dialog-import-opt-new').addClass('selected')
       })
     },

     oneditcancel: function() {
     },

     oneditsave: function() {
     },

     labelStyle: function() {
       return this.name?"node_label_italic":"";
     },
   });
 })();
</script>

<script type="text/html" data-template-name="FlowHubPull">
    <div class="form-row">
        <input type="text" id="node-input-flowid" disabled="disabled"
               style="display:inline-block; width:40%; vertical-align:baseline;"
               placeholder="FlowId to Import">
        <button id="node-input-import-flow-but"
                class="red-ui-button">Import Flow</button>
        <input type="text" id="node-input-flowname" style="display: none;">

        <a id="flowhubpull-view-flow-link" style="color: blue; display: none; margin-left: 80px;"
           target="_blank" href="">Webiliser <i class="fa fa-external-link"></i></a>
    </div>

<!--
    <div class="form-row">
      <label>
            <span>Import to:</span>
      </label>

      <input type="checkbox" id="node-input-notab" style="display:none;">
      <span>
        <a id="flowhubpull-dialog-import-opt-current" class="red-ui-button toggle" href="#" data-i18n="clipboard.export.current">current flow</a>
        <a id="flowhubpull-dialog-import-opt-new" class="red-ui-button toggle" href="#" data-i18n="clipboard.import.newFlow">new flow</a>
      </span>
    </div>
-->
    <div class="form-row node-input-target-row">
        <button id="node-input-refresh-list-but"
                class="red-ui-button"><i class="fa fa-refresh"></i> Refresh Flow List</button>
    </div>

    <div class="form-row node-input-target-row node-input-target-list-row"
         style="position: relative; min-height: 100px">
        <div style="position: absolute; top: -30px; right: 0px;">
            <input type="text" id="node-input-flowhubpull-target-filter">
        </div>

        <div id="node-input-flowhubpull-target-container-div"></div>
    </div>

    <div class="form-row">
      <label for="node-input-flowrevision"><i class="fa fa-tag"></i> Revision</label>
      <input type="text" id="node-input-flowrevision" placeholder="Revision"/>
    </div>

    <div class="form-row">
      <hr/>
    </div>

    <div class="form-row">
      <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name">Name</span></label>
      <input type="text" id="node-input-name" placeholder="Name"/>
    </div>

</script>


<script type="text/html" data-help-name="FlowHubPull">
    <p>
        Import Flows from FlowHub.org. Opens the flow import dialog
        with flow data. Flow can be imported into a new tab or the
        existing tab.
    </p>
</script>
<!-- --- [red-module:@gregoriusrippenstein/node-red-contrib-flowhub/flowhubcfg] --- -->
<script type="text/javascript">
(function ($) {
   RED.nodes.registerType('FlowHubCfg', {
      category: 'config',
      hasUsers: false,
      defaults: {
        apiToken: { value: "" },
        apiTokenType: { value: "" },
        fullname: { value: "" },
        email: { value: "" },
        flowid: { value: "" },
        flowrevision: { value: "" },
        notab: { value: false },
        pushcomment: { value: "" },
        pushnewflows: { value: false },
        forcepush: { value: false },
        tokens: { value: [] },
        flowrevisions: { value: {} }
      },
      label: 'FlowHubCfg',
  });
})(jQuery);
</script>

<!-- The html for the config node info panel (in right sidebar) -->
<script type="text/x-red" data-template-name="FlowHubCfg">
This page is intentional left blank.
</script>

<!-- --- [red-module:@gregoriusrippenstein/node-red-contrib-introspection/seeker] --- -->
<script type="text/javascript">
RED.nodes.registerType("Seeker",{color:"#e5e4ef",icon:"font-awesome/fa-ship",category:"introspection",paletteLabel:"Seeker",defaults:{name:{value:""}},inputs:0,outputs:1,label:function(){return this.name||this._def.paletteLabel},labelStyle:function(){return this.name?"node_label_italic":""},oneditprepare:function(){var n=this;window._introSpectionSeekerStack=[],window._introWorker=void 0;let i=e=>{var t=RED.nodes.node(e[e.length-1]);let n=[];return e.forEach(function(e){var t,e=RED.nodes.node(e)||RED.nodes.junction(e);void 0!==e&&(t=RED.nodes.workspace(e.z)||RED.nodes.subflow(e.z),n.push({label:"",_label:RED.utils.getNodeLabel(e),node:e,sublabel:t&&RED.utils.getNodeLabel(t)||e.z,icon:RED.utils.createNodeIcon(e,!0),class:"intro-remove-top-left"}))}),{node:t,label:RED.utils.getNodeLabel(t),_label:RED.utils.getNodeLabel(t),_pathlen:e.length,sublabel:"Length: "+e.length,selected:!1,checkbox:!1,children:n}};var o=$("#node-input-seeker-target-filter").searchBox({style:"compact",delay:300,change:function(){let t=$(this).val().trim().toLowerCase();var e,n=$("#node-input-seeker-target-container-div").treeList("data");""===t?($("#node-input-seeker-target-container-div").treeList("filter",null),o.searchBox("count","")):(e=$("#node-input-seeker-target-container-div").treeList("filter",function(e){return-1<e._label.toLowerCase().indexOf(t)||-1<e.node.type.toLowerCase().indexOf(t)||e.sublabel.toLowerCase().indexOf(t)}),o.searchBox("count",e+" / "+n.length))}}),r=((e=>{let n=`#node-input-${e}-target-container-div`,o=`#node-input-${e}-extract-pathway-but`,i=`#node-input-${e}-show-pathway-but`;$(n).css({width:"100%",height:"calc(100%)"}).treeList({multi:!1}).on("treelistitemmouseover",function(e,t){}).on("treelistitemmouseout",function(e,t){}).on("treelistconfirm",function(e,t){t.node&&!t.children&&(RED.view.reveal(t.node.id),RED.view.select(t.node.id),setTimeout(()=>{RED.editor.edit(t.node)},100))}).on("treelistselect",function(e,t){t.node&&!t.children&&(RED.workspaces.show(t.node.z,!1,!1,!0),RED.view.reveal(t.node.id,!0),RED.view.redraw()),1==$(n).treeList("data").filter(e=>e.expanded).length?($(o).prop("disabled",!1),$(i).prop("disabled",!1)):($(o).prop("disabled",!0),$(i).prop("disabled",!0))})})("seeker"),function(t,n){if(n.indexOf(t.id)<0&&!t.d)switch(t.type){case"link call":RED.nodes.getNodeLinks(t).forEach(e=>{r(e.target,[...n,t.id])}),t.links.forEach(e=>{e=RED.nodes.node(e);e&&r(e,[...n,t.id])});break;case"link out":t.links.forEach(e=>{e=RED.nodes.node(e);e&&r(e,[...n,t.id])});break;case"Sink":n.push(t.id),window._introSpectionSeekerStack=[n,...window._introSpectionSeekerStack];break;default:RED.nodes.getNodeLinks(t).forEach(e=>{r(e.target,[...n,t.id])})}});let a=e=>{e&&e.preventDefault();let t=window._introSpectionSeekerStack.length,n=25,o=("-"!=$("#node-input-seeker-show-percent").val()&&(n=parseInt(t*(parseInt($("#node-input-seeker-show-percent").val())/100))),e=$("#node-input-seeker-show-ordering").val(),{1:(e,t)=>e.length<t.length?-1:1,2:(e,t)=>e.length>t.length?-1:1,3:(e,t)=>RED.utils.getNodeLabel(RED.nodes.node(e[e.length-1]))<RED.utils.getNodeLabel(RED.nodes.node(t[t.length-1]))?-1:1,4:(e,t)=>{e=RED.utils.getNodeLabel(RED.nodes.node(e[e.length-1]));return RED.utils.getNodeLabel(RED.nodes.node(t[t.length-1]))<e?-1:1},5:(e,t)=>.5<Math.random()?-1:1}[parseInt(e)]||((e,t)=>e.length<t.length?-1:1));setTimeout(()=>{setTimeout(()=>{$("#node-input-seeker-totalPaths").html(n>t?""+t:n+" / "+t)},10),setTimeout(()=>{$("#node-input-seeker-target-container-div").treeList("data",window._introSpectionSeekerStack.sort(o).slice(0,n).map(e=>i(e)))},20)},100)},d=()=>{let e=window._introSpectionSeekerStack.length;setTimeout(()=>{$("#node-input-seeker-totalPaths").html(e),$("#node-input-seeker-spinner").hide(),$("#node-input-seeker-start-but").html('<span><i class="fa fa-refresh"></i> Find Pathways</span>')},10);var t="seeker",n=e;$(`#node-input-${t}-show-percent`).show(),$(`#node-input-${t}-show-ordering`).show();var o,i=$(`#node-input-${t}-show-percent`),r=(i.html(""),i.append($("<option></option>").val("-").html("Show..")),[5,10,20,30,40,50,75].forEach(e=>{var t=parseInt(e*n/100);0!=t&&i.append($("<option></option>").val(e).html(t+" paths"))}),i.append($("<option></option>").val(100).html("All")),i.val("-"),(i=$(`#node-input-${t}-show-ordering`)).html(""),{"Count Asc":1,"Count Desc":2,"Name Asc":3,"Name Desc":4,Random:5});for(o in r)i.append($("<option></option>").val(r[o]).html(o));i.val(1),$("#node-input-seeker-show-ordering").on("change",a),$("#node-input-seeker-show-percent").on("change",a),$("#node-input-seeker-show-percent").trigger("change")};$("#node-input-seeker-show-pathway-but").on("click",e=>{e&&e.preventDefault();var e=$("#node-input-seeker-target-container-div").treeList("data").filter(e=>e.expanded);1==(e=e).length?(e=e[0].children.filter(e=>e.node.z==RED.workspaces.active()).map(e=>e.node.id),RED.tray.hide(),RED.view.selectNodes({selected:e,onselect:()=>{RED.tray.show()},oncancel:()=>{RED.tray.show()}})):RED.notify("Only one expanded pathway can be shown.",{type:"warning"})}),$("#node-input-seeker-extract-pathway-but").on("click",e=>{e&&e.preventDefault(),(e=>{if(1==e.length){e=e[0].children.map(e=>e.node).filter(e=>["link in","link out","Seeker","Sink","junction"].indexOf(e.type)<0);let o=RED.nodes.createExportableNodeSet(e).map(e=>(e.id=RED.nodes.id(),e)),i=0;o=o.map((e,t)=>{try{var n;e._def=e._def||RED.nodes.getType(e.type),e._def&&e._def._&&e._?(n=RED.utils.getNodeLabel(e,e.info).split("\\n").length,i+=30*n+30):i+=50}catch(e){i+=50}return delete e.z,e.y=i,e.x=0,e.wires=[[]],t!=o.length-1&&(e.wires=[[o[t+1].id]]),e}),RED.clipboard.copyText(JSON.stringify(o))&&RED.notify("Pathway copied to clipboard",{type:"success"})}else RED.notify("Only one expanded pathway can be extracted.",{type:"warning"})})($("#node-input-seeker-target-container-div").treeList("data").filter(e=>e.expanded))}),$("#node-input-seeker-start-but").on("click",e=>{if(e&&e.preventDefault(),window._introWorker)window._introWorker.terminate(),delete window._introWorker,d();else if(setTimeout(()=>{$("#node-input-seeker-totalPaths").html(""),$("#node-input-seeker-spinner").show(),$("#node-input-seeker-show-percent").hide(),$("#node-input-seeker-show-ordering").hide()},10),window._introSpectionSeekerStack=[],"undefined"!=typeof Worker){let t=new Worker("data:text/javascript;base64,bGV0IGludHJvU3BlY3Rpb25TdGFjaz1bXSxncmFwaD1bXSxncmFwaEluZGV4PXt9LFJFRD17bm9kZXM6e25vZGU6ZT0+Z3JhcGhbZ3JhcGhJbmRleFtlXV0sZ2V0Tm9kZUxpbmtzOmE9PmEuZmxhdHdpcmVzLm1hcChlPT4oe3RhcmdldDpSRUQubm9kZXMubm9kZShlKSxzb3VyY2U6YX0pKX19LHRyYXZlcnNlPWZ1bmN0aW9uKGEscyl7aWYocy5pbmRleE9mKGEuaWQpPDAmJiFhLmQpc3dpdGNoKGEudHlwZSl7Y2FzZSJsaW5rIGNhbGwiOlJFRC5ub2Rlcy5nZXROb2RlTGlua3MoYSkuZm9yRWFjaChlPT57dHJhdmVyc2UoZS50YXJnZXQsWy4uLnMsYS5pZF0pfSksYS5saW5rcy5mb3JFYWNoKGU9PntlPVJFRC5ub2Rlcy5ub2RlKGUpO2UmJnRyYXZlcnNlKGUsWy4uLnMsYS5pZF0pfSk7YnJlYWs7Y2FzZSJsaW5rIG91dCI6YS5saW5rcy5mb3JFYWNoKGU9PntlPVJFRC5ub2Rlcy5ub2RlKGUpO2UmJnRyYXZlcnNlKGUsWy4uLnMsYS5pZF0pfSk7YnJlYWs7Y2FzZSJTaW5rIjpzLnB1c2goYS5pZCkscG9zdE1lc3NhZ2Uocyk7YnJlYWs7ZGVmYXVsdDpSRUQubm9kZXMuZ2V0Tm9kZUxpbmtzKGEpLmZvckVhY2goZT0+e3RyYXZlcnNlKGUudGFyZ2V0LFsuLi5zLGEuaWRdKX0pfX07b25tZXNzYWdlPWZ1bmN0aW9uKGUpe2xldCBhPWUuZGF0YS5zZWVrZXJJZDsoZ3JhcGg9ZS5kYXRhLm5vZGVzLm1hcChlPT4oe3dpcmVzOmUud2lyZXMsbGlua3M6ZS5saW5rcyxkOmUuZGlzYWJsZWR8fGUuZCxpZDplLmlkLHR5cGU6ZS50eXBlfSkpLmZpbHRlcihlPT4hIWUud2lyZXMpLm1hcChlPT4oZS5mbGF0d2lyZXM9ZS53aXJlcy5mbGF0KCksZSkpKS5mb3JFYWNoKChlLGEpPT5ncmFwaEluZGV4W2UuaWRdPWEpLFJFRC5ub2Rlcy5nZXROb2RlTGlua3MoUkVELm5vZGVzLm5vZGUoYSkpLmZvckVhY2goZT0+e3RyYXZlcnNlKGUudGFyZ2V0LFthXSl9KSxwb3N0TWVzc2FnZSgiZG9uZSIpfTs=");(window._introWorker=t).onmessage=function(e){"done"==e.data?(t.terminate(),delete window._introWorker,d()):(window._introSpectionSeekerStack.push(e.data),$("#node-input-seeker-totalPaths").html(window._introSpectionSeekerStack.length),26==window._introSpectionSeekerStack.length&&$("#node-input-seeker-target-container-div").treeList("data",window._introSpectionSeekerStack.sort((e,t)=>e.length<t.length?-1:1).slice(0,25).map(e=>i(e))))},setTimeout(()=>{t.postMessage({seekerId:n.id,nodes:RED.nodes.createCompleteNodeSet({credentials:!1})}),$("#node-input-seeker-start-but").html('<span><i class="fa fa-stop"></i> Stop</span>')},10)}else setTimeout(()=>{RED.nodes.getNodeLinks(n).forEach(e=>{r(e.target,[n.id])}),d()},300)})},oneditsave:function(){window._introWorker&&(window._introWorker.terminate(),delete window._introWorker),delete window._introSpectionSeekerStack},oneditcancel:function(){window._introWorker&&(window._introWorker.terminate(),delete window._introWorker),delete window._introSpectionSeekerStack},oneditresize:function(e){for(var t=$("#dialog-form>div:not(.node-input-target-list-row)"),n=$("#dialog-form").height(),o=0;o<t.length;o++)n-=$(t[o]).outerHeight(!0);$("#dialog-form>div.node-input-target-list-row").css("height",n+"px")}});
</script>

<script type="text/html" data-template-name="Seeker">

  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name">Name</span></label>
    <input type="text" id="node-input-name" placeholder="Name">
  </div>

  <div class="form-row node-input-target-row">
    <button id="node-input-seeker-start-but" class="red-ui-button"><span><i class="fa fa-refresh"></i> Find Pathways</span></button>
    <select class='hide' style="width:100px;" id="node-input-seeker-show-percent"></select>
    <select class='hide' style="width:100px;" id="node-input-seeker-show-ordering"></select>
    <button id="node-input-seeker-show-pathway-but" class="red-ui-button">Show Pathway</button>
  </div>

  <div class="form-row node-input-target-row node-input-target-list-row" style="margin-top: 40px; position: relative; min-height: 100px">
    <div style="position: absolute; top: -30px; right: 0;"><input type="text" id="node-input-seeker-target-filter"></div>

    <div id="node-input-seeker-target-container-div"></div>
  </div>

  <div class="form-row" style="margin-top: 0px; margin-bottom: 20px;">
    <label>Total Paths:
        <span id="node-input-seeker-totalPaths"></span><img class='hide' id="node-input-seeker-spinner" src='red/images/spin.svg'/>
    </label>
    <button id="node-input-seeker-extract-pathway-but" style="float: right" class="red-ui-button">Extract Pathway to Clipboard</button>
  </div>

</script>

<style>
  .intro-remove-top-left i.red-ui-palette-icon-fa {
    top: -2px !important;
    left: 0px !important;
  }
</style>


<script type="text/html" data-help-name="Seeker">
  <p>The Seeker seeks in the sink and presents all (max 25) paths that lead to the sink.</p>
</script>
<!-- --- [red-module:@gregoriusrippenstein/node-red-contrib-introspection/sink] --- -->
<script type="text/javascript">
RED.nodes.registerType("Sink",{color:"#e5e4ef",icon:"font-awesome/fa-anchor",category:"introspection",paletteLabel:"Sink",defaults:{name:{value:""}},inputs:1,outputs:0,label:function(){return this.name||this._def.paletteLabel},labelStyle:function(){return this.name?"node_label_italic":""},oneditprepare:function(){var n=this;let o=1,i=(window._introSpectionsinkStack=[],window._introWorker=void 0,e=>{var t=RED.nodes.node(e[e.length-1]);let n=[];return e.forEach(function(e){var t,e=RED.nodes.node(e)||RED.nodes.junction(e);void 0!==e&&(t=RED.nodes.workspace(e.z)||RED.nodes.subflow(e.z),n.push({label:"",_label:RED.utils.getNodeLabel(e),node:e,sublabel:t&&RED.utils.getNodeLabel(t)||e.z,icon:RED.utils.createNodeIcon(e,!0),class:"intro-remove-top-left"}))}),{node:t,label:RED.utils.getNodeLabel(t),_label:RED.utils.getNodeLabel(t),_pathlen:e.length,sublabel:"Length: "+e.length,selected:!1,checkbox:!1,children:n}});var a=$("#node-input-sink-target-filter").searchBox({style:"compact",delay:300,change:function(){let t=$(this).val().trim().toLowerCase();var e,n=$("#node-input-sink-target-container-div").treeList("data");""===t?($("#node-input-sink-target-container-div").treeList("filter",null),a.searchBox("count","")):(e=$("#node-input-sink-target-container-div").treeList("filter",function(e){return-1<e._label.toLowerCase().indexOf(t)||-1<e.node.type.toLowerCase().indexOf(t)||e.sublabel.toLowerCase().indexOf(t)}),a.searchBox("count",e+" / "+n.length))}}),d=((e=>{let n=`#node-input-${e}-target-container-div`,o=`#node-input-${e}-extract-pathway-but`,i=`#node-input-${e}-show-pathway-but`;$(n).css({width:"100%",height:"calc(100%)"}).treeList({multi:!1}).on("treelistitemmouseover",function(e,t){}).on("treelistitemmouseout",function(e,t){}).on("treelistconfirm",function(e,t){t.node&&!t.children&&(RED.view.reveal(t.node.id),RED.view.select(t.node.id),setTimeout(()=>{RED.editor.edit(t.node)},100))}).on("treelistselect",function(e,t){t.node&&!t.children&&(RED.workspaces.show(t.node.z,!1,!1,!0),RED.view.reveal(t.node.id,!0),RED.view.redraw()),1==$(n).treeList("data").filter(e=>e.expanded).length?($(o).prop("disabled",!1),$(i).prop("disabled",!1)):($(o).prop("disabled",!0),$(i).prop("disabled",!0))})})("sink"),function(t,n){if(n.indexOf(t.id)<0&&!t.d)switch(t.type){case"link in":t.links.forEach(e=>{e=RED.nodes.node(e);e&&d(e,[...n,t.id])});break;case"Seeker":n.push(t.id),window._introSpectionsinkStack=[n,...window._introSpectionsinkStack];break;default:RED.nodes.getNodeLinks(t,o).forEach(e=>{d(e.source,[...n,t.id])})}});let l=e=>{e&&e.preventDefault();let t=window._introSpectionsinkStack.length,n=25,o=("-"!=$("#node-input-sink-show-percent").val()&&(n=parseInt(t*(parseInt($("#node-input-sink-show-percent").val())/100))),e=$("#node-input-sink-show-ordering").val(),{1:(e,t)=>e.length<t.length?-1:1,2:(e,t)=>e.length>t.length?-1:1,3:(e,t)=>RED.utils.getNodeLabel(RED.nodes.node(e[e.length-1]))<RED.utils.getNodeLabel(RED.nodes.node(t[t.length-1]))?-1:1,4:(e,t)=>{e=RED.utils.getNodeLabel(RED.nodes.node(e[e.length-1]));return RED.utils.getNodeLabel(RED.nodes.node(t[t.length-1]))<e?-1:1},5:(e,t)=>.5<Math.random()?-1:1}[parseInt(e)]||((e,t)=>e.length<t.length?-1:1));setTimeout(()=>{setTimeout(()=>{$("#node-input-sink-totalPaths").html(n>t?""+t:n+" / "+t)},10),setTimeout(()=>{$("#node-input-sink-target-container-div").treeList("data",window._introSpectionsinkStack.sort(o).slice(0,n).map(e=>i(e)))},20)},100)},r=()=>{let e=window._introSpectionsinkStack.length;setTimeout(()=>{$("#node-input-sink-start-but").html('<i class="fa fa-refresh"></i> Find Pathways'),$("#node-input-sink-totalPaths").html(e),$("#node-input-sink-spinner").hide()},10);var t="sink",n=e;$(`#node-input-${t}-show-percent`).show(),$(`#node-input-${t}-show-ordering`).show();var o,i=$(`#node-input-${t}-show-percent`),a=(i.html(""),i.append($("<option></option>").val("-").html("Show..")),[5,10,20,30,40,50,75].forEach(e=>{var t=parseInt(e*n/100);0!=t&&i.append($("<option></option>").val(e).html(t+" paths"))}),i.append($("<option></option>").val(100).html("All")),i.val("-"),(i=$(`#node-input-${t}-show-ordering`)).html(""),{"Count Asc":1,"Count Desc":2,"Name Asc":3,"Name Desc":4,Random:5});for(o in a)i.append($("<option></option>").val(a[o]).html(o));i.val(1),$("#node-input-sink-show-ordering").on("change",l),$("#node-input-sink-show-percent").on("change",l),$("#node-input-sink-show-percent").trigger("change")};$("#node-input-sink-show-pathway-but").on("click",e=>{e&&e.preventDefault();var e=$("#node-input-sink-target-container-div").treeList("data").filter(e=>e.expanded);1==(e=e).length?(e=e[0].children.filter(e=>e.node.z==RED.workspaces.active()).map(e=>e.node.id),RED.tray.hide(),RED.view.selectNodes({selected:e,onselect:()=>{RED.tray.show()},oncancel:()=>{RED.tray.show()}})):RED.notify("Only one expanded pathway can be shown.",{type:"warning"})}),$("#node-input-sink-extract-pathway-but").on("click",e=>{e&&e.preventDefault(),(e=>{if(1==e.length){e=e[0].children.map(e=>e.node).filter(e=>["link in","link out","Seeker","Sink","junction"].indexOf(e.type)<0);let o=RED.nodes.createExportableNodeSet(e).map(e=>(e.id=RED.nodes.id(),e)),i=0;o=o.map((e,t)=>{try{var n;e._def=e._def||RED.nodes.getType(e.type),e._def&&e._def._&&e._?(n=RED.utils.getNodeLabel(e,e.info).split("\\n").length,i+=30*n+30):i+=50}catch(e){i+=50}return delete e.z,e.y=i,e.x=0,e.wires=[[]],t!=o.length-1&&(e.wires=[[o[t+1].id]]),e}),RED.clipboard.copyText(JSON.stringify(o))&&RED.notify("Pathway copied to clipboard",{type:"success"})}else RED.notify("Only one expanded pathway can be extracted.",{type:"warning"})})($("#node-input-sink-target-container-div").treeList("data").filter(e=>e.expanded))}),$("#node-input-sink-start-but").on("click",e=>{if(e&&e.preventDefault(),window._introWorker)window._introWorker.terminate(),delete window._introWorker,r();else if(setTimeout(()=>{$("#node-input-sink-totalPaths").html(""),$("#node-input-sink-spinner").show(),$("#node-input-sink-show-percent").hide(),$("#node-input-sink-show-ordering").hide()},10),window._introSpectionsinkStack=[],"undefined"!=typeof Worker){let t=new Worker("data:text/javascript;base64,bGV0IGludHJvU3BlY3Rpb25TdGFjaz1bXSxncmFwaD1bXSxncmFwaEluZGV4PXt9LFJFRD17bm9kZXM6e25vZGU6ZT0+Z3JhcGhbZ3JhcGhJbmRleFtlXV0sZ2V0Tm9kZUxpbmtzOnM9PnMuaW53aXJlcy5tYXAoZT0+KHt0YXJnZXQ6cyxzb3VyY2U6UkVELm5vZGVzLm5vZGUoZSl9KSl9fTt2YXIgdHJhdmVyc2U9ZnVuY3Rpb24ocyxhKXtpZihhLmluZGV4T2Yocy5pZCk8MCYmIXMuZClzd2l0Y2gocy50eXBlKXtjYXNlImxpbmsgaW4iOnMubGlua3MuZm9yRWFjaChlPT57ZT1SRUQubm9kZXMubm9kZShlKTtlJiZ0cmF2ZXJzZShlLFsuLi5hLHMuaWRdKX0pO2JyZWFrO2Nhc2UiU2Vla2VyIjphLnB1c2gocy5pZCkscG9zdE1lc3NhZ2UoYSk7YnJlYWs7ZGVmYXVsdDpSRUQubm9kZXMuZ2V0Tm9kZUxpbmtzKHMpLmZvckVhY2goZT0+e3RyYXZlcnNlKGUuc291cmNlLFsuLi5hLHMuaWRdKX0pfX07b25tZXNzYWdlPWZ1bmN0aW9uKGUpe2xldCBzPWUuZGF0YS5zaW5rSWQ7KGdyYXBoPShncmFwaD1lLmRhdGEubm9kZXMubWFwKGU9Pih7d2lyZXM6ZS53aXJlcyxsaW5rczplLmxpbmtzLGQ6ZS5kaXNhYmxlZHx8ZS5kLGlkOmUuaWQsdHlwZTplLnR5cGV9KSkuZmlsdGVyKGU9PiEhZS53aXJlcykubWFwKGU9PihlLmZsYXR3aXJlcz1lLndpcmVzLmZsYXQoKSxlKSkpLm1hcChzPT4ocy5pbndpcmVzPWdyYXBoLmZpbHRlcihlPT4tMTxlLmZsYXR3aXJlcy5pbmRleE9mKHMuaWQpKS5tYXAoZT0+ZS5pZCkscykpKS5mb3JFYWNoKChlLHMpPT5ncmFwaEluZGV4W2UuaWRdPXMpLFJFRC5ub2Rlcy5nZXROb2RlTGlua3MoUkVELm5vZGVzLm5vZGUocykpLmZvckVhY2goZT0+e3RyYXZlcnNlKGUuc291cmNlLFtzXSl9KSxwb3N0TWVzc2FnZSgiZG9uZSIpfTs=");(window._introWorker=t).onmessage=function(e){"done"==e.data?(t.terminate(),delete window._introWorker,r()):(window._introSpectionsinkStack.push(e.data),$("#node-input-sink-totalPaths").html(window._introSpectionsinkStack.length),26==window._introSpectionsinkStack.length&&$("#node-input-sink-target-container-div").treeList("data",window._introSpectionsinkStack.sort((e,t)=>e.length<t.length?-1:1).slice(0,25).map(e=>i(e))))},setTimeout(()=>{t.postMessage({sinkId:n.id,nodes:RED.nodes.createCompleteNodeSet({credentials:!1})}),$("#node-input-sink-start-but").html('<i class="fa fa-stop"></i> Stop')},10)}else setTimeout(()=>{RED.nodes.getNodeLinks(n,o).forEach(e=>{d(e.source,[n.id])}),r()},300)})},oneditsave:function(){window._introWorker&&(window._introWorker.terminate(),delete window._introWorker),delete window._introSpectionsinkStack},oneditcancel:function(){window._introWorker&&(window._introWorker.terminate(),delete window._introWorker),delete window._introSpectionsinkStack},oneditresize:function(e){for(var t=$("#dialog-form>div:not(.node-input-target-list-row)"),n=$("#dialog-form").height(),o=0;o<t.length;o++)n-=$(t[o]).outerHeight(!0);$("#dialog-form>div.node-input-target-list-row").css("height",n+"px")}});
</script>

<script type="text/html" data-template-name="Sink">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name">Name</span></label>
    <input type="text" id="node-input-name" placeholder="Name">
  </div>

  <div class="form-row node-input-target-row">
    <button id="node-input-sink-start-but" class="red-ui-button"><i class="fa fa-refresh"></i> Find Pathways</button>
    <select class='hide' style="width:100px;" id="node-input-sink-show-percent"></select>
    <select class='hide' style="width:100px;" id="node-input-sink-show-ordering"></select>
    <button id="node-input-sink-show-pathway-but" class="red-ui-button">Show Pathway</button>
  </div>

  <div class="form-row node-input-target-row node-input-target-list-row" style="margin-top: 40px; position: relative; min-height: 100px">
    <div style="position: absolute; top: -30px; right: 0;"><input type="text" id="node-input-sink-target-filter"></div>

    <div id="node-input-sink-target-container-div"></div>
  </div>

  <div class="form-row" style="margin-top: 0px; margin-bottom: 20px;">
    <label>Total Paths:
        <span id="node-input-sink-totalPaths"></span><img id="node-input-sink-spinner" class="hide" src='red/images/spin.svg'/>
     </label>
     <button id="node-input-sink-extract-pathway-but" class="red-ui-button" style="float: right">Extract Pathway to Clipboard</button>
  </div>
</script>

<style>
  .intro-remove-top-left i.red-ui-palette-icon-fa {
    top: -2px !important;
    left: 0px !important;
  }
</style>


<script type="text/html" data-help-name="Sink">
  <p>Sink is the end of a chain of nodes to complete a full text.</p>
</script>
<!-- --- [red-module:@gregoriusrippenstein/node-red-contrib-introspection/clientcode] --- -->
<script type="text/javascript">

function handleMsgTracePacket(e,r){if(r.nodeid){let a=RED.nodes.node(r.nodeid);if(a){var s,r=$("#node-input-msgtracer-trace-treelist").treeList("data");let t=!1;r.forEach(e=>{e.id==a.id&&(t=!0,e.seenCounter+=1,e.sublabel=e.seenCounter+" @ "+e.workspaceLabel)}),t?$("#node-input-msgtracer-trace-treelist").treeList("data",r):(s={id:a.id,label:"",_label:RED.utils.getNodeLabel(a),seenCounter:1,workspaceLabel:(RED.nodes.workspace(a.z)||{label:a.z}).label,sublabel:"1 @ "+(RED.nodes.workspace(a.z)||{label:a.z}).label,selected:!1,checkbox:!1,node:a,icon:RED.utils.createNodeIcon(a,!0)},$("#node-input-msgtracer-trace-treelist").treeList("data",[s,...r]))}}}RED.comms.subscribe("msgtracer:node-received",(e,t)=>{try{handleMsgTracePacket(e,t)}catch(e){console.error(e)}});

function handleClientCodeFrontend(event,data){var doSend,doStatus,doError,nodeid,_msg,msg,node,payload,topic;"execfunc"==data.msg&&(doSend=(o,d,e)=>{"object"==typeof o&&(o={...e,...o}),$.ajax({url:"ClientCode/"+d,type:"POST",contentType:"application/json; charset=utf-8",data:JSON.stringify(o),success:function(o){},error:function(o,e,t){RED.notify("ClientCode Communcation Failure: "+d+": "+e,{type:"error",id:d,timeout:3e3})}})},doStatus=(o,d,e)=>{$.ajax({url:"ClientCode/"+d+"/status",type:"POST",contentType:"application/json; charset=utf-8",data:JSON.stringify(o),success:function(o){},error:function(o,e,t){RED.notify("ClientCode Communcation Failure: "+d+": "+e,{type:"error",id:d,timeout:3e3})}})},doError=(o,e,t)=>{RED.notify("ClientCode Failed: "+e+": "+o,{type:"error",id:e,timeout:3e3}),console.log("ClientCode: Error with node: "+e+": "+o)},nodeid=data.nodeid,_msg=data._msg,msg=data._msg,node={id:data.nodeid,send:o=>{doSend(o,nodeid,_msg)},error:o=>{doError(o,nodeid,_msg)},status:o=>{doStatus(o,nodeid,_msg)}},payload=data.payload,topic=data.topic,eval(data.func))}RED.comms.subscribe("introspect:client-code-perform",(o,e)=>{try{handleClientCodeFrontend(o,e)}catch(o){console.error(o)}});

  RED.nodes.registerType('ClientCode',{
    color: '#e5e4ef',
    icon: "introspesubflow.svg",
    category: 'introspection',
    paletteLabel: "ClientCode",
    defaults: {
      name: {
        value:"",
      },
      clientcode: {
        value: "node.send(msg)"
      },
      format: {
        value: "javascript"
      }
    },
    inputs:1,
    outputs:1,

    label: function() {
      return (this.name || this._def.paletteLabel);
    },

    labelStyle: function() {
      return this.name?"node_label_italic":"";
    },

    oneditsave: function() {
      $('#node-input-clientcode').val(this.editor.getValue());
      this.editor.destroy();
      delete this.editor;
    },

    oneditcancel: function() {
      this.editor.destroy();
      delete this.editor;
    },

    oneditprepare: function() {
      const that = this;
      const stateId = RED.editor.generateViewStateId("node", this, "");

      this.editor = RED.editor.createEditor({
        id: 'node-input-clientcode-editor',
        mode: 'ace/mode/nrjavascript',
        stateId: stateId,
        globals: {
          msg:true,
          RED: true,
          node: true,
          alert: true,
          console: true,
          Buffer: true,
          setTimeout: true,
          clearTimeout: true,
          setInterval: true,
          clearInterval: true
        },
        value: $("#node-input-clientcode").val()
      });

      $("#node-input-format").on("change", function() {
        var mod = "ace/mode/"+$("#node-input-format").val();
        that.editor.getSession().setMode({
          path: mod,
          v: Date.now()
        });
      });

      RED.popover.tooltip($("#node-clientcode-expand-editor"), RED._("node-red:common.label.expand"));
      $("#node-clientcode-expand-editor").on("click", function (e) {
        e.preventDefault();
        const value = that.editor.getValue();
        that.editor.saveView();
        RED.editor.editText({
          mode: $("#node-input-format").val(),
          value: value,
          stateId: stateId,
          width: "Infinity",
          focus: true,
          complete: function (v, cursor) {
            that.editor.setValue(v, -1);
            setTimeout(function () {
              that.editor.restoreView();
              that.editor.focus();
            }, 250);
          }
        })
      })

    },

    oneditresize: function(size) {
      var rows = $("#dialog-form>div:not(.node-text-editor-row)");
      var height = $("#dialog-form").height();
      for (var i=0; i<rows.length; i++) {
        height -= $(rows[i]).outerHeight(true);
      }
      var editorRow = $("#dialog-form>div.node-text-editor-row");
      height -= (parseInt(editorRow.css("marginTop"))+parseInt(editorRow.css("marginBottom")));
      $(".node-text-editor").css("height",height+"px");
      this.editor.resize();
    }
  });
</script>

<script type="text/html" data-template-name="ClientCode">
  <div class="form-row">
      <label for="node-input-name">
          <i class="fa fa-tag"></i>
          <span data-i18n="common.label.name">Name</span>
      </label>
      <input type="text" id="node-input-name" placeholder="Name">
  </div>

  <div class="form-row" style="position: relative; margin-bottom: 0px;">
      <label for="node-input-clientcode">
          <i class="fa fa-file-code-o"></i> Client Code
      </label>

      <div style="position: absolute; right:0;display:inline-block; text-align: right; font-size: 0.8em;">
          Syntax:
          <select id="node-input-format" style="width:110px; font-size: 10px !important;  height: 24px; padding:0;">
              <option value="handlebars">mustache</option>
              <option value="html">HTML</option>
              <option value="json">JSON</option>
              <option value="javascript">JavaScript</option>
              <option value="css">CSS</option>
              <option value="markdown">Markdown</option>
              <option value="php">PHP</option>
              <option value="python">Python</option>
              <option value="sql">SQL</option>
              <option value="yaml">YAML</option>
              <option value="text">None</option>
          </select>
          <button type="button" id="node-clientcode-expand-editor"
                  class="red-ui-button red-ui-button-small">
              <i class="fa fa-expand"></i>
          </button>
      </div>
  </div>

  <div class="form-row node-text-editor-row">
      <div style="height: 250px; min-height:150px;"
           class="node-text-editor"
           id="node-input-clientcode-editor" ></div>
  </div>

  <input type="hidden" id="node-input-clientcode" autofocus="autofocus">
</script>


<script type="text/html" data-help-name="ClientCode">
  <p>Execute Javascript code in the Node-RED frontend, triggered from the server.</p>

  The code is executed in the users browser and has the following enviornment defined:
  <pre>
  <code>
Variables:
  nodeid - id of this node
  _msg - a reference to the msg object passed to this node
  msg - alias for _msg
  node.id - id of this node, same as `nodeid` above
  payload - a reference to msg.payload as it was received by this node
  topic - a reference to the msg.topic as it was recieved by this node

Functionality:
  node.send({..}) - send data to the output port of this node
  node.error("msg") - generate an error for the node
  node.status( { fill: 'red', shape: 'dot', text: 'hello world'}) - generate a status for the node.
    </code>
   </pre>

    <p>
    This might be confusing since the code in the node <b>is not</b>
    executed on the Node-RED server, rather it is executed in the client
    browser.
    <p>
    This of course makes no sense for flows that are executed "head less"
    on the server in the backgrond on some dark and stormy night. The ClientCode
    node is intended for immediate, frontend-only use.
    <p>
    An example flow with some use cases is included and can be accessed either via
    the Import Flow dialog or accessed online <a style="color: blue" href="https://flowhub.org/f/e02ba6e534f7a0f4" target="_blank">at here <i class="fa fa-external-link"></i></a>.
    <p>
    The code to be executed by the client can also be passed in via the `msg` object using the
    `clientcode` attribute on the `msg` object. If this attribute is set, it will take precendence
    over the code defined in the node itself.
</script>
<!-- --- [red-module:@gregoriusrippenstein/node-red-contrib-introspection/getflows] --- -->
<script type="text/javascript">
  RED.nodes.registerType('GetFlows',{
    color: '#e5e4ef',
    icon: "introspesubflow.svg",
    category: 'introspection',
    defaults: {
      name: {
        value:"",
      },
      flowVersion: {
        value: "v1"
      },
      useAuthentication: {
        value:false
      },
      apiUsername: {
        value: "",
      },
      apiUsernameType: {
        value: "env",
      },
      apiPassword: {
        value: "",
      },
      apiPasswordType: {
        value: "env",
      },
    },
    inputs:1,
    outputs:1,

    label: function() {
      return (this.name || this._def.paletteLabel);
    },

    labelStyle: function() {
      return this.name?"node_label_italic":"";
    },
    oneditprepare: function() {
      $("#node-input-apiUsername").typedInput({
        types:["env", "msg", "flow","global", "cred"],
        typeField: "#node-input-apiUsernameType"
      });

      $("#node-input-apiPassword").typedInput({
        types:["env", "msg", "flow","global", "env", "cred"],
        typeField: "#node-input-apiPasswordType"
      });

      if ( $('#node-input-useAuthentication').is(":checked") ) {
        $('#useAuthentication-input-fields').show();
      } else {
        $('#useAuthentication-input-fields').hide()
      }

      $('#node-input-useAuthentication').on( 'change', function() {
        if ( $('#node-input-useAuthentication').is(":checked") ) {
          $('#useAuthentication-input-fields').show();
        } else {
          $('#useAuthentication-input-fields').hide()
        }
      });
    },
  });
</script>

<script type="text/html" data-template-name="GetFlows">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>

    <div class="form-row">
      <label for="node-input-flowVersion">
        <i class="fa fa-tag"></i>
        <span>Flow Version</span>
      </label>

      <select id="node-input-flowVersion">
        <option value="v1" selected=selected>Version 1</option>
        <option value="v2">Version 2</option>
      </select>
    </div>

    <div class="form-row">
      <label for="node-input-useAuthentication">
        <i class="fa "></i>
        <span>Use Authentication?</span>
      </label>

      <input type="checkbox" id="node-input-useAuthentication"
             style="display:inline-block; width:15px; vertical-align:baseline;">
    </div>

    <div id="useAuthentication-input-fields" class="hidden">
      <div class="form-row">
        <label for="node-input-apiUsername">
          <i class="fa fa-tag"></i>
          Username
        </label>
        <input type="text" id="node-input-apiUsername">
        <input type="hidden" id="node-input-apiUsernameType">
      </div>

      <div class="form-row">
        <label for="node-input-apiPassword">
          <i class="fa fa-tag"></i>
          Password
        </label>
        <input type="text" id="node-input-apiPassword">
        <input type="hidden" id="node-input-apiPasswordType">
      </div>
    </div>
</script>


<script type="text/html" data-help-name="GetFlows">
  <p>Retrieves the current flow file from this server. This uses the Node-RED API and is therefore storage-method independent. Payload becomes a Json string.</p>

  If the response is to sent to another host, then insert a JSON node to convert the response of this node to a Javascript array which can be passed as payload
  to the SendFlow node.
</script>
<!-- --- [red-module:@gregoriusrippenstein/node-red-contrib-introspection/sendflow] --- -->
<script type="text/javascript">
  RED.nodes.registerType('SendFlow',{
    color: '#e5e4ef',
    icon: "introspesubflow.svg",
    category: 'introspection',
    defaults: {
      name: {
        value:"",
      },

      hostUrl: {
        value:"hostUrl",
        required:true
      },
      hostUrlType: {
        value:"str"
      },

      flowVersion: {
        value: "v1"
      },
      useAuthentication: {
        value:false
      },
      apiUsername: {
        value: "",
      },
      apiUsernameType: {
        value: "env",
      },
      apiPassword: {
        value: "",
      },
      apiPasswordType: {
        value: "env",
      },
    },

    inputs:1,
    outputs:1,

    label: function() {
      return (this.name || this._def.paletteLabel);
    },

    labelStyle: function() {
      return this.name?"node_label_italic":"";
    },

    oneditprepare: function() {
      $("#node-input-apiUsername").typedInput({
        types:["env", "msg", "flow","global", "cred"],
        typeField: "#node-input-apiUsernameType"
      });

      $("#node-input-apiPassword").typedInput({
        types:["env", "msg", "flow","global", "cred"],
        typeField: "#node-input-apiPasswordType"
      });

      $("#node-input-hostUrl").typedInput({
        types:["str", "msg", "flow", "global", "env"],
        typeField: "#node-input-hostUrlType"
      });

      if ( $('#node-input-useAuthentication').is(":checked") ) {
        $('#useAuthentication-input-fields').show();
      } else {
        $('#useAuthentication-input-fields').hide()
      }

      $('#node-input-useAuthentication').on( 'change', function() {
        if ( $('#node-input-useAuthentication').is(":checked") ) {
          $('#useAuthentication-input-fields').show();
        } else {
          $('#useAuthentication-input-fields').hide()
        }
      });
    },
  });
</script>

<script type="text/html" data-template-name="SendFlow">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>

    <div class="form-row">
        <label for="node-input-hostUrl"><i class="fa fa-tag"></i> Host</label>
        <input type="text" id="node-input-hostUrl" placeholder="hostUrl">
        <input type="hidden" id="node-input-hostUrlType" value="str">
    </div>

    <div class="form-row">
      <label for="node-input-flowVersion">
        <i class="fa fa-tag"></i>
        <span>Flow Version</span>
      </label>

      <select id="node-input-flowVersion">
        <option value="v1" selected=selected>Version 1</option>
        <option value="v2">Version 2</option>
      </select>
    </div>

    <div class="form-row">
      <label for="node-input-useAuthentication">
        <i class="fa "></i>
        <span>Use Authentication?</span>
      </label>

      <input type="checkbox" id="node-input-useAuthentication"
             style="display:inline-block; width:15px; vertical-align:baseline;">
    </div>

    <div id="useAuthentication-input-fields" class="hidden">
      <div class="form-row">
        <label for="node-input-apiUsername">
          <i class="fa fa-tag"></i>
          Username
        </label>
        <input type="text" id="node-input-apiUsername">
        <input type="hidden" id="node-input-apiUsernameType">
      </div>

      <div class="form-row">
        <label for="node-input-apiPassword">
          <i class="fa fa-tag"></i>
          Password
        </label>
        <input type="text" id="node-input-apiPassword">
        <input type="hidden" id="node-input-apiPasswordType">
      </div>
    </div>
</script>


<script type="text/html" data-help-name="SendFlow">
  <p>Send flow to another Node-RED instance.</p>

  Payload is assumed to be a Javascript array containing flow data.
</script>
<!-- --- [red-module:@gregoriusrippenstein/node-red-contrib-introspection/installpackage] --- -->
<script type="text/javascript">
  RED.nodes.registerType('InstallPackage',{
    color: '#e5e4ef',
    icon: "introspesubflow.svg",
    category: 'introspection',
    paletteLabel: "InstallPkg",
    defaults: {
      name: {
        value:"",
      },

      hostUrl: {
        value:"hostUrl",
        required:true
      },
      hostUrlType: {
        value:"str"
      },

      useAuthentication: {
        value:false
      },
      apiUsername: {
        value: "",
      },
      apiUsernameType: {
        value: "env",
      },
      apiPassword: {
        value: "",
      },
      apiPasswordType: {
        value: "env",
      },
      locally: {
        value: false
      }
    },

    inputs:1,
    outputs:1,

    label: function() {
      return (this.name || this._def.paletteLabel);
    },

    labelStyle: function() {
      return this.name?"node_label_italic":"";
    },

    oneditprepare: function() {
      $("#node-input-apiUsername").typedInput({
        types:["env", "msg", "flow","global", "cred"],
        typeField: "#node-input-apiUsernameType"
      });

      $("#node-input-apiPassword").typedInput({
        types:["env", "msg", "flow","global", "env", "cred"],
        typeField: "#node-input-apiPasswordType"
      });

      $("#node-input-hostUrl").typedInput({
        types:["str", "msg", "flow", "global", "env"],
        typeField: "#node-input-hostUrlType"
      });

      if ( $('#node-input-useAuthentication').is(":checked") ) {
        $('#useAuthentication-input-fields').show();
      } else {
        $('#useAuthentication-input-fields').hide()
      }

      $('#node-input-useAuthentication').on( 'change', function() {
        if ( $('#node-input-useAuthentication').is(":checked") ) {
          $('#useAuthentication-input-fields').show();
        } else {
          $('#useAuthentication-input-fields').hide()
        }
      });

      if ( $('#node-input-locally').is(":checked") ) {
        $('.hostUrl-row').hide();
      } else {
        $('.hostUrl-row').show();
      }

      $('#node-input-locally').on( 'change', function() {
        if ( $('#node-input-locally').is(":checked") ) {
          $('.hostUrl-row').hide();
        } else {
          $('.hostUrl-row').show();
        }
      });
    },
  });
</script>

<script type="text/html" data-template-name="InstallPackage">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>

<!--
    <div class="form-row">
      <input type="checkbox" id="node-input-locally"
             style="display:inline-block; width:15px; vertical-align:baseline;">
      <label for="node-input-locally"><i class="fa fa-home"></i> Locally?</label>
    </div>
-->

    <div class="form-row hostUrl-row">
      <label for="node-input-hostUrl"><i class="fa fa-tag"></i> Host</label>
      <input type="text" id="node-input-hostUrl" placeholder="hostUrl">
      <input type="hidden" id="node-input-hostUrlType" value="str">
    </div>

    <div class="form-row">
      <input type="checkbox" id="node-input-useAuthentication"
             style="display:inline-block; width:15px; vertical-align:baseline;">

      <label for="node-input-useAuthentication">
        <i class="fa fa-key"></i>
        <span>Use Authentication?</span>
      </label>
    </div>

    <div id="useAuthentication-input-fields" class="hidden">
      <div class="form-row">
        <label for="node-input-apiUsername">
          <i class="fa fa-tag"></i>
          Username
        </label>
        <input type="text" id="node-input-apiUsername">
        <input type="hidden" id="node-input-apiUsernameType">
      </div>

      <div class="form-row">
        <label for="node-input-apiPassword">
          <i class="fa fa-tag"></i>
          Password
        </label>
        <input type="text" id="node-input-apiPassword">
        <input type="hidden" id="node-input-apiPasswordType">
      </div>
    </div>
</script>


<script type="text/html" data-help-name="InstallPackage">
  <p>Install package on another Node-RED instance.</p>

  <p>This takes two forms, it can either install a package by name and version (defaults to "latest") or it can
  accept a buffer object containing a .tgz package file.</p>

  <p></p>For the first case:
  <pre>
    msg.payload = {
      module: "@gregoriusrippenstein/node-red-contrib-introspection",
      version: "0.10.0"
    }
  </pre>

  <p>To install a .tgz file, read it into a Buffer object and set the payload to:</p>
  <pre>
    msg.payload = {
      data: new Buffer("ddd")
    }
  </pre>
</script>
<!-- --- [red-module:@gregoriusrippenstein/node-red-scratchpad/scratchpad] --- -->
<script type="text/javascript">
(function ($) {
   RED.nodes.registerType('ScratchPadCfg', {
      category: 'config',
      hasUsers: false,
      defaults: {
         name: { value: "" },
         scratches: { value: [] }
      },
      paletteLabel: 'ScratchPadCfg',
      label: function () {
         return this.name;
      }
  });
})(jQuery);
</script>

<!-- The html for the config node info panel (in right sidebar) -->
<script type="text/x-red" data-template-name="ScratchPadCfg">
   <p>Scratch input for development.</p>
</script>

<!-- --- [red-module:node-red-node-markdown/markdown] --- -->

<script type="text/html" data-template-name="markdown">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
</script>



<script type="text/javascript">
    RED.nodes.registerType('markdown',{
        category: 'parser',
        color:"#DEBD5C",
        defaults: {
            name: {value:""}
        },
        inputs:1,
        outputs:1,
        icon: "parser-markdown.png",
        label: function() {
            return this.name||"markdown";
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        }
    });
</script>
<script type="text/html" data-help-name="markdown">
    <p>A function that converts the <code>msg.payload</code> in markdown format to html.</p>
    <p>If the input is a string it converts it to html.</p>
    <p>All other message types are ignored.</p>
    <p>Uses the markdown-it library - You can see a demo
        <a href="https://markdown-it.github.io/">here</a>.</p>
    <p>It is configured with html, linkify and typographer options turned on.</p>

</script>
